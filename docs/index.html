<!doctype html><meta charset=utf-8><meta content="width=device-width,initial-scale=1.0,viewport-fit=cover,user-scalable=no" name=viewport><meta content=#1a1a1a name=theme-color><meta content=black-translucent name=apple-mobile-web-app-status-bar-style><title>KML Heatmap</title><link href=https://unpkg.com/leaflet@1.9.4/dist/leaflet.css rel=stylesheet><link href=https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.css rel=stylesheet><style>*{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI','Roboto','Helvetica Neue',Arial,sans-serif;-webkit-tap-highlight-color:transparent}html{margin:0;padding:0;width:100%;height:100%;overflow:hidden;background:#1a1a1a;overscroll-behavior:none;-webkit-overflow-scrolling:touch}body{margin:0;padding:0;width:100vw;min-height:100vh;min-height:100dvh;overflow:hidden;background:#1a1a1a;position:relative;overscroll-behavior:none;-webkit-overflow-scrolling:touch}#map{position:absolute;top:0;bottom:0;right:0;left:0;background:#1a1a1a;overscroll-behavior:none}.leaflet-control-zoom{display:none!important}.control-btn{position:fixed;background-color:#2b2b2b;color:#ffffff;border:2px solid #555;border-radius:4px;padding:6px 12px;cursor:pointer;z-index:10000;font-size:14px;font-weight:bold;box-shadow:0 1px 5px rgba(0,0,0,0.4);touch-action:manipulation}.control-btn:hover{background-color:#3b3b3b}.control-btn.left{left:10px}#stats-btn{top:10px}#export-btn{top:50px}#wrapped-btn{top:90px}.control-btn.right{right:10px;min-width:120px;text-align:center}#year-filter{top:10px}#heatmap-btn{top:50px}#airports-btn{top:90px}#altitude-btn{top:130px}#airspeed-btn{top:170px}#aviation-btn{top:210px}#year-filter{background-color:#2b2b2b;color:#ffffff;border:2px solid #555;border-radius:4px;padding:6px 12px;cursor:pointer;font-size:14px;font-weight:bold;box-shadow:0 1px 5px rgba(0,0,0,0.4);touch-action:manipulation;width:120px;box-sizing:border-box;text-align:center}#year-filter select{background:transparent;color:#ffffff;border:0!important;border-style:none!important;border-width:0!important;border-color:transparent!important;border-image:none!important;cursor:pointer;font-size:14px;font-weight:bold;width:calc(100% + 24px);margin:-6px -12px;padding:6px 12px;outline:none!important;box-shadow:none!important;text-align:center;text-align-last:center;-webkit-appearance:none;-moz-appearance:none;appearance:none}#year-filter select:focus{outline:none!important;border:0!important;border-style:none!important;box-shadow:none!important}#year-filter select:active{border:0!important;border-style:none!important}#year-filter select option{background-color:#2b2b2b;color:#ffffff;text-align:center}#year-filter:hover{background-color:#3b3b3b}#altitude-legend{position:fixed;bottom:30px;left:10px;background-color:rgba(43,43,43,0.9);color:#ffffff;border:2px solid #555;border-radius:4px;padding:10px;z-index:1000;font-size:12px;min-width:200px;display:none}#altitude-legend .legend-title{font-weight:bold;margin-bottom:8px;font-size:13px}#altitude-legend .gradient-bar{height:20px;background:linear-gradient(to right,rgb(80,160,255) 0%,rgb(0,255,255) 20%,rgb(0,255,0) 40%,rgb(255,255,0) 60%,rgb(255,165,0) 80%,rgb(255,66,66) 100%);border-radius:3px;margin-bottom:5px}#altitude-legend .labels{display:flex;justify-content:space-between;font-size:11px}#airspeed-legend{position:fixed;bottom:30px;left:10px;background-color:rgba(43,43,43,0.9);color:#ffffff;border:2px solid #555;border-radius:4px;padding:10px;z-index:1000;font-size:12px;min-width:200px;display:none}#airspeed-legend .legend-title{font-weight:bold;margin-bottom:8px;font-size:13px}#airspeed-legend .gradient-bar{height:20px;background:linear-gradient(to right,rgb(80,160,255) 0%,rgb(0,255,255) 20%,rgb(0,255,0) 40%,rgb(255,255,0) 60%,rgb(255,165,0) 80%,rgb(255,66,66) 100%);border-radius:3px;margin-bottom:5px}#airspeed-legend .labels{display:flex;justify-content:space-between;font-size:11px}#stats-panel{position:fixed;top:130px;left:10px;width:280px;background-color:#2b2b2b;border:2px solid #555;border-radius:4px;z-index:10001;font-size:13px;padding:12px;display:none;color:#ffffff;box-shadow:0 2px 6px rgba(0,0,0,0.3);max-height:80vh;overflow-y:auto}#loading{position:fixed;bottom:10px;right:10px;background-color:#2b2b2b;color:#ffffff;border:2px solid #555;border-radius:4px;padding:6px 12px;z-index:10000;font-size:12px;display:none}#wrapped-modal{position:fixed;top:0;left:0;width:100%;height:100%;background:linear-gradient(135deg,rgba(10,10,20,0.97) 0%,rgba(15,20,35,0.97) 100%);z-index:20000;display:none;justify-content:center;align-items:center;padding:0;box-sizing:border-box}#wrapped-container{display:flex;flex-direction:column;width:100%;height:100%;overflow-y:auto}#wrapped-header{display:flex;justify-content:flex-end;align-items:center;padding:12px 40px;background:transparent;flex-shrink:0}#wrapped-content{display:flex;gap:30px;flex:1;overflow-y:auto;align-items:stretch;padding:0 40px 40px 40px}#wrapped-map-container{flex:1;background-color:#1a1a1a;border-radius:20px;overflow:hidden;box-shadow:0 10px 40px rgba(0,0,0,0.5);position:relative;display:flex;align-items:center;justify-content:center;min-width:400px}#wrapped-map-snapshot{width:100%;height:100%;object-fit:cover}#wrapped-cards-column{display:flex;flex-direction:column;gap:20px;width:500px;flex-shrink:0}.wrapped-square-card{background:linear-gradient(135deg,#1a1a2e 0%,#16213e 50%,#0f3460 100%);border-radius:20px;padding:30px;flex-shrink:0;box-shadow:0 10px 40px rgba(0,0,0,0.5);color:#ffffff;position:relative;display:flex;flex-direction:column}#wrapped-card-stats{}#wrapped-card-facts{}#wrapped-card-airports{}.wrapped-square-card h1{font-size:36px;margin:0 0 10px 0;text-align:center;background:linear-gradient(135deg,#f093fb 0%,#f5576c 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;text-fill-color:transparent}.wrapped-square-card .year{font-size:64px;font-weight:bold;text-align:center;margin:20px 0;background:linear-gradient(135deg,#4facfe 0%,#00f2fe 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;text-fill-color:transparent}.wrapped-square-card .stat-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:20px;margin:30px 0}.wrapped-square-card .stat-card{background-color:rgba(255,255,255,0.1);border-radius:12px;padding:20px;text-align:center}.wrapped-square-card .stat-value{font-size:32px;font-weight:bold;color:#4facfe;margin-bottom:5px}.wrapped-square-card .stat-label{font-size:12px;opacity:0.8;text-transform:uppercase;letter-spacing:1px}#wrapped-header .close-btn{background:transparent;border:none;color:rgba(255,255,255,0.6);font-size:14px;cursor:pointer;padding:6px 12px;border-radius:6px;transition:all 0.2s ease;font-weight:500;display:flex;align-items:center;gap:6px;letter-spacing:0.5px}#wrapped-header .close-btn:hover{background-color:rgba(255,255,255,0.08);color:rgba(255,255,255,0.9)}.wrapped-square-card .fun-facts{margin:25px 0;padding:20px;background:linear-gradient(135deg,rgba(79,172,254,0.15) 0%,rgba(0,242,254,0.15) 100%);border-radius:12px;border:1px solid rgba(79,172,254,0.3)}.wrapped-square-card .fun-facts-title{font-size:16px;font-weight:bold;margin-bottom:12px;color:#4facfe;text-transform:uppercase;letter-spacing:1px}.wrapped-square-card .fun-fact{font-size:14px;margin:10px 0;padding:10px 12px;opacity:0.95;line-height:1.6;border-radius:8px;background:rgba(255,255,255,0.05);border-left:3px solid;transition:all 0.2s ease}.wrapped-square-card .fun-fact:hover{opacity:1;background:rgba(255,255,255,0.08);transform:translateX(3px)}.wrapped-square-card .fun-fact strong{color:#00f2fe;font-weight:600}.wrapped-square-card .fun-fact[data-category="distance"]{border-left-color:#4facfe}.wrapped-square-card .fun-fact[data-category="altitude"]{border-left-color:#f093fb}.wrapped-square-card .fun-fact[data-category="time"]{border-left-color:#ffd93d}.wrapped-square-card .fun-fact[data-category="airports"]{border-left-color:#6bcf7f}.wrapped-square-card .fun-fact[data-category="frequency"]{border-left-color:#ff6b9d}.wrapped-square-card .fun-fact[data-category="achievement"]{border-left-color:#ffa500;background:linear-gradient(135deg,rgba(255,165,0,0.1) 0%,rgba(255,215,0,0.1) 100%)}.wrapped-square-card .top-airports{margin:25px 0}.wrapped-square-card .top-airports-title{font-size:16px;font-weight:bold;margin-bottom:12px;color:#f5576c;text-transform:uppercase;letter-spacing:1px}.wrapped-square-card .top-airport{display:flex;justify-content:space-between;align-items:center;padding:10px 15px;margin:8px 0;background-color:rgba(245,87,108,0.15);border-radius:8px;border-left:3px solid #f5576c}.wrapped-square-card .top-airport-name{font-size:14px;font-weight:500}.wrapped-square-card .top-airport-count{font-size:14px;font-weight:bold;color:#f5576c}.wrapped-square-card .airports-grid{margin:25px 0}.wrapped-square-card .airports-grid-title{font-size:16px;font-weight:bold;margin-bottom:12px;color:#f093fb;text-transform:uppercase;letter-spacing:1px}.wrapped-square-card .airport-badges{display:flex;flex-wrap:wrap;gap:8px}.wrapped-square-card .airport-badge{background:linear-gradient(135deg,rgba(240,147,251,0.2) 0%,rgba(245,87,108,0.2) 100%);border:1px solid rgba(240,147,251,0.4);padding:6px 12px;border-radius:20px;font-size:12px;font-weight:500;color:#ffffff;white-space:nowrap}#wrapped-card-content{flex:1;margin:0 -40px;padding:0 40px}@media (max-width:768px){#wrapped-modal{padding:0}#wrapped-header{padding:10px 20px}#wrapped-header .close-btn{font-size:13px;padding:5px 10px}#wrapped-content{flex-direction:column;gap:20px;padding:0 20px 20px 20px}#wrapped-cards-column{width:100%;gap:15px}.wrapped-square-card{width:100%;height:auto;padding:20px;box-sizing:border-box}#wrapped-map-container{width:100%;padding-bottom:100%;position:relative;height:0;min-width:0}#wrapped-map-container>*{position:absolute;top:0;left:0;width:100%;height:100%}.wrapped-square-card h1{font-size:24px;word-wrap:break-word;line-height:1.2}.wrapped-square-card .year{font-size:48px;margin:15px 0}.wrapped-square-card .stat-grid{gap:12px;margin:20px 0}.wrapped-square-card .stat-card{padding:15px 10px}.wrapped-square-card .stat-value{font-size:28px}.wrapped-square-card .stat-label{font-size:11px}.wrapped-square-card .fun-facts{margin:15px 0;padding:15px}.wrapped-square-card .fun-facts-title{font-size:14px}.wrapped-square-card .fun-fact{font-size:12px;padding:8px 10px;margin:8px 0}.wrapped-square-card .fun-fact:hover{transform:translateX(2px)}.wrapped-square-card .top-airports{margin:15px 0}.wrapped-square-card .top-airports-title{font-size:14px}.wrapped-square-card .top-airport{padding:8px 12px}.wrapped-square-card .top-airport-name{font-size:12px}.wrapped-square-card .top-airport-count{font-size:12px}.wrapped-square-card .airports-grid{margin:15px 0}.wrapped-square-card .airports-grid-title{font-size:14px}.wrapped-square-card .airport-badge{padding:5px 10px;font-size:11px}}.leaflet-control-attribution{display:none!important}.leaflet-control-layers{background-color:#2b2b2b!important;color:#ffffff!important;border:1px solid #555!important}.leaflet-control-layers-toggle{background-color:#2b2b2b!important;border:1px solid #555!important}.leaflet-control-layers label{color:#ffffff!important}.leaflet-control-zoom{border:2px solid #555!important}.leaflet-control-zoom a{background-color:#2b2b2b!important;color:#ffffff!important}.leaflet-control-zoom a:hover{background-color:#3b3b3b!important}.airport-marker{width:6px;height:6px;background-color:#28a745;border:1px solid #ffffff;border-radius:50%;box-shadow:0 2px 6px rgba(0,0,0,0.4);cursor:pointer;transition:all 0.2s ease;flex-shrink:0}.airport-marker-home{background-color:#007bff!important}.airport-label{background-color:rgba(43,43,43,0.9);border:1px solid #28a745;color:#ffffff;font-family:monospace;font-weight:bold;font-size:9px;padding:1px 3px;border-radius:3px;white-space:nowrap;pointer-events:none;box-shadow:0 1px 3px rgba(0,0,0,0.4);position:absolute;bottom:10px;left:50%;transform:translateX(-50%)}.airport-label-home{border-color:#007bff!important}.airport-marker-container{position:relative;display:flex;align-items:center;justify-content:center;width:6px;height:6px}.airport-marker-container:hover .airport-marker{transform:scale(1.3);box-shadow:0 3px 8px rgba(0,0,0,0.6)}.airport-marker-small{width:7px;height:7px;border:1px solid #ffffff}.airport-label-small{font-size:10px;padding:1px 3px;bottom:11px}.airport-marker-container-small{width:7px;height:7px}.airport-marker-medium-small{width:8px;height:8px;border:1px solid #ffffff}.airport-label-medium-small{font-size:11px;padding:1px 4px;bottom:12px}.airport-marker-container-medium-small{width:8px;height:8px}.airport-marker-medium{width:10px;height:10px;border:2px solid #ffffff}.airport-label-medium{font-size:12px;padding:2px 5px;bottom:14px}.airport-marker-container-medium{width:10px;height:10px}.airport-marker-large{width:11px;height:11px;border:2px solid #ffffff}.airport-label-large{font-size:12px;padding:2px 5px;bottom:16px}.airport-marker-container-large{width:11px;height:11px}.airport-marker-xlarge{width:12px;height:12px;border:2px solid #ffffff}.airport-label-xlarge{font-size:13px;padding:2px 6px;bottom:18px}.airport-marker-container-xlarge{width:12px;height:12px}.leaflet-tooltip{background-color:#2b2b2b;border:2px solid #28a745;color:#ffffff;font-family:monospace;font-weight:bold;font-size:12px;padding:4px 8px;border-radius:4px;box-shadow:0 2px 6px rgba(0,0,0,0.4)}.leaflet-tooltip-top:before{border-top-color:#28a745}.leaflet-tooltip-bottom:before{border-bottom-color:#28a745}.leaflet-tooltip-left:before{border-left-color:#28a745}.leaflet-tooltip-right:before{border-right-color:#28a745}</style><body><div id=map></div><button class="control-btn left" id=stats-btn onclick=toggleStats()>üìä Stats</button><button class="control-btn left" id=export-btn onclick=exportMap()>üì∑ Export</button><button class="control-btn left" id=wrapped-btn onclick=showWrapped()>‚ú® Wrapped</button><button class="control-btn right" id=heatmap-btn onclick=toggleHeatmap()>üî• Heatmap</button><button class="control-btn right" id=airports-btn onclick=toggleAirports()>‚úàÔ∏è Airports</button><button class="control-btn right" id=altitude-btn onclick=toggleAltitude()>‚õ∞Ô∏è Altitude</button><button class="control-btn right" id=airspeed-btn onclick=toggleAirspeed()>üöÄ Speed</button><button class="control-btn right" style="display: none;" id=aviation-btn onclick=toggleAviation()>üó∫Ô∏è Aviation</button><div class="control-btn right" id=year-filter><select id=year-select onchange=filterByYear()><option value=all>üìÖ Years</select></div><div id=stats-panel></div><div id=altitude-legend><div class=legend-title>‚õ∞Ô∏è Altitude</div><div class=gradient-bar></div><div class=labels><span id=legend-min>0 ft</span><span id=legend-max>10,000 ft</span></div></div><div id=airspeed-legend><div class=legend-title>üöÄ Groundspeed</div><div class=gradient-bar></div><div class=labels><span id=airspeed-legend-min>0 kt</span><span id=airspeed-legend-max>200 kt</span></div></div><div id=loading>Loading data...</div><div id=wrapped-modal onclick=closeWrapped(event)><div id=wrapped-container onclick=event.stopPropagation()><div id=wrapped-header><button class=close-btn onclick=closeWrapped()>‚úï Close</button></div><div id=wrapped-content><div id=wrapped-cards-column><div class=wrapped-square-card id=wrapped-card-stats><h1>‚ú® Your Year in Flight</h1><div class=year id=wrapped-year>2025</div><div class=stat-grid id=wrapped-stats></div></div><div class=wrapped-square-card id=wrapped-card-facts><div class=fun-facts id=wrapped-fun-facts></div></div><div class=wrapped-square-card id=wrapped-card-airports><div class=top-airports id=wrapped-top-airports></div><div class=airports-grid id=wrapped-airports-grid></div></div></div><div id=wrapped-map-container></div></div></div></div><script src=https://unpkg.com/leaflet@1.9.4/dist/leaflet.js></script><script src=https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js></script><script src=https://cdn.jsdelivr.net/npm/dom-to-image@2.6.0/dist/dom-to-image.min.js></script><script>const CENTER=[51.227789,13.3316945];const BOUNDS=[[48.101383,9.362755],[54.354195,17.300634]];const STADIA_API_KEY='ac4dd698-4222-457a-9fdd-763b5f9506b2';const OPENAIP_API_KEY='8c48c5bab93ab7426e33c63e0f2da961';const DATA_DIR='data';function ddToDms(dd,isLat){const direction=dd>=0?(isLat?'N':'E'):(isLat?'S':'W');dd=Math.abs(dd);const degrees=Math.floor(dd);const minutes=Math.floor((dd-degrees)*60);const seconds=((dd-degrees)*60-minutes)*60;return degrees+"¬∞"+minutes+"'"+seconds.toFixed(1)+'"'+direction;}
var map=L.map('map',{center:CENTER,zoom:10,zoomSnap:0.25,zoomDelta:0.25,wheelPxPerZoomLevel:120,preferCanvas:true});if(STADIA_API_KEY){L.tileLayer('https://tiles.stadiamaps.com/tiles/alidade_smooth_dark/{z}/{x}/{y}{r}.png?api_key='+STADIA_API_KEY,{attribution:'&copy; <a href="https://stadiamaps.com/">Stadia Maps</a>'}).addTo(map);}else{L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',{attribution:'&copy; OpenStreetMap contributors, &copy; CARTO'}).addTo(map);}
map.fitBounds(BOUNDS,{padding:[30,30]});var altitudeRenderer=L.svg();var airspeedRenderer=L.svg();var heatmapLayer=null;var altitudeLayer=L.layerGroup();var airspeedLayer=L.layerGroup();var airportLayer=L.layerGroup();var currentResolution=null;var loadedData={};var currentData=null;var fullStats=null;var altitudeRange={min:0,max:10000};var airspeedRange={min:0,max:200};var heatmapVisible=true;var altitudeVisible=false;var airspeedVisible=false;var airportsVisible=true;var aviationVisible=false;var selectedPathIds=new Set();var pathSegments={};var pathToAirports={};var airportToPaths={};var airportMarkers={};var openaipLayers={};if(OPENAIP_API_KEY){openaipLayers['Aviation Data']=L.tileLayer('https://{s}.api.tiles.openaip.net/api/data/openaip/{z}/{x}/{y}.png?apiKey='+OPENAIP_API_KEY,{attribution:'&copy; <a href="https://www.openaip.net">OpenAIP</a>',maxZoom:18,minZoom:7,subdomains:['a','b','c']});}
airportLayer.addTo(map);document.getElementById('altitude-btn').style.opacity='0.5';document.getElementById('airspeed-btn').style.opacity='0.5';document.getElementById('aviation-btn').style.opacity='0.5';if(OPENAIP_API_KEY){document.getElementById('aviation-btn').style.display='block';}
function getResolutionForZoom(zoom){if(zoom<=4)return'z0_4';if(zoom<=7)return'z5_7';if(zoom<=10)return'z8_10';if(zoom<=13)return'z11_13';return'z14_plus';}
function showLoading(){document.getElementById('loading').style.display='block';}
function hideLoading(){document.getElementById('loading').style.display='none';}
async function loadData(resolution){if(loadedData[resolution]){return loadedData[resolution];}
showLoading();try{const response=await fetch(DATA_DIR+'/data_'+resolution+'.json');const data=await response.json();loadedData[resolution]=data;console.log('Loaded '+resolution+' resolution:',data.downsampled_points+' points');return data;}catch(error){console.error('Error loading data:',error);return null;}finally{hideLoading();}}
async function loadAirports(){try{const response=await fetch(DATA_DIR+'/airports.json');const data=await response.json();return data.airports;}catch(error){console.error('Error loading airports:',error);return[];}}
async function loadMetadata(){try{const response=await fetch(DATA_DIR+'/metadata.json');return await response.json();}catch(error){console.error('Error loading metadata:',error);return null;}}
async function updateLayers(){const zoom=map.getZoom();const resolution=getResolutionForZoom(zoom);if(resolution===currentResolution){return;}
currentResolution=resolution;const data=await loadData(resolution);if(!data)return;currentData=data;if(heatmapLayer){map.removeLayer(heatmapLayer);}
heatmapLayer=L.heatLayer(data.coordinates,{radius:10,blur:15,minOpacity:0.25,maxOpacity:0.6,max:1.0,gradient:{0.0:'blue',0.3:'cyan',0.5:'lime',0.7:'yellow',1.0:'red'}});if(heatmapLayer._canvas){heatmapLayer._canvas.style.pointerEvents='none';}
if(heatmapVisible){heatmapLayer.addTo(map);}
pathToAirports={};airportToPaths={};if(data.path_info){data.path_info.forEach(function(pathInfo){var pathId=pathInfo.id;pathToAirports[pathId]={start:pathInfo.start_airport,end:pathInfo.end_airport};if(pathInfo.start_airport){if(!airportToPaths[pathInfo.start_airport]){airportToPaths[pathInfo.start_airport]=[];}
airportToPaths[pathInfo.start_airport].push(pathId);}
if(pathInfo.end_airport){if(!airportToPaths[pathInfo.end_airport]){airportToPaths[pathInfo.end_airport]=[];}
airportToPaths[pathInfo.end_airport].push(pathId);}});}
if(data.path_segments&&data.path_segments.length>0){var altitudes=data.path_segments.map(function(s){return s.altitude_ft;});altitudeRange.min=Math.min(...altitudes);altitudeRange.max=Math.max(...altitudes);}
redrawAltitudePaths();console.log('Updated to '+resolution+' resolution');}
function redrawAltitudePaths(){if(!currentData)return;altitudeLayer.clearLayers();pathSegments={};var colorMinAlt,colorMaxAlt;if(selectedPathIds.size>0){var selectedSegments=currentData.path_segments.filter(function(segment){return selectedPathIds.has(segment.path_id);});if(selectedSegments.length>0){var altitudes=selectedSegments.map(function(s){return s.altitude_ft;});colorMinAlt=Math.min(...altitudes);colorMaxAlt=Math.max(...altitudes);}else{colorMinAlt=altitudeRange.min;colorMaxAlt=altitudeRange.max;}}else{colorMinAlt=altitudeRange.min;colorMaxAlt=altitudeRange.max;}
currentData.path_segments.forEach(function(segment){var pathId=segment.path_id;if(selectedYear!=='all'){var pathInfo=currentData.path_info.find(function(p){return p.id===pathId;});if(pathInfo&&pathInfo.year&&pathInfo.year.toString()!==selectedYear){return;}}
var isSelected=selectedPathIds.has(pathId);var color=getColorForAltitude(segment.altitude_ft,colorMinAlt,colorMaxAlt);var polyline=L.polyline(segment.coords,{color:color,weight:isSelected?6:4,opacity:isSelected?1.0:(selectedPathIds.size>0?0.1:0.85),renderer:altitudeRenderer,interactive:true}).bindPopup('Altitude: '+segment.altitude_ft+' ft ('+segment.altitude_m+' m)').addTo(altitudeLayer);polyline.on('click',function(e){L.DomEvent.stopPropagation(e);togglePathSelection(pathId);});if(!pathSegments[pathId]){pathSegments[pathId]=[];}
pathSegments[pathId].push(polyline);});updateAltitudeLegend(colorMinAlt,colorMaxAlt);updateAirportOpacity();updateStatsForSelection();}
function getColorForAltitude(altitude,minAlt,maxAlt){var normalized=(altitude-minAlt)/Math.max(maxAlt-minAlt,1);normalized=Math.max(0,Math.min(1,normalized));var r,g,b;if(normalized<0.2){var t=normalized/0.2;r=Math.round(80*(1-t));g=Math.round(160+95*t);b=255;}else if(normalized<0.4){var t=(normalized-0.2)/0.2;r=0;g=255;b=Math.round(255*(1-t));}else if(normalized<0.6){var t=(normalized-0.4)/0.2;r=Math.round(255*t);g=255;b=0;}else if(normalized<0.8){var t=(normalized-0.6)/0.2;r=255;g=Math.round(255*(1-t*0.35));b=0;}else{var t=(normalized-0.8)/0.2;r=255;g=Math.round(165*(1-t*0.6));b=Math.round(66*t);}
return'rgb('+r+','+g+','+b+')';}
function updateAirportOpacity(){if(selectedPathIds.size===0){Object.keys(airportMarkers).forEach(function(airportName){var marker=airportMarkers[airportName];marker.setOpacity(1.0);});return;}
var selectedAirports=new Set();selectedPathIds.forEach(function(pathId){var airports=pathToAirports[pathId];if(airports){if(airports.start)selectedAirports.add(airports.start);if(airports.end)selectedAirports.add(airports.end);}});Object.keys(airportMarkers).forEach(function(airportName){var marker=airportMarkers[airportName];if(selectedAirports.has(airportName)){marker.setOpacity(1.0);}else{marker.setOpacity(0.3);}});}
var selectedYear='all';function filterByYear(){const yearSelect=document.getElementById('year-select');selectedYear=yearSelect.value;altitudeLayer.clearLayers();pathSegments={};selectedPathIds.clear();currentResolution=null;updateLayers();}
(async function(){const airports=await loadAirports();const metadata=await loadMetadata();if(metadata&&metadata.available_years){const yearSelect=document.getElementById('year-select');metadata.available_years.forEach(function(year){const option=document.createElement('option');option.value=year;option.textContent='üìÖ '+year;yearSelect.appendChild(option);});}
let homeBaseAirport=null;if(airports.length>0){homeBaseAirport=airports.reduce((max,airport)=>airport.flight_count>max.flight_count?airport:max,airports[0]);}
airports.forEach(function(airport){const icaoMatch=airport.name?airport.name.match(/\b([A-Z]{4})\b/):null;const icao=icaoMatch?icaoMatch[1]:'APT';const isHomeBase=homeBaseAirport&&airport.name===homeBaseAirport.name;const homeClass=isHomeBase?' airport-marker-home':'';const homeLabelClass=isHomeBase?' airport-label-home':'';const markerHtml='<div class="airport-marker-container"><div class="airport-marker'+homeClass+'"></div><div class="airport-label'+homeLabelClass+'">'+icao+'</div></div>';const latDms=ddToDms(airport.lat,true);const lonDms=ddToDms(airport.lon,false);const googleMapsLink=`https://www.google.com/maps?q=${airport.lat},${airport.lon}`;const popup=`
                <div style="font-size: 12px; min-width: 150px;">
                    <b>üõ´ ${airport.name || 'Unknown'}</b><br>
                    <a href="${googleMapsLink}" target="_blank" style="color: #4285f4; text-decoration: none;">${latDms} ${lonDms}</a><br>
                    <b>Flights:</b> ${airport.flight_count}
                </div>`;var marker=L.marker([airport.lat,airport.lon],{icon:L.divIcon({html:markerHtml,iconSize:[12,12],iconAnchor:[6,6],popupAnchor:[2,-6],className:''}),icao:icao}).bindPopup(popup,{autoPanPadding:[50,50]});marker.on('click',function(e){selectPathsByAirport(airport.name);});marker.addTo(airportLayer);airportMarkers[airport.name]=marker;});if(metadata&&metadata.stats){fullStats=metadata.stats;updateStatsPanel(fullStats,false);}
if(metadata&&metadata.min_groundspeed_knots!==undefined&&metadata.max_groundspeed_knots!==undefined){airspeedRange.min=metadata.min_groundspeed_knots;airspeedRange.max=metadata.max_groundspeed_knots;updateAirspeedLegend(airspeedRange.min,airspeedRange.max);}
updateLayers();updateAirportMarkerSizes();})();map.on('zoomend',function(){updateLayers();updateAirportMarkerSizes();});map.on('click',function(e){if(selectedPathIds.size>0){clearSelection();}});function togglePathSelection(pathId){if(selectedPathIds.has(pathId)){selectedPathIds.delete(pathId);}else{selectedPathIds.add(pathId);}
redrawAltitudePaths();if(airspeedVisible){redrawAirspeedPaths();}}
function selectPathsByAirport(airportName){var pathIds=airportToPaths[airportName]||[];pathIds.forEach(function(pathId){selectedPathIds.add(pathId);});redrawAltitudePaths();if(airspeedVisible){redrawAirspeedPaths();}}
function clearSelection(){selectedPathIds.clear();redrawAltitudePaths();if(airspeedVisible){redrawAirspeedPaths();}}
function updateAirportMarkerSizes(){const zoom=map.getZoom();let sizeClass='';if(zoom>=14){sizeClass='xlarge';}else if(zoom>=12){sizeClass='large';}else if(zoom>=10){sizeClass='medium';}else if(zoom>=8){sizeClass='medium-small';}else if(zoom>=6){sizeClass='small';}
document.querySelectorAll('.airport-marker-container').forEach(function(container){const marker=container.querySelector('.airport-marker');const label=container.querySelector('.airport-label');if(zoom<5){label.style.display='none';}else{label.style.display='';}
container.classList.remove('airport-marker-container-small','airport-marker-container-medium-small','airport-marker-container-medium','airport-marker-container-large','airport-marker-container-xlarge');marker.classList.remove('airport-marker-small','airport-marker-medium-small','airport-marker-medium','airport-marker-large','airport-marker-xlarge');label.classList.remove('airport-label-small','airport-label-medium-small','airport-label-medium','airport-label-large','airport-label-xlarge');if(sizeClass){container.classList.add('airport-marker-container-'+sizeClass);marker.classList.add('airport-marker-'+sizeClass);label.classList.add('airport-label-'+sizeClass);}});}
function updateAltitudeLegend(minAlt,maxAlt){var minFt=Math.round(minAlt);var maxFt=Math.round(maxAlt);var minM=Math.round(minAlt*0.3048);var maxM=Math.round(maxAlt*0.3048);document.getElementById('legend-min').textContent=minFt.toLocaleString()+' ft ('+minM.toLocaleString()+' m)';document.getElementById('legend-max').textContent=maxFt.toLocaleString()+' ft ('+maxM.toLocaleString()+' m)';}
function redrawAirspeedPaths(){if(!currentData)return;airspeedLayer.clearLayers();var colorMinSpeed,colorMaxSpeed;if(selectedPathIds.size>0){var selectedSegments=currentData.path_segments.filter(function(segment){return selectedPathIds.has(segment.path_id)&&segment.groundspeed_knots>0;});if(selectedSegments.length>0){var groundspeeds=selectedSegments.map(function(s){return s.groundspeed_knots;});colorMinSpeed=Math.min(...groundspeeds);colorMaxSpeed=Math.max(...groundspeeds);}else{colorMinSpeed=airspeedRange.min;colorMaxSpeed=airspeedRange.max;}}else{colorMinSpeed=airspeedRange.min;colorMaxSpeed=airspeedRange.max;}
currentData.path_segments.forEach(function(segment){var pathId=segment.path_id;if(selectedYear!=='all'){var pathInfo=currentData.path_info.find(function(p){return p.id===pathId;});if(pathInfo&&pathInfo.year&&pathInfo.year.toString()!==selectedYear){return;}}
if(segment.groundspeed_knots>0){var isSelected=selectedPathIds.has(pathId);var color=getColorForAltitude(segment.groundspeed_knots,colorMinSpeed,colorMaxSpeed);var polyline=L.polyline(segment.coords,{color:color,weight:isSelected?6:4,opacity:isSelected?1.0:(selectedPathIds.size>0?0.1:0.85),renderer:airspeedRenderer,interactive:true}).addTo(airspeedLayer);polyline.on('click',function(e){L.DomEvent.stopPropagation(e);togglePathSelection(pathId);});}});updateAirspeedLegend(colorMinSpeed,colorMaxSpeed);}
function updateAirspeedLegend(minSpeed,maxSpeed){var minKnots=Math.round(minSpeed);var maxKnots=Math.round(maxSpeed);var minKmh=Math.round(minSpeed*1.852);var maxKmh=Math.round(maxSpeed*1.852);document.getElementById('airspeed-legend-min').textContent=minKnots.toLocaleString()+' kt ('+minKmh.toLocaleString()+' km/h)';document.getElementById('airspeed-legend-max').textContent=maxKnots.toLocaleString()+' kt ('+maxKmh.toLocaleString()+' km/h)';}
function updateStatsForSelection(){if(selectedPathIds.size===0){if(fullStats){updateStatsPanel(fullStats,false);}
return;}
var selectedSegments=currentData.path_segments.filter(function(segment){return selectedPathIds.has(segment.path_id);});if(selectedSegments.length===0)return;var selectedPathInfos=currentData.path_info.filter(function(pathInfo){return selectedPathIds.has(pathInfo.id);});var selectedAirports=new Set();selectedPathInfos.forEach(function(pathInfo){if(pathInfo.start_airport)selectedAirports.add(pathInfo.start_airport);if(pathInfo.end_airport)selectedAirports.add(pathInfo.end_airport);});var totalDistanceKm=0;selectedSegments.forEach(function(segment){var coords=segment.coords;if(coords&&coords.length===2){var lat1=coords[0][0]*Math.PI/180;var lon1=coords[0][1]*Math.PI/180;var lat2=coords[1][0]*Math.PI/180;var lon2=coords[1][1]*Math.PI/180;var dlat=lat2-lat1;var dlon=lon2-lon1;var a=Math.sin(dlat/2)*Math.sin(dlat/2)+
Math.cos(lat1)*Math.cos(lat2)*Math.sin(dlon/2)*Math.sin(dlon/2);var c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));totalDistanceKm+=6371*c;}});var altitudes=selectedSegments.map(function(s){return s.altitude_m;});var minAltitudeM=Math.min(...altitudes);var maxAltitudeM=Math.max(...altitudes);var totalAltitudeGainM=0;var prevAltitudeM=null;selectedSegments.forEach(function(segment){if(prevAltitudeM!==null){var gain=segment.altitude_m-prevAltitudeM;if(gain>0){totalAltitudeGainM+=gain;}}
prevAltitudeM=segment.altitude_m;});var groundspeeds=selectedSegments.map(function(s){return s.groundspeed_knots;}).filter(function(s){return s>0;});var maxGroundspeedKnots=groundspeeds.length>0?Math.max(...groundspeeds):0;var avgGroundspeedKnots=0;if(groundspeeds.length>0){var sumSpeed=groundspeeds.reduce(function(a,b){return a+b;},0);avgGroundspeedKnots=sumSpeed/groundspeeds.length;}
var selectedStats={total_points:selectedSegments.length*2,num_paths:selectedPathIds.size,num_airports:selectedAirports.size,airport_names:Array.from(selectedAirports).sort(),total_distance_nm:totalDistanceKm*0.539957,max_altitude_ft:maxAltitudeM*3.28084,min_altitude_ft:minAltitudeM*3.28084,total_altitude_gain_ft:totalAltitudeGainM*3.28084,average_groundspeed_knots:avgGroundspeedKnots,max_groundspeed_knots:maxGroundspeedKnots};updateStatsPanel(selectedStats,true);}
function updateStatsPanel(stats,isSelection){let html='';if(isSelection){html+='<p style="margin:0 0 10px 0; font-weight:bold; font-size:15px;">üìä Selected Paths Statistics</p>';html+='<div style="background-color: #3a5a7a; padding: 4px 8px; margin-bottom: 8px; border-radius: 3px; font-size: 11px; color: #a0c0e0;">Showing stats for '+stats.num_paths+' selected path(s)</div>';}else{html+='<p style="margin:0 0 10px 0; font-weight:bold; font-size:15px;">üìä Flight Statistics</p>';}
html+='<div style="margin-bottom: 8px;"><strong>Data Points:</strong> '+stats.total_points.toLocaleString()+'</div>';html+='<div style="margin-bottom: 8px;"><strong>Flights:</strong> '+stats.num_paths+'</div>';html+='<div style="margin-bottom: 8px;"><strong>Airports Visited:</strong> '+stats.num_airports+'</div>';if(stats.airport_names&&stats.airport_names.length>0){html+='<div style="margin-bottom: 8px; max-height: 150px; overflow-y: auto;"><strong>Airports:</strong><br>';stats.airport_names.forEach(function(name){html+='<span style="margin-left: 10px;">‚Ä¢ '+name+'</span><br>';});html+='</div>';}
if(stats.total_flight_time_str){html+='<div style="margin-bottom: 8px;"><strong>Total Flight Time:</strong> '+stats.total_flight_time_str+'</div>';}
var distanceKm=(stats.total_distance_nm*1.852).toFixed(1);html+='<div style="margin-bottom: 8px;"><strong>Distance:</strong> '+stats.total_distance_nm.toFixed(1)+' nm ('+distanceKm+' km)</div>';if(stats.num_paths>0){var avgDistanceNm=(stats.total_distance_nm/stats.num_paths).toFixed(1);var avgDistanceKm=(avgDistanceNm*1.852).toFixed(1);html+='<div style="margin-bottom: 8px;"><strong>Average Distance per Trip:</strong> '+avgDistanceNm+' nm ('+avgDistanceKm+' km)</div>';}
if(stats.average_groundspeed_knots&&stats.average_groundspeed_knots>0){var kmh=(stats.average_groundspeed_knots*1.852).toFixed(1);html+='<div style="margin-bottom: 8px;"><strong>Average Groundspeed:</strong> '+stats.average_groundspeed_knots.toFixed(1)+' kt ('+kmh+' km/h)</div>';}
if(stats.cruise_speed_knots&&stats.cruise_speed_knots>0){var kmh_cruise=(stats.cruise_speed_knots*1.852).toFixed(1);html+='<div style="margin-bottom: 8px;"><strong>Cruise Speed (>1000ft AGL):</strong> '+stats.cruise_speed_knots.toFixed(1)+' kt ('+kmh_cruise+' km/h)</div>';}
if(stats.max_groundspeed_knots&&stats.max_groundspeed_knots>0){var kmh_max=(stats.max_groundspeed_knots*1.852).toFixed(1);html+='<div style="margin-bottom: 8px;"><strong>Max Groundspeed:</strong> '+stats.max_groundspeed_knots.toFixed(1)+' kt ('+kmh_max+' km/h)</div>';}
if(stats.max_altitude_ft){var maxAltitudeM=Math.round(stats.max_altitude_ft*0.3048);html+='<div style="margin-bottom: 8px;"><strong>Max Altitude:</strong> '+Math.round(stats.max_altitude_ft)+' ft ('+maxAltitudeM+' m)</div>';if(!isSelection&&stats.total_altitude_gain_ft){var elevationGainM=Math.round(stats.total_altitude_gain_ft*0.3048);html+='<div style="margin-bottom: 8px;"><strong>Elevation Gain:</strong> '+Math.round(stats.total_altitude_gain_ft)+' ft ('+elevationGainM+' m)</div>';}}
document.getElementById('stats-panel').innerHTML=html;}
function toggleStats(){const panel=document.getElementById('stats-panel');panel.style.display=panel.style.display==='none'?'block':'none';}
function toggleHeatmap(){if(heatmapVisible){if(heatmapLayer){map.removeLayer(heatmapLayer);}
heatmapVisible=false;document.getElementById('heatmap-btn').style.opacity='0.5';}else{if(heatmapLayer){map.addLayer(heatmapLayer);if(heatmapLayer._canvas){heatmapLayer._canvas.style.pointerEvents='none';}}
heatmapVisible=true;document.getElementById('heatmap-btn').style.opacity='1.0';}}
function toggleAltitude(){if(altitudeVisible){map.removeLayer(altitudeLayer);altitudeVisible=false;document.getElementById('altitude-btn').style.opacity='0.5';document.getElementById('altitude-legend').style.display='none';}else{if(airspeedVisible){map.removeLayer(airspeedLayer);airspeedVisible=false;document.getElementById('airspeed-btn').style.opacity='0.5';document.getElementById('airspeed-legend').style.display='none';}
map.addLayer(altitudeLayer);altitudeVisible=true;document.getElementById('altitude-btn').style.opacity='1.0';document.getElementById('altitude-legend').style.display='block';}}
function toggleAirspeed(){if(airspeedVisible){map.removeLayer(airspeedLayer);airspeedVisible=false;document.getElementById('airspeed-btn').style.opacity='0.5';document.getElementById('airspeed-legend').style.display='none';}else{if(altitudeVisible){map.removeLayer(altitudeLayer);altitudeVisible=false;document.getElementById('altitude-btn').style.opacity='0.5';document.getElementById('altitude-legend').style.display='none';}
map.addLayer(airspeedLayer);airspeedVisible=true;document.getElementById('airspeed-btn').style.opacity='1.0';document.getElementById('airspeed-legend').style.display='block';redrawAirspeedPaths();}}
function toggleAirports(){if(airportsVisible){map.removeLayer(airportLayer);airportsVisible=false;document.getElementById('airports-btn').style.opacity='0.5';}else{map.addLayer(airportLayer);airportsVisible=true;document.getElementById('airports-btn').style.opacity='1.0';}}
function toggleAviation(){if(OPENAIP_API_KEY&&openaipLayers['Aviation Data']){if(aviationVisible){map.removeLayer(openaipLayers['Aviation Data']);aviationVisible=false;document.getElementById('aviation-btn').style.opacity='0.5';}else{map.addLayer(openaipLayers['Aviation Data']);aviationVisible=true;document.getElementById('aviation-btn').style.opacity='1.0';}}}
function exportMap(){const btn=document.getElementById('export-btn');btn.disabled=true;btn.textContent='‚è≥ Exporting...';const mapContainer=document.getElementById('map');const controls=[document.querySelector('.leaflet-control-zoom'),document.getElementById('stats-btn'),document.getElementById('export-btn'),document.getElementById('wrapped-btn'),document.getElementById('year-filter'),document.getElementById('heatmap-btn'),document.getElementById('altitude-btn'),document.getElementById('airspeed-btn'),document.getElementById('airports-btn'),document.getElementById('aviation-btn'),document.getElementById('stats-panel'),document.getElementById('altitude-legend'),document.getElementById('airspeed-legend'),document.getElementById('loading')];const displayStates=controls.map(el=>el?el.style.display:null);controls.forEach(el=>{if(el)el.style.display='none';});setTimeout(function(){domtoimage.toJpeg(mapContainer,{width:mapContainer.offsetWidth*2,height:mapContainer.offsetHeight*2,bgcolor:'#1a1a1a',quality:0.95,style:{transform:'scale(2)',transformOrigin:'top left'}}).then(function(dataUrl){controls.forEach((el,i)=>{if(el)el.style.display=displayStates[i]||'';});btn.disabled=false;btn.textContent='üì∑ Export';const link=document.createElement('a');link.download='heatmap_'+new Date().toISOString().slice(0,19).replace(/[:.]/g,'-')+'.jpg';link.href=dataUrl;link.click();}).catch(function(error){controls.forEach((el,i)=>{if(el)el.style.display=displayStates[i]||'';});alert('Export failed: '+error.message);btn.disabled=false;btn.textContent='üì∑ Export';});},200);}
function generateFunFacts(yearStats){const allFacts=[];const earthCircumferenceKm=40075;const moonDistanceKm=384400;const issAltitudeKm=408;const everestHeightFt=29032;const everestHeightM=8849;const commercialCruiseAltFt=35000;const totalDistanceKm=yearStats.total_distance_nm*1.852;const timesAroundEarth=totalDistanceKm/earthCircumferenceKm;const percentToMoon=(totalDistanceKm/moonDistanceKm)*100;if(timesAroundEarth>=0.5){allFacts.push({category:'distance',icon:'üåç',text:`You flew <strong>${timesAroundEarth.toFixed(1)}x</strong> around the Earth`,priority:timesAroundEarth>=1?10:7});}
if(percentToMoon>=0.1){allFacts.push({category:'distance',icon:'üåô',text:`That's <strong>${percentToMoon.toFixed(1)}%</strong> of the flight distance to the Moon`,priority:percentToMoon>=1?9:5});}
if(totalDistanceKm>=issAltitudeKm){const timesToISS=(totalDistanceKm/issAltitudeKm).toFixed(1);allFacts.push({category:'distance',icon:'üõ∞Ô∏è',text:`You could have reached the ISS <strong>${timesToISS}x</strong> times`,priority:6});}
if(yearStats.total_flights>0){const avgFlight=(yearStats.total_distance_nm/yearStats.total_flights).toFixed(0);allFacts.push({category:'distance',icon:'üìè',text:`Average flight: <strong>${avgFlight} nm</strong>`,priority:4});}
if(fullStats&&fullStats.total_altitude_gain_ft){const gainFt=Math.round(fullStats.total_altitude_gain_ft);const timesEverest=gainFt/everestHeightFt;if(timesEverest>=1){allFacts.push({category:'altitude',icon:'‚¨ÜÔ∏è',text:`You climbed <strong>${gainFt.toLocaleString()} ft</strong> - that's scaling Everest <strong>${timesEverest.toFixed(1)}x</strong>!`,priority:9});}else if(gainFt>10000){allFacts.push({category:'altitude',icon:'‚¨ÜÔ∏è',text:`Total elevation gain: <strong>${gainFt.toLocaleString()} ft</strong>`,priority:5});}}
if(fullStats&&fullStats.total_flight_time_seconds){const totalHours=fullStats.total_flight_time_seconds/3600;const totalDays=totalHours/24;const hoursPerYear=8760;const percentOfYear=(totalHours/hoursPerYear*100).toFixed(2);if(totalDays>=1){allFacts.push({category:'time',icon:'‚è±Ô∏è',text:`You spent <strong>${totalDays.toFixed(1)} days</strong> in the air - that's <strong>${percentOfYear}%</strong> of the year!`,priority:8});}else if(totalHours>=10){allFacts.push({category:'time',icon:'‚è∞',text:`Total airtime: <strong>${totalHours.toFixed(1)} hours</strong>`,priority:5});}}
if(fullStats&&fullStats.cruise_speed_knots&&fullStats.cruise_speed_knots>0&&yearStats.total_flights>0){const cruiseSpeedKt=Math.round(fullStats.cruise_speed_knots);const avgDistanceNm=Math.round(yearStats.total_distance_nm/yearStats.total_flights);allFacts.push({category:'speed',icon:'‚úàÔ∏è',text:`Cruising at <strong>${cruiseSpeedKt} kt</strong>, averaging <strong>${avgDistanceNm} nm</strong> per adventure`,priority:8});}
if(fullStats&&fullStats.max_altitude_ft>40000){allFacts.push({category:'achievement',icon:'üöÄ',text:`You're practically an astronaut at <strong>${Math.round(fullStats.max_altitude_ft).toLocaleString()} ft</strong>!`,priority:10});}
allFacts.sort((a,b)=>b.priority-a.priority);const selectedFacts=[];const usedCategories=new Set();const maxFactsPerCategory=2;const categoryCount={};for(const fact of allFacts){const catCount=categoryCount[fact.category]||0;if(catCount<maxFactsPerCategory){selectedFacts.push(fact);categoryCount[fact.category]=catCount+1;usedCategories.add(fact.category);if(selectedFacts.length>=6)break;}}
if(selectedFacts.length<4){for(const fact of allFacts){if(!selectedFacts.includes(fact)){selectedFacts.push(fact);if(selectedFacts.length>=4)break;}}}
return selectedFacts;}
let originalMapParent=null;let originalMapIndex=0;function showWrapped(){const year=selectedYear!=='all'?selectedYear:(fullStats.available_years?fullStats.available_years[fullStats.available_years.length-1]:new Date().getFullYear());const yearStats=calculateYearStats(year);document.getElementById('wrapped-year').textContent=year;const statsHtml=`
                <div class="stat-card">
                    <div class="stat-value">${yearStats.total_flights}</div>
                    <div class="stat-label">Flights</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${yearStats.num_airports}</div>
                    <div class="stat-label">Airports</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${yearStats.total_distance_nm.toFixed(0)}</div>
                    <div class="stat-label">Nautical Miles</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${yearStats.flight_time}</div>
                    <div class="stat-label">Flight Time</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${(fullStats.max_groundspeed_knots || 0).toFixed(0)} kt</div>
                    <div class="stat-label">Max Groundspeed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${Math.round(fullStats.max_altitude_ft || 0).toLocaleString()} ft</div>
                    <div class="stat-label">Max Altitude</div>
                </div>
            `;document.getElementById('wrapped-stats').innerHTML=statsHtml;const funFacts=generateFunFacts(yearStats);let funFactsHtml='<div class="fun-facts-title">‚ú® Fun Facts</div>';funFacts.forEach(function(fact){funFactsHtml+=`<div class="fun-fact" data-category="${fact.category}">${fact.icon} ${fact.text}</div>`;});document.getElementById('wrapped-fun-facts').innerHTML=funFactsHtml;if(fullStats&&fullStats.airport_names&&fullStats.airport_names.length>0){loadAirports().then(function(airports){const sortedAirports=airports.sort((a,b)=>b.flight_count-a.flight_count);const homeBase=sortedAirports[0];let homeBaseHtml='<div class="top-airports-title">üè† Home Base</div>';homeBaseHtml+=`
                        <div class="top-airport">
                            <div class="top-airport-name">${homeBase.name}</div>
                            <div class="top-airport-count">${homeBase.flight_count} flights</div>
                        </div>
                    `;document.getElementById('wrapped-top-airports').innerHTML=homeBaseHtml;const destinations=fullStats.airport_names.filter(name=>name!==homeBase.name);let airportBadgesHtml='<div class="airports-grid-title">üó∫Ô∏è All Destinations</div><div class="airport-badges">';destinations.forEach(function(airportName){airportBadgesHtml+=`<div class="airport-badge">${airportName}</div>`;});airportBadgesHtml+='</div>';document.getElementById('wrapped-airports-grid').innerHTML=airportBadgesHtml;});}
const mapContainer=document.getElementById('map');const wrappedMapContainer=document.getElementById('wrapped-map-container');if(!originalMapParent){originalMapParent=mapContainer.parentNode;originalMapIndex=Array.from(originalMapParent.children).indexOf(mapContainer);}
map.fitBounds(BOUNDS,{padding:[80,80]});const controls=[document.querySelector('.leaflet-control-zoom'),document.getElementById('stats-btn'),document.getElementById('export-btn'),document.getElementById('wrapped-btn'),document.getElementById('heatmap-btn'),document.getElementById('airports-btn'),document.getElementById('altitude-btn'),document.getElementById('airspeed-btn'),document.getElementById('aviation-btn'),document.getElementById('year-filter'),document.getElementById('stats-panel'),document.getElementById('altitude-legend'),document.getElementById('airspeed-legend'),document.getElementById('loading')];controls.forEach(el=>{if(el)el.style.display='none';});document.getElementById('wrapped-modal').style.display='flex';setTimeout(function(){wrappedMapContainer.appendChild(mapContainer);mapContainer.style.width='100%';mapContainer.style.height='100%';mapContainer.style.borderRadius='12px';mapContainer.style.overflow='hidden';wrappedMapContainer.offsetHeight;setTimeout(function(){map.invalidateSize();map.fitBounds(BOUNDS,{padding:[80,80]});},100);},50);}
function closeWrapped(event){if(!event||event.target.id==='wrapped-modal'){const mapContainer=document.getElementById('map');if(originalMapParent){const children=Array.from(originalMapParent.children);if(originalMapIndex>=children.length){originalMapParent.appendChild(mapContainer);}else{originalMapParent.insertBefore(mapContainer,children[originalMapIndex]);}
mapContainer.style.width='';mapContainer.style.height='';mapContainer.style.borderRadius='';mapContainer.style.overflow='';const controls=[document.querySelector('.leaflet-control-zoom'),document.getElementById('stats-btn'),document.getElementById('export-btn'),document.getElementById('wrapped-btn'),document.getElementById('heatmap-btn'),document.getElementById('airports-btn'),document.getElementById('altitude-btn'),document.getElementById('airspeed-btn'),document.getElementById('aviation-btn'),document.getElementById('year-filter'),document.getElementById('stats-panel'),document.getElementById('altitude-legend'),document.getElementById('airspeed-legend'),document.getElementById('loading')];controls.forEach(el=>{if(el)el.style.display='';});setTimeout(function(){map.invalidateSize();},100);}
document.getElementById('wrapped-modal').style.display='none';}}
function calculateYearStats(year){if(!fullStats){return{total_flights:0,total_distance_nm:0,num_airports:0,flight_time:'0h 0m'};}
if(fullStats.available_years&&fullStats.available_years.length>0){const yearStr=year.toString();if(fullStats.available_years.length===1&&fullStats.available_years[0].toString()===yearStr){return{total_flights:fullStats.num_paths,total_distance_nm:fullStats.total_distance_nm,num_airports:fullStats.num_airports,flight_time:fullStats.total_flight_time_str||'---'};}}
return{total_flights:fullStats.num_paths,total_distance_nm:fullStats.total_distance_nm,num_airports:fullStats.num_airports,flight_time:fullStats.total_flight_time_str||'---'};}</script>