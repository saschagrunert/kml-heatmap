<!doctype html><meta charset=utf-8><meta content="width=device-width,initial-scale=1.0" name=viewport><title>KML Heatmap</title><link href=https://unpkg.com/leaflet@1.9.4/dist/leaflet.css rel=stylesheet><link href=https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.css rel=stylesheet><link href=https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css rel=stylesheet><link href=https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css rel=stylesheet><style>*{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI','Roboto','Helvetica Neue',Arial,sans-serif}body{margin:0;padding:0}#map{position:absolute;top:0;bottom:0;right:0;left:0}.control-btn{position:fixed;background-color:#2b2b2b;color:#ffffff;border:2px solid #555;border-radius:4px;padding:6px 12px;cursor:pointer;z-index:10000;font-size:14px;font-weight:bold;box-shadow:0 1px 5px rgba(0,0,0,0.4);touch-action:manipulation}.control-btn:hover{background-color:#3b3b3b}.control-btn.left{left:50px}#stats-btn{top:10px}#export-btn{top:50px}#wrapped-btn{top:90px}.control-btn.right{right:10px;min-width:120px;text-align:center}#year-filter{top:10px}#heatmap-btn{top:50px}#airports-btn{top:90px}#altitude-btn{top:130px}#aviation-btn{top:170px}#year-filter{background-color:#2b2b2b;color:#ffffff;border:2px solid #555;border-radius:4px;padding:6px 12px;cursor:pointer;font-size:14px;font-weight:bold;box-shadow:0 1px 5px rgba(0,0,0,0.4);touch-action:manipulation;width:120px;box-sizing:border-box;text-align:center}#year-filter select{background:transparent;color:#ffffff;border:0!important;border-style:none!important;border-width:0!important;border-color:transparent!important;border-image:none!important;cursor:pointer;font-size:14px;font-weight:bold;width:calc(100% + 24px);margin:-6px -12px;padding:6px 12px;outline:none!important;box-shadow:none!important;text-align:center;text-align-last:center;-webkit-appearance:none;-moz-appearance:none;appearance:none}#year-filter select:focus{outline:none!important;border:0!important;border-style:none!important;box-shadow:none!important}#year-filter select:active{border:0!important;border-style:none!important}#year-filter select option{background-color:#2b2b2b;color:#ffffff;text-align:center}#year-filter:hover{background-color:#3b3b3b}#altitude-legend{position:fixed;bottom:30px;left:10px;background-color:rgba(43,43,43,0.9);color:#ffffff;border:2px solid #555;border-radius:4px;padding:10px;z-index:1000;font-size:12px;min-width:200px;display:none}#altitude-legend .legend-title{font-weight:bold;margin-bottom:8px;font-size:13px}#altitude-legend .gradient-bar{height:20px;background:linear-gradient(to right,rgb(80,160,255) 0%,rgb(0,255,255) 20%,rgb(0,255,0) 40%,rgb(255,255,0) 60%,rgb(255,165,0) 80%,rgb(255,66,66) 100%);border-radius:3px;margin-bottom:5px}#altitude-legend .labels{display:flex;justify-content:space-between;font-size:11px}#stats-panel{position:fixed;top:10px;left:135px;width:280px;background-color:#2b2b2b;border:2px solid #555;z-index:10001;font-size:13px;padding:12px;display:none;color:#ffffff;box-shadow:0 2px 6px rgba(0,0,0,0.3);max-height:80vh;overflow-y:auto}#loading{position:fixed;bottom:10px;right:10px;background-color:#2b2b2b;color:#ffffff;border:2px solid #555;border-radius:4px;padding:6px 12px;z-index:10000;font-size:12px;display:none}#wrapped-modal{position:fixed;top:0;left:0;width:100%;height:100%;background:linear-gradient(135deg,rgba(10,10,20,0.97) 0%,rgba(15,20,35,0.97) 100%);z-index:20000;display:none;justify-content:center;align-items:center;padding:40px;box-sizing:border-box}#wrapped-container{display:flex;gap:30px;width:100%;height:100%}#wrapped-map-container{flex:1;background-color:#1a1a1a;border-radius:20px;overflow:hidden;box-shadow:0 10px 40px rgba(0,0,0,0.5);position:relative}#wrapped-map-snapshot{width:100%;height:100%;object-fit:cover}#wrapped-card{background:linear-gradient(135deg,#1a1a2e 0%,#16213e 50%,#0f3460 100%);border-radius:20px;padding:40px;width:500px;flex-shrink:0;overflow:hidden;box-shadow:0 10px 40px rgba(0,0,0,0.5);color:#ffffff;position:relative;display:flex;flex-direction:column}#wrapped-card h1{font-size:48px;margin:0 0 10px 0;background:linear-gradient(135deg,#f093fb 0%,#f5576c 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;text-fill-color:transparent}#wrapped-card .year{font-size:72px;font-weight:bold;text-align:center;margin:20px 0;background:linear-gradient(135deg,#4facfe 0%,#00f2fe 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;text-fill-color:transparent}#wrapped-card .stat-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:20px;margin:30px 0}#wrapped-card .stat-card{background-color:rgba(255,255,255,0.1);border-radius:12px;padding:20px;text-align:center}#wrapped-card .stat-value{font-size:36px;font-weight:bold;color:#4facfe;margin-bottom:5px}#wrapped-card .stat-label{font-size:14px;opacity:0.8;text-transform:uppercase;letter-spacing:1px}#wrapped-card .close-btn{position:absolute;top:20px;right:20px;background:transparent;border:none;color:#ffffff;font-size:32px;cursor:pointer;padding:0;width:40px;height:40px;line-height:40px;text-align:center;border-radius:50%;transition:background-color 0.2s}#wrapped-card .close-btn:hover{background-color:rgba(255,255,255,0.1)}#wrapped-card .fun-facts{margin:25px 0;padding:20px;background:linear-gradient(135deg,rgba(79,172,254,0.15) 0%,rgba(0,242,254,0.15) 100%);border-radius:12px;border:1px solid rgba(79,172,254,0.3)}#wrapped-card .fun-facts-title{font-size:16px;font-weight:bold;margin-bottom:12px;color:#4facfe;text-transform:uppercase;letter-spacing:1px}#wrapped-card .fun-fact{font-size:14px;margin:8px 0;opacity:0.9;line-height:1.6}#wrapped-card .fun-fact strong{color:#00f2fe}#wrapped-card .top-airports{margin:25px 0}#wrapped-card .top-airports-title{font-size:16px;font-weight:bold;margin-bottom:12px;color:#f5576c;text-transform:uppercase;letter-spacing:1px}#wrapped-card .top-airport{display:flex;justify-content:space-between;align-items:center;padding:10px 15px;margin:8px 0;background-color:rgba(245,87,108,0.15);border-radius:8px;border-left:3px solid #f5576c}#wrapped-card .top-airport-name{font-size:14px;font-weight:500}#wrapped-card .top-airport-count{font-size:14px;font-weight:bold;color:#f5576c}#wrapped-card .airports-grid{margin:25px 0}#wrapped-card .airports-grid-title{font-size:16px;font-weight:bold;margin-bottom:12px;color:#f093fb;text-transform:uppercase;letter-spacing:1px}#wrapped-card .airport-badges{display:flex;flex-wrap:wrap;gap:8px}#wrapped-card .airport-badge{background:linear-gradient(135deg,rgba(240,147,251,0.2) 0%,rgba(245,87,108,0.2) 100%);border:1px solid rgba(240,147,251,0.4);padding:6px 12px;border-radius:20px;font-size:12px;font-weight:500;color:#ffffff;white-space:nowrap}#wrapped-card-content{flex:1;overflow-y:auto;overflow-x:hidden;margin:0 -40px;padding:0 40px}#wrapped-card-content::-webkit-scrollbar{width:8px}#wrapped-card-content::-webkit-scrollbar-track{background:rgba(255,255,255,0.05);border-radius:4px}#wrapped-card-content::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.2);border-radius:4px}#wrapped-card-content::-webkit-scrollbar-thumb:hover{background:rgba(255,255,255,0.3)}#wrapped-card .export-wrapped-btn{background:linear-gradient(135deg,#f093fb 0%,#f5576c 100%);border:none;color:#ffffff;padding:15px 30px;border-radius:25px;font-size:16px;font-weight:bold;cursor:pointer;margin-top:30px;width:100%;box-shadow:0 5px 15px rgba(245,87,108,0.3);transition:transform 0.2s,box-shadow 0.2s;flex-shrink:0}#wrapped-card .export-wrapped-btn:hover{transform:translateY(-2px);box-shadow:0 7px 20px rgba(245,87,108,0.4)}.leaflet-control-attribution{display:none!important}.leaflet-control-layers{background-color:#2b2b2b!important;color:#ffffff!important;border:1px solid #555!important}.leaflet-control-layers-toggle{background-color:#2b2b2b!important;border:1px solid #555!important}.leaflet-control-layers label{color:#ffffff!important}.leaflet-control-zoom{border:2px solid #555!important}.leaflet-control-zoom a{background-color:#2b2b2b!important;color:#ffffff!important}.leaflet-control-zoom a:hover{background-color:#3b3b3b!important}.airport-cluster-marker{background:transparent;border:none}.airport-marker{width:12px;height:12px;background-color:#28a745;border:2px solid #ffffff;border-radius:50%;box-shadow:0 2px 6px rgba(0,0,0,0.4);cursor:pointer;transition:all 0.2s ease;flex-shrink:0}.airport-label{background-color:rgba(43,43,43,0.9);border:1px solid #28a745;color:#ffffff;font-family:monospace;font-weight:bold;font-size:11px;padding:2px 6px;border-radius:3px;white-space:nowrap;pointer-events:none;box-shadow:0 1px 3px rgba(0,0,0,0.4);margin-left:6px}.airport-marker-container{display:flex;align-items:center;width:auto;height:16px}.airport-marker-container:hover .airport-marker{transform:scale(1.3);box-shadow:0 3px 8px rgba(0,0,0,0.6)}.airport-cluster-dot{width:20px;height:20px;background-color:#28a745;border:3px solid #ffffff;border-radius:50%;box-shadow:0 3px 8px rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;color:#ffffff;font-weight:bold;font-size:11px;cursor:pointer;transition:all 0.2s ease}.airport-cluster-dot:hover{transform:scale(1.2);box-shadow:0 4px 10px rgba(0,0,0,0.7)}.leaflet-tooltip{background-color:#2b2b2b;border:2px solid #28a745;color:#ffffff;font-family:monospace;font-weight:bold;font-size:12px;padding:4px 8px;border-radius:4px;box-shadow:0 2px 6px rgba(0,0,0,0.4)}.leaflet-tooltip-top:before{border-top-color:#28a745}.leaflet-tooltip-bottom:before{border-bottom-color:#28a745}.leaflet-tooltip-left:before{border-left-color:#28a745}.leaflet-tooltip-right:before{border-right-color:#28a745}</style><body><div id=map></div><button class="control-btn left" id=stats-btn onclick=toggleStats()>üìä Stats</button><button class="control-btn left" id=export-btn onclick=exportMap()>üì∑ Export</button><button class="control-btn left" id=wrapped-btn onclick=showWrapped()>‚ú® Wrapped</button><button class="control-btn right" id=heatmap-btn onclick=toggleHeatmap()>üî• Heatmap</button><button class="control-btn right" id=airports-btn onclick=toggleAirports()>‚úàÔ∏è Airports</button><button class="control-btn right" id=altitude-btn onclick=toggleAltitude()>‚õ∞Ô∏è Altitude</button><button class="control-btn right" style="display: none;" id=aviation-btn onclick=toggleAviation()>üó∫Ô∏è Aviation</button><div class="control-btn right" id=year-filter><select id=year-select onchange=filterByYear()><option value=all>üìÖ Years</select></div><div id=stats-panel></div><div id=altitude-legend><div class=legend-title>‚õ∞Ô∏è Altitude</div><div class=gradient-bar></div><div class=labels><span id=legend-min>0 ft</span><span id=legend-max>10,000 ft</span></div></div><div id=loading>Loading data...</div><div id=wrapped-modal onclick=closeWrapped(event)><div id=wrapped-container onclick=event.stopPropagation()><div id=wrapped-card><button class=close-btn onclick=closeWrapped()>√ó</button><h1>‚ú® Your Year in Flight</h1><div class=year id=wrapped-year>2025</div><div id=wrapped-card-content><div class=stat-grid id=wrapped-stats></div><div class=fun-facts id=wrapped-fun-facts></div><div class=top-airports id=wrapped-top-airports></div><div class=airports-grid id=wrapped-airports-grid></div></div><button class=export-wrapped-btn onclick=exportWrappedCard()>üì∑ Export Wrapped Card</button></div><div id=wrapped-map-container><img alt="Flight map" id=wrapped-map-snapshot></div></div></div><script src=https://unpkg.com/leaflet@1.9.4/dist/leaflet.js></script><script src=https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js></script><script src=https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js></script><script src=https://cdn.jsdelivr.net/npm/dom-to-image@2.6.0/dist/dom-to-image.min.js></script><script>const CENTER=[51.227789,13.3316945];const BOUNDS=[[48.101383,9.362755],[54.354195,17.300634]];const STADIA_API_KEY='ac4dd698-4222-457a-9fdd-763b5f9506b2';const OPENAIP_API_KEY='8c48c5bab93ab7426e33c63e0f2da961';const DATA_DIR='data';function ddToDms(dd,isLat){const direction=dd>=0?(isLat?'N':'E'):(isLat?'S':'W');dd=Math.abs(dd);const degrees=Math.floor(dd);const minutes=Math.floor((dd-degrees)*60);const seconds=((dd-degrees)*60-minutes)*60;return degrees+"¬∞"+minutes+"'"+seconds.toFixed(1)+'"'+direction;}
var map=L.map('map',{center:CENTER,zoom:10,zoomSnap:0.25,zoomDelta:0.25,wheelPxPerZoomLevel:120,preferCanvas:true});if(STADIA_API_KEY){L.tileLayer('https://tiles.stadiamaps.com/tiles/alidade_smooth_dark/{z}/{x}/{y}{r}.png?api_key='+STADIA_API_KEY,{attribution:'&copy; <a href="https://stadiamaps.com/">Stadia Maps</a>'}).addTo(map);}else{L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',{attribution:'&copy; OpenStreetMap contributors, &copy; CARTO'}).addTo(map);}
map.fitBounds(BOUNDS,{padding:[30,30]});var canvasRenderer=L.canvas({padding:0.5});var heatmapLayer=null;var altitudeLayer=L.layerGroup();var airportLayer=L.markerClusterGroup({showCoverageOnHover:false,zoomToBoundsOnClick:true,spiderfyOnMaxZoom:true,disableClusteringAtZoom:12,maxClusterRadius:25,iconCreateFunction:function(cluster){var markers=cluster.getAllChildMarkers();var icaoCodes=markers.map(function(marker){return marker.options.icao||'APT';}).filter(function(value,index,self){return self.indexOf(value)===index;});var count=markers.length;var html='<div class="airport-cluster-dot">'+count+'</div>';return L.divIcon({html:html,iconSize:[20,20],iconAnchor:[10,10],popupAnchor:[0,-10],className:'airport-cluster-marker'});}});var currentResolution=null;var loadedData={};var currentData=null;var fullStats=null;var altitudeRange={min:0,max:10000};var heatmapVisible=true;var altitudeVisible=false;var airportsVisible=true;var aviationVisible=false;var selectedPathIds=new Set();var pathSegments={};var pathToAirports={};var airportToPaths={};var airportMarkers={};var openaipLayers={};if(OPENAIP_API_KEY){openaipLayers['Aviation Data']=L.tileLayer('https://{s}.api.tiles.openaip.net/api/data/openaip/{z}/{x}/{y}.png?apiKey='+OPENAIP_API_KEY,{attribution:'&copy; <a href="https://www.openaip.net">OpenAIP</a>',maxZoom:18,minZoom:7,subdomains:['a','b','c']});}
airportLayer.on('clusterclick',function(cluster){var markers=cluster.layer.getAllChildMarkers();var icaoCodes=markers.map(function(marker){return marker.options.icao||'APT';}).filter(function(value,index,self){return self.indexOf(value)===index;}).sort();var popupContent='<div style="font-size: 12px;"><b>'+markers.length+' Airports</b><br>'+'<div style="max-height: 150px; overflow-y: auto; margin-top: 5px;">'+
icaoCodes.join(', ')+'</div></div>';cluster.layer.bindPopup(popupContent).openPopup();});airportLayer.addTo(map);document.getElementById('altitude-btn').style.opacity='0.5';document.getElementById('aviation-btn').style.opacity='0.5';if(OPENAIP_API_KEY){document.getElementById('aviation-btn').style.display='block';}
function getResolutionForZoom(zoom){if(zoom<=4)return'z0_4';if(zoom<=7)return'z5_7';if(zoom<=10)return'z8_10';if(zoom<=13)return'z11_13';return'z14_plus';}
function showLoading(){document.getElementById('loading').style.display='block';}
function hideLoading(){document.getElementById('loading').style.display='none';}
async function loadData(resolution){if(loadedData[resolution]){return loadedData[resolution];}
showLoading();try{const response=await fetch(DATA_DIR+'/data_'+resolution+'.json');const data=await response.json();loadedData[resolution]=data;console.log('Loaded '+resolution+' resolution:',data.downsampled_points+' points');return data;}catch(error){console.error('Error loading data:',error);return null;}finally{hideLoading();}}
async function loadAirports(){try{const response=await fetch(DATA_DIR+'/airports.json');const data=await response.json();return data.airports;}catch(error){console.error('Error loading airports:',error);return[];}}
async function loadMetadata(){try{const response=await fetch(DATA_DIR+'/metadata.json');return await response.json();}catch(error){console.error('Error loading metadata:',error);return null;}}
async function updateLayers(){const zoom=map.getZoom();const resolution=getResolutionForZoom(zoom);if(resolution===currentResolution){return;}
currentResolution=resolution;const data=await loadData(resolution);if(!data)return;currentData=data;if(heatmapLayer){map.removeLayer(heatmapLayer);}
heatmapLayer=L.heatLayer(data.coordinates,{radius:10,blur:15,minOpacity:0.25,maxOpacity:0.6,max:1.0,gradient:{0.0:'blue',0.3:'cyan',0.5:'lime',0.7:'yellow',1.0:'red'}});if(heatmapLayer._canvas){heatmapLayer._canvas.style.pointerEvents='none';}
if(heatmapVisible){heatmapLayer.addTo(map);}
pathToAirports={};airportToPaths={};if(data.path_info){data.path_info.forEach(function(pathInfo){var pathId=pathInfo.id;pathToAirports[pathId]={start:pathInfo.start_airport,end:pathInfo.end_airport};if(pathInfo.start_airport){if(!airportToPaths[pathInfo.start_airport]){airportToPaths[pathInfo.start_airport]=[];}
airportToPaths[pathInfo.start_airport].push(pathId);}
if(pathInfo.end_airport){if(!airportToPaths[pathInfo.end_airport]){airportToPaths[pathInfo.end_airport]=[];}
airportToPaths[pathInfo.end_airport].push(pathId);}});}
if(data.path_segments&&data.path_segments.length>0){var altitudes=data.path_segments.map(function(s){return s.altitude_ft;});altitudeRange.min=Math.min(...altitudes);altitudeRange.max=Math.max(...altitudes);}
redrawAltitudePaths();console.log('Updated to '+resolution+' resolution');}
function redrawAltitudePaths(){if(!currentData)return;altitudeLayer.clearLayers();pathSegments={};var colorMinAlt,colorMaxAlt;if(selectedPathIds.size>0){var selectedSegments=currentData.path_segments.filter(function(segment){return selectedPathIds.has(segment.path_id);});if(selectedSegments.length>0){var altitudes=selectedSegments.map(function(s){return s.altitude_ft;});colorMinAlt=Math.min(...altitudes);colorMaxAlt=Math.max(...altitudes);}else{colorMinAlt=altitudeRange.min;colorMaxAlt=altitudeRange.max;}}else{colorMinAlt=altitudeRange.min;colorMaxAlt=altitudeRange.max;}
currentData.path_segments.forEach(function(segment){var pathId=segment.path_id;if(selectedYear!=='all'){var pathInfo=currentData.path_info.find(function(p){return p.id===pathId;});if(pathInfo&&pathInfo.year&&pathInfo.year.toString()!==selectedYear){return;}}
var isSelected=selectedPathIds.has(pathId);var color=getColorForAltitude(segment.altitude_ft,colorMinAlt,colorMaxAlt);var polyline=L.polyline(segment.coords,{color:color,weight:isSelected?6:4,opacity:isSelected?1.0:(selectedPathIds.size>0?0.1:0.85),renderer:canvasRenderer}).bindPopup('Altitude: '+segment.altitude_ft+' ft ('+segment.altitude_m+' m)').addTo(altitudeLayer);polyline.on('click',function(e){L.DomEvent.stopPropagation(e);togglePathSelection(pathId);});if(!pathSegments[pathId]){pathSegments[pathId]=[];}
pathSegments[pathId].push(polyline);});updateAltitudeLegend(colorMinAlt,colorMaxAlt);updateAirportOpacity();updateStatsForSelection();}
function getColorForAltitude(altitude,minAlt,maxAlt){var normalized=(altitude-minAlt)/Math.max(maxAlt-minAlt,1);normalized=Math.max(0,Math.min(1,normalized));var r,g,b;if(normalized<0.2){var t=normalized/0.2;r=Math.round(80*(1-t));g=Math.round(160+95*t);b=255;}else if(normalized<0.4){var t=(normalized-0.2)/0.2;r=0;g=255;b=Math.round(255*(1-t));}else if(normalized<0.6){var t=(normalized-0.4)/0.2;r=Math.round(255*t);g=255;b=0;}else if(normalized<0.8){var t=(normalized-0.6)/0.2;r=255;g=Math.round(255*(1-t*0.35));b=0;}else{var t=(normalized-0.8)/0.2;r=255;g=Math.round(165*(1-t*0.6));b=Math.round(66*t);}
return'rgb('+r+','+g+','+b+')';}
function updateAirportOpacity(){if(selectedPathIds.size===0){Object.keys(airportMarkers).forEach(function(airportName){var marker=airportMarkers[airportName];marker.setOpacity(1.0);});return;}
var selectedAirports=new Set();selectedPathIds.forEach(function(pathId){var airports=pathToAirports[pathId];if(airports){if(airports.start)selectedAirports.add(airports.start);if(airports.end)selectedAirports.add(airports.end);}});Object.keys(airportMarkers).forEach(function(airportName){var marker=airportMarkers[airportName];if(selectedAirports.has(airportName)){marker.setOpacity(1.0);}else{marker.setOpacity(0.3);}});}
var selectedYear='all';function filterByYear(){const yearSelect=document.getElementById('year-select');selectedYear=yearSelect.value;altitudeLayer.clearLayers();pathSegments={};selectedPathIds.clear();currentResolution=null;updateLayers();}
(async function(){const airports=await loadAirports();const metadata=await loadMetadata();if(metadata&&metadata.available_years){const yearSelect=document.getElementById('year-select');metadata.available_years.forEach(function(year){const option=document.createElement('option');option.value=year;option.textContent='üìÖ '+year;yearSelect.appendChild(option);});}
airports.forEach(function(airport){const icaoMatch=airport.name?airport.name.match(/\b([A-Z]{4})\b/):null;const icao=icaoMatch?icaoMatch[1]:'APT';const markerHtml='<div class="airport-marker-container"><div class="airport-marker"></div><div class="airport-label">'+icao+'</div></div>';const latDms=ddToDms(airport.lat,true);const lonDms=ddToDms(airport.lon,false);const googleMapsLink=`https://www.google.com/maps?q=${airport.lat},${airport.lon}`;const popup=`
                <div style="font-size: 12px; min-width: 150px;">
                    <b>üõ´ ${airport.name || 'Unknown'}</b><br>
                    <a href="${googleMapsLink}" target="_blank" style="color: #4285f4; text-decoration: none;">${latDms} ${lonDms}</a><br>
                    <b>Flights:</b> ${airport.flight_count}
                </div>`;var marker=L.marker([airport.lat,airport.lon],{icon:L.divIcon({html:markerHtml,iconSize:[12,12],iconAnchor:[6,6],popupAnchor:[2,-6],className:''}),icao:icao}).bindPopup(popup,{autoPanPadding:[50,50]});marker.on('click',function(e){selectPathsByAirport(airport.name);});marker.addTo(airportLayer);airportMarkers[airport.name]=marker;});if(metadata&&metadata.stats){fullStats=metadata.stats;updateStatsPanel(fullStats,false);}
updateLayers();})();map.on('zoomend',updateLayers);map.on('click',function(e){if(selectedPathIds.size>0){clearSelection();}});function togglePathSelection(pathId){if(selectedPathIds.has(pathId)){selectedPathIds.delete(pathId);}else{selectedPathIds.add(pathId);}
redrawAltitudePaths();}
function selectPathsByAirport(airportName){var pathIds=airportToPaths[airportName]||[];pathIds.forEach(function(pathId){selectedPathIds.add(pathId);});redrawAltitudePaths();}
function clearSelection(){selectedPathIds.clear();redrawAltitudePaths();}
function updateAltitudeLegend(minAlt,maxAlt){var minFt=Math.round(minAlt);var maxFt=Math.round(maxAlt);var minM=Math.round(minAlt*0.3048);var maxM=Math.round(maxAlt*0.3048);document.getElementById('legend-min').textContent=minFt.toLocaleString()+' ft ('+minM.toLocaleString()+' m)';document.getElementById('legend-max').textContent=maxFt.toLocaleString()+' ft ('+maxM.toLocaleString()+' m)';}
function updateStatsForSelection(){if(selectedPathIds.size===0){if(fullStats){updateStatsPanel(fullStats,false);}
return;}
var selectedSegments=currentData.path_segments.filter(function(segment){return selectedPathIds.has(segment.path_id);});if(selectedSegments.length===0)return;var selectedPathInfos=currentData.path_info.filter(function(pathInfo){return selectedPathIds.has(pathInfo.id);});var selectedAirports=new Set();selectedPathInfos.forEach(function(pathInfo){if(pathInfo.start_airport)selectedAirports.add(pathInfo.start_airport);if(pathInfo.end_airport)selectedAirports.add(pathInfo.end_airport);});var totalDistanceKm=0;selectedSegments.forEach(function(segment){var coords=segment.coords;if(coords&&coords.length===2){var lat1=coords[0][0]*Math.PI/180;var lon1=coords[0][1]*Math.PI/180;var lat2=coords[1][0]*Math.PI/180;var lon2=coords[1][1]*Math.PI/180;var dlat=lat2-lat1;var dlon=lon2-lon1;var a=Math.sin(dlat/2)*Math.sin(dlat/2)+
Math.cos(lat1)*Math.cos(lat2)*Math.sin(dlon/2)*Math.sin(dlon/2);var c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));totalDistanceKm+=6371*c;}});var altitudes=selectedSegments.map(function(s){return s.altitude_m;});var minAltitudeM=Math.min(...altitudes);var maxAltitudeM=Math.max(...altitudes);var selectedStats={total_points:selectedSegments.length*2,num_paths:selectedPathIds.size,num_airports:selectedAirports.size,airport_names:Array.from(selectedAirports).sort(),total_distance_nm:totalDistanceKm*0.539957,max_altitude_ft:maxAltitudeM*3.28084,min_altitude_ft:minAltitudeM*3.28084};updateStatsPanel(selectedStats,true);}
function updateStatsPanel(stats,isSelection){let html='';if(isSelection){html+='<p style="margin:0 0 10px 0; font-weight:bold; font-size:15px;">üìä Selected Paths Statistics</p>';html+='<div style="background-color: #3a5a7a; padding: 4px 8px; margin-bottom: 8px; border-radius: 3px; font-size: 11px; color: #a0c0e0;">Showing stats for '+stats.num_paths+' selected path(s)</div>';}else{html+='<p style="margin:0 0 10px 0; font-weight:bold; font-size:15px;">üìä Flight Statistics</p>';}
html+='<div style="margin-bottom: 8px;"><strong>Data Points:</strong><br>';html+='<span style="margin-left: 10px;">‚Ä¢ Total Points: '+stats.total_points.toLocaleString()+'</span><br>';html+='<span style="margin-left: 10px;">‚Ä¢ Number of Paths: '+stats.num_paths+'</span></div>';html+='<div style="margin-bottom: 8px;"><strong>Airports Visited:</strong> '+stats.num_airports+'</div>';if(stats.airport_names&&stats.airport_names.length>0){html+='<div style="margin-bottom: 8px; max-height: 150px; overflow-y: auto;"><strong>Airports:</strong><br>';stats.airport_names.forEach(function(name){html+='<span style="margin-left: 10px;">‚Ä¢ '+name+'</span><br>';});html+='</div>';}
var distanceKm=(stats.total_distance_nm*1.852).toFixed(1);html+='<div style="margin-bottom: 8px;"><strong>Distance:</strong> '+stats.total_distance_nm.toFixed(1)+' nm ('+distanceKm+' km)</div>';if(stats.total_flight_time_str){html+='<div style="margin-bottom: 8px;"><strong>Total Flight Time:</strong> '+stats.total_flight_time_str+'</div>';}
if(stats.max_altitude_ft){var maxAltitudeM=Math.round(stats.max_altitude_ft*0.3048);html+='<div style="margin-bottom: 8px;"><strong>Max Altitude:</strong> '+Math.round(stats.max_altitude_ft)+' ft ('+maxAltitudeM+' m)</div>';if(!isSelection&&stats.total_altitude_gain_ft){var elevationGainM=Math.round(stats.total_altitude_gain_ft*0.3048);html+='<div style="margin-bottom: 8px;"><strong>Elevation Gain:</strong> '+Math.round(stats.total_altitude_gain_ft)+' ft ('+elevationGainM+' m)</div>';}}
document.getElementById('stats-panel').innerHTML=html;}
function toggleStats(){const panel=document.getElementById('stats-panel');panel.style.display=panel.style.display==='none'?'block':'none';}
function toggleHeatmap(){if(heatmapVisible){if(heatmapLayer){map.removeLayer(heatmapLayer);}
heatmapVisible=false;document.getElementById('heatmap-btn').style.opacity='0.5';}else{if(heatmapLayer){map.addLayer(heatmapLayer);if(heatmapLayer._canvas){heatmapLayer._canvas.style.pointerEvents='none';}}
heatmapVisible=true;document.getElementById('heatmap-btn').style.opacity='1.0';}}
function toggleAltitude(){if(altitudeVisible){map.removeLayer(altitudeLayer);altitudeVisible=false;document.getElementById('altitude-btn').style.opacity='0.5';document.getElementById('altitude-legend').style.display='none';}else{map.addLayer(altitudeLayer);altitudeVisible=true;document.getElementById('altitude-btn').style.opacity='1.0';document.getElementById('altitude-legend').style.display='block';}}
function toggleAirports(){if(airportsVisible){map.removeLayer(airportLayer);airportsVisible=false;document.getElementById('airports-btn').style.opacity='0.5';}else{map.addLayer(airportLayer);airportsVisible=true;document.getElementById('airports-btn').style.opacity='1.0';}}
function toggleAviation(){if(OPENAIP_API_KEY&&openaipLayers['Aviation Data']){if(aviationVisible){map.removeLayer(openaipLayers['Aviation Data']);aviationVisible=false;document.getElementById('aviation-btn').style.opacity='0.5';}else{map.addLayer(openaipLayers['Aviation Data']);aviationVisible=true;document.getElementById('aviation-btn').style.opacity='1.0';}}}
function exportMap(){const btn=document.getElementById('export-btn');btn.disabled=true;btn.textContent='‚è≥ Exporting...';const mapContainer=document.getElementById('map');const controls=[document.querySelector('.leaflet-control-zoom'),document.getElementById('stats-btn'),document.getElementById('export-btn'),document.getElementById('heatmap-btn'),document.getElementById('altitude-btn'),document.getElementById('airports-btn'),document.getElementById('aviation-btn'),document.getElementById('stats-panel'),document.getElementById('altitude-legend'),document.getElementById('loading')];const displayStates=controls.map(el=>el?el.style.display:null);controls.forEach(el=>{if(el)el.style.display='none';});setTimeout(function(){domtoimage.toJpeg(mapContainer,{width:mapContainer.offsetWidth*2,height:mapContainer.offsetHeight*2,bgcolor:'#1a1a1a',quality:0.95,style:{transform:'scale(2)',transformOrigin:'top left'}}).then(function(dataUrl){controls.forEach((el,i)=>{if(el)el.style.display=displayStates[i]||'';});btn.disabled=false;btn.textContent='üì∑ Export';const link=document.createElement('a');link.download='heatmap_'+new Date().toISOString().slice(0,19).replace(/[:.]/g,'-')+'.jpg';link.href=dataUrl;link.click();}).catch(function(error){controls.forEach((el,i)=>{if(el)el.style.display=displayStates[i]||'';});alert('Export failed: '+error.message);btn.disabled=false;btn.textContent='üì∑ Export';});},200);}
function showWrapped(){const year=selectedYear!=='all'?selectedYear:(fullStats.available_years?fullStats.available_years[fullStats.available_years.length-1]:new Date().getFullYear());const yearStats=calculateYearStats(year);document.getElementById('wrapped-year').textContent=year;const statsHtml=`
                <div class="stat-card">
                    <div class="stat-value">${yearStats.total_flights}</div>
                    <div class="stat-label">Flights</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${yearStats.total_distance_nm.toFixed(0)}</div>
                    <div class="stat-label">Nautical Miles</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${yearStats.num_airports}</div>
                    <div class="stat-label">Airports</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${yearStats.flight_time}</div>
                    <div class="stat-label">Flight Time</div>
                </div>
            `;document.getElementById('wrapped-stats').innerHTML=statsHtml;const earthCircumferenceKm=40075;const moonDistanceKm=384400;const timesAroundEarth=(yearStats.total_distance_nm*1.852/earthCircumferenceKm).toFixed(1);const percentToMoon=(yearStats.total_distance_nm*1.852/moonDistanceKm*100).toFixed(1);const funFactsHtml=`
                <div class="fun-facts-title">üåç Fun Facts</div>
                <div class="fun-fact">You flew <strong>${timesAroundEarth}x</strong> around the Earth</div>
                <div class="fun-fact">That's <strong>${percentToMoon}%</strong> of the distance to the Moon</div>
                <div class="fun-fact">Average flight: <strong>${(yearStats.total_distance_nm / yearStats.total_flights).toFixed(0)} nm</strong></div>
            `;document.getElementById('wrapped-fun-facts').innerHTML=funFactsHtml;if(fullStats&&fullStats.airport_names&&fullStats.airport_names.length>0){loadAirports().then(function(airports){const sortedAirports=airports.sort((a,b)=>b.flight_count-a.flight_count);const top3=sortedAirports.slice(0,3);let topAirportsHtml='<div class="top-airports-title">‚úàÔ∏è Top Airports</div>';top3.forEach(function(airport){topAirportsHtml+=`
                            <div class="top-airport">
                                <div class="top-airport-name">${airport.name}</div>
                                <div class="top-airport-count">${airport.flight_count} flights</div>
                            </div>
                        `;});document.getElementById('wrapped-top-airports').innerHTML=topAirportsHtml;});let airportBadgesHtml='<div class="airports-grid-title">üó∫Ô∏è All Airports</div><div class="airport-badges">';fullStats.airport_names.forEach(function(airportName){airportBadgesHtml+=`<div class="airport-badge">${airportName}</div>`;});airportBadgesHtml+='</div>';document.getElementById('wrapped-airports-grid').innerHTML=airportBadgesHtml;}
const originalCenter=map.getCenter();const originalZoom=map.getZoom();map.fitBounds(BOUNDS,{padding:[30,30]});const mapContainer=document.getElementById('map');const controls=[document.querySelector('.leaflet-control-zoom'),document.getElementById('stats-btn'),document.getElementById('export-btn'),document.getElementById('wrapped-btn'),document.getElementById('heatmap-btn'),document.getElementById('airports-btn'),document.getElementById('altitude-btn'),document.getElementById('aviation-btn'),document.getElementById('year-filter'),document.getElementById('stats-panel'),document.getElementById('altitude-legend'),document.getElementById('loading')];const displayStates=controls.map(el=>el?el.style.display:null);controls.forEach(el=>{if(el)el.style.display='none';});setTimeout(function(){domtoimage.toJpeg(mapContainer,{width:mapContainer.offsetWidth,height:mapContainer.offsetHeight,bgcolor:'#1a1a1a',quality:0.9}).then(function(dataUrl){controls.forEach((el,i)=>{if(el)el.style.display=displayStates[i]||'';});map.setView(originalCenter,originalZoom);document.getElementById('wrapped-map-snapshot').src=dataUrl;document.getElementById('wrapped-modal').style.display='flex';}).catch(function(error){controls.forEach((el,i)=>{if(el)el.style.display=displayStates[i]||'';});map.setView(originalCenter,originalZoom);console.error('Map capture failed:',error);document.getElementById('wrapped-modal').style.display='flex';});},1500);}
function closeWrapped(event){if(!event||event.target.id==='wrapped-modal'){document.getElementById('wrapped-modal').style.display='none';}}
function calculateYearStats(year){if(!fullStats){return{total_flights:0,total_distance_nm:0,num_airports:0,flight_time:'0h 0m'};}
if(fullStats.available_years&&fullStats.available_years.length>0){const yearStr=year.toString();if(fullStats.available_years.length===1&&fullStats.available_years[0].toString()===yearStr){return{total_flights:fullStats.num_paths,total_distance_nm:fullStats.total_distance_nm,num_airports:fullStats.num_airports,flight_time:fullStats.total_flight_time_str||'---'};}}
return{total_flights:fullStats.num_paths,total_distance_nm:fullStats.total_distance_nm,num_airports:fullStats.num_airports,flight_time:fullStats.total_flight_time_str||'---'};}
function exportWrappedCard(){const container=document.getElementById('wrapped-container');const closeBtn=document.querySelector('#wrapped-card .close-btn');const exportBtn=document.querySelector('#wrapped-card .export-wrapped-btn');closeBtn.style.display='none';exportBtn.style.display='block';exportBtn.style.opacity='0';exportBtn.style.pointerEvents='none';const containerClone=container.cloneNode(true);const clonedCloseBtn=containerClone.querySelector('#wrapped-card .close-btn');const clonedExportBtn=containerClone.querySelector('#wrapped-card .export-wrapped-btn');if(clonedCloseBtn)clonedCloseBtn.remove();if(clonedExportBtn)clonedExportBtn.remove();const wrapper=document.createElement('div');wrapper.style.cssText=`
                position: fixed;
                top: 0;
                left: 0;
                background: linear-gradient(135deg, rgba(10, 10, 20, 0.97) 0%, rgba(15, 20, 35, 0.97) 100%);
                padding: 60px;
                border-radius: 20px;
                width: auto;
                height: auto;
                max-width: none;
                max-height: none;
                z-index: 99999;
                visibility: hidden;
            `;wrapper.appendChild(containerClone);document.body.appendChild(wrapper);wrapper.offsetHeight;setTimeout(function(){wrapper.style.visibility='visible';domtoimage.toJpeg(wrapper,{width:wrapper.offsetWidth*2,height:wrapper.offsetHeight*2,quality:0.95,style:{transform:'scale(2)',transformOrigin:'top left',visibility:'visible'}}).then(function(dataUrl){document.body.removeChild(wrapper);closeBtn.style.display='block';exportBtn.style.opacity='1';exportBtn.style.pointerEvents='auto';const link=document.createElement('a');const year=document.getElementById('wrapped-year').textContent;link.download='flight_wrapped_'+year+'.jpg';link.href=dataUrl;link.click();}).catch(function(error){if(document.body.contains(wrapper)){document.body.removeChild(wrapper);}
closeBtn.style.display='block';exportBtn.style.opacity='1';exportBtn.style.pointerEvents='auto';alert('Export failed: '+error.message);});},200);}</script>