(function(d){"use strict";const m="kml-heatmap-state";class w{constructor(){this.layerVisibility={heatmap:!0,altitude:!1,airspeed:!1,airports:!0,aviation:!1},this.replayState={active:!1,playing:!1,currentTime:0,maxTime:0,speed:50,interval:null,layer:null,segments:[],airplaneMarker:null,lastDrawnIndex:-1,lastBearing:null,animationFrameId:null,lastFrameTime:null,colorMinAlt:0,colorMaxAlt:1e4,colorMinSpeed:0,colorMaxSpeed:200,autoZoom:!1,lastZoom:null,recenterTimestamps:[]},this.selectedYear="all",this.selectedAircraft="all",this.selectedPathIds=new Set}saveState(t){const e={center:t.getCenter(),zoom:t.getZoom(),heatmapVisible:this.layerVisibility.heatmap,altitudeVisible:this.layerVisibility.altitude,airspeedVisible:this.layerVisibility.airspeed,airportsVisible:this.layerVisibility.airports,aviationVisible:this.layerVisibility.aviation,selectedYear:this.selectedYear,selectedAircraft:this.selectedAircraft,selectedPathIds:Array.from(this.selectedPathIds),statsPanelVisible:document.getElementById("stats-panel")?.classList.contains("visible")??!1,replayActive:this.replayState.active,replayPlaying:this.replayState.playing,replayCurrentTime:this.replayState.currentTime,replaySpeed:this.replayState.speed,replayAutoZoom:this.replayState.autoZoom};try{localStorage.setItem(m,JSON.stringify(e))}catch{}}loadState(){try{const t=localStorage.getItem(m);if(t)return JSON.parse(t)}catch{}return null}restoreState(t){t&&(this.layerVisibility.heatmap=t.heatmapVisible??!0,this.layerVisibility.altitude=t.altitudeVisible??!1,this.layerVisibility.airspeed=t.airspeedVisible??!1,this.layerVisibility.airports=t.airportsVisible??!0,this.layerVisibility.aviation=t.aviationVisible??!1,this.selectedYear=t.selectedYear??"all",this.selectedAircraft=t.selectedAircraft??"all",this.selectedPathIds=new Set(t.selectedPathIds??[]),this.replayState.currentTime=t.replayCurrentTime??0,this.replayState.speed=t.replaySpeed??50,this.replayState.autoZoom=t.replayAutoZoom??!1)}getLayerVisibility(){return{...this.layerVisibility}}getReplayState(){return this.replayState}getSelectedYear(){return this.selectedYear}getSelectedAircraft(){return this.selectedAircraft}getSelectedPathIds(){return new Set(this.selectedPathIds)}setLayerVisibility(t,e){this.layerVisibility[t]=e}setSelectedYear(t){this.selectedYear=t}setSelectedAircraft(t){this.selectedAircraft=t}togglePathSelection(t){return this.selectedPathIds.has(t)?(this.selectedPathIds.delete(t),!1):(this.selectedPathIds.add(t),!0)}clearPathSelection(){this.selectedPathIds.clear()}addPathsToSelection(t){t.forEach(e=>this.selectedPathIds.add(e))}}class x{constructor(t){this.loadedData=new Map,this.airports=null,this.metadata=null,this.dataDir=t}async loadData(t){if(this.loadedData.has(t))return this.loadedData.get(t);this.showLoading();try{const e=await fetch(`${this.dataDir}/data_${t}.json`);if(!e.ok)throw new Error(`HTTP ${e.status}: ${e.statusText}`);const a=await e.json();if(!this.isValidFlightData(a))throw new Error("Invalid flight data structure");return this.loadedData.set(t,a),console.log(`Loaded ${t} resolution:`,a.downsampled_points,"points"),a}catch(e){return console.error(`Error loading data for ${t}:`,e),null}finally{this.hideLoading()}}isValidFlightData(t){return!!(t&&typeof t=="object"&&"coordinates"in t&&Array.isArray(t.coordinates)&&"downsampled_points"in t&&typeof t.downsampled_points=="number")}isValidAirport(t){return!!(t&&typeof t=="object"&&"name"in t&&typeof t.name=="string"&&"lat"in t&&typeof t.lat=="number"&&!Number.isNaN(t.lat)&&"lon"in t&&typeof t.lon=="number"&&!Number.isNaN(t.lon)&&"flight_count"in t&&typeof t.flight_count=="number")}async loadAirports(){if(this.airports!==null)return this.airports;try{const e=await(await fetch(`${this.dataDir}/airports.json`)).json();return this.airports=e.airports.filter(a=>{const i=this.isValidAirport(a);return i||console.warn("Invalid airport data:",a),i}),this.airports}catch(t){return console.error("Error loading airports:",t),[]}}async loadMetadata(){if(this.metadata!==null)return this.metadata;try{const t=await fetch(`${this.dataDir}/metadata.json`);return this.metadata=await t.json(),this.metadata}catch(t){return console.error("Error loading metadata:",t),null}}getCachedData(t){return this.loadedData.get(t)??null}clearCache(){this.loadedData.clear(),this.airports=null,this.metadata=null}showLoading(){const t=document.getElementById("loading");t&&(t.style.display="block")}hideLoading(){const t=document.getElementById("loading");t&&(t.style.display="none")}}function b(o){const t=Math.floor(o/3600),e=Math.floor(o%3600/60),a=Math.floor(o%60);return t>0?`${t}h ${e}m ${a}s`:e>0?`${e}m ${a}s`:`${a}s`}function E(o,t,e){if(e===t)return"rgb(0, 128, 255)";const a=(o-t)/(e-t),i=Math.max(0,Math.min(1,a));if(i<.25){const r=i/.25;return`rgb(${Math.round(0+0*r)}, ${Math.round(0+100*r)}, ${Math.round(255-55*r)})`}else if(i<.5){const r=(i-.25)/.25;return`rgb(${Math.round(0+0*r)}, ${Math.round(100+155*r)}, ${Math.round(200-200*r)})`}else if(i<.75){const r=(i-.5)/.25;return`rgb(${Math.round(0+255*r)}, ${Math.round(255-0*r)}, ${Math.round(0+0*r)})`}else{const r=(i-.75)/.25;return`rgb(${Math.round(255-0*r)}, ${Math.round(255-255*r)}, ${Math.round(0+0*r)})`}}function P(o,t,e){if(e===t)return"rgb(192, 0, 64)";const a=(o-t)/(e-t),i=Math.max(0,Math.min(1,a));if(i<.5){const r=i/.5;return`rgb(${Math.round(128+127*r)}, ${Math.round(0+0*r)}, ${Math.round(128-128*r)})`}else{const r=(i-.5)/.5;return`rgb(${Math.round(255-0*r)}, ${Math.round(0+255*r)}, ${Math.round(0+0*r)})`}}const h={DEFAULT_ZOOM:10,ZOOM_SNAP:.25,ZOOM_DELTA:.25,WHEEL_PX_PER_ZOOM_LEVEL:120,BOUNDS_PADDING:[30,30]},p={RADIUS:10,BLUR:15,MIN_OPACITY:.25,MAX_OPACITY:.6},v={WEIGHT:2,OPACITY:.7},u={METERS_TO_FEET:3.28084,KM_TO_NAUTICAL_MILES:.539957,EARTH_CIRCUMFERENCE_KM:40075},I={MODAL:1e4};class C{constructor(t){this.map=t,this.layers={heatmap:null,altitude:d.layerGroup(),airspeed:d.layerGroup(),airport:d.layerGroup(),replay:null}}updateHeatmap(t,e){this.layers.heatmap&&this.map.removeLayer(this.layers.heatmap),this.layers.heatmap=d.heatLayer(t,{radius:p.RADIUS,blur:p.BLUR,minOpacity:p.MIN_OPACITY,maxOpacity:p.MAX_OPACITY,max:1,gradient:{0:"#00008B",.2:"#0000CD",.4:"#4169E1",.6:"#FF8C00",.8:"#FF4500",1:"#FF0000"}}),e&&this.layers.heatmap.addTo(this.map)}updateAltitudePaths(t,e,a,i){this.updatePathLayer(this.layers.altitude,t,r=>{if(!r.altitude)return null;const s=(r.altitude[0]+r.altitude[1])/2;return E(s,e,a)},i)}updateAirspeedPaths(t,e,a,i){this.updatePathLayer(this.layers.airspeed,t,r=>{if(!r.groundspeed)return null;const s=(r.groundspeed[0]+r.groundspeed[1])/2;return P(s,e,a)},i)}updatePathLayer(t,e,a,i){t.clearLayers();const r=d.svg();e.forEach(s=>{if(!s.coords||s.coords.length<2)return;const n=a(s);if(!n)return;const c=d.polyline([[s.coords[0].lat,s.coords[0].lon],[s.coords[1].lat,s.coords[1].lon]],{color:n,weight:v.WEIGHT,opacity:v.OPACITY,renderer:r});i&&c.on("click",()=>i(s.path_id)),c.addTo(t)})}toggleLayer(t,e){const a=this.layers[t];a&&(e?this.map.hasLayer(a)||a.addTo(this.map):this.map.hasLayer(a)&&this.map.removeLayer(a))}getLayer(t){return this.layers[t]}clearAll(){Object.values(this.layers).forEach(t=>{t&&("clearLayers"in t&&t.clearLayers(),this.map.hasLayer(t)&&this.map.removeLayer(t))})}}class F{constructor(t,e){this.airportMarkers=new Map,this.pathToAirports=new Map,this.airportToPaths=new Map,this.map=t,this.airportLayer=e}createAirportMarkers(t,e){this.airportMarkers.clear(),this.airportLayer.clearLayers(),t.forEach(a=>{const i=a.name.split(" ")[0],r=d.divIcon({className:"airport-marker",html:`
          <div style="
            background: rgba(255, 165, 0, 0.8);
            border: 2px solid white;
            border-radius: 50%;
            width: 12px;
            height: 12px;
            position: relative;
          "></div>
          <div style="
            position: absolute;
            top: 14px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 2px 4px;
            border-radius: 3px;
            font-size: 10px;
            white-space: nowrap;
            font-weight: bold;
          ">${i}</div>
        `,iconSize:[12,12],iconAnchor:[6,6]}),s=d.marker([a.lat,a.lon],{icon:r}),n=`
        <div style="min-width: 150px;">
          <strong>${a.name}</strong><br>
          <strong>Visits:</strong> ${a.flight_count}
        </div>
      `;s.bindPopup(n),e&&s.on("click",()=>e(a.name)),s.addTo(this.airportLayer),this.airportMarkers.set(a.name,s)})}buildAirportRelationships(t){this.pathToAirports.clear(),this.airportToPaths.clear(),t.forEach(e=>{const a={};e.start_airport&&(a.start=e.start_airport,this.airportToPaths.has(e.start_airport)||this.airportToPaths.set(e.start_airport,new Set),this.airportToPaths.get(e.start_airport).add(e.id)),e.end_airport&&(a.end=e.end_airport,this.airportToPaths.has(e.end_airport)||this.airportToPaths.set(e.end_airport,new Set),this.airportToPaths.get(e.end_airport).add(e.id)),(a.start||a.end)&&this.pathToAirports.set(e.id,a)})}updateAirportOpacity(t,e){if(!e){this.airportMarkers.forEach(a=>{a.setOpacity(1)});return}this.airportMarkers.forEach((a,i)=>{t.has(i)?a.setOpacity(1):a.setOpacity(0)})}getPathsForAirport(t){return this.airportToPaths.get(t)||new Set}getAirportsForPath(t){return this.pathToAirports.get(t)}clear(){this.airportMarkers.clear(),this.airportLayer.clearLayers(),this.pathToAirports.clear(),this.airportToPaths.clear()}}function f(o,t){const{year:e,aircraft:a,selectedPathIds:i}=t,r=!e||e==="all"||!!o.year&&o.year.toString()===e,s=!a||a==="all"||o.aircraft_registration===a,n=!i||i.size===0||i.has(o.id);return r&&s&&n}function M(o){const{year:t,aircraft:e,selectedPathIds:a}=o;return(!t||t==="all")&&(!e||e==="all")&&(!a||a.size===0)}class T{calculateFilteredStats(t,e,a,i){if(M(i))return t;const r=e.filter(l=>f(l,i));let s=0,n=0;const c=new Set;r.forEach(l=>{l.distance_km&&(s+=l.distance_km),l.duration_seconds&&(n+=l.duration_seconds),l.start_airport&&c.add(l.start_airport),l.end_airport&&c.add(l.end_airport)});const B=new Set(r.map(l=>l.id)),z=a.filter(l=>B.has(l.path_id));let g=1/0,y=-1/0;z.forEach(l=>{if(l.altitude){const[A,S]=l.altitude;g=Math.min(g,A,S),y=Math.max(y,A,S)}});const R=g!==1/0?g*u.METERS_TO_FEET:0,N=y!==-1/0?y*u.METERS_TO_FEET:0;return{total_distance_km:s,total_distance_nm:s*u.KM_TO_NAUTICAL_MILES,min_altitude_ft:R,max_altitude_ft:N,airports_visited:c.size,total_flight_time_seconds:n,paths:r}}getVisibleAirports(t,e){const a=new Set;return t.forEach(i=>{f(i,e)&&(i.start_airport&&a.add(i.start_airport),i.end_airport&&a.add(i.end_airport))}),a}calculateYearStats(t){const e=new Map;return t.forEach(a=>{if(!a.year)return;e.has(a.year)||e.set(a.year,{distance:0,time:0,airports:new Set,paths:0});const i=e.get(a.year);i.distance+=a.distance_km||0,i.time+=a.duration_seconds||0,i.paths++,a.start_airport&&i.airports.add(a.start_airport),a.end_airport&&i.airports.add(a.end_airport)}),e}getUniqueYears(t){const e=new Set;return t.forEach(a=>{a.year&&e.add(a.year)}),Array.from(e).sort((a,i)=>i-a)}getUniqueAircraft(t){const e=new Set;return t.forEach(a=>{a.aircraft_registration&&e.add(a.aircraft_registration)}),Array.from(e).sort()}}class ${constructor(t){this.map=t}async exportAsImage(t="flight-map.jpg"){try{const e=window.domtoimage;if(!e){console.error("domtoimage library not loaded"),alert("Export functionality requires domtoimage library");return}const a=this.map.getContainer(),i=a.style.cursor;a.style.cursor="wait";const r=await e.toBlob(a,{quality:.95,bgcolor:"#1a1a1a"});a.style.cursor=i;const s=document.createElement("a");s.download=t,s.href=URL.createObjectURL(r),s.click(),URL.revokeObjectURL(s.href)}catch(e){console.error("Export failed:",e),alert("Failed to export map image")}}async exportAsCanvasImage(t="flight-map.jpg"){try{const e=this.map.getContainer(),a=document.createElement("canvas"),i=a.getContext("2d");if(!i)throw new Error("Failed to get canvas context");const r=e.getBoundingClientRect();a.width=r.width,a.height=r.height,i.fillStyle="#1a1a1a",i.fillRect(0,0,a.width,a.height),a.toBlob(s=>{if(!s)throw new Error("Failed to create blob");const n=document.createElement("a");n.download=t,n.href=URL.createObjectURL(s),n.click(),URL.revokeObjectURL(n.href)},"image/jpeg",.95)}catch(e){console.error("Canvas export failed:",e),alert("Failed to export map image")}}}class O{updateButtonState(t,e){const a=document.getElementById(t);a&&(a.style.opacity=e?"1.0":"0.5")}showAviationButton(t){const e=document.getElementById("aviation-btn");e&&(e.style.display=t?"block":"none")}toggleStatsPanel(){const t=document.getElementById("stats-panel");if(t){const e=t.classList.contains("visible");return e?t.classList.remove("visible"):t.classList.add("visible"),!e}return!1}updateStatsPanel(t){const e=document.getElementById("stats-panel");e&&(e.innerHTML=t)}updateAltitudeLegend(t,e){const a=document.getElementById("altitude-legend");a&&(a.innerHTML=`
        <div style="font-weight: bold; margin-bottom: 4px;">Altitude (ft)</div>
        <div style="display: flex; align-items: center; gap: 8px;">
          <div style="width: 20px; height: 100px; background: linear-gradient(to top,
            rgb(0,0,255), rgb(0,100,200), rgb(0,255,0), rgb(255,255,0), rgb(255,0,0));
            border: 1px solid rgba(255,255,255,0.3); border-radius: 3px;"></div>
          <div style="display: flex; flex-direction: column; justify-content: space-between; height: 100px;">
            <div>${Math.round(e).toLocaleString()}</div>
            <div>${Math.round((t+e)/2).toLocaleString()}</div>
            <div>${Math.round(t).toLocaleString()}</div>
          </div>
        </div>
      `)}updateAirspeedLegend(t,e){const a=document.getElementById("airspeed-legend");a&&(a.innerHTML=`
        <div style="font-weight: bold; margin-bottom: 4px;">Airspeed (kts)</div>
        <div style="display: flex; align-items: center; gap: 8px;">
          <div style="width: 20px; height: 100px; background: linear-gradient(to top,
            rgb(128,0,128), rgb(255,0,0), rgb(255,255,0));
            border: 1px solid rgba(255,255,255,0.3); border-radius: 3px;"></div>
          <div style="display: flex; flex-direction: column; justify-content: space-between; height: 100px;">
            <div>${Math.round(e)}</div>
            <div>${Math.round((t+e)/2)}</div>
            <div>${Math.round(t)}</div>
          </div>
        </div>
      `)}toggleLegend(t,e){const a=document.getElementById(t);a&&(a.style.display=e?"block":"none")}toggleButtonsVisibility(){const t=["stats-btn","export-btn","wrapped-btn","heatmap-btn","altitude-btn","airspeed-btn","airports-btn","aviation-btn","year-filter","aircraft-filter"],a=document.getElementById(t[0])?.style.display==="none";return t.forEach(i=>{const r=document.getElementById(i);r&&(r.style.display=a?"block":"none")}),!a}updateYearFilter(t){this.updateFilterDropdown("year-filter","All Years",t.sort((e,a)=>a-e).map(e=>({value:e.toString(),text:e.toString()})))}updateAircraftFilter(t){this.updateFilterDropdown("aircraft-filter","All Aircraft",t.sort().map(e=>({value:e,text:e})))}updateFilterDropdown(t,e,a){const i=document.getElementById(t);if(!i)return;const r=i.value;i.innerHTML=`<option value="all">${e}</option>`,a.forEach(({value:s,text:n})=>{const c=document.createElement("option");c.value=s,c.textContent=n,i.appendChild(c)}),Array.from(i.options).some(s=>s.value===r)&&(i.value=r)}}class V{constructor(){this.modal=null}show(t,e,a,i){const r=this.generateFunFacts(e,a),s=this.generateHTML(t,e,r);this.modal||(this.modal=document.createElement("div"),this.modal.id="wrapped-modal",this.modal.style.cssText=`
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.95);
        z-index: ${I.MODAL};
        overflow: auto;
      `,document.body.appendChild(this.modal),this.modal.addEventListener("click",c=>{c.target===this.modal&&this.close()})),this.modal.innerHTML=s,this.modal.style.display="flex";const n=this.modal.querySelector(".wrapped-close");n&&n.addEventListener("click",()=>this.close())}close(){this.modal&&(this.modal.style.display="none")}generateFunFacts(t,e){const a=[],r=t.total_distance_km/u.EARTH_CIRCUMFERENCE_KM;if(r>=.5&&a.push({category:"distance",icon:"üåç",text:`You flew <strong>${r.toFixed(1)}x</strong> around the Earth`,priority:10}),t.total_flight_time_seconds){const n=t.total_flight_time_seconds/3600/24;n>=1&&a.push({category:"time",icon:"‚è±Ô∏è",text:`You spent <strong>${n.toFixed(1)} days</strong> in the air`,priority:8})}return t.airports_visited>0&&a.push({category:"airports",icon:"üõ´",text:`Visited <strong>${t.airports_visited}</strong> different airports`,priority:7}),a.sort((s,n)=>n.priority-s.priority).slice(0,5)}generateHTML(t,e,a){return`
      <div style="
        max-width: 800px;
        margin: auto;
        padding: 40px 20px;
        color: white;
        font-family: system-ui, -apple-system, sans-serif;
      ">
        <button class="wrapped-close" style="
          position: absolute;
          top: 20px;
          right: 20px;
          background: rgba(255,255,255,0.2);
          border: none;
          color: white;
          font-size: 24px;
          width: 40px;
          height: 40px;
          border-radius: 50%;
          cursor: pointer;
        ">√ó</button>

        <h1 style="font-size: 48px; text-align: center; margin-bottom: 40px;">
          ${t} Wrapped
        </h1>

        <div style="background: rgba(255,255,255,0.1); padding: 30px; border-radius: 12px; margin-bottom: 30px;">
          <h2 style="font-size: 32px; margin-bottom: 20px;">By the Numbers</h2>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
            <div>
              <div style="font-size: 36px; font-weight: bold; color: #4CAF50;">
                ${e.total_distance_nm.toFixed(0)}
              </div>
              <div style="color: #aaa;">nautical miles</div>
            </div>
            <div>
              <div style="font-size: 36px; font-weight: bold; color: #2196F3;">
                ${b(e.total_flight_time_seconds)}
              </div>
              <div style="color: #aaa;">flight time</div>
            </div>
            <div>
              <div style="font-size: 36px; font-weight: bold; color: #FF9800;">
                ${e.airports_visited}
              </div>
              <div style="color: #aaa;">airports</div>
            </div>
            <div>
              <div style="font-size: 36px; font-weight: bold; color: #E91E63;">
                ${Math.round(e.max_altitude_ft).toLocaleString()}
              </div>
              <div style="color: #aaa;">feet (max alt)</div>
            </div>
          </div>
        </div>

        ${a.map(i=>`<div style="
background:rgba(255,255,255,0.1);padding:20px;border-radius:12px;margin-bottom:20px;display:flex;align-items:center;gap:15px;"><div style="font-size: 48px;">${i.icon}</div><div style="font-size: 18px;">${i.text}</div></div>`).join("")}

        <div style="text-align: center; margin-top: 40px;">
          <button class="wrapped-close" style="
            background: #4CAF50;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 18px;
            cursor: pointer;
          ">Close</button>
        </div>
      </div>
    `}}function D(o){return o<=4?"z0_4":o<=7?"z5_7":o<=10?"z8_10":o<=13?"z11_13":"z14_plus"}class k{applyFilters(t,e){if(M(e))return t;const a=this.getFilteredPathIds(t.path_info,e),i=this.filterSegments(t.path_segments,a),r=this.extractCoordinates(i);return{...t,coordinates:r,path_segments:i}}getFilteredPathIds(t,e){const a=new Set;return t?.forEach(i=>{f(i,e)&&a.add(i.id)}),a}filterSegments(t,e){return t?.filter(a=>e.has(a.path_id))}extractCoordinates(t){const e=new Set;return t?.forEach(a=>{a.coords&&a.coords.length===2&&(e.add(JSON.stringify([a.coords[0].lat,a.coords[0].lon])),e.add(JSON.stringify([a.coords[1].lat,a.coords[1].lon])))}),Array.from(e).map(a=>JSON.parse(a))}}class _{constructor(t){this.replayController=null,this.currentResolution=null,this.fullPathInfo=null,this.fullPathSegments=null,this.config=t,this.stateManager=new w,this.dataLoader=new x(t.dataDir),this.statisticsCalculator=new T,this.uiController=new O,this.wrappedView=new V,this.filterController=new k}async init(){this.initializeMap(),this.layerManager=new C(this.map);const t=this.layerManager.getLayer("airport");this.airportManager=new F(this.map,t),this.mapExporter=new $(this.map);const e=this.stateManager.loadState();this.stateManager.restoreState(e),e?.center&&e?.zoom?this.map.setView([e.center.lat,e.center.lng],e.zoom):this.map.fitBounds(this.config.bounds,{padding:h.BOUNDS_PADDING}),this.setupEventHandlers(),this.initializeUI(),await this.updateLayers(),await this.loadAndDisplayAirports();const a=await this.dataLoader.loadMetadata();a&&this.displayStats(a,!1),await this.loadFullResolutionData()}initializeMap(){if(this.map=d.map("map",{center:this.config.center,zoom:h.DEFAULT_ZOOM,zoomSnap:h.ZOOM_SNAP,zoomDelta:h.ZOOM_DELTA,wheelPxPerZoomLevel:h.WHEEL_PX_PER_ZOOM_LEVEL,preferCanvas:!0}),this.config.stadiaApiKey?d.tileLayer(`https://tiles.stadiamaps.com/tiles/alidade_smooth_dark/{z}/{x}/{y}{r}.png?api_key=${this.config.stadiaApiKey}`,{attribution:'&copy; <a href="https://stadiamaps.com/">Stadia Maps</a>'}).addTo(this.map):d.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png",{attribution:"&copy; OpenStreetMap contributors, &copy; CARTO"}).addTo(this.map),this.config.openaipApiKey){const t=d.tileLayer(`https://{s}.api.tiles.openaip.net/api/data/openaip/{z}/{x}/{y}.png?apiKey=${this.config.openaipApiKey}`,{attribution:'&copy; <a href="https://www.openaip.net">OpenAIP</a>',maxZoom:18,minZoom:7,subdomains:["a","b","c"]});this.stateManager.getLayerVisibility().aviation&&t.addTo(this.map),this.map.openaipLayer=t}}setupEventHandlers(){this.map.on("moveend",()=>this.stateManager.saveState(this.map)),this.map.on("zoomend",()=>{this.stateManager.saveState(this.map),this.updateLayers()}),this.setupButtonHandlers(),this.setupFilterHandlers()}setupButtonHandlers(){Object.entries({"heatmap-btn":()=>this.toggleHeatmap(),"altitude-btn":()=>this.toggleAltitude(),"airspeed-btn":()=>this.toggleAirspeed(),"airports-btn":()=>this.toggleAirports(),"aviation-btn":()=>this.toggleAviation(),"stats-btn":()=>this.toggleStats(),"export-btn":()=>this.exportMap(),"wrapped-btn":()=>this.showWrapped()}).forEach(([e,a])=>{const i=document.getElementById(e);i&&i.addEventListener("click",a)})}setupFilterHandlers(){const t=document.getElementById("year-filter");t&&t.addEventListener("change",()=>{this.stateManager.setSelectedYear(t.value),this.applyFilters()});const e=document.getElementById("aircraft-filter");e&&e.addEventListener("change",()=>{this.stateManager.setSelectedAircraft(e.value),this.applyFilters()})}initializeUI(){const t=this.stateManager.getLayerVisibility();if(this.uiController.updateButtonState("heatmap-btn",t.heatmap),this.uiController.updateButtonState("altitude-btn",t.altitude),this.uiController.updateButtonState("airspeed-btn",t.airspeed),this.uiController.updateButtonState("airports-btn",t.airports),this.uiController.updateButtonState("aviation-btn",t.aviation),this.uiController.showAviationButton(!!this.config.openaipApiKey),t.airports){const e=this.layerManager.getLayer("airport");e&&e.addTo(this.map)}}async loadFullResolutionData(){const t=await this.dataLoader.loadData("z14_plus");if(t?.path_info&&t?.path_segments){this.fullPathInfo=t.path_info,this.fullPathSegments=t.path_segments,this.airportManager.buildAirportRelationships(this.fullPathInfo);const e=this.statisticsCalculator.getUniqueYears(this.fullPathInfo);this.uiController.updateYearFilter(e);const a=this.statisticsCalculator.getUniqueAircraft(this.fullPathInfo);this.uiController.updateAircraftFilter(a)}}async updateLayers(){const t=this.map.getZoom(),e=D(t);if(e===this.currentResolution)return;this.currentResolution=e;const a=await this.dataLoader.loadData(e);if(!a)return;const i=this.getFilteredData(a),r=this.stateManager.getLayerVisibility();if(this.layerManager.updateHeatmap(i.coordinates,r.heatmap),r.altitude&&i.path_segments){const s=a.altitude_range??{min:0,max:1e4};this.layerManager.updateAltitudePaths(i.path_segments,s.min,s.max,n=>this.handlePathClick(n)),this.uiController.updateAltitudeLegend(s.min,s.max)}if(r.airspeed&&i.path_segments){const s=a.airspeed_range??{min:0,max:200};this.layerManager.updateAirspeedPaths(i.path_segments,s.min,s.max,n=>this.handlePathClick(n)),this.uiController.updateAirspeedLegend(s.min,s.max)}}getFilteredData(t){const e={year:this.stateManager.getSelectedYear(),aircraft:this.stateManager.getSelectedAircraft(),selectedPathIds:this.stateManager.getSelectedPathIds()};return this.filterController.applyFilters(t,e)}async loadAndDisplayAirports(){const t=await this.dataLoader.loadAirports();this.airportManager.createAirportMarkers(t,e=>{this.handleAirportClick(e)})}handlePathClick(t){this.stateManager.togglePathSelection(t),this.applyFilters()}handleAirportClick(t){const e=Array.from(this.airportManager.getPathsForAirport(t));this.stateManager.clearPathSelection(),this.stateManager.addPathsToSelection(e),this.applyFilters()}applyFilters(){if(this.updateLayers(),this.fullPathInfo){const t=this.stateManager.getSelectedYear(),e=this.stateManager.getSelectedAircraft(),a=this.stateManager.getSelectedPathIds(),i=this.statisticsCalculator.getVisibleAirports(this.fullPathInfo,{year:t,aircraft:e,selectedPathIds:a}),r=t!=="all"||e!=="all"||a.size>0;this.airportManager.updateAirportOpacity(i,r)}this.updateFilteredStats(),this.stateManager.saveState(this.map)}async updateFilteredStats(){const t=await this.dataLoader.loadMetadata();if(!t||!this.fullPathInfo||!this.fullPathSegments)return;const e=this.stateManager.getSelectedYear(),a=this.stateManager.getSelectedAircraft(),i=this.stateManager.getSelectedPathIds(),r=this.statisticsCalculator.calculateFilteredStats(t,this.fullPathInfo,this.fullPathSegments,{year:e,aircraft:a,selectedPathIds:i});this.displayStats(r,i.size>0)}displayStats(t,e){const a=`
      <h3>${e?"Selection":"Total"} Statistics</h3>
      <div><strong>Distance:</strong> ${t.total_distance_nm.toFixed(0)} nm (${t.total_distance_km.toFixed(0)} km)</div>
      <div><strong>Altitude:</strong> ${Math.round(t.min_altitude_ft).toLocaleString()} - ${Math.round(t.max_altitude_ft).toLocaleString()} ft</div>
      <div><strong>Airports:</strong> ${t.airports_visited}</div>
      <div><strong>Flight Time:</strong> ${b(t.total_flight_time_seconds)}</div>
    `;this.uiController.updateStatsPanel(a)}toggleHeatmap(){const e=!this.stateManager.getLayerVisibility().heatmap;this.stateManager.setLayerVisibility("heatmap",e),this.layerManager.toggleLayer("heatmap",e),this.uiController.updateButtonState("heatmap-btn",e),this.stateManager.saveState(this.map)}toggleAltitude(){const e=!this.stateManager.getLayerVisibility().altitude;this.stateManager.setLayerVisibility("altitude",e),this.layerManager.toggleLayer("altitude",e),this.uiController.updateButtonState("altitude-btn",e),this.uiController.toggleLegend("altitude-legend",e),this.stateManager.saveState(this.map),e&&this.updateLayers()}toggleAirspeed(){const e=!this.stateManager.getLayerVisibility().airspeed;this.stateManager.setLayerVisibility("airspeed",e),this.layerManager.toggleLayer("airspeed",e),this.uiController.updateButtonState("airspeed-btn",e),this.uiController.toggleLegend("airspeed-legend",e),this.stateManager.saveState(this.map),e&&this.updateLayers()}toggleAirports(){const e=!this.stateManager.getLayerVisibility().airports;this.stateManager.setLayerVisibility("airports",e),this.layerManager.toggleLayer("airport",e),this.uiController.updateButtonState("airports-btn",e),this.stateManager.saveState(this.map)}toggleAviation(){const e=!this.stateManager.getLayerVisibility().aviation;this.stateManager.setLayerVisibility("aviation",e);const a=this.map.openaipLayer;a&&(e?a.addTo(this.map):this.map.removeLayer(a)),this.uiController.updateButtonState("aviation-btn",e),this.stateManager.saveState(this.map)}toggleStats(){this.uiController.toggleStatsPanel(),this.stateManager.saveState(this.map)}async exportMap(){await this.mapExporter.exportAsImage()}async showWrapped(){const t=await this.dataLoader.loadMetadata();if(!t||!this.fullPathInfo){alert("No data available for wrapped view");return}const e=new Date().getFullYear(),a=this.statisticsCalculator.calculateFilteredStats(t,this.fullPathInfo,this.fullPathSegments||[],{year:e.toString()});this.wrappedView.show(e,a,t,this.map)}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{new _(window.kmlHeatmapConfig).init()}):new _(window.kmlHeatmapConfig).init()})(L);