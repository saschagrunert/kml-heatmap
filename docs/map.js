const CENTER=[51.286375,13.3316945];const BOUNDS=[[48.101383,9.362755],[54.471367,17.300634]];const STADIA_API_KEY='ac4dd698-4222-457a-9fdd-763b5f9506b2';const OPENAIP_API_KEY='8c48c5bab93ab7426e33c63e0f2da961';const DATA_DIR='data';var selectedYear='all';var selectedAircraft='all';var allAirportsData=[];function ddToDms(dd,isLat){const direction=dd>=0?(isLat?'N':'E'):(isLat?'S':'W');dd=Math.abs(dd);const degrees=Math.floor(dd);const minutes=Math.floor((dd-degrees)*60);const seconds=((dd-degrees)*60-minutes)*60;return degrees+"¬∞"+minutes+"'"+seconds.toFixed(1)+'"'+direction;}
function saveMapState(){const state={center:map.getCenter(),zoom:map.getZoom(),heatmapVisible:heatmapVisible,altitudeVisible:altitudeVisible,airspeedVisible:airspeedVisible,airportsVisible:airportsVisible,aviationVisible:aviationVisible,selectedYear:selectedYear,selectedAircraft:selectedAircraft,selectedPathIds:Array.from(selectedPathIds),statsPanelVisible:document.getElementById('stats-panel').classList.contains('visible')};try{localStorage.setItem('kml-heatmap-state',JSON.stringify(state));}catch(e){}
updateUrl(state);}
function loadMapState(){try{const saved=localStorage.getItem('kml-heatmap-state');if(saved){return JSON.parse(saved);}}catch(e){}
return null;}
function parseUrlParams(){const params=new URLSearchParams(window.location.search);if(params.toString()===''){return null;}
const state={};if(params.has('y')){state.selectedYear=params.get('y');}
if(params.has('a')){state.selectedAircraft=params.get('a');}
if(params.has('p')){const pathStr=params.get('p');if(pathStr){state.selectedPathIds=pathStr.split(',').map(id=>parseInt(id,10)).filter(id=>!isNaN(id));}}
if(params.has('v')){const vis=params.get('v');if(vis.length===6){state.heatmapVisible=vis[0]==='1';state.altitudeVisible=vis[1]==='1';state.airspeedVisible=vis[2]==='1';state.airportsVisible=vis[3]==='1';state.aviationVisible=vis[4]==='1';state.statsPanelVisible=vis[5]==='1';}}
if(params.has('lat')&&params.has('lng')){const lat=parseFloat(params.get('lat'));const lng=parseFloat(params.get('lng'));if(!isNaN(lat)&&!isNaN(lng)&&lat>=-90&&lat<=90&&lng>=-180&&lng<=180){state.center={lat:lat,lng:lng};}}
if(params.has('z')){const zoom=parseFloat(params.get('z'));if(!isNaN(zoom)){state.zoom=Math.max(1,Math.min(18,zoom));}}
return state;}
function encodeStateToUrl(state){const params=new URLSearchParams();if(state.selectedYear){params.set('y',state.selectedYear);}
if(state.selectedAircraft&&state.selectedAircraft!=='all'){params.set('a',state.selectedAircraft);}
if(state.selectedPathIds&&state.selectedPathIds.length>0){params.set('p',state.selectedPathIds.join(','));}
const vis=[state.heatmapVisible?'1':'0',state.altitudeVisible?'1':'0',state.airspeedVisible?'1':'0',state.airportsVisible?'1':'0',state.aviationVisible?'1':'0',state.statsPanelVisible?'1':'0'].join('');if(vis!=='100100'){params.set('v',vis);}
if(state.center){params.set('lat',state.center.lat.toFixed(6));params.set('lng',state.center.lng.toFixed(6));}
if(state.zoom!==undefined){params.set('z',state.zoom.toFixed(2));}
return params.toString();}
function updateUrl(state){const urlParams=encodeStateToUrl(state);const newUrl=urlParams?'?'+urlParams:window.location.pathname;try{history.replaceState(null,'',newUrl);}catch(e){}}
function loadState(){const urlState=parseUrlParams();if(urlState&&Object.keys(urlState).length>0){return urlState;}
return loadMapState();}
var map=L.map('map',{center:CENTER,zoom:10,zoomSnap:0.25,zoomDelta:0.25,wheelPxPerZoomLevel:120,preferCanvas:true});if(STADIA_API_KEY){L.tileLayer('https://tiles.stadiamaps.com/tiles/alidade_smooth_dark/{z}/{x}/{y}{r}.png?api_key='+STADIA_API_KEY,{attribution:'&copy; <a href="https://stadiamaps.com/">Stadia Maps</a>'}).addTo(map);}else{L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',{attribution:'&copy; OpenStreetMap contributors, &copy; CARTO'}).addTo(map);}
const savedState=loadState();var restoredYearFromState=false;if(savedState){if(savedState.selectedYear!==undefined){selectedYear=savedState.selectedYear;restoredYearFromState=true;}
if(savedState.selectedAircraft){selectedAircraft=savedState.selectedAircraft;}}
if(savedState&&savedState.center&&savedState.zoom){map.setView([savedState.center.lat,savedState.center.lng],savedState.zoom);}else{map.fitBounds(BOUNDS,{padding:[30,30]});}
var altitudeRenderer=L.svg();var airspeedRenderer=L.svg();var heatmapLayer=null;var altitudeLayer=L.layerGroup();var airspeedLayer=L.layerGroup();var airportLayer=L.layerGroup();var currentResolution=null;var loadedData={};var currentData=null;var fullStats=null;var fullPathInfo=null;var fullPathSegments=null;var altitudeRange={min:0,max:10000};var airspeedRange={min:0,max:200};var heatmapVisible=savedState&&savedState.heatmapVisible!==undefined?savedState.heatmapVisible:true;var altitudeVisible=savedState&&savedState.altitudeVisible!==undefined?savedState.altitudeVisible:false;var airspeedVisible=savedState&&savedState.airspeedVisible!==undefined?savedState.airspeedVisible:false;var airportsVisible=savedState&&savedState.airportsVisible!==undefined?savedState.airportsVisible:true;var aviationVisible=savedState&&savedState.aviationVisible!==undefined?savedState.aviationVisible:false;var selectedPathIds=new Set();var pathSegments={};var pathToAirports={};var airportToPaths={};var airportMarkers={};var replayActive=false;var replayPlaying=false;var replayCurrentTime=0;var replayMaxTime=0;var replaySpeed=50.0;var replayInterval=null;var replayLayer=null;var replaySegments=[];var replayAirplaneMarker=null;var replayLastDrawnIndex=-1;var replayLastBearing=null;var replayAnimationFrameId=null;var replayLastFrameTime=null;var replayColorMinAlt=0;var replayColorMaxAlt=10000;var replayColorMinSpeed=0;var replayColorMaxSpeed=200;var replayAutoZoom=false;var replayLastZoom=null;var replayRecenterTimestamps=[];var buttonsHidden=false;var openaipLayers={};if(OPENAIP_API_KEY){openaipLayers['Aviation Data']=L.tileLayer('https://{s}.api.tiles.openaip.net/api/data/openaip/{z}/{x}/{y}.png?apiKey='+OPENAIP_API_KEY,{attribution:'&copy; <a href="https://www.openaip.net">OpenAIP</a>',maxZoom:18,minZoom:7,subdomains:['a','b','c']});}
if(airportsVisible){airportLayer.addTo(map);}
document.getElementById('heatmap-btn').style.opacity=heatmapVisible?'1.0':'0.5';document.getElementById('altitude-btn').style.opacity=altitudeVisible?'1.0':'0.5';document.getElementById('airspeed-btn').style.opacity=airspeedVisible?'1.0':'0.5';document.getElementById('airports-btn').style.opacity=airportsVisible?'1.0':'0.5';document.getElementById('aviation-btn').style.opacity=aviationVisible?'1.0':'0.5';if(OPENAIP_API_KEY){document.getElementById('aviation-btn').style.display='block';}
function getResolutionForZoom(zoom){if(zoom<=4)return'z0_4';if(zoom<=7)return'z5_7';if(zoom<=10)return'z8_10';if(zoom<=13)return'z11_13';return'z14_plus';}
function showLoading(){document.getElementById('loading').style.display='block';}
function hideLoading(){document.getElementById('loading').style.display='none';}
async function loadData(resolution,year){if(!year){year=selectedYear||'all';}
const cacheKey=resolution+'_'+year;if(loadedData[cacheKey]){return loadedData[cacheKey];}
if(year==='all'){return await loadAndCombineAllYears(resolution);}
showLoading();try{const filename=DATA_DIR+'/'+year+'/'+resolution+'.json';const response=await fetch(filename);const data=await response.json();loadedData[cacheKey]=data;console.log('Loaded '+resolution+' ('+year+'):',data.downsampled_points+' points');return data;}catch(error){console.error('Error loading data for year '+year+':',error);return null;}finally{hideLoading();}}
async function loadAndCombineAllYears(resolution){const cacheKey=resolution+'_all';if(loadedData[cacheKey]){return loadedData[cacheKey];}
showLoading();try{const metadata=await loadMetadata();if(!metadata||!metadata.available_years){console.error('No metadata or available years found');return null;}
console.log('Loading all years for '+resolution+':',metadata.available_years);const promises=metadata.available_years.map(year=>loadData(resolution,year.toString()));const yearDatasets=await Promise.all(promises);const combined={coordinates:[],path_segments:[],path_info:[],resolution:resolution,original_points:0,downsampled_points:0};yearDatasets.forEach(data=>{if(!data)return;combined.coordinates.push(...data.coordinates);combined.path_segments.push(...data.path_segments);combined.path_info.push(...data.path_info);combined.original_points+=data.original_points||0;combined.downsampled_points+=data.downsampled_points||0;});combined.compression_ratio=combined.original_points>0?(combined.downsampled_points/combined.original_points*100):100;loadedData[cacheKey]=combined;console.log('Combined all years for '+resolution+':',combined.downsampled_points+' points');return combined;}catch(error){console.error('Error loading and combining all years:',error);return null;}finally{hideLoading();}}
async function loadAirports(){try{const response=await fetch(DATA_DIR+'/airports.json');const data=await response.json();return data.airports;}catch(error){console.error('Error loading airports:',error);return[];}}
function calculateAirportFlightCounts(){if(!fullPathInfo)return{};var counts={};var filteredPaths=fullPathInfo.filter(function(pathInfo){if(selectedYear!=='all'){if(!pathInfo.year||pathInfo.year.toString()!==selectedYear){return false;}}
if(selectedAircraft!=='all'){if(!pathInfo.aircraft_registration||pathInfo.aircraft_registration!==selectedAircraft){return false;}}
return true;});filteredPaths.forEach(function(pathInfo){var uniqueAirports=new Set();if(pathInfo.start_airport){uniqueAirports.add(pathInfo.start_airport);}
if(pathInfo.end_airport){uniqueAirports.add(pathInfo.end_airport);}
uniqueAirports.forEach(function(airport){counts[airport]=(counts[airport]||0)+1;});});return counts;}
function updateAirportPopups(){if(!allAirportsData||!airportMarkers)return;var airportCounts=calculateAirportFlightCounts();var homeBaseName=null;var maxCount=0;Object.keys(airportCounts).forEach(function(name){if(airportCounts[name]>maxCount){maxCount=airportCounts[name];homeBaseName=name;}});allAirportsData.forEach(function(airport){var marker=airportMarkers[airport.name];if(!marker)return;var flightCount=airportCounts[airport.name]||0;var isHomeBase=airport.name===homeBaseName;const icaoMatch=airport.name?airport.name.match(/\b([A-Z]{4})\b/):null;const icao=icaoMatch?icaoMatch[1]:'APT';const latDms=ddToDms(airport.lat,true);const lonDms=ddToDms(airport.lon,false);const googleMapsLink=`https://www.google.com/maps?q=${airport.lat},${airport.lon}`;const popup=`
        <div style="
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            min-width: 220px;
            padding: 8px 4px;
            background-color: #2b2b2b;
            color: #ffffff;
        ">
            <div style="
                font-size: 15px;
                font-weight: bold;
                color: #28a745;
                margin-bottom: 10px;
                padding-bottom: 8px;
                border-bottom: 2px solid #28a745;
                display: flex;
                align-items: center;
                gap: 6px;
            ">
                <span style="font-size: 18px;">üõ´</span>
                <span>${airport.name || 'Unknown'}</span>
                ${isHomeBase ? '<span style="font-size: 12px; background: #007bff; color: white; padding: 2px 6px; border-radius: 3px; margin-left: 4px;">HOME</span>' : ''}
            </div>
            <div style="margin-bottom: 8px;">
                <div style="font-size: 11px; color: #999; margin-bottom: 2px; text-transform: uppercase; letter-spacing: 0.5px;">Coordinates</div>
                <a href="${googleMapsLink}"
                   target="_blank"
                   style="
                       color: #4facfe;
                       text-decoration: none;
                       font-size: 12px;
                       font-family: monospace;
                       display: flex;
                       align-items: center;
                       gap: 4px;
                   "
                   onmouseover="this.style.textDecoration='underline'"
                   onmouseout="this.style.textDecoration='none'">
                    <span>üìç</span>
                    <span>${latDms}<br>${lonDms}</span>
                </a>
            </div>
            <div style="
                background: linear-gradient(135deg, rgba(79, 172, 254, 0.15) 0%, rgba(0, 242, 254, 0.15) 100%);
                padding: 8px 10px;
                border-radius: 6px;
                border-left: 3px solid #4facfe;
                display: flex;
                justify-content: space-between;
                align-items: center;
            ">
                <span style="font-size: 12px; color: #ccc; font-weight: 500;">Total Flights</span>
                <span style="font-size: 16px; font-weight: bold; color: #4facfe;">${flightCount}</span>
            </div>
        </div>`;marker.setPopupContent(popup);});}
async function loadMetadata(){try{const response=await fetch(DATA_DIR+'/metadata.json');return await response.json();}catch(error){console.error('Error loading metadata:',error);return null;}}
async function updateLayers(){const zoom=map.getZoom();const resolution=getResolutionForZoom(zoom);if(resolution===currentResolution){return;}
currentResolution=resolution;const data=await loadData(resolution,selectedYear);if(!data)return;currentData=data;var filteredCoordinates=data.coordinates;if((selectedYear!=='all'||selectedAircraft!=='all')&&data.path_segments){var filteredPathIds=new Set();if(data.path_info){data.path_info.forEach(function(pathInfo){var matchesYear=selectedYear==='all'||(pathInfo.year&&pathInfo.year.toString()===selectedYear);var matchesAircraft=selectedAircraft==='all'||(pathInfo.aircraft_registration===selectedAircraft);if(matchesYear&&matchesAircraft){filteredPathIds.add(pathInfo.id);}});}
var coordSet=new Set();data.path_segments.forEach(function(segment){if(filteredPathIds.has(segment.path_id)){var coords=segment.coords;if(coords&&coords.length===2){coordSet.add(JSON.stringify(coords[0]));coordSet.add(JSON.stringify(coords[1]));}}});filteredCoordinates=Array.from(coordSet).map(function(str){return JSON.parse(str);});}
if(heatmapLayer){map.removeLayer(heatmapLayer);}
heatmapLayer=L.heatLayer(filteredCoordinates,{radius:10,blur:15,minOpacity:0.25,maxOpacity:0.6,max:1.0,gradient:{0.0:'blue',0.3:'cyan',0.5:'lime',0.7:'yellow',1.0:'red'}});if(heatmapLayer._canvas){heatmapLayer._canvas.style.pointerEvents='none';}
if(heatmapVisible&&!replayActive){heatmapLayer.addTo(map);}
pathToAirports={};airportToPaths={};if(data.path_info){data.path_info.forEach(function(pathInfo){var pathId=pathInfo.id;pathToAirports[pathId]={start:pathInfo.start_airport,end:pathInfo.end_airport};if(pathInfo.start_airport){if(!airportToPaths[pathInfo.start_airport]){airportToPaths[pathInfo.start_airport]=[];}
airportToPaths[pathInfo.start_airport].push(pathId);}
if(pathInfo.end_airport){if(!airportToPaths[pathInfo.end_airport]){airportToPaths[pathInfo.end_airport]=[];}
airportToPaths[pathInfo.end_airport].push(pathId);}});}
if(data.path_segments&&data.path_segments.length>0){var altitudes=data.path_segments.map(function(s){return s.altitude_ft;});altitudeRange.min=Math.min(...altitudes);altitudeRange.max=Math.max(...altitudes);}
redrawAltitudePaths();if(airspeedVisible){redrawAirspeedPaths();}
console.log('Updated to '+resolution+' resolution');}
function redrawAltitudePaths(){if(!currentData)return;altitudeLayer.clearLayers();pathSegments={};var colorMinAlt,colorMaxAlt;if(selectedPathIds.size>0){var selectedSegments=currentData.path_segments.filter(function(segment){return selectedPathIds.has(segment.path_id);});if(selectedSegments.length>0){var altitudes=selectedSegments.map(function(s){return s.altitude_ft;});colorMinAlt=Math.min(...altitudes);colorMaxAlt=Math.max(...altitudes);}else{colorMinAlt=altitudeRange.min;colorMaxAlt=altitudeRange.max;}}else{colorMinAlt=altitudeRange.min;colorMaxAlt=altitudeRange.max;}
currentData.path_segments.forEach(function(segment){var pathId=segment.path_id;var pathInfo=currentData.path_info.find(function(p){return p.id===pathId;});if(selectedYear!=='all'){if(pathInfo&&pathInfo.year&&pathInfo.year.toString()!==selectedYear){return;}}
if(selectedAircraft!=='all'){if(pathInfo&&pathInfo.aircraft_registration!==selectedAircraft){return;}}
var isSelected=selectedPathIds.has(pathId);var color=getColorForAltitude(segment.altitude_ft,colorMinAlt,colorMaxAlt);var polyline=L.polyline(segment.coords,{color:color,weight:isSelected?6:4,opacity:isSelected?1.0:(selectedPathIds.size>0?0.1:0.85),renderer:altitudeRenderer,interactive:true}).bindPopup('Altitude: '+segment.altitude_ft+' ft ('+segment.altitude_m+' m)').addTo(altitudeLayer);polyline.on('click',function(e){L.DomEvent.stopPropagation(e);togglePathSelection(pathId);});if(!pathSegments[pathId]){pathSegments[pathId]=[];}
pathSegments[pathId].push(polyline);});updateAltitudeLegend(colorMinAlt,colorMaxAlt);updateAirportOpacity();updateStatsForSelection();}
function getColorForAltitude(altitude,minAlt,maxAlt){var normalized=(altitude-minAlt)/Math.max(maxAlt-minAlt,1);normalized=Math.max(0,Math.min(1,normalized));var r,g,b;if(normalized<0.2){var t=normalized/0.2;r=Math.round(80*(1-t));g=Math.round(160+95*t);b=255;}else if(normalized<0.4){var t=(normalized-0.2)/0.2;r=0;g=255;b=Math.round(255*(1-t));}else if(normalized<0.6){var t=(normalized-0.4)/0.2;r=Math.round(255*t);g=255;b=0;}else if(normalized<0.8){var t=(normalized-0.6)/0.2;r=255;g=Math.round(255*(1-t*0.35));b=0;}else{var t=(normalized-0.8)/0.2;r=255;g=Math.round(165*(1-t*0.6));b=Math.round(66*t);}
return'rgb('+r+','+g+','+b+')';}
function updateAirportOpacity(){var hasFilters=selectedYear!=='all'||selectedAircraft!=='all';var hasSelection=selectedPathIds.size>0;if(!hasFilters&&!hasSelection){Object.keys(airportMarkers).forEach(function(airportName){var marker=airportMarkers[airportName];marker.setOpacity(1.0);});return;}
var visibleAirports=new Set();if(hasFilters&&fullPathInfo){fullPathInfo.forEach(function(pathInfo){var matchesYear=selectedYear==='all'||(pathInfo.year&&pathInfo.year.toString()===selectedYear);var matchesAircraft=selectedAircraft==='all'||(pathInfo.aircraft_registration===selectedAircraft);if(matchesYear&&matchesAircraft){if(pathInfo.start_airport)visibleAirports.add(pathInfo.start_airport);if(pathInfo.end_airport)visibleAirports.add(pathInfo.end_airport);}});}
if(hasSelection){selectedPathIds.forEach(function(pathId){if(fullPathInfo){var pathInfo=fullPathInfo.find(function(p){return p.id===pathId;});if(pathInfo){if(pathInfo.start_airport)visibleAirports.add(pathInfo.start_airport);if(pathInfo.end_airport)visibleAirports.add(pathInfo.end_airport);}}else{var airports=pathToAirports[pathId];if(airports){if(airports.start)visibleAirports.add(airports.start);if(airports.end)visibleAirports.add(airports.end);}}});}
Object.keys(airportMarkers).forEach(function(airportName){var marker=airportMarkers[airportName];if(visibleAirports.has(airportName)){marker.setOpacity(1.0);}else{marker.setOpacity(0.0);}});}
function calculateFilteredStats(){if(!fullPathInfo||!fullPathSegments){return fullStats;}
var filteredPathInfo=fullPathInfo.filter(function(pathInfo){if(selectedYear!=='all'){if(!pathInfo.year||pathInfo.year.toString()!==selectedYear){return false;}}
if(selectedAircraft!=='all'){if(!pathInfo.aircraft_registration||pathInfo.aircraft_registration!==selectedAircraft){return false;}}
return true;});if(filteredPathInfo.length===0){return{total_points:0,num_paths:0,num_airports:0,airport_names:[],num_aircraft:0,aircraft_list:[],total_distance_nm:0};}
var airports=new Set();filteredPathInfo.forEach(function(pathInfo){if(pathInfo.start_airport)airports.add(pathInfo.start_airport);if(pathInfo.end_airport)airports.add(pathInfo.end_airport);});var aircraftMap={};filteredPathInfo.forEach(function(pathInfo){if(pathInfo.aircraft_registration){var reg=pathInfo.aircraft_registration;if(!aircraftMap[reg]){aircraftMap[reg]={registration:reg,type:pathInfo.aircraft_type,flights:0};}
aircraftMap[reg].flights+=1;}});if(selectedAircraft!=='all'&&selectedYear==='all'&&fullStats&&fullStats.aircraft_list){var fullAircraft=fullStats.aircraft_list.find(function(a){return a.registration===selectedAircraft;});if(fullAircraft&&aircraftMap[selectedAircraft]){aircraftMap[selectedAircraft].flights=fullAircraft.flights;}}
var aircraftList=Object.values(aircraftMap).sort(function(a,b){return b.flights-a.flights;});var filteredSegments=fullPathSegments.filter(function(segment){var pathInfo=filteredPathInfo.find(function(p){return p.id===segment.path_id;});return pathInfo!==undefined;});var totalDistanceKm=0;if(selectedAircraft!=='all'&&selectedYear==='all'&&fullStats&&fullStats.aircraft_list){var fullAircraft=fullStats.aircraft_list.find(function(a){return a.registration===selectedAircraft;});if(fullAircraft&&fullAircraft.flight_distance_km){totalDistanceKm=fullAircraft.flight_distance_km;}}else{filteredSegments.forEach(function(segment){var coords=segment.coords;if(coords&&coords.length===2){var lat1=coords[0][0]*Math.PI/180;var lon1=coords[0][1]*Math.PI/180;var lat2=coords[1][0]*Math.PI/180;var lon2=coords[1][1]*Math.PI/180;var dlat=lat2-lat1;var dlon=lon2-lon1;var a=Math.sin(dlat/2)*Math.sin(dlat/2)+
Math.cos(lat1)*Math.cos(lat2)*Math.sin(dlon/2)*Math.sin(dlon/2);var c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));totalDistanceKm+=6371*c;}});}
var altitudes=filteredSegments.map(function(s){return s.altitude_m;});var maxAltitudeM=altitudes.length>0?Math.max(...altitudes):0;var minAltitudeM=altitudes.length>0?Math.min(...altitudes):0;var groundspeeds=filteredSegments.map(function(s){return s.groundspeed_knots;}).filter(function(s){return s>0;});var maxGroundspeedKnots=groundspeeds.length>0?Math.max(...groundspeeds):0;var avgGroundspeedKnots=0;if(groundspeeds.length>0){avgGroundspeedKnots=groundspeeds.reduce(function(a,b){return a+b;},0)/groundspeeds.length;}
var totalAltitudeGainM=0;var prevAltM=null;filteredSegments.forEach(function(segment){if(prevAltM!==null&&segment.altitude_m>prevAltM){totalAltitudeGainM+=segment.altitude_m-prevAltM;}
prevAltM=segment.altitude_m;});var longestFlightKm=0;var pathDistances={};filteredSegments.forEach(function(segment){var coords=segment.coords;if(coords&&coords.length===2){var lat1=coords[0][0]*Math.PI/180;var lon1=coords[0][1]*Math.PI/180;var lat2=coords[1][0]*Math.PI/180;var lon2=coords[1][1]*Math.PI/180;var dlat=lat2-lat1;var dlon=lon2-lon1;var a=Math.sin(dlat/2)*Math.sin(dlat/2)+
Math.cos(lat1)*Math.cos(lat2)*Math.sin(dlon/2)*Math.sin(dlon/2);var c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));var dist=6371*c;if(!pathDistances[segment.path_id]){pathDistances[segment.path_id]=0;}
pathDistances[segment.path_id]+=dist;}});Object.values(pathDistances).forEach(function(dist){if(dist>longestFlightKm)longestFlightKm=dist;});var totalFlightTimeSeconds=0;if(filteredSegments.length>0&&filteredSegments[0].time!==undefined){var segmentsByPath={};filteredSegments.forEach(function(seg){if(!segmentsByPath[seg.path_id]){segmentsByPath[seg.path_id]=[];}
segmentsByPath[seg.path_id].push(seg);});Object.keys(segmentsByPath).forEach(function(pathId){var pathSegments=segmentsByPath[pathId];pathSegments.sort(function(a,b){return a.time-b.time;});if(pathSegments.length>0){var pathDuration=pathSegments[pathSegments.length-1].time-pathSegments[0].time;totalFlightTimeSeconds+=pathDuration;}});}
var hours=Math.floor(totalFlightTimeSeconds/3600);var minutes=Math.floor((totalFlightTimeSeconds%3600)/60);var totalFlightTimeStr=hours+'h '+minutes+'m';var cruiseSegments=filteredSegments.filter(function(seg){return seg.altitude_ft>(minAltitudeM*3.28084+1000);});var cruiseSpeedKnots=0;if(cruiseSegments.length>0){var cruiseSpeeds=cruiseSegments.map(function(s){return s.groundspeed_knots;}).filter(function(s){return s>0;});if(cruiseSpeeds.length>0){cruiseSpeedKnots=cruiseSpeeds.reduce(function(a,b){return a+b;},0)/cruiseSpeeds.length;}}
var altitudeBins={};if(cruiseSegments.length>0&&cruiseSegments[0].time!==undefined&&cruiseSegments[0].path_id!==undefined){var segmentsByPath={};cruiseSegments.forEach(function(seg){if(!segmentsByPath[seg.path_id]){segmentsByPath[seg.path_id]=[];}
segmentsByPath[seg.path_id].push(seg);});Object.keys(segmentsByPath).forEach(function(pathId){var pathSegments=segmentsByPath[pathId];pathSegments.sort(function(a,b){return a.time-b.time;});for(var i=0;i<pathSegments.length;i++){var seg=pathSegments[i];var bin=Math.round(seg.altitude_ft/100)*100;var duration=0;if(i<pathSegments.length-1){duration=pathSegments[i+1].time-seg.time;}else if(i>0){duration=seg.time-pathSegments[i-1].time;}else{duration=1;}
altitudeBins[bin]=(altitudeBins[bin]||0)+duration;}});}else{cruiseSegments.forEach(function(seg){var bin=Math.round(seg.altitude_ft/100)*100;altitudeBins[bin]=(altitudeBins[bin]||0)+1;});}
var mostCommonCruiseAltFt=0;var maxCount=0;Object.keys(altitudeBins).forEach(function(bin){if(altitudeBins[bin]>maxCount){maxCount=altitudeBins[bin];mostCommonCruiseAltFt=parseInt(bin);}});var totalFlights=aircraftList.reduce(function(sum,aircraft){return sum+aircraft.flights;},0);return{total_points:filteredSegments.length*2,num_paths:totalFlights,num_airports:airports.size,airport_names:Array.from(airports).sort(),num_aircraft:aircraftList.length,aircraft_list:aircraftList,total_distance_nm:totalDistanceKm*0.539957,total_distance_km:totalDistanceKm,longest_flight_nm:longestFlightKm*0.539957,longest_flight_km:longestFlightKm,max_altitude_ft:maxAltitudeM*3.28084,max_altitude_m:maxAltitudeM,min_altitude_ft:minAltitudeM*3.28084,min_altitude_m:minAltitudeM,total_altitude_gain_ft:totalAltitudeGainM*3.28084,total_altitude_gain_m:totalAltitudeGainM,max_groundspeed_knots:maxGroundspeedKnots,average_groundspeed_knots:avgGroundspeedKnots,cruise_speed_knots:cruiseSpeedKnots,most_common_cruise_altitude_ft:mostCommonCruiseAltFt,most_common_cruise_altitude_m:Math.round(mostCommonCruiseAltFt*0.3048),total_flight_time_seconds:totalFlightTimeSeconds,total_flight_time_str:totalFlightTimeStr};}
function updateAircraftDropdown(){if(!fullPathInfo)return;const aircraftSelect=document.getElementById('aircraft-select');const currentSelection=selectedAircraft;while(aircraftSelect.options.length>1){aircraftSelect.remove(1);}
var yearFilteredPathInfo;if(selectedYear==='all'){yearFilteredPathInfo=fullPathInfo;}else{yearFilteredPathInfo=fullPathInfo.filter(function(pathInfo){return pathInfo.year&&pathInfo.year.toString()===selectedYear;});}
var aircraftMap={};yearFilteredPathInfo.forEach(function(pathInfo){if(pathInfo.aircraft_registration){var reg=pathInfo.aircraft_registration;if(!aircraftMap[reg]){aircraftMap[reg]={registration:reg,type:pathInfo.aircraft_type,flights:0};}
aircraftMap[reg].flights+=1;}});var aircraftList=Object.values(aircraftMap).sort(function(a,b){return b.flights-a.flights;});var selectedAircraftExists=false;aircraftList.forEach(function(aircraft){const option=document.createElement('option');option.value=aircraft.registration;var typeStr=aircraft.type?' ('+aircraft.type+')':'';option.textContent='‚úàÔ∏è '+aircraft.registration+typeStr;aircraftSelect.appendChild(option);if(aircraft.registration===currentSelection){selectedAircraftExists=true;}});if(!selectedAircraftExists&&currentSelection!=='all'){selectedAircraft='all';aircraftSelect.value='all';}else{aircraftSelect.value=currentSelection;}}
function filterByYear(){const yearSelect=document.getElementById('year-select');selectedYear=yearSelect.value;loadedData={};currentResolution=null;altitudeLayer.clearLayers();pathSegments={};selectedPathIds.clear();updateLayers();loadData('z14_plus',selectedYear).then(function(fullResData){if(fullResData){fullPathInfo=fullResData.path_info||[];fullPathSegments=fullResData.path_segments||[];}
updateAircraftDropdown();var filteredStats=calculateFilteredStats();updateStatsPanel(filteredStats,false);updateAirportOpacity();updateAirportPopups();});saveMapState();}
function filterByAircraft(){const aircraftSelect=document.getElementById('aircraft-select');selectedAircraft=aircraftSelect.value;altitudeLayer.clearLayers();pathSegments={};selectedPathIds.clear();currentResolution=null;updateLayers();var filteredStats=calculateFilteredStats();updateStatsPanel(filteredStats,false);updateAirportOpacity();updateAirportPopups();saveMapState();}
(async function(){const airports=await loadAirports();allAirportsData=airports;const metadata=await loadMetadata();if(metadata&&metadata.available_years){const yearSelect=document.getElementById('year-select');metadata.available_years.forEach(function(year){const option=document.createElement('option');option.value=year;option.textContent='üìÖ '+year;yearSelect.appendChild(option);});if(selectedYear==='all'&&!restoredYearFromState){const currentYear=metadata.available_years[metadata.available_years.length-1];selectedYear=currentYear.toString();}
if(selectedYear&&selectedYear!=='all'){yearSelect.value=selectedYear;}}
let homeBaseAirport=null;if(airports.length>0){homeBaseAirport=airports.reduce((max,airport)=>airport.flight_count>max.flight_count?airport:max,airports[0]);}
airports.forEach(function(airport){const icaoMatch=airport.name?airport.name.match(/\b([A-Z]{4})\b/):null;const icao=icaoMatch?icaoMatch[1]:'APT';const isHomeBase=homeBaseAirport&&airport.name===homeBaseAirport.name;const homeClass=isHomeBase?' airport-marker-home':'';const homeLabelClass=isHomeBase?' airport-label-home':'';const markerHtml='<div class="airport-marker-container"><div class="airport-marker'+homeClass+'"></div><div class="airport-label'+homeLabelClass+'">'+icao+'</div></div>';const latDms=ddToDms(airport.lat,true);const lonDms=ddToDms(airport.lon,false);const googleMapsLink=`https://www.google.com/maps?q=${airport.lat},${airport.lon}`;const popup=`
        <div style="
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            min-width: 220px;
            padding: 8px 4px;
            background-color: #2b2b2b;
            color: #ffffff;
        ">
            <div style="
                font-size: 15px;
                font-weight: bold;
                color: #28a745;
                margin-bottom: 10px;
                padding-bottom: 8px;
                border-bottom: 2px solid #28a745;
                display: flex;
                align-items: center;
                gap: 6px;
            ">
                <span style="font-size: 18px;">üõ´</span>
                <span>${airport.name || 'Unknown'}</span>
                ${isHomeBase ? '<span style="font-size: 12px; background: #007bff; color: white; padding: 2px 6px; border-radius: 3px; margin-left: 4px;">HOME</span>' : ''}
            </div>
            <div style="margin-bottom: 8px;">
                <div style="font-size: 11px; color: #999; margin-bottom: 2px; text-transform: uppercase; letter-spacing: 0.5px;">Coordinates</div>
                <a href="${googleMapsLink}"
                   target="_blank"
                   style="
                       color: #4facfe;
                       text-decoration: none;
                       font-size: 12px;
                       font-family: monospace;
                       display: flex;
                       align-items: center;
                       gap: 4px;
                   "
                   onmouseover="this.style.textDecoration='underline'"
                   onmouseout="this.style.textDecoration='none'">
                    <span>üìç</span>
                    <span>${latDms}<br>${lonDms}</span>
                </a>
            </div>
            <div style="
                background: linear-gradient(135deg, rgba(79, 172, 254, 0.15) 0%, rgba(0, 242, 254, 0.15) 100%);
                padding: 8px 10px;
                border-radius: 6px;
                border-left: 3px solid #4facfe;
                display: flex;
                justify-content: space-between;
                align-items: center;
            ">
                <span style="font-size: 12px; color: #ccc; font-weight: 500;">Total Flights</span>
                <span style="font-size: 16px; font-weight: bold; color: #4facfe;">${airport.flight_count}</span>
            </div>
        </div>`;var marker=L.marker([airport.lat,airport.lon],{icon:L.divIcon({html:markerHtml,iconSize:[12,12],iconAnchor:[6,6],popupAnchor:[0,-6],className:''}),icao:icao}).bindPopup(popup,{autoPanPadding:[50,50]});marker.on('click',function(e){if(!replayActive){selectPathsByAirport(airport.name);}});marker.addTo(airportLayer);airportMarkers[airport.name]=marker;});if(metadata&&metadata.stats){fullStats=metadata.stats;}
try{const fullResData=await loadData('z14_plus',selectedYear);if(fullResData&&fullResData.path_info){fullPathInfo=fullResData.path_info;}
if(fullResData&&fullResData.path_segments){fullPathSegments=fullResData.path_segments;}}catch(error){console.error('Failed to load full path data:',error);}
updateAircraftDropdown();updateAirportPopups();if(fullStats){const initialStats=calculateFilteredStats();updateStatsPanel(initialStats,false);}
updateAirportOpacity();saveMapState();if(metadata&&metadata.min_groundspeed_knots!==undefined&&metadata.max_groundspeed_knots!==undefined){airspeedRange.min=metadata.min_groundspeed_knots;airspeedRange.max=metadata.max_groundspeed_knots;updateAirspeedLegend(airspeedRange.min,airspeedRange.max);}
updateLayers();updateAirportMarkerSizes();if(altitudeVisible){map.addLayer(altitudeLayer);document.getElementById('altitude-legend').style.display='block';}
if(airspeedVisible){map.addLayer(airspeedLayer);document.getElementById('airspeed-legend').style.display='block';}
if(aviationVisible&&OPENAIP_API_KEY&&openaipLayers['Aviation Data']){map.addLayer(openaipLayers['Aviation Data']);}
if(savedState&&savedState.selectedPathIds&&savedState.selectedPathIds.length>0){savedState.selectedPathIds.forEach(function(pathId){selectedPathIds.add(pathId);});if(altitudeVisible){redrawAltitudePaths();}
if(airspeedVisible){redrawAirspeedPaths();}
updateReplayButtonState();}
if(savedState&&savedState.statsPanelVisible){const panel=document.getElementById('stats-panel');panel.style.display='block';panel.offsetHeight;panel.classList.add('visible');}
map.on('moveend',saveMapState);map.on('zoomend',saveMapState);})();map.on('zoomend',function(){updateLayers();updateAirportMarkerSizes();});map.on('click',function(e){if(replayActive&&replayAirplaneMarker&&replayAirplaneMarker.isPopupOpen()){replayAirplaneMarker.closePopup();}
if(!replayActive&&selectedPathIds.size>0){clearSelection();}});function togglePathSelection(pathId){if(selectedPathIds.has(pathId)){selectedPathIds.delete(pathId);}else{selectedPathIds.add(pathId);}
if(altitudeVisible){redrawAltitudePaths();setTimeout(function(){map.invalidateSize();},50);}
if(airspeedVisible){redrawAirspeedPaths();setTimeout(function(){map.invalidateSize();},50);}
updateReplayButtonState();saveMapState();}
function selectPathsByAirport(airportName){var pathIds=airportToPaths[airportName]||[];pathIds.forEach(function(pathId){selectedPathIds.add(pathId);});if(altitudeVisible){redrawAltitudePaths();setTimeout(function(){map.invalidateSize();},50);}
if(airspeedVisible){redrawAirspeedPaths();setTimeout(function(){map.invalidateSize();},50);}
updateReplayButtonState();saveMapState();}
function clearSelection(){selectedPathIds.clear();if(altitudeVisible){redrawAltitudePaths();setTimeout(function(){map.invalidateSize();},50);}
if(airspeedVisible){redrawAirspeedPaths();setTimeout(function(){map.invalidateSize();},50);}
updateReplayButtonState();saveMapState();}
function updateAirportMarkerSizes(){const zoom=map.getZoom();let sizeClass='';if(zoom>=14){sizeClass='xlarge';}else if(zoom>=12){sizeClass='large';}else if(zoom>=10){sizeClass='medium';}else if(zoom>=8){sizeClass='medium-small';}else if(zoom>=6){sizeClass='small';}
document.querySelectorAll('.airport-marker-container').forEach(function(container){const marker=container.querySelector('.airport-marker');const label=container.querySelector('.airport-label');if(zoom<5){label.style.display='none';}else{label.style.display='';}
container.classList.remove('airport-marker-container-small','airport-marker-container-medium-small','airport-marker-container-medium','airport-marker-container-large','airport-marker-container-xlarge');marker.classList.remove('airport-marker-small','airport-marker-medium-small','airport-marker-medium','airport-marker-large','airport-marker-xlarge');label.classList.remove('airport-label-small','airport-label-medium-small','airport-label-medium','airport-label-large','airport-label-xlarge');if(sizeClass){container.classList.add('airport-marker-container-'+sizeClass);marker.classList.add('airport-marker-'+sizeClass);label.classList.add('airport-label-'+sizeClass);}});}
function updateAltitudeLegend(minAlt,maxAlt){var minFt=Math.round(minAlt);var maxFt=Math.round(maxAlt);var minM=Math.round(minAlt*0.3048);var maxM=Math.round(maxAlt*0.3048);document.getElementById('legend-min').textContent=minFt.toLocaleString()+' ft ('+minM.toLocaleString()+' m)';document.getElementById('legend-max').textContent=maxFt.toLocaleString()+' ft ('+maxM.toLocaleString()+' m)';}
function redrawAirspeedPaths(){if(!currentData){console.warn('redrawAirspeedPaths: No current data available');return;}
airspeedLayer.clearLayers();var colorMinSpeed,colorMaxSpeed;if(selectedPathIds.size>0){var selectedSegments=currentData.path_segments.filter(function(segment){return selectedPathIds.has(segment.path_id)&&segment.groundspeed_knots>0;});if(selectedSegments.length>0){var groundspeeds=selectedSegments.map(function(s){return s.groundspeed_knots;});colorMinSpeed=Math.min(...groundspeeds);colorMaxSpeed=Math.max(...groundspeeds);}else{colorMinSpeed=airspeedRange.min;colorMaxSpeed=airspeedRange.max;}}else{colorMinSpeed=airspeedRange.min;colorMaxSpeed=airspeedRange.max;}
currentData.path_segments.forEach(function(segment){var pathId=segment.path_id;var pathInfo=currentData.path_info.find(function(p){return p.id===pathId;});if(selectedYear!=='all'){if(pathInfo&&pathInfo.year&&pathInfo.year.toString()!==selectedYear){return;}}
if(selectedAircraft!=='all'){if(pathInfo&&pathInfo.aircraft_registration!==selectedAircraft){return;}}
if(segment.groundspeed_knots>0){var isSelected=selectedPathIds.has(pathId);var color=getColorForAltitude(segment.groundspeed_knots,colorMinSpeed,colorMaxSpeed);var kmh=Math.round(segment.groundspeed_knots*1.852);var polyline=L.polyline(segment.coords,{color:color,weight:isSelected?6:4,opacity:isSelected?1.0:(selectedPathIds.size>0?0.1:0.85),renderer:airspeedRenderer,interactive:true}).bindPopup('Groundspeed: '+segment.groundspeed_knots+' kt ('+kmh+' km/h)').addTo(airspeedLayer);polyline.on('click',function(e){L.DomEvent.stopPropagation(e);togglePathSelection(pathId);});}});updateAirspeedLegend(colorMinSpeed,colorMaxSpeed);updateAirportOpacity();updateStatsForSelection();}
function updateAirspeedLegend(minSpeed,maxSpeed){var minKnots=Math.round(minSpeed);var maxKnots=Math.round(maxSpeed);var minKmh=Math.round(minSpeed*1.852);var maxKmh=Math.round(maxSpeed*1.852);document.getElementById('airspeed-legend-min').textContent=minKnots.toLocaleString()+' kt ('+minKmh.toLocaleString()+' km/h)';document.getElementById('airspeed-legend-max').textContent=maxKnots.toLocaleString()+' kt ('+maxKmh.toLocaleString()+' km/h)';}
function updateStatsForSelection(){if(selectedPathIds.size===0){var statsToShow=calculateFilteredStats();if(statsToShow){updateStatsPanel(statsToShow,false);}
return;}
var selectedSegments=currentData.path_segments.filter(function(segment){return selectedPathIds.has(segment.path_id);});if(selectedSegments.length===0)return;var selectedPathInfos=currentData.path_info.filter(function(pathInfo){return selectedPathIds.has(pathInfo.id);});var selectedAirports=new Set();selectedPathInfos.forEach(function(pathInfo){if(pathInfo.start_airport)selectedAirports.add(pathInfo.start_airport);if(pathInfo.end_airport)selectedAirports.add(pathInfo.end_airport);});var selectedAircraftMap={};selectedPathInfos.forEach(function(pathInfo){if(pathInfo.aircraft_registration){var reg=pathInfo.aircraft_registration;if(!selectedAircraftMap[reg]){selectedAircraftMap[reg]={registration:reg,type:pathInfo.aircraft_type,flights:0};}
selectedAircraftMap[reg].flights+=1;}});var selectedAircraftList=Object.values(selectedAircraftMap).sort(function(a,b){return b.flights-a.flights;});var totalDistanceKm=0;selectedSegments.forEach(function(segment){var coords=segment.coords;if(coords&&coords.length===2){var lat1=coords[0][0]*Math.PI/180;var lon1=coords[0][1]*Math.PI/180;var lat2=coords[1][0]*Math.PI/180;var lon2=coords[1][1]*Math.PI/180;var dlat=lat2-lat1;var dlon=lon2-lon1;var a=Math.sin(dlat/2)*Math.sin(dlat/2)+
Math.cos(lat1)*Math.cos(lat2)*Math.sin(dlon/2)*Math.sin(dlon/2);var c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));totalDistanceKm+=6371*c;}});var fullSelectedSegments=selectedSegments;if(fullPathSegments){fullSelectedSegments=fullPathSegments.filter(function(seg){return selectedPathIds.has(seg.path_id);});}
var altitudes=fullSelectedSegments.map(function(s){return s.altitude_m;});var minAltitudeM=Math.min(...altitudes);var maxAltitudeM=Math.max(...altitudes);var totalAltitudeGainM=0;var prevAltitudeM=null;selectedSegments.forEach(function(segment){if(prevAltitudeM!==null){var gain=segment.altitude_m-prevAltitudeM;if(gain>0){totalAltitudeGainM+=gain;}}
prevAltitudeM=segment.altitude_m;});var groundspeeds=selectedSegments.map(function(s){return s.groundspeed_knots;}).filter(function(s){return s>0;});var maxGroundspeedKnots=groundspeeds.length>0?Math.max(...groundspeeds):0;var avgGroundspeedKnots=0;if(groundspeeds.length>0){var sumSpeed=groundspeeds.reduce(function(a,b){return a+b;},0);avgGroundspeedKnots=sumSpeed/groundspeeds.length;}
var longestFlightKm=0;var pathDistances={};selectedSegments.forEach(function(segment){var coords=segment.coords;if(coords&&coords.length===2){var lat1=coords[0][0]*Math.PI/180;var lon1=coords[0][1]*Math.PI/180;var lat2=coords[1][0]*Math.PI/180;var lon2=coords[1][1]*Math.PI/180;var dlat=lat2-lat1;var dlon=lon2-lon1;var a=Math.sin(dlat/2)*Math.sin(dlat/2)+
Math.cos(lat1)*Math.cos(lat2)*Math.sin(dlon/2)*Math.sin(dlon/2);var c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));var dist=6371*c;if(!pathDistances[segment.path_id]){pathDistances[segment.path_id]=0;}
pathDistances[segment.path_id]+=dist;}});Object.values(pathDistances).forEach(function(dist){if(dist>longestFlightKm)longestFlightKm=dist;});var totalFlightTimeSeconds=0;if(fullPathSegments){selectedPathIds.forEach(function(pathId){var pathSegments=fullPathSegments.filter(function(seg){return seg.path_id===pathId&&seg.time!==undefined&&seg.time!==null;});if(pathSegments.length>0){var times=pathSegments.map(function(seg){return seg.time;});var minTime=Math.min(...times);var maxTime=Math.max(...times);totalFlightTimeSeconds+=(maxTime-minTime);}});}else{selectedPathInfos.forEach(function(pathInfo){if(fullStats&&fullStats.total_flight_time_seconds&&fullStats.num_paths>0){totalFlightTimeSeconds+=fullStats.total_flight_time_seconds/fullStats.num_paths;}});}
var hours=Math.floor(totalFlightTimeSeconds/3600);var minutes=Math.floor((totalFlightTimeSeconds%3600)/60);var totalFlightTimeStr=hours+'h '+minutes+'m';var cruiseSegments=fullSelectedSegments.filter(function(seg){return seg.altitude_ft>(minAltitudeM*3.28084+1000);});var cruiseSpeedKnots=0;if(cruiseSegments.length>0){var cruiseSpeeds=cruiseSegments.map(function(s){return s.groundspeed_knots;}).filter(function(s){return s>0;});if(cruiseSpeeds.length>0){cruiseSpeedKnots=cruiseSpeeds.reduce(function(a,b){return a+b;},0)/cruiseSpeeds.length;}}
var altitudeBins={};if(cruiseSegments.length>0&&cruiseSegments[0].time!==undefined&&cruiseSegments[0].path_id!==undefined){var segmentsByPath={};cruiseSegments.forEach(function(seg){if(!segmentsByPath[seg.path_id]){segmentsByPath[seg.path_id]=[];}
segmentsByPath[seg.path_id].push(seg);});Object.keys(segmentsByPath).forEach(function(pathId){var pathSegments=segmentsByPath[pathId];pathSegments.sort(function(a,b){return a.time-b.time;});for(var i=0;i<pathSegments.length;i++){var seg=pathSegments[i];var bin=Math.round(seg.altitude_ft/100)*100;var duration=0;if(i<pathSegments.length-1){duration=pathSegments[i+1].time-seg.time;}else if(i>0){duration=seg.time-pathSegments[i-1].time;}else{duration=1;}
altitudeBins[bin]=(altitudeBins[bin]||0)+duration;}});}else{cruiseSegments.forEach(function(seg){var bin=Math.round(seg.altitude_ft/100)*100;altitudeBins[bin]=(altitudeBins[bin]||0)+1;});}
var mostCommonCruiseAltFt=0;var maxCount=0;Object.keys(altitudeBins).forEach(function(bin){if(altitudeBins[bin]>maxCount){maxCount=altitudeBins[bin];mostCommonCruiseAltFt=parseInt(bin);}});var selectedStats={total_points:selectedSegments.length*2,num_paths:selectedPathIds.size,num_airports:selectedAirports.size,airport_names:Array.from(selectedAirports).sort(),num_aircraft:selectedAircraftList.length,aircraft_list:selectedAircraftList,total_distance_nm:totalDistanceKm*0.539957,total_distance_km:totalDistanceKm,longest_flight_nm:longestFlightKm*0.539957,longest_flight_km:longestFlightKm,max_altitude_ft:maxAltitudeM*3.28084,max_altitude_m:maxAltitudeM,min_altitude_ft:minAltitudeM*3.28084,min_altitude_m:minAltitudeM,total_altitude_gain_ft:totalAltitudeGainM*3.28084,total_altitude_gain_m:totalAltitudeGainM,average_groundspeed_knots:avgGroundspeedKnots,max_groundspeed_knots:maxGroundspeedKnots,cruise_speed_knots:cruiseSpeedKnots,most_common_cruise_altitude_ft:mostCommonCruiseAltFt,most_common_cruise_altitude_m:Math.round(mostCommonCruiseAltFt*0.3048),total_flight_time_seconds:totalFlightTimeSeconds,total_flight_time_str:totalFlightTimeStr};updateStatsPanel(selectedStats,true);}
function updateStatsPanel(stats,isSelection){let html='';if(isSelection){html+='<p style="margin:0 0 10px 0; font-weight:bold; font-size:15px;">üìä Selected Paths Statistics</p>';html+='<div style="background-color: #3a5a7a; padding: 4px 8px; margin-bottom: 8px; border-radius: 3px; font-size: 11px; color: #a0c0e0;">Showing stats for '+stats.num_paths+' selected path(s)</div>';}else{html+='<p style="margin:0 0 10px 0; font-weight:bold; font-size:15px;">üìä Flight Statistics</p>';}
html+='<div style="margin-bottom: 8px;"><strong>Data Points:</strong> '+stats.total_points.toLocaleString()+'</div>';html+='<div style="margin-bottom: 8px;"><strong>Flights:</strong> '+stats.num_paths+'</div>';if(stats.airport_names&&stats.airport_names.length>0){html+='<div style="margin-bottom: 8px; max-height: 150px; overflow-y: auto;"><strong>Airports ('+stats.num_airports+'):</strong><br>';stats.airport_names.forEach(function(name){html+='<span style="margin-left: 10px;">‚Ä¢ '+name+'</span><br>';});html+='</div>';}
if(stats.num_aircraft&&stats.num_aircraft>0&&stats.aircraft_list&&stats.aircraft_list.length>0){html+='<div style="margin-bottom: 8px; max-height: 150px; overflow-y: auto;"><strong>Aircrafts ('+stats.num_aircraft+'):</strong><br>';stats.aircraft_list.forEach(function(aircraft){var typeStr=aircraft.type?' ('+aircraft.type+')':'';html+='<span style="margin-left: 10px;">‚Ä¢ '+aircraft.registration+typeStr+' - '+aircraft.flights+' flight(s)</span><br>';});html+='</div>';}
if(stats.total_flight_time_str){html+='<div style="margin-bottom: 8px;"><strong>Total Flight Time:</strong> '+stats.total_flight_time_str+'</div>';}
var distanceKm=(stats.total_distance_nm*1.852).toFixed(1);html+='<div style="margin-bottom: 8px;"><strong>Distance:</strong> '+stats.total_distance_nm.toFixed(1)+' nm ('+distanceKm+' km)</div>';if(stats.num_paths>0){var avgDistanceNm=(stats.total_distance_nm/stats.num_paths).toFixed(1);var avgDistanceKm=(avgDistanceNm*1.852).toFixed(1);html+='<div style="margin-bottom: 8px;"><strong>Average Distance per Trip:</strong> '+avgDistanceNm+' nm ('+avgDistanceKm+' km)</div>';}
if(stats.longest_flight_nm&&stats.longest_flight_nm>0){var longestKm=stats.longest_flight_km.toFixed(1);html+='<div style="margin-bottom: 8px;"><strong>Longest Flight:</strong> '+stats.longest_flight_nm.toFixed(1)+' nm ('+longestKm+' km)</div>';}
if(stats.average_groundspeed_knots&&stats.average_groundspeed_knots>0){var kmh=Math.round(stats.average_groundspeed_knots*1.852);html+='<div style="margin-bottom: 8px;"><strong>Average Groundspeed:</strong> '+Math.round(stats.average_groundspeed_knots)+' kt ('+kmh+' km/h)</div>';}
if(stats.cruise_speed_knots&&stats.cruise_speed_knots>0){var kmh_cruise=Math.round(stats.cruise_speed_knots*1.852);html+='<div style="margin-bottom: 8px;"><strong>Cruise Speed (>1000ft AGL):</strong> '+Math.round(stats.cruise_speed_knots)+' kt ('+kmh_cruise+' km/h)</div>';}
if(stats.max_groundspeed_knots&&stats.max_groundspeed_knots>0){var kmh_max=Math.round(stats.max_groundspeed_knots*1.852);html+='<div style="margin-bottom: 8px;"><strong>Max Groundspeed:</strong> '+Math.round(stats.max_groundspeed_knots)+' kt ('+kmh_max+' km/h)</div>';}
if(stats.max_altitude_ft){var maxAltitudeM=Math.round(stats.max_altitude_ft*0.3048);html+='<div style="margin-bottom: 8px;"><strong>Max Altitude (MSL):</strong> '+Math.round(stats.max_altitude_ft)+' ft ('+maxAltitudeM+' m)</div>';if(stats.total_altitude_gain_ft){var elevationGainM=Math.round(stats.total_altitude_gain_ft*0.3048);html+='<div style="margin-bottom: 8px;"><strong>Elevation Gain:</strong> '+Math.round(stats.total_altitude_gain_ft)+' ft ('+elevationGainM+' m)</div>';}}
if(stats.most_common_cruise_altitude_ft&&stats.most_common_cruise_altitude_ft>0){var cruiseAltM=Math.round(stats.most_common_cruise_altitude_m);html+='<div style="margin-bottom: 8px;"><strong>Most Common Cruise Altitude (AGL):</strong> '+stats.most_common_cruise_altitude_ft.toLocaleString()+' ft ('+cruiseAltM.toLocaleString()+' m)</div>';}
document.getElementById('stats-panel').innerHTML=html;}
function toggleStats(){const panel=document.getElementById('stats-panel');if(panel.classList.contains('visible')){panel.classList.remove('visible');setTimeout(()=>{panel.style.display='none';saveMapState();},300);}else{panel.style.display='block';panel.offsetHeight;panel.classList.add('visible');saveMapState();}}
function toggleHeatmap(){if(heatmapVisible){if(heatmapLayer){map.removeLayer(heatmapLayer);}
heatmapVisible=false;document.getElementById('heatmap-btn').style.opacity='0.5';}else{if(heatmapLayer){map.addLayer(heatmapLayer);if(heatmapLayer._canvas){heatmapLayer._canvas.style.pointerEvents='none';}}
heatmapVisible=true;document.getElementById('heatmap-btn').style.opacity='1.0';}
saveMapState();}
function toggleAltitude(){if(altitudeVisible){if(replayActive&&!airspeedVisible){return;}
map.removeLayer(altitudeLayer);altitudeVisible=false;document.getElementById('altitude-btn').style.opacity='0.5';document.getElementById('altitude-legend').style.display='none';}else{if(airspeedVisible){if(!replayActive){map.removeLayer(airspeedLayer);}
airspeedVisible=false;document.getElementById('airspeed-btn').style.opacity='0.5';document.getElementById('airspeed-legend').style.display='none';}
if(!replayActive){map.addLayer(altitudeLayer);redrawAltitudePaths();}else{var savedTime=replayCurrentTime;var savedIndex=replayLastDrawnIndex;replayLayer.clearLayers();replayLastDrawnIndex=-1;for(var i=0;i<=savedIndex&&i<replaySegments.length;i++){var seg=replaySegments[i];if(seg.time<=savedTime){var segmentColor=getColorForAltitude(seg.altitude_ft,replayColorMinAlt,replayColorMaxAlt);L.polyline(seg.coords,{color:segmentColor,weight:3,opacity:0.8}).addTo(replayLayer);replayLastDrawnIndex=i;}}}
altitudeVisible=true;document.getElementById('altitude-btn').style.opacity='1.0';document.getElementById('altitude-legend').style.display='block';}
if(replayActive&&replayAirplaneMarker&&replayAirplaneMarker.isPopupOpen()){updateReplayAirplanePopup();}
saveMapState();}
function toggleAirspeed(){if(airspeedVisible){if(replayActive&&!altitudeVisible){return;}
map.removeLayer(airspeedLayer);airspeedVisible=false;document.getElementById('airspeed-btn').style.opacity='0.5';document.getElementById('airspeed-legend').style.display='none';}else{if(altitudeVisible){if(!replayActive){map.removeLayer(altitudeLayer);}
altitudeVisible=false;document.getElementById('altitude-btn').style.opacity='0.5';document.getElementById('altitude-legend').style.display='none';}
if(!replayActive){map.addLayer(airspeedLayer);redrawAirspeedPaths();}else{var savedTime=replayCurrentTime;var savedIndex=replayLastDrawnIndex;replayLayer.clearLayers();replayLastDrawnIndex=-1;for(var i=0;i<=savedIndex&&i<replaySegments.length;i++){var seg=replaySegments[i];if(seg.time<=savedTime&&seg.groundspeed_knots>0){var segmentColor=getColorForAltitude(seg.groundspeed_knots,replayColorMinSpeed,replayColorMaxSpeed);L.polyline(seg.coords,{color:segmentColor,weight:3,opacity:0.8}).addTo(replayLayer);replayLastDrawnIndex=i;}}}
airspeedVisible=true;document.getElementById('airspeed-btn').style.opacity='1.0';document.getElementById('airspeed-legend').style.display='block';}
if(replayActive&&replayAirplaneMarker&&replayAirplaneMarker.isPopupOpen()){updateReplayAirplanePopup();}
saveMapState();}
function toggleAirports(){if(airportsVisible){map.removeLayer(airportLayer);airportsVisible=false;document.getElementById('airports-btn').style.opacity='0.5';}else{map.addLayer(airportLayer);airportsVisible=true;document.getElementById('airports-btn').style.opacity='1.0';}
saveMapState();}
function toggleAviation(){if(OPENAIP_API_KEY&&openaipLayers['Aviation Data']){if(aviationVisible){map.removeLayer(openaipLayers['Aviation Data']);aviationVisible=false;document.getElementById('aviation-btn').style.opacity='0.5';}else{map.addLayer(openaipLayers['Aviation Data']);aviationVisible=true;document.getElementById('aviation-btn').style.opacity='1.0';}
saveMapState();}}
function formatTime(seconds){const hours=Math.floor(seconds/3600);const minutes=Math.floor((seconds%3600)/60);const secs=Math.floor(seconds%60);if(hours>0){return hours+':'+minutes.toString().padStart(2,'0')+':'+secs.toString().padStart(2,'0');}
return minutes+':'+secs.toString().padStart(2,'0');}
function toggleReplay(){const panel=document.getElementById('replay-controls');if(replayActive){stopReplay();panel.style.display='none';replayActive=false;document.getElementById('replay-btn').textContent='‚ñ∂Ô∏è Replay';document.body.classList.remove('replay-active');if(replayAirplaneMarker){map.removeLayer(replayAirplaneMarker);replayAirplaneMarker=null;}
if(replayLayer){map.removeLayer(replayLayer);}
restoreLayerVisibility();if(!altitudeVisible&&!airspeedVisible){altitudeVisible=true;document.getElementById('altitude-btn').style.opacity='1.0';document.getElementById('altitude-legend').style.display='block';map.addLayer(altitudeLayer);}
setTimeout(function(){if(altitudeVisible){redrawAltitudePaths();}else if(airspeedVisible){redrawAirspeedPaths();}
map.invalidateSize();},100);updateReplayButtonState();saveMapState();}else{if(selectedPathIds.size!==1){return;}
if(initializeReplay()){panel.style.display='block';replayActive=true;document.getElementById('replay-btn').textContent='‚èπÔ∏è Replay';document.getElementById('replay-btn').style.opacity='1.0';const autoZoomBtn=document.getElementById('replay-autozoom-btn');if(autoZoomBtn){autoZoomBtn.style.opacity=replayAutoZoom?'1.0':'0.5';autoZoomBtn.title=replayAutoZoom?'Auto-zoom enabled':'Auto-zoom disabled';}
document.body.classList.add('replay-active');hideOtherLayersDuringReplay();saveMapState();}}}
function updateReplayButtonState(){const btn=document.getElementById('replay-btn');if(selectedPathIds.size===1){btn.style.opacity='1.0';}else{btn.style.opacity='0.5';}}
function updateReplayAirplanePopup(){if(!replayAirplaneMarker||!replayActive)return;var currentSegment=null;for(var i=0;i<replaySegments.length;i++){var seg=replaySegments[i];if(seg.time<=replayCurrentTime){currentSegment=seg;}else{break;}}
if(!currentSegment){currentSegment=replaySegments[0];}
var popupContent='<div style="font-family: -apple-system, BlinkMacSystemFont, \'Segoe UI\', Roboto, Arial, sans-serif; min-width: 180px; padding: 8px 4px; background-color: #2b2b2b; color: #ffffff;">';popupContent+='<div style="font-size: 14px; font-weight: bold; color: #4facfe; margin-bottom: 8px; padding-bottom: 6px; border-bottom: 2px solid #4facfe; display: flex; align-items: center; gap: 6px;">';popupContent+='<span style="font-size: 16px;">‚úàÔ∏è</span>';popupContent+='<span>Current Position</span>';popupContent+='</div>';var altFt=currentSegment.altitude_ft;var altM=currentSegment.altitude_m;var altFtRounded=Math.round(altFt/50)*50;var altMRounded=Math.round(altFtRounded*0.3048);var altColor=getColorForAltitude(altFt,replayColorMinAlt,replayColorMaxAlt);var altColorBg=altColor.replace('rgb(','rgba(').replace(')',', 0.15)');popupContent+='<div style="margin-bottom: 8px;">';popupContent+='<div style="font-size: 11px; color: #999; margin-bottom: 2px; text-transform: uppercase; letter-spacing: 0.5px;">Altitude (MSL)</div>';popupContent+='<div style="background: '+altColorBg+'; padding: 6px 8px; border-radius: 6px; border-left: 3px solid '+altColor+';">';popupContent+='<span style="font-size: 16px; font-weight: bold; color: '+altColor+';">'+altFtRounded.toLocaleString()+' ft</span>';popupContent+='<span style="font-size: 12px; color: #ccc; margin-left: 6px;">('+altMRounded.toLocaleString()+' m)</span>';popupContent+='</div>';popupContent+='</div>';var speedKt=currentSegment.groundspeed_knots||0;var speedKmh=speedKt*1.852;var speedKtRounded=Math.round(speedKt);var speedKmhRounded=Math.round(speedKmh);var speedColor=getColorForAltitude(speedKt,replayColorMinSpeed,replayColorMaxSpeed);var speedColorBg=speedColor.replace('rgb(','rgba(').replace(')',', 0.15)');popupContent+='<div style="margin-bottom: 8px;">';popupContent+='<div style="font-size: 11px; color: #999; margin-bottom: 2px; text-transform: uppercase; letter-spacing: 0.5px;">Groundspeed</div>';popupContent+='<div style="background: '+speedColorBg+'; padding: 6px 8px; border-radius: 6px; border-left: 3px solid '+speedColor+';">';popupContent+='<span style="font-size: 16px; font-weight: bold; color: '+speedColor+';">'+speedKtRounded.toLocaleString()+' kt</span>';popupContent+='<span style="font-size: 12px; color: #ccc; margin-left: 6px;">('+speedKmhRounded.toLocaleString()+' km/h)</span>';popupContent+='</div>';popupContent+='</div>';popupContent+='</div>';if(!replayAirplaneMarker.getPopup()){replayAirplaneMarker.bindPopup(popupContent,{autoPanPadding:[50,50]});}else{replayAirplaneMarker.getPopup().setContent(popupContent);}
replayAirplaneMarker.openPopup();}
function initializeReplay(){if(!fullPathSegments){alert('No flight data available for replay. Please wait for data to load or refresh the page.');return false;}
const selectedPathId=Array.from(selectedPathIds)[0];replaySegments=fullPathSegments.filter(function(seg){return seg.path_id===selectedPathId&&seg.time!==undefined&&seg.time!==null;});if(replaySegments.length===0){alert('No timestamp data available for this path. The flight may not have timing information.');return false;}
replaySegments.sort(function(a,b){return a.time-b.time;});if(currentData&&currentData.path_segments){var currentResSegments=currentData.path_segments.filter(function(seg){return seg.path_id===selectedPathId;});if(currentResSegments.length>0){var altitudes=currentResSegments.map(function(s){return s.altitude_ft;});replayColorMinAlt=Math.min(...altitudes);replayColorMaxAlt=Math.max(...altitudes);var groundspeeds=currentResSegments.map(function(s){return s.groundspeed_knots;}).filter(function(s){return s>0;});if(groundspeeds.length>0){replayColorMinSpeed=Math.min(...groundspeeds);replayColorMaxSpeed=Math.max(...groundspeeds);}else{replayColorMinSpeed=airspeedRange.min;replayColorMaxSpeed=airspeedRange.max;}}else{var altitudes=replaySegments.map(function(s){return s.altitude_ft;});replayColorMinAlt=Math.min(...altitudes);replayColorMaxAlt=Math.max(...altitudes);var groundspeeds=replaySegments.map(function(s){return s.groundspeed_knots;}).filter(function(s){return s>0;});if(groundspeeds.length>0){replayColorMinSpeed=Math.min(...groundspeeds);replayColorMaxSpeed=Math.max(...groundspeeds);}else{replayColorMinSpeed=airspeedRange.min;replayColorMaxSpeed=airspeedRange.max;}}}
replayMaxTime=replaySegments[replaySegments.length-1].time;document.getElementById('replay-slider').max=replayMaxTime;document.getElementById('replay-slider-end').textContent=formatTime(replayMaxTime);updateAltitudeLegend(replayColorMinAlt,replayColorMaxAlt);updateAirspeedLegend(replayColorMinSpeed,replayColorMaxSpeed);if(!replayLayer){replayLayer=L.layerGroup();}
replayLayer.clearLayers();replayLayer.addTo(map);if(replayAirplaneMarker){map.removeLayer(replayAirplaneMarker);replayAirplaneMarker=null;}
var airplaneIcon=L.divIcon({html:'<div class="replay-airplane-icon">‚úàÔ∏è</div>',iconSize:[32,32],iconAnchor:[16,16],className:''});var startCoords=replaySegments[0].coords[0];replayAirplaneMarker=L.marker([startCoords[0],startCoords[1]],{icon:airplaneIcon,zIndexOffset:1000});replayAirplaneMarker.addTo(map);var markerElement=replayAirplaneMarker.getElement();if(markerElement){markerElement.style.transition='transform 0.08s linear';markerElement.style.cursor='pointer';markerElement.style.pointerEvents='auto';markerElement.addEventListener('click',function(e){e.stopPropagation();if(replayAirplaneMarker.isPopupOpen()){replayAirplaneMarker.closePopup();}else{updateReplayAirplanePopup();}});}
replayCurrentTime=0;replayLastDrawnIndex=-1;replayLastBearing=null;if(replayAutoZoom){map.setView([startCoords[0],startCoords[1]],16,{animate:true,duration:0.8});replayLastZoom=16;}else{map.panTo([startCoords[0],startCoords[1]],{animate:true,duration:0.8});}
updateReplayDisplay();return true;}
function hideOtherLayersDuringReplay(){if(heatmapLayer&&heatmapVisible){map.removeLayer(heatmapLayer);}
if(altitudeVisible){map.removeLayer(altitudeLayer);}
if(airspeedVisible){map.removeLayer(airspeedLayer);}
document.getElementById('heatmap-btn').disabled=true;document.getElementById('airports-btn').disabled=true;document.getElementById('aviation-btn').disabled=true;document.getElementById('year-select').disabled=true;document.getElementById('aircraft-select').disabled=true;}
function restoreLayerVisibility(){if(heatmapLayer&&heatmapVisible){map.addLayer(heatmapLayer);if(heatmapLayer._canvas){heatmapLayer._canvas.style.pointerEvents='none';}}
if(altitudeVisible){map.addLayer(altitudeLayer);setTimeout(function(){redrawAltitudePaths();map.invalidateSize();},50);}
if(airspeedVisible){map.addLayer(airspeedLayer);setTimeout(function(){redrawAirspeedPaths();map.invalidateSize();},50);}
document.getElementById('heatmap-btn').disabled=false;document.getElementById('airports-btn').disabled=false;document.getElementById('aviation-btn').disabled=false;document.getElementById('year-select').disabled=false;document.getElementById('aircraft-select').disabled=false;}
function playReplay(){if(!replayActive)return;if(replayCurrentTime>=replayMaxTime){replayCurrentTime=0;replayLastDrawnIndex=-1;replayLayer.clearLayers();if(replayAirplaneMarker&&replaySegments.length>0){var startCoords=replaySegments[0].coords[0];replayAirplaneMarker.setLatLng([startCoords[0],startCoords[1]]);if(replayAutoZoom){map.setView([startCoords[0],startCoords[1]],16,{animate:true,duration:0.5});replayLastZoom=16;}}
replayRecenterTimestamps=[];replayLastBearing=null;}
replayPlaying=true;document.getElementById('replay-play-btn').style.display='none';document.getElementById('replay-pause-btn').style.display='inline-block';replayLastFrameTime=null;function animateReplay(timestamp){if(!replayPlaying)return;if(replayLastFrameTime===null){replayLastFrameTime=timestamp;}
const deltaMs=timestamp-replayLastFrameTime;replayLastFrameTime=timestamp;const deltaTime=(deltaMs/1000)*replaySpeed;replayCurrentTime+=deltaTime;if(replayCurrentTime>=replayMaxTime){replayCurrentTime=replayMaxTime;pauseReplay();if(replaySegments.length>0){var allCoords=[];replaySegments.forEach(function(seg){if(seg.coords&&seg.coords.length>0){seg.coords.forEach(function(coord){allCoords.push(coord);});}});if(allCoords.length>0){var bounds=L.latLngBounds(allCoords);map.fitBounds(bounds,{padding:[50,50],animate:true,duration:1.0});}}}else{replayAnimationFrameId=requestAnimationFrame(animateReplay);}
updateReplayDisplay();}
replayAnimationFrameId=requestAnimationFrame(animateReplay);saveMapState();}
function pauseReplay(){replayPlaying=false;document.getElementById('replay-play-btn').style.display='inline-block';document.getElementById('replay-pause-btn').style.display='none';if(replayAnimationFrameId){cancelAnimationFrame(replayAnimationFrameId);replayAnimationFrameId=null;}
replayLastFrameTime=null;saveMapState();}
function stopReplay(){pauseReplay();replayCurrentTime=0;replayLastDrawnIndex=-1;replayLastBearing=null;replayRecenterTimestamps=[];if(replayLayer){replayLayer.clearLayers();}
if(replayAirplaneMarker&&replaySegments.length>0){var startCoords=replaySegments[0].coords[0];replayAirplaneMarker.setLatLng([startCoords[0],startCoords[1]]);}
updateReplayDisplay();}
function seekReplay(value){var newTime=parseFloat(value);if(newTime<replayCurrentTime){replayLayer.clearLayers();replayLastDrawnIndex=-1;}
replayCurrentTime=newTime;updateReplayDisplay(true);saveMapState();}
function changeReplaySpeed(){const select=document.getElementById('replay-speed');replaySpeed=parseFloat(select.value);saveMapState();}
function updateReplayDisplay(isManualSeek){document.getElementById('replay-time-display').textContent=formatTime(replayCurrentTime)+' / '+formatTime(replayMaxTime);document.getElementById('replay-slider').value=replayCurrentTime;document.getElementById('replay-slider-start').textContent=formatTime(replayCurrentTime);var lastSegment=null;var nextSegment=null;var currentIndex=-1;for(var i=0;i<replaySegments.length;i++){var seg=replaySegments[i];if(seg.time<=replayCurrentTime){lastSegment=seg;currentIndex=i;}else{nextSegment=seg;break;}}
if(replayLayer){var useAirspeedColors=airspeedVisible&&!altitudeVisible;for(var i=0;i<replaySegments.length;i++){var seg=replaySegments[i];if(seg.time<=replayCurrentTime&&replayCurrentTime>0){if(i>replayLastDrawnIndex){var segmentColor;if(useAirspeedColors&&seg.groundspeed_knots>0){segmentColor=getColorForAltitude(seg.groundspeed_knots,replayColorMinSpeed,replayColorMaxSpeed);}else{segmentColor=getColorForAltitude(seg.altitude_ft,replayColorMinAlt,replayColorMaxAlt);}
L.polyline(seg.coords,{color:segmentColor,weight:3,opacity:0.8}).addTo(replayLayer);replayLastDrawnIndex=i;}}else{break;}}}
if(replayAirplaneMarker&&!map.hasLayer(replayAirplaneMarker)){replayAirplaneMarker.addTo(map);}
if(replayAirplaneMarker){if(lastSegment){var currentPos;var bearing=0;if(nextSegment&&lastSegment.time<replayCurrentTime){var timeFraction=(replayCurrentTime-lastSegment.time)/(nextSegment.time-lastSegment.time);var lat1=lastSegment.coords[1][0];var lon1=lastSegment.coords[1][1];var lat2=nextSegment.coords[0][0];var lon2=nextSegment.coords[0][1];currentPos=[lat1+(lat2-lat1)*timeFraction,lon1+(lon2-lon1)*timeFraction];bearing=calculateBearing(lat1,lon1,lat2,lon2);}else{currentPos=lastSegment.coords[1];var lat1=lastSegment.coords[0][0];var lon1=lastSegment.coords[0][1];var lat2=lastSegment.coords[1][0];var lon2=lastSegment.coords[1][1];bearing=calculateBearing(lat1,lon1,lat2,lon2);}
var smoothedBearing=calculateSmoothedBearing(currentIndex,5);if(smoothedBearing!==null){bearing=smoothedBearing;replayLastBearing=bearing;}else if(replayLastBearing!==null){bearing=replayLastBearing;}
replayAirplaneMarker.setLatLng(currentPos);if(replayPlaying||isManualSeek){var mapSize=map.getSize();var airplanePoint=map.latLngToContainerPoint(currentPos);var marginPercent=0.10;var marginX=mapSize.x*marginPercent;var marginY=mapSize.y*marginPercent;var needsRecenter=false;if(airplanePoint.x<marginX||airplanePoint.x>mapSize.x-marginX||airplanePoint.y<marginY||airplanePoint.y>mapSize.y-marginY){needsRecenter=true;}
if(isManualSeek){needsRecenter=true;}
if(needsRecenter){map.panTo(currentPos,{animate:true,duration:0.5,easeLinearity:0.25,noMoveStart:true});var now=Date.now();replayRecenterTimestamps.push(now);var cutoffTime=now-30000;replayRecenterTimestamps=replayRecenterTimestamps.filter(function(ts){return ts>cutoffTime;});}
if(replayAutoZoom){var now=Date.now();var cutoffTime=now-30000;replayRecenterTimestamps=replayRecenterTimestamps.filter(function(ts){return ts>cutoffTime;});var recenterCount=replayRecenterTimestamps.length;if(recenterCount>2){var now=Date.now();var fiveSecondsAgo=now-5000;var recentRecenters=replayRecenterTimestamps.filter(function(ts){return ts>=fiveSecondsAgo;});if(recentRecenters.length>2){var zoomOutStep=0;var oldestRecent=Math.min(...recentRecenters);var newestRecent=Math.max(...recentRecenters);var recentWindow=(newestRecent-oldestRecent)/1000;var avgInterval=recentWindow/(recentRecenters.length-1);var zoomOutStep=1;if(zoomOutStep>0&&replayLastZoom!==null&&replayLastZoom>9){var newZoom=Math.max(9,replayLastZoom-zoomOutStep);map.setZoom(newZoom,{animate:true,duration:0.5});replayLastZoom=newZoom;replayRecenterTimestamps=[];}}}}}
var iconElement=replayAirplaneMarker.getElement();if(iconElement){var iconDiv=iconElement.querySelector('.replay-airplane-icon');if(iconDiv){var adjustedBearing=bearing-45;iconDiv.style.transform='translate3d(0,0,0) rotate('+adjustedBearing+'deg)';}}}else if(replaySegments.length>0){var startCoords=replaySegments[0].coords[0];replayAirplaneMarker.setLatLng([startCoords[0],startCoords[1]]);}}
if(replayAirplaneMarker&&replayAirplaneMarker.getPopup()&&replayAirplaneMarker.isPopupOpen()){updateReplayAirplanePopup();}}
function calculateSmoothedBearing(currentIdx,lookAhead){if(currentIdx<0||currentIdx>=replaySegments.length){return null;}
var startSeg=replaySegments[currentIdx];var endIdx=Math.min(currentIdx+lookAhead,replaySegments.length-1);var endSeg=replaySegments[endIdx];var lat1=startSeg.coords[1][0];var lon1=startSeg.coords[1][1];var lat2=endSeg.coords[1][0];var lon2=endSeg.coords[1][1];var œÜ1=lat1*Math.PI/180;var œÜ2=lat2*Math.PI/180;var ŒîœÜ=(lat2-lat1)*Math.PI/180;var ŒîŒª=(lon2-lon1)*Math.PI/180;var a=Math.sin(ŒîœÜ/2)*Math.sin(ŒîœÜ/2)+
Math.cos(œÜ1)*Math.cos(œÜ2)*Math.sin(ŒîŒª/2)*Math.sin(ŒîŒª/2);var c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));var distanceKm=6371*c;if(distanceKm<0.05){return null;}
return calculateBearing(lat1,lon1,lat2,lon2);}
function calculateBearing(lat1,lon1,lat2,lon2){var œÜ1=lat1*Math.PI/180;var œÜ2=lat2*Math.PI/180;var ŒîŒª=(lon2-lon1)*Math.PI/180;var y=Math.sin(ŒîŒª)*Math.cos(œÜ2);var x=Math.cos(œÜ1)*Math.sin(œÜ2)-Math.sin(œÜ1)*Math.cos(œÜ2)*Math.cos(ŒîŒª);var Œ∏=Math.atan2(y,x);return(Œ∏*180/Math.PI+360)%360;}
function exportMap(){const btn=document.getElementById('export-btn');btn.disabled=true;btn.textContent='‚è≥ Exporting...';const mapContainer=document.getElementById('map');const controls=[document.querySelector('.leaflet-control-zoom'),document.getElementById('stats-btn'),document.getElementById('export-btn'),document.getElementById('wrapped-btn'),document.getElementById('replay-btn'),document.getElementById('year-filter'),document.getElementById('aircraft-filter'),document.getElementById('heatmap-btn'),document.getElementById('altitude-btn'),document.getElementById('airspeed-btn'),document.getElementById('airports-btn'),document.getElementById('aviation-btn'),document.getElementById('stats-panel'),document.getElementById('altitude-legend'),document.getElementById('airspeed-legend'),document.getElementById('loading')];const displayStates=controls.map(el=>el?el.style.display:null);controls.forEach(el=>{if(el)el.style.display='none';});setTimeout(function(){domtoimage.toJpeg(mapContainer,{width:mapContainer.offsetWidth*2,height:mapContainer.offsetHeight*2,bgcolor:'#1a1a1a',quality:0.95,style:{transform:'scale(2)',transformOrigin:'top left'}}).then(function(dataUrl){controls.forEach((el,i)=>{if(el)el.style.display=displayStates[i]||'';});btn.disabled=false;btn.textContent='üì∑ Export';const link=document.createElement('a');link.download='heatmap_'+new Date().toISOString().slice(0,19).replace(/[:.]/g,'-')+'.jpg';link.href=dataUrl;link.click();}).catch(function(error){controls.forEach((el,i)=>{if(el)el.style.display=displayStates[i]||'';});alert('Export failed: '+error.message);btn.disabled=false;btn.textContent='üì∑ Export';});},200);}
function generateFunFacts(yearStats){const allFacts=[];const earthCircumferenceKm=40075;const everestHeightFt=29032;const everestHeightM=8849;const commercialCruiseAltFt=35000;const newYorkToLondonKm=5585;const newYorkToLAKm=3944;const parisToTokyoKm=9715;const londonToSydneyKm=17015;const berlinToNewYorkKm=6385;const totalDistanceKm=yearStats.total_distance_nm*1.852;const timesAroundEarth=totalDistanceKm/earthCircumferenceKm;if(timesAroundEarth>=0.5){allFacts.push({category:'distance',icon:'üåç',text:`You flew <strong>${timesAroundEarth.toFixed(1)}x</strong> around the Earth`,priority:timesAroundEarth>=1?10:7});}
if(totalDistanceKm>=londonToSydneyKm){const timesLondonSydney=(totalDistanceKm/londonToSydneyKm).toFixed(1);allFacts.push({category:'distance',icon:'‚úàÔ∏è',text:`Your <strong>${yearStats.total_distance_nm.toFixed(0)} nm</strong> could fly you London to Sydney <strong>${timesLondonSydney}x</strong>`,priority:9});}else if(totalDistanceKm>=parisToTokyoKm){const timesParisToTokyo=(totalDistanceKm/parisToTokyoKm).toFixed(1);allFacts.push({category:'distance',icon:'üóº',text:`Your <strong>${yearStats.total_distance_nm.toFixed(0)} nm</strong> could fly you Paris to Tokyo <strong>${timesParisToTokyo}x</strong>`,priority:8});}else if(totalDistanceKm>=berlinToNewYorkKm){const timesBerlinNY=(totalDistanceKm/berlinToNewYorkKm).toFixed(1);allFacts.push({category:'distance',icon:'üóΩ',text:`Your <strong>${yearStats.total_distance_nm.toFixed(0)} nm</strong> could fly you Berlin to New York <strong>${timesBerlinNY}x</strong>`,priority:7});}else if(totalDistanceKm>=newYorkToLAKm){const timesNYToLA=(totalDistanceKm/newYorkToLAKm).toFixed(1);allFacts.push({category:'distance',icon:'üåâ',text:`Your <strong>${yearStats.total_distance_nm.toFixed(0)} nm</strong> could fly you New York to LA <strong>${timesNYToLA}x</strong>`,priority:6});}
if(fullStats&&fullStats.total_altitude_gain_ft){const gainFt=Math.round(fullStats.total_altitude_gain_ft);const timesEverest=gainFt/everestHeightFt;if(timesEverest>=1){allFacts.push({category:'altitude',icon:'‚¨ÜÔ∏è',text:`You climbed <strong>${gainFt.toLocaleString()} ft</strong> - that's scaling Everest <strong>${timesEverest.toFixed(1)}x</strong>!`,priority:9});}else if(gainFt>10000){allFacts.push({category:'altitude',icon:'‚¨ÜÔ∏è',text:`Total elevation gain: <strong>${gainFt.toLocaleString()} ft</strong>`,priority:5});}}
if(fullStats&&fullStats.total_flight_time_seconds){const totalHours=fullStats.total_flight_time_seconds/3600;const totalDays=totalHours/24;const hoursPerYear=8760;const percentOfYear=(totalHours/hoursPerYear*100).toFixed(2);if(totalDays>=1){allFacts.push({category:'time',icon:'‚è±Ô∏è',text:`You spent <strong>${totalDays.toFixed(1)} days</strong> in the air - that's <strong>${percentOfYear}%</strong> of the year!`,priority:8});}else if(totalHours>=10){allFacts.push({category:'time',icon:'‚è∞',text:`Total airtime: <strong>${totalHours.toFixed(1)} hours</strong>`,priority:5});}}
if(fullStats&&fullStats.cruise_speed_knots&&fullStats.cruise_speed_knots>0&&yearStats.total_flights>0){const cruiseSpeedKt=Math.round(fullStats.cruise_speed_knots);const avgDistanceNm=Math.round(yearStats.total_distance_nm/yearStats.total_flights);allFacts.push({category:'speed',icon:'‚úàÔ∏è',text:`Cruising at <strong>${cruiseSpeedKt} kt</strong>, averaging <strong>${avgDistanceNm} nm</strong> per adventure`,priority:8});}
if(fullStats&&fullStats.longest_flight_nm&&fullStats.longest_flight_nm>0){const longestFlightNm=fullStats.longest_flight_nm;const longestFlightKm=fullStats.longest_flight_km;const munichToHamburgKm=612;const berlinToMunichKm=504;const frankfurtToViennaKm=516;const parisToBarcelonaKm=831;const londonToEdinburghKm=534;if(longestFlightKm>=munichToHamburgKm*0.9&&longestFlightKm<=munichToHamburgKm*1.1){allFacts.push({category:'distance',icon:'üõ´',text:`Your longest adventure was <strong>${longestFlightNm.toFixed(0)} nm</strong> - like flying Munich to Hamburg!`,priority:8});}else if(longestFlightKm>=berlinToMunichKm*0.9){allFacts.push({category:'distance',icon:'üõ´',text:`Your longest journey: <strong>${longestFlightNm.toFixed(0)} nm</strong> - that's Berlin to Munich distance!`,priority:8});}else if(longestFlightKm>=200){allFacts.push({category:'distance',icon:'üõ´',text:`Your longest single flight covered <strong>${longestFlightNm.toFixed(0)} nm</strong> (<strong>${longestFlightKm.toFixed(0)} km</strong>)`,priority:7});}}
if(fullStats&&fullStats.most_common_cruise_altitude_ft&&fullStats.most_common_cruise_altitude_ft>0){const cruiseAltFt=fullStats.most_common_cruise_altitude_ft;const cruiseAltM=Math.round(fullStats.most_common_cruise_altitude_m);const eiffelTowerM=330;const empireStateBuildingM=381;const berlinTVTowerM=368;const cologneMonM=157;if(cruiseAltM>=empireStateBuildingM*0.9&&cruiseAltM<=empireStateBuildingM*1.3){allFacts.push({category:'altitude',icon:'üèîÔ∏è',text:`Your sweet spot: <strong>${cruiseAltFt.toLocaleString()} ft</strong> AGL - about the height of the Empire State Building!`,priority:8});}else if(cruiseAltM>=eiffelTowerM*0.9&&cruiseAltM<=eiffelTowerM*1.5){allFacts.push({category:'altitude',icon:'üóº',text:`Preferred cruise altitude: <strong>${cruiseAltFt.toLocaleString()} ft</strong> AGL - like flying over the Eiffel Tower!`,priority:8});}else if(cruiseAltFt>=1000&&cruiseAltFt<=3000){allFacts.push({category:'altitude',icon:'‚úàÔ∏è',text:`You love the low-level views at <strong>${cruiseAltFt.toLocaleString()} ft</strong> AGL - classic VFR territory!`,priority:7});}else if(cruiseAltFt>3000){allFacts.push({category:'altitude',icon:'‚¨ÜÔ∏è',text:`Most common cruise: <strong>${cruiseAltFt.toLocaleString()} ft</strong> AGL (<strong>${cruiseAltM.toLocaleString()} m</strong>)`,priority:7});}}
if(fullStats&&fullStats.aircraft_list&&fullStats.aircraft_list.length>0){const primaryAircraft=fullStats.aircraft_list[0];const totalAircraft=fullStats.aircraft_list.length;const primaryModel=primaryAircraft.model||primaryAircraft.type||'aircraft';if(totalAircraft===1){allFacts.push({category:'aircraft',icon:'‚úàÔ∏è',text:`Loyal to <strong>${primaryAircraft.registration}</strong> - all ${primaryAircraft.flights} flights in this ${primaryModel}!`,priority:9});}else if(totalAircraft>=4){allFacts.push({category:'aircraft',icon:'üõ©Ô∏è',text:`You explored <strong>${totalAircraft} different aircraft</strong> - a true aviator!`,priority:9});}else{allFacts.push({category:'aircraft',icon:'‚úàÔ∏è',text:`Your go-to: <strong>${primaryAircraft.registration}</strong> (${primaryModel}) with <strong>${primaryAircraft.flights} flights</strong>`,priority:9});}}
if(fullStats&&fullStats.max_altitude_ft>40000){allFacts.push({category:'achievement',icon:'üöÄ',text:`You're practically an astronaut at <strong>${Math.round(fullStats.max_altitude_ft).toLocaleString()} ft</strong>!`,priority:10});}
allFacts.sort((a,b)=>b.priority-a.priority);const selectedFacts=[];const usedCategories=new Set();const maxFactsPerCategory=2;const categoryCount={};for(const fact of allFacts){const catCount=categoryCount[fact.category]||0;if(catCount<maxFactsPerCategory){selectedFacts.push(fact);categoryCount[fact.category]=catCount+1;usedCategories.add(fact.category);if(selectedFacts.length>=6)break;}}
if(selectedFacts.length<4){for(const fact of allFacts){if(!selectedFacts.includes(fact)){selectedFacts.push(fact);if(selectedFacts.length>=4)break;}}}
return selectedFacts;}
let originalMapParent=null;let originalMapIndex=0;function showWrapped(){const year=selectedYear;const yearStats=calculateYearStats(year);if(year==='all'){document.getElementById('wrapped-title').textContent='‚ú® Your Flight History';document.getElementById('wrapped-year').textContent='All Years';}else{document.getElementById('wrapped-title').textContent='‚ú® Your Year in Flight';document.getElementById('wrapped-year').textContent=year;}
const statsHtml=`
        <div class="stat-card">
            <div class="stat-value">${yearStats.total_flights}</div>
            <div class="stat-label">Flights</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">${yearStats.num_airports}</div>
            <div class="stat-label">Airports</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">${yearStats.total_distance_nm.toFixed(0)}</div>
            <div class="stat-label">Nautical Miles</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">${yearStats.flight_time}</div>
            <div class="stat-label">Flight Time</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">${(fullStats.max_groundspeed_knots || 0).toFixed(0)} kt</div>
            <div class="stat-label">Max Groundspeed</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">${Math.round(fullStats.max_altitude_ft || 0).toLocaleString()} ft</div>
            <div class="stat-label">Max Altitude (MSL)</div>
        </div>
    `;document.getElementById('wrapped-stats').innerHTML=statsHtml;const funFacts=generateFunFacts(yearStats);let funFactsHtml='<div class="fun-facts-title">‚ú® Facts</div>';funFacts.forEach(function(fact){funFactsHtml+=`<div class="fun-fact" data-category="${fact.category}"><span class="fun-fact-icon">${fact.icon}</span><span class="fun-fact-text">${fact.text}</span></div>`;});document.getElementById('wrapped-fun-facts').innerHTML=funFactsHtml;if(yearStats.aircraft_list&&yearStats.aircraft_list.length>0){let fleetHtml='<div class="aircraft-fleet-title">‚úàÔ∏è Fleet</div>';const maxFlights=yearStats.aircraft_list[0].flights;const minFlights=yearStats.aircraft_list[yearStats.aircraft_list.length-1].flights;const flightRange=maxFlights-minFlights;yearStats.aircraft_list.forEach(function(aircraft,index){const modelStr=aircraft.model||aircraft.type||'';const normalized=flightRange>0?(aircraft.flights-minFlights)/flightRange:1;let colorClass;if(normalized>=0.75){colorClass='fleet-aircraft-high';}else if(normalized>=0.5){colorClass='fleet-aircraft-medium-high';}else if(normalized>=0.25){colorClass='fleet-aircraft-medium-low';}else{colorClass='fleet-aircraft-low';}
const flightTimeStr=aircraft.flight_time_str||'---';fleetHtml+=`
                <div class="fleet-aircraft ${colorClass}">
                    <div class="fleet-aircraft-info">
                        <div class="fleet-aircraft-model">${modelStr}</div>
                        <div class="fleet-aircraft-registration">${aircraft.registration}</div>
                    </div>
                    <div class="fleet-aircraft-stats">
                        <div class="fleet-aircraft-flights">${aircraft.flights} flights</div>
                        <div class="fleet-aircraft-time">${flightTimeStr}</div>
                    </div>
                </div>
            `;});document.getElementById('wrapped-aircraft-fleet').innerHTML=fleetHtml;}
if(yearStats.airport_names&&yearStats.airport_names.length>0){var filteredPathInfo;if(year==='all'){filteredPathInfo=fullPathInfo;}else{const yearStr=year.toString();filteredPathInfo=fullPathInfo.filter(function(pathInfo){return pathInfo.year&&pathInfo.year.toString()===yearStr;});}
loadAirports().then(function(allAirports){var yearAirportCounts={};filteredPathInfo.forEach(function(pathInfo){if(pathInfo.start_airport){yearAirportCounts[pathInfo.start_airport]=(yearAirportCounts[pathInfo.start_airport]||0)+1;}
if(pathInfo.end_airport){yearAirportCounts[pathInfo.end_airport]=(yearAirportCounts[pathInfo.end_airport]||0)+1;}});var yearAirports=yearStats.airport_names.map(function(name){return{name:name,flight_count:yearAirportCounts[name]||0};});yearAirports.sort((a,b)=>b.flight_count-a.flight_count);const homeBase=yearAirports[0];let homeBaseHtml='<div class="top-airports-title">üè† Home Base</div>';homeBaseHtml+=`
                <div class="top-airport">
                    <div class="top-airport-name">${homeBase.name}</div>
                    <div class="top-airport-count">${homeBase.flight_count} flights</div>
                </div>
            `;document.getElementById('wrapped-top-airports').innerHTML=homeBaseHtml;const destinations=yearStats.airport_names.filter(name=>name!==homeBase.name);let airportBadgesHtml='<div class="airports-grid-title">üó∫Ô∏è Destinations</div><div class="airport-badges">';destinations.forEach(function(airportName){airportBadgesHtml+=`<div class="airport-badge">${airportName}</div>`;});airportBadgesHtml+='</div>';document.getElementById('wrapped-airports-grid').innerHTML=airportBadgesHtml;});}
const mapContainer=document.getElementById('map');const wrappedMapContainer=document.getElementById('wrapped-map-container');if(!originalMapParent){originalMapParent=mapContainer.parentNode;originalMapIndex=Array.from(originalMapParent.children).indexOf(mapContainer);}
map.fitBounds(BOUNDS,{padding:[80,80]});const controls=[document.querySelector('.leaflet-control-zoom'),document.getElementById('stats-btn'),document.getElementById('export-btn'),document.getElementById('wrapped-btn'),document.getElementById('heatmap-btn'),document.getElementById('airports-btn'),document.getElementById('altitude-btn'),document.getElementById('airspeed-btn'),document.getElementById('aviation-btn'),document.getElementById('year-filter'),document.getElementById('aircraft-filter'),document.getElementById('stats-panel'),document.getElementById('altitude-legend'),document.getElementById('airspeed-legend'),document.getElementById('loading')];controls.forEach(el=>{if(el)el.style.display='none';});document.getElementById('wrapped-modal').style.display='flex';setTimeout(function(){wrappedMapContainer.appendChild(mapContainer);mapContainer.style.width='100%';mapContainer.style.height='100%';mapContainer.style.borderRadius='12px';mapContainer.style.overflow='hidden';wrappedMapContainer.offsetHeight;setTimeout(function(){map.invalidateSize();map.fitBounds(BOUNDS,{padding:[80,80]});},100);},50);}
function closeWrapped(event){if(!event||event.target.id==='wrapped-modal'){const mapContainer=document.getElementById('map');if(originalMapParent){const children=Array.from(originalMapParent.children);if(originalMapIndex>=children.length){originalMapParent.appendChild(mapContainer);}else{originalMapParent.insertBefore(mapContainer,children[originalMapIndex]);}
mapContainer.style.width='';mapContainer.style.height='';mapContainer.style.borderRadius='';mapContainer.style.overflow='';const controls=[document.querySelector('.leaflet-control-zoom'),document.getElementById('stats-btn'),document.getElementById('export-btn'),document.getElementById('wrapped-btn'),document.getElementById('heatmap-btn'),document.getElementById('airports-btn'),document.getElementById('altitude-btn'),document.getElementById('airspeed-btn'),document.getElementById('year-filter'),document.getElementById('aircraft-filter'),document.getElementById('stats-panel'),document.getElementById('altitude-legend'),document.getElementById('airspeed-legend'),document.getElementById('loading')];controls.forEach(el=>{if(el)el.style.display='';});if(OPENAIP_API_KEY){const aviationBtn=document.getElementById('aviation-btn');if(aviationBtn)aviationBtn.style.display='';}
setTimeout(function(){map.invalidateSize();},100);}
document.getElementById('wrapped-modal').style.display='none';}}
function calculateYearStats(year){if(!fullPathInfo||!fullPathSegments){return{total_flights:0,total_distance_nm:0,num_airports:0,flight_time:'0h 0m',aircraft_list:[],airport_names:[]};}
var filteredPathInfo;if(year==='all'){filteredPathInfo=fullPathInfo;}else{const yearStr=year.toString();filteredPathInfo=fullPathInfo.filter(function(pathInfo){return pathInfo.year&&pathInfo.year.toString()===yearStr;});}
if(filteredPathInfo.length===0){return{total_flights:0,total_distance_nm:0,num_airports:0,flight_time:'0h 0m',aircraft_list:[],airport_names:[]};}
var airports=new Set();var airportNames=[];filteredPathInfo.forEach(function(pathInfo){if(pathInfo.start_airport){airports.add(pathInfo.start_airport);if(!airportNames.includes(pathInfo.start_airport)){airportNames.push(pathInfo.start_airport);}}
if(pathInfo.end_airport){airports.add(pathInfo.end_airport);if(!airportNames.includes(pathInfo.end_airport)){airportNames.push(pathInfo.end_airport);}}});var aircraftMap={};filteredPathInfo.forEach(function(pathInfo){if(pathInfo.aircraft_registration){var reg=pathInfo.aircraft_registration;if(!aircraftMap[reg]){aircraftMap[reg]={registration:reg,type:pathInfo.aircraft_type,flights:0,flight_time_seconds:0};}
aircraftMap[reg].flights+=1;}});var pathIds=new Set(filteredPathInfo.map(function(p){return p.id;}));var filteredSegments=fullPathSegments.filter(function(segment){return pathIds.has(segment.path_id);});var totalDistanceKm=0;filteredSegments.forEach(function(segment){if(segment.coords&&segment.coords.length===2){var lat1=segment.coords[0][0]*Math.PI/180;var lon1=segment.coords[0][1]*Math.PI/180;var lat2=segment.coords[1][0]*Math.PI/180;var lon2=segment.coords[1][1]*Math.PI/180;var dlat=lat2-lat1;var dlon=lon2-lon1;var a=Math.sin(dlat/2)*Math.sin(dlat/2)+
Math.cos(lat1)*Math.cos(lat2)*Math.sin(dlon/2)*Math.sin(dlon/2);var c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));totalDistanceKm+=6371*c;}});var totalFlightTimeSeconds=0;var pathDurations={};filteredSegments.forEach(function(segment){if(segment.time!==undefined&&segment.path_id!==undefined){var pathId=segment.path_id;if(!pathDurations[pathId]){pathDurations[pathId]={min:Infinity,max:-Infinity};}
pathDurations[pathId].min=Math.min(pathDurations[pathId].min,segment.time);pathDurations[pathId].max=Math.max(pathDurations[pathId].max,segment.time);}});Object.keys(pathDurations).forEach(function(pathId){var duration=pathDurations[pathId];if(duration.min!==Infinity&&duration.max!==-Infinity){var durationSeconds=duration.max-duration.min;totalFlightTimeSeconds+=durationSeconds;var pathInfo=filteredPathInfo.find(function(p){return p.id===parseInt(pathId);});if(pathInfo&&pathInfo.aircraft_registration&&aircraftMap[pathInfo.aircraft_registration]){aircraftMap[pathInfo.aircraft_registration].flight_time_seconds+=durationSeconds;}}});var flightTimeStr='0h 0m';if(totalFlightTimeSeconds>0){var hours=Math.floor(totalFlightTimeSeconds/3600);var minutes=Math.floor((totalFlightTimeSeconds%3600)/60);flightTimeStr=hours+'h '+minutes+'m';}
var aircraftList=Object.values(aircraftMap).map(function(aircraft){var hours=Math.floor(aircraft.flight_time_seconds/3600);var minutes=Math.floor((aircraft.flight_time_seconds%3600)/60);var result={registration:aircraft.registration,type:aircraft.type,flights:aircraft.flights,flight_time_str:hours+'h '+minutes+'m'};if(fullStats&&fullStats.aircraft_list){var fullAircraft=fullStats.aircraft_list.find(function(a){return a.registration===aircraft.registration;});if(fullAircraft&&fullAircraft.model){result.model=fullAircraft.model;}}
return result;}).sort(function(a,b){return b.flights-a.flights;});return{total_flights:filteredPathInfo.length,total_distance_nm:totalDistanceKm*0.539957,num_airports:airports.size,flight_time:flightTimeStr,aircraft_list:aircraftList,airport_names:airportNames};}
function toggleButtonsVisibility(){const toggleableButtons=document.querySelectorAll('.toggleable-btn');const hideButton=document.getElementById('hide-buttons-btn');if(buttonsHidden){toggleableButtons.forEach(function(btn){btn.classList.remove('buttons-hidden');});hideButton.textContent='üîº';buttonsHidden=false;}else{toggleableButtons.forEach(function(btn){btn.classList.add('buttons-hidden');});hideButton.textContent='üîΩ';buttonsHidden=true;}}
function toggleAutoZoom(){replayAutoZoom=!replayAutoZoom;const autoZoomBtn=document.getElementById('replay-autozoom-btn');if(replayAutoZoom){autoZoomBtn.style.opacity='1.0';autoZoomBtn.title='Auto-zoom enabled';if(replayActive&&replayAirplaneMarker){var currentPos=replayAirplaneMarker.getLatLng();map.setView(currentPos,16,{animate:true,duration:0.5});replayLastZoom=16;}}else{autoZoomBtn.style.opacity='0.5';autoZoomBtn.title='Auto-zoom disabled';replayLastZoom=null;}
saveMapState();}