"use strict";var MapAppModule=(()=>{var Sa=Object.create;var Ce=Object.defineProperty;var La=Object.getOwnPropertyDescriptor;var _a=Object.getOwnPropertyNames;var Ta=Object.getPrototypeOf,xa=Object.prototype.hasOwnProperty;var wa=(p,e)=>()=>(e||p((e={exports:{}}).exports,e),e.exports),Ea=(p,e)=>{for(var t in e)Ce(p,t,{get:e[t],enumerable:!0})},Ut=(p,e,t,a)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of _a(e))!xa.call(p,s)&&s!==t&&Ce(p,s,{get:()=>e[s],enumerable:!(a=La(e,s))||a.enumerable});return p};var Re=(p,e,t)=>(t=p!=null?Sa(Ta(p)):{},Ut(e||!p||!p.__esModule?Ce(t,"default",{value:p,enumerable:!0}):t,p)),Pa=p=>Ut(Ce({},"__esModule",{value:!0}),p);var ge=wa((ei,Yt)=>{Yt.exports=window.L});var Ja={};Ea(Ja,{MapApp:()=>Ke});var k=Re(ge(),1);function Gt(...p){console.warn(...p)}function Kt(...p){console.error(...p)}var ot=class{constructor(){this.cache=new Map}get(e){if(this.cache.has(e)){let a=this.cache.get(e);if(document.contains(a))return a;this.cache.delete(e)}let t=document.getElementById(e);return t&&this.cache.set(e,t),t}cacheElements(e){e.forEach(t=>{let a=document.getElementById(t);a&&this.cache.set(t,a)})}clear(){this.cache.clear()}remove(e){this.cache.delete(e)}has(e){return this.cache.has(e)}get size(){return this.cache.size}},o=new ot;var ke=class{constructor(e){this.app=e,o.cacheElements(["loading"]),this.dataLoader=new window.KMLHeatmap.DataLoader({dataDir:e.config.dataDir,showLoading:()=>this.showLoading(),hideLoading:()=>this.hideLoading()}),this.loadedData={},this.currentData=null}showLoading(){let e=o.get("loading");e&&(e.style.display="block")}hideLoading(){let e=o.get("loading");e&&(e.style.display="none")}async loadData(e,t){return await this.dataLoader.loadData(e,t)}async loadAirports(){return await this.dataLoader.loadAirports()}async loadMetadata(){return await this.dataLoader.loadMetadata()}async updateLayers(){if(!this.app.map)return;let e=await this.loadData("data",this.app.selectedYear);if(!e)return;this.currentData=e,this.app.currentData=e;let t=e.coordinates;if((this.app.selectedYear!=="all"||this.app.selectedAircraft!=="all")&&e.path_segments){let a=new Set;e.path_info&&e.path_info.forEach(r=>{let n=this.app.selectedYear==="all"||r.year&&r.year.toString()===this.app.selectedYear,l=this.app.selectedAircraft==="all"||r.aircraft_registration===this.app.selectedAircraft;n&&l&&a.add(r.id)});let s=new Set;e.path_segments.forEach(r=>{if(a.has(r.path_id)){let n=r.coords;n&&n.length===2&&(s.add(JSON.stringify(n[0])),s.add(JSON.stringify(n[1])))}}),t=Array.from(s).map(r=>JSON.parse(r))}if(this.app.heatmapLayer&&this.app.heatmapLayer.remove(),this.app.heatmapLayer=L.heatLayer(t,{radius:10,blur:15,minOpacity:.25,maxOpacity:.6,max:1,gradient:{0:"blue",.3:"cyan",.5:"lime",.7:"yellow",1:"red"}}),this.app.heatmapLayer.e&&(this.app.heatmapLayer.e.style.pointerEvents="none"),this.app.heatmapVisible&&!this.app.replayManager.replayActive&&this.app.heatmapLayer.addTo(this.app.map),this.app.pathToAirports={},this.app.airportToPaths={},e.path_info&&e.path_info.forEach(a=>{let s=a.id;this.app.pathToAirports[s]={start:a.start_airport,end:a.end_airport},a.start_airport&&(this.app.airportToPaths[a.start_airport]||(this.app.airportToPaths[a.start_airport]=new Set),this.app.airportToPaths[a.start_airport].add(s)),a.end_airport&&(this.app.airportToPaths[a.end_airport]||(this.app.airportToPaths[a.end_airport]=new Set),this.app.airportToPaths[a.end_airport].add(s))}),e.path_segments&&e.path_segments.length>0){let a=e.path_segments.map(n=>n.altitude_ft||0),s=a[0]??0,r=a[0]??0;for(let n=1;n<a.length;n++){let l=a[n]??0;l<s&&(s=l),l>r&&(r=l)}this.app.altitudeRange.min=s,this.app.altitudeRange.max=r}this.app.layerManager.redrawAltitudePaths(),this.app.airspeedVisible&&this.app.layerManager.redrawAirspeedPaths()}};var De=class{constructor(e){this.app=e,o.cacheElements(["stats-panel","wrapped-modal"])}saveMapState(){if(!this.app.map)return;let e=o.get("stats-panel"),t=o.get("wrapped-modal"),a={center:this.app.map.getCenter(),zoom:this.app.map.getZoom(),heatmapVisible:this.app.heatmapVisible,altitudeVisible:this.app.altitudeVisible,airspeedVisible:this.app.airspeedVisible,airportsVisible:this.app.airportsVisible,aviationVisible:this.app.aviationVisible,selectedYear:this.app.selectedYear,selectedAircraft:this.app.selectedAircraft,selectedPathIds:Array.from(this.app.selectedPathIds),statsPanelVisible:e?e.classList.contains("visible"):!1,wrappedVisible:t?t.style.display==="flex":!1,buttonsHidden:this.app.buttonsHidden};try{localStorage.setItem("kml-heatmap-state",JSON.stringify(a))}catch{}this.updateUrl(a)}loadMapState(){try{let e=localStorage.getItem("kml-heatmap-state");if(e)return JSON.parse(e)}catch{}return null}updateUrl(e){let t=window.KMLHeatmap.encodeStateToUrl(e),a=t?"?"+t:window.location.pathname;try{history.replaceState(null,"",a)}catch{}}loadState(){let e=window.KMLHeatmap.parseUrlParams(new URLSearchParams(window.location.search));return e&&Object.keys(e).length>0?e:this.loadMapState()}};var ce=Re(ge(),1);var Ie=class{constructor(e){this.app=e,o.cacheElements(["legend-min","legend-max","airspeed-legend-min","airspeed-legend-max"])}redrawAltitudePaths(){if(!this.app.currentData)return;this.app.altitudeLayer.clearLayers(),this.app.pathSegments={};let e,t;if(this.app.selectedPathIds.size>0){let a=this.app.currentData.path_segments.filter(s=>this.app.selectedPathIds.has(s.path_id));if(a.length>0){let s=a.map(l=>l.altitude_ft||0),r=s[0]??0,n=s[0]??0;for(let l=1;l<s.length;l++){let c=s[l]??0;c<r&&(r=c),c>n&&(n=c)}e=r,t=n}else e=this.app.altitudeRange.min,t=this.app.altitudeRange.max}else e=this.app.altitudeRange.min,t=this.app.altitudeRange.max;this.app.currentData.path_segments.forEach(a=>{let s=a.path_id,r=this.app.currentData.path_info.find(m=>m.id===s);if(this.app.selectedYear!=="all"&&r&&r.year&&r.year.toString()!==this.app.selectedYear||this.app.selectedAircraft!=="all"&&r&&r.aircraft_registration!==this.app.selectedAircraft)return;let n=this.app.selectedPathIds.has(s);if(this.app.selectedPathIds.size>0&&!n&&this.app.buttonsHidden)return;let l=window.KMLHeatmap.getColorForAltitude(a.altitude_ft??0,e,t);ce.polyline(a.coords||[],{color:l,weight:n?6:4,opacity:n?1:this.app.selectedPathIds.size>0?.1:.85,renderer:this.app.altitudeRenderer,interactive:!0}).bindPopup("Altitude: "+a.altitude_ft+" ft ("+a.altitude_m+" m)").addTo(this.app.altitudeLayer).on("click",m=>{ce.DomEvent.stopPropagation(m),this.app.pathSelection.togglePathSelection(s)}),this.app.pathSegments[s]||(this.app.pathSegments[s]=[]),this.app.pathSegments[s].push(a)}),this.updateAltitudeLegend(e,t),this.app.airportManager.updateAirportOpacity(),this.app.statsManager.updateStatsForSelection()}redrawAirspeedPaths(){if(!this.app.currentData){Gt("redrawAirspeedPaths: No current data available");return}this.app.airspeedLayer.clearLayers();let e,t;if(this.app.selectedPathIds.size>0){let a=this.app.currentData.path_segments.filter(s=>this.app.selectedPathIds.has(s.path_id)&&(s.groundspeed_knots||0)>0);if(a.length>0){let s=a.map(l=>l.groundspeed_knots||0),r=s[0]??0,n=s[0]??0;for(let l=1;l<s.length;l++){let c=s[l]??0;c<r&&(r=c),c>n&&(n=c)}e=r,t=n}else e=this.app.airspeedRange.min,t=this.app.airspeedRange.max}else e=this.app.airspeedRange.min,t=this.app.airspeedRange.max;this.app.currentData.path_segments.forEach(a=>{let s=a.path_id,r=this.app.currentData.path_info.find(n=>n.id===s);if(!(this.app.selectedYear!=="all"&&r&&r.year&&r.year.toString()!==this.app.selectedYear)&&!(this.app.selectedAircraft!=="all"&&r&&r.aircraft_registration!==this.app.selectedAircraft)&&(a.groundspeed_knots||0)>0){let n=this.app.selectedPathIds.has(s);if(this.app.selectedPathIds.size>0&&!n&&this.app.buttonsHidden)return;let l=window.KMLHeatmap.getColorForAirspeed(a.groundspeed_knots??0,e,t),c=Math.round((a.groundspeed_knots||0)*1.852);ce.polyline(a.coords||[],{color:l,weight:n?6:4,opacity:n?1:this.app.selectedPathIds.size>0?.1:.85,renderer:this.app.airspeedRenderer,interactive:!0}).bindPopup("Groundspeed: "+a.groundspeed_knots+" kt ("+c+" km/h)").addTo(this.app.airspeedLayer).on("click",y=>{ce.DomEvent.stopPropagation(y),this.app.pathSelection.togglePathSelection(s)})}}),this.updateAirspeedLegend(e,t),this.app.airportManager.updateAirportOpacity(),this.app.statsManager.updateStatsForSelection()}updateAltitudeLegend(e,t){let a=Math.round(e),s=Math.round(t),r=Math.round(e*.3048),n=Math.round(t*.3048),l=o.get("legend-min"),c=o.get("legend-max");l&&(l.textContent=a.toLocaleString()+" ft ("+r.toLocaleString()+" m)"),c&&(c.textContent=s.toLocaleString()+" ft ("+n.toLocaleString()+" m)")}updateAirspeedLegend(e,t){let a=Math.round(e),s=Math.round(t),r=Math.round(e*1.852),n=Math.round(t*1.852),l=o.get("airspeed-legend-min"),c=o.get("airspeed-legend-max");l&&(l.textContent=a.toLocaleString()+" kt ("+r.toLocaleString()+" km/h)"),c&&(c.textContent=s.toLocaleString()+" kt ("+n.toLocaleString()+" km/h)")}};var Oe=class{constructor(e){this.app=e,o.cacheElements(["aircraft-select","year-select"])}updateAircraftDropdown(){if(!this.app.fullPathInfo)return;let e=o.get("aircraft-select");if(!e)return;let t=this.app.selectedAircraft;for(;e.options.length>1;)e.remove(1);let a;this.app.selectedYear==="all"?a=this.app.fullPathInfo:a=this.app.fullPathInfo.filter(l=>l.year&&l.year.toString()===this.app.selectedYear);let s={};a.forEach(l=>{if(l.aircraft_registration){let c=l.aircraft_registration;s[c]||(s[c]={registration:c,type:l.aircraft_type,flights:0}),s[c].flights+=1}});let r=Object.values(s).sort((l,c)=>c.flights-l.flights),n=!1;r.forEach(l=>{let c=document.createElement("option");c.value=l.registration;let m=l.type?" ("+l.type+")":"";c.textContent="\u2708\uFE0F "+l.registration+m,e.appendChild(c),l.registration===t&&(n=!0)}),!n&&t!=="all"?(this.app.selectedAircraft="all",e.value="all"):e.value=t}async filterByYear(){let e=o.get("year-select");if(!e)return;this.app.selectedYear=e.value,this.app.dataManager.loadedData={},this.app.altitudeLayer.clearLayers(),this.app.pathSegments={},this.app.isInitializing||this.app.selectedPathIds.clear(),await this.app.dataManager.updateLayers();let t=await this.app.dataManager.loadData("data",this.app.selectedYear);t&&(this.app.fullPathInfo=t.path_info||[],this.app.fullPathSegments=t.path_segments||[]),this.updateAircraftDropdown();let a=window.KMLHeatmap.calculateFilteredStatistics({pathInfo:this.app.fullPathInfo??[],segments:this.app.fullPathSegments??[],year:this.app.selectedYear,aircraft:this.app.selectedAircraft,coordinateCount:this.app.currentData?.original_points});this.app.statsManager.updateStatsPanel(a,!1),this.app.airportManager.updateAirportOpacity(),this.app.airportManager.updateAirportPopups(),this.app.isInitializing||this.app.stateManager.saveMapState()}async filterByAircraft(){let e=o.get("aircraft-select");if(!e)return;this.app.selectedAircraft=e.value,this.app.altitudeLayer.clearLayers(),this.app.pathSegments={},this.app.isInitializing||this.app.selectedPathIds.clear(),await this.app.dataManager.updateLayers();let t=window.KMLHeatmap.calculateFilteredStatistics({pathInfo:this.app.fullPathInfo??[],segments:this.app.fullPathSegments??[],year:this.app.selectedYear,aircraft:this.app.selectedAircraft,coordinateCount:this.app.currentData?.original_points});this.app.statsManager.updateStatsPanel(t,!1),this.app.airportManager.updateAirportOpacity(),this.app.airportManager.updateAirportPopups(),this.app.isInitializing||this.app.stateManager.saveMapState()}};var{entries:ea,setPrototypeOf:Wt,isFrozen:Ca,getPrototypeOf:Ra,getOwnPropertyDescriptor:ka}=Object,{freeze:F,seal:B,create:ut}=Object,{apply:ft,construct:gt}=typeof Reflect<"u"&&Reflect;F||(F=function(e){return e});B||(B=function(e){return e});ft||(ft=function(e,t){for(var a=arguments.length,s=new Array(a>2?a-2:0),r=2;r<a;r++)s[r-2]=arguments[r];return e.apply(t,s)});gt||(gt=function(e){for(var t=arguments.length,a=new Array(t>1?t-1:0),s=1;s<t;s++)a[s-1]=arguments[s];return new e(...a)});var He=N(Array.prototype.forEach),Da=N(Array.prototype.lastIndexOf),$t=N(Array.prototype.pop),ye=N(Array.prototype.push),Ia=N(Array.prototype.splice),Ne=N(String.prototype.toLowerCase),pt=N(String.prototype.toString),lt=N(String.prototype.match),be=N(String.prototype.replace),Oa=N(String.prototype.indexOf),Ha=N(String.prototype.trim),V=N(Object.prototype.hasOwnProperty),H=N(RegExp.prototype.test),Me=Fa(TypeError);function N(p){return function(e){e instanceof RegExp&&(e.lastIndex=0);for(var t=arguments.length,a=new Array(t>1?t-1:0),s=1;s<t;s++)a[s-1]=arguments[s];return ft(p,e,a)}}function Fa(p){return function(){for(var e=arguments.length,t=new Array(e),a=0;a<e;a++)t[a]=arguments[a];return gt(p,t)}}function g(p,e){let t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:Ne;Wt&&Wt(p,null);let a=e.length;for(;a--;){let s=e[a];if(typeof s=="string"){let r=t(s);r!==s&&(Ca(e)||(e[a]=r),s=r)}p[s]=!0}return p}function Na(p){for(let e=0;e<p.length;e++)V(p,e)||(p[e]=null);return p}function K(p){let e=ut(null);for(let[t,a]of ea(p))V(p,t)&&(Array.isArray(a)?e[t]=Na(a):a&&typeof a=="object"&&a.constructor===Object?e[t]=K(a):e[t]=a);return e}function Ae(p,e){for(;p!==null;){let a=ka(p,e);if(a){if(a.get)return N(a.get);if(typeof a.value=="function")return N(a.value)}p=Ra(p)}function t(){return null}return t}var Zt=F(["a","abbr","acronym","address","area","article","aside","audio","b","bdi","bdo","big","blink","blockquote","body","br","button","canvas","caption","center","cite","code","col","colgroup","content","data","datalist","dd","decorator","del","details","dfn","dialog","dir","div","dl","dt","element","em","fieldset","figcaption","figure","font","footer","form","h1","h2","h3","h4","h5","h6","head","header","hgroup","hr","html","i","img","input","ins","kbd","label","legend","li","main","map","mark","marquee","menu","menuitem","meter","nav","nobr","ol","optgroup","option","output","p","picture","pre","progress","q","rp","rt","ruby","s","samp","search","section","select","shadow","slot","small","source","spacer","span","strike","strong","style","sub","summary","sup","table","tbody","td","template","textarea","tfoot","th","thead","time","tr","track","tt","u","ul","var","video","wbr"]),dt=F(["svg","a","altglyph","altglyphdef","altglyphitem","animatecolor","animatemotion","animatetransform","circle","clippath","defs","desc","ellipse","enterkeyhint","exportparts","filter","font","g","glyph","glyphref","hkern","image","inputmode","line","lineargradient","marker","mask","metadata","mpath","part","path","pattern","polygon","polyline","radialgradient","rect","stop","style","switch","symbol","text","textpath","title","tref","tspan","view","vkern"]),ct=F(["feBlend","feColorMatrix","feComponentTransfer","feComposite","feConvolveMatrix","feDiffuseLighting","feDisplacementMap","feDistantLight","feDropShadow","feFlood","feFuncA","feFuncB","feFuncG","feFuncR","feGaussianBlur","feImage","feMerge","feMergeNode","feMorphology","feOffset","fePointLight","feSpecularLighting","feSpotLight","feTile","feTurbulence"]),za=F(["animate","color-profile","cursor","discard","font-face","font-face-format","font-face-name","font-face-src","font-face-uri","foreignobject","hatch","hatchpath","mesh","meshgradient","meshpatch","meshrow","missing-glyph","script","set","solidcolor","unknown","use"]),ht=F(["math","menclose","merror","mfenced","mfrac","mglyph","mi","mlabeledtr","mmultiscripts","mn","mo","mover","mpadded","mphantom","mroot","mrow","ms","mspace","msqrt","mstyle","msub","msup","msubsup","mtable","mtd","mtext","mtr","munder","munderover","mprescripts"]),Ba=F(["maction","maligngroup","malignmark","mlongdiv","mscarries","mscarry","msgroup","mstack","msline","msrow","semantics","annotation","annotation-xml","mprescripts","none"]),jt=F(["#text"]),qt=F(["accept","action","align","alt","autocapitalize","autocomplete","autopictureinpicture","autoplay","background","bgcolor","border","capture","cellpadding","cellspacing","checked","cite","class","clear","color","cols","colspan","controls","controlslist","coords","crossorigin","datetime","decoding","default","dir","disabled","disablepictureinpicture","disableremoteplayback","download","draggable","enctype","enterkeyhint","exportparts","face","for","headers","height","hidden","high","href","hreflang","id","inert","inputmode","integrity","ismap","kind","label","lang","list","loading","loop","low","max","maxlength","media","method","min","minlength","multiple","muted","name","nonce","noshade","novalidate","nowrap","open","optimum","part","pattern","placeholder","playsinline","popover","popovertarget","popovertargetaction","poster","preload","pubdate","radiogroup","readonly","rel","required","rev","reversed","role","rows","rowspan","spellcheck","scope","selected","shape","size","sizes","slot","span","srclang","start","src","srcset","step","style","summary","tabindex","title","translate","type","usemap","valign","value","width","wrap","xmlns","slot"]),mt=F(["accent-height","accumulate","additive","alignment-baseline","amplitude","ascent","attributename","attributetype","azimuth","basefrequency","baseline-shift","begin","bias","by","class","clip","clippathunits","clip-path","clip-rule","color","color-interpolation","color-interpolation-filters","color-profile","color-rendering","cx","cy","d","dx","dy","diffuseconstant","direction","display","divisor","dur","edgemode","elevation","end","exponent","fill","fill-opacity","fill-rule","filter","filterunits","flood-color","flood-opacity","font-family","font-size","font-size-adjust","font-stretch","font-style","font-variant","font-weight","fx","fy","g1","g2","glyph-name","glyphref","gradientunits","gradienttransform","height","href","id","image-rendering","in","in2","intercept","k","k1","k2","k3","k4","kerning","keypoints","keysplines","keytimes","lang","lengthadjust","letter-spacing","kernelmatrix","kernelunitlength","lighting-color","local","marker-end","marker-mid","marker-start","markerheight","markerunits","markerwidth","maskcontentunits","maskunits","max","mask","mask-type","media","method","mode","min","name","numoctaves","offset","operator","opacity","order","orient","orientation","origin","overflow","paint-order","path","pathlength","patterncontentunits","patterntransform","patternunits","points","preservealpha","preserveaspectratio","primitiveunits","r","rx","ry","radius","refx","refy","repeatcount","repeatdur","restart","result","rotate","scale","seed","shape-rendering","slope","specularconstant","specularexponent","spreadmethod","startoffset","stddeviation","stitchtiles","stop-color","stop-opacity","stroke-dasharray","stroke-dashoffset","stroke-linecap","stroke-linejoin","stroke-miterlimit","stroke-opacity","stroke","stroke-width","style","surfacescale","systemlanguage","tabindex","tablevalues","targetx","targety","transform","transform-origin","text-anchor","text-decoration","text-rendering","textlength","type","u1","u2","unicode","values","viewbox","visibility","version","vert-adv-y","vert-origin-x","vert-origin-y","width","word-spacing","wrap","writing-mode","xchannelselector","ychannelselector","x","x1","x2","xmlns","y","y1","y2","z","zoomandpan"]),Xt=F(["accent","accentunder","align","bevelled","close","columnsalign","columnlines","columnspan","denomalign","depth","dir","display","displaystyle","encoding","fence","frame","height","href","id","largeop","length","linethickness","lspace","lquote","mathbackground","mathcolor","mathsize","mathvariant","maxsize","minsize","movablelimits","notation","numalign","open","rowalign","rowlines","rowspacing","rowspan","rspace","rquote","scriptlevel","scriptminsize","scriptsizemultiplier","selection","separator","separators","stretchy","subscriptshift","supscriptshift","symmetric","voffset","width","xmlns"]),Fe=F(["xlink:href","xml:id","xlink:title","xml:space","xmlns:xlink"]),Va=B(/\{\{[\w\W]*|[\w\W]*\}\}/gm),Ua=B(/<%[\w\W]*|[\w\W]*%>/gm),Ya=B(/\$\{[\w\W]*/gm),Ga=B(/^data-[\-\w.\u00B7-\uFFFF]+$/),Ka=B(/^aria-[\-\w]+$/),ta=B(/^(?:(?:(?:f|ht)tps?|mailto|tel|callto|sms|cid|xmpp|matrix):|[^a-z]|[a-z+.\-]+(?:[^a-z+.\-:]|$))/i),Wa=B(/^(?:\w+script|data):/i),$a=B(/[\u0000-\u0020\u00A0\u1680\u180E\u2000-\u2029\u205F\u3000]/g),aa=B(/^html$/i),Za=B(/^[a-z][.\w]*(-[.\w]+)+$/i),Jt=Object.freeze({__proto__:null,ARIA_ATTR:Ka,ATTR_WHITESPACE:$a,CUSTOM_ELEMENT:Za,DATA_ATTR:Ga,DOCTYPE_NAME:aa,ERB_EXPR:Ua,IS_ALLOWED_URI:ta,IS_SCRIPT_OR_DATA:Wa,MUSTACHE_EXPR:Va,TMPLIT_EXPR:Ya}),ve={element:1,attribute:2,text:3,cdataSection:4,entityReference:5,entityNode:6,progressingInstruction:7,comment:8,document:9,documentType:10,documentFragment:11,notation:12},ja=function(){return typeof window>"u"?null:window},qa=function(e,t){if(typeof e!="object"||typeof e.createPolicy!="function")return null;let a=null,s="data-tt-policy-suffix";t&&t.hasAttribute(s)&&(a=t.getAttribute(s));let r="dompurify"+(a?"#"+a:"");try{return e.createPolicy(r,{createHTML(n){return n},createScriptURL(n){return n}})}catch{return console.warn("TrustedTypes policy "+r+" could not be created."),null}},Qt=function(){return{afterSanitizeAttributes:[],afterSanitizeElements:[],afterSanitizeShadowDOM:[],beforeSanitizeAttributes:[],beforeSanitizeElements:[],beforeSanitizeShadowDOM:[],uponSanitizeAttribute:[],uponSanitizeElement:[],uponSanitizeShadowNode:[]}};function ia(){let p=arguments.length>0&&arguments[0]!==void 0?arguments[0]:ja(),e=u=>ia(u);if(e.version="3.3.1",e.removed=[],!p||!p.document||p.document.nodeType!==ve.document||!p.Element)return e.isSupported=!1,e;let{document:t}=p,a=t,s=a.currentScript,{DocumentFragment:r,HTMLTemplateElement:n,Node:l,Element:c,NodeFilter:m,NamedNodeMap:y=p.NamedNodeMap||p.MozNamedAttrMap,HTMLFormElement:M,DOMParser:b,trustedTypes:f}=p,v=c.prototype,T=Ae(v,"cloneNode"),D=Ae(v,"remove"),X=Ae(v,"nextSibling"),$=Ae(v,"childNodes"),S=Ae(v,"parentNode");if(typeof n=="function"){let u=t.createElement("template");u.content&&u.content.ownerDocument&&(t=u.content.ownerDocument)}let A,U="",{implementation:Q,createNodeIterator:he,createDocumentFragment:ie,getElementsByTagName:Se}=t,{importNode:la}=a,O=Qt();e.isSupported=typeof ea=="function"&&typeof S=="function"&&Q&&Q.createHTMLDocument!==void 0;let{MUSTACHE_EXPR:We,ERB_EXPR:$e,TMPLIT_EXPR:Ze,DATA_ATTR:da,ARIA_ATTR:ca,IS_SCRIPT_OR_DATA:ha,ATTR_WHITESPACE:bt,CUSTOM_ELEMENT:ma}=Jt,{IS_ALLOWED_URI:Mt}=Jt,P=null,At=g({},[...Zt,...dt,...ct,...ht,...jt]),C=null,vt=g({},[...qt,...mt,...Xt,...Fe]),x=Object.seal(ut(null,{tagNameCheck:{writable:!0,configurable:!1,enumerable:!0,value:null},attributeNameCheck:{writable:!0,configurable:!1,enumerable:!0,value:null},allowCustomizedBuiltInElements:{writable:!0,configurable:!1,enumerable:!0,value:!1}})),me=null,je=null,re=Object.seal(ut(null,{tagCheck:{writable:!0,configurable:!1,enumerable:!0,value:null},attributeCheck:{writable:!0,configurable:!1,enumerable:!0,value:null}})),St=!0,qe=!0,Lt=!1,_t=!0,se=!1,Le=!0,ee=!1,Xe=!1,Je=!1,ne=!1,_e=!1,Te=!1,Tt=!0,xt=!1,ua="user-content-",Qe=!0,ue=!1,oe={},Y=null,et=g({},["annotation-xml","audio","colgroup","desc","foreignobject","head","iframe","math","mi","mn","mo","ms","mtext","noembed","noframes","noscript","plaintext","script","style","svg","template","thead","title","video","xmp"]),wt=null,Et=g({},["audio","video","img","source","image","track"]),tt=null,Pt=g({},["alt","class","for","id","label","name","pattern","placeholder","role","summary","title","value","style","xmlns"]),xe="http://www.w3.org/1998/Math/MathML",we="http://www.w3.org/2000/svg",Z="http://www.w3.org/1999/xhtml",pe=Z,at=!1,it=null,fa=g({},[xe,we,Z],pt),Ee=g({},["mi","mo","mn","ms","mtext"]),Pe=g({},["annotation-xml"]),ga=g({},["title","style","font","a","script"]),fe=null,ya=["application/xhtml+xml","text/html"],ba="text/html",E=null,le=null,Ma=t.createElement("form"),Ct=function(i){return i instanceof RegExp||i instanceof Function},rt=function(){let i=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};if(!(le&&le===i)){if((!i||typeof i!="object")&&(i={}),i=K(i),fe=ya.indexOf(i.PARSER_MEDIA_TYPE)===-1?ba:i.PARSER_MEDIA_TYPE,E=fe==="application/xhtml+xml"?pt:Ne,P=V(i,"ALLOWED_TAGS")?g({},i.ALLOWED_TAGS,E):At,C=V(i,"ALLOWED_ATTR")?g({},i.ALLOWED_ATTR,E):vt,it=V(i,"ALLOWED_NAMESPACES")?g({},i.ALLOWED_NAMESPACES,pt):fa,tt=V(i,"ADD_URI_SAFE_ATTR")?g(K(Pt),i.ADD_URI_SAFE_ATTR,E):Pt,wt=V(i,"ADD_DATA_URI_TAGS")?g(K(Et),i.ADD_DATA_URI_TAGS,E):Et,Y=V(i,"FORBID_CONTENTS")?g({},i.FORBID_CONTENTS,E):et,me=V(i,"FORBID_TAGS")?g({},i.FORBID_TAGS,E):K({}),je=V(i,"FORBID_ATTR")?g({},i.FORBID_ATTR,E):K({}),oe=V(i,"USE_PROFILES")?i.USE_PROFILES:!1,St=i.ALLOW_ARIA_ATTR!==!1,qe=i.ALLOW_DATA_ATTR!==!1,Lt=i.ALLOW_UNKNOWN_PROTOCOLS||!1,_t=i.ALLOW_SELF_CLOSE_IN_ATTR!==!1,se=i.SAFE_FOR_TEMPLATES||!1,Le=i.SAFE_FOR_XML!==!1,ee=i.WHOLE_DOCUMENT||!1,ne=i.RETURN_DOM||!1,_e=i.RETURN_DOM_FRAGMENT||!1,Te=i.RETURN_TRUSTED_TYPE||!1,Je=i.FORCE_BODY||!1,Tt=i.SANITIZE_DOM!==!1,xt=i.SANITIZE_NAMED_PROPS||!1,Qe=i.KEEP_CONTENT!==!1,ue=i.IN_PLACE||!1,Mt=i.ALLOWED_URI_REGEXP||ta,pe=i.NAMESPACE||Z,Ee=i.MATHML_TEXT_INTEGRATION_POINTS||Ee,Pe=i.HTML_INTEGRATION_POINTS||Pe,x=i.CUSTOM_ELEMENT_HANDLING||{},i.CUSTOM_ELEMENT_HANDLING&&Ct(i.CUSTOM_ELEMENT_HANDLING.tagNameCheck)&&(x.tagNameCheck=i.CUSTOM_ELEMENT_HANDLING.tagNameCheck),i.CUSTOM_ELEMENT_HANDLING&&Ct(i.CUSTOM_ELEMENT_HANDLING.attributeNameCheck)&&(x.attributeNameCheck=i.CUSTOM_ELEMENT_HANDLING.attributeNameCheck),i.CUSTOM_ELEMENT_HANDLING&&typeof i.CUSTOM_ELEMENT_HANDLING.allowCustomizedBuiltInElements=="boolean"&&(x.allowCustomizedBuiltInElements=i.CUSTOM_ELEMENT_HANDLING.allowCustomizedBuiltInElements),se&&(qe=!1),_e&&(ne=!0),oe&&(P=g({},jt),C=[],oe.html===!0&&(g(P,Zt),g(C,qt)),oe.svg===!0&&(g(P,dt),g(C,mt),g(C,Fe)),oe.svgFilters===!0&&(g(P,ct),g(C,mt),g(C,Fe)),oe.mathMl===!0&&(g(P,ht),g(C,Xt),g(C,Fe))),i.ADD_TAGS&&(typeof i.ADD_TAGS=="function"?re.tagCheck=i.ADD_TAGS:(P===At&&(P=K(P)),g(P,i.ADD_TAGS,E))),i.ADD_ATTR&&(typeof i.ADD_ATTR=="function"?re.attributeCheck=i.ADD_ATTR:(C===vt&&(C=K(C)),g(C,i.ADD_ATTR,E))),i.ADD_URI_SAFE_ATTR&&g(tt,i.ADD_URI_SAFE_ATTR,E),i.FORBID_CONTENTS&&(Y===et&&(Y=K(Y)),g(Y,i.FORBID_CONTENTS,E)),i.ADD_FORBID_CONTENTS&&(Y===et&&(Y=K(Y)),g(Y,i.ADD_FORBID_CONTENTS,E)),Qe&&(P["#text"]=!0),ee&&g(P,["html","head","body"]),P.table&&(g(P,["tbody"]),delete me.tbody),i.TRUSTED_TYPES_POLICY){if(typeof i.TRUSTED_TYPES_POLICY.createHTML!="function")throw Me('TRUSTED_TYPES_POLICY configuration option must provide a "createHTML" hook.');if(typeof i.TRUSTED_TYPES_POLICY.createScriptURL!="function")throw Me('TRUSTED_TYPES_POLICY configuration option must provide a "createScriptURL" hook.');A=i.TRUSTED_TYPES_POLICY,U=A.createHTML("")}else A===void 0&&(A=qa(f,s)),A!==null&&typeof U=="string"&&(U=A.createHTML(""));F&&F(i),le=i}},Rt=g({},[...dt,...ct,...za]),kt=g({},[...ht,...Ba]),Aa=function(i){let d=S(i);(!d||!d.tagName)&&(d={namespaceURI:pe,tagName:"template"});let h=Ne(i.tagName),_=Ne(d.tagName);return it[i.namespaceURI]?i.namespaceURI===we?d.namespaceURI===Z?h==="svg":d.namespaceURI===xe?h==="svg"&&(_==="annotation-xml"||Ee[_]):!!Rt[h]:i.namespaceURI===xe?d.namespaceURI===Z?h==="math":d.namespaceURI===we?h==="math"&&Pe[_]:!!kt[h]:i.namespaceURI===Z?d.namespaceURI===we&&!Pe[_]||d.namespaceURI===xe&&!Ee[_]?!1:!kt[h]&&(ga[h]||!Rt[h]):!!(fe==="application/xhtml+xml"&&it[i.namespaceURI]):!1},G=function(i){ye(e.removed,{element:i});try{S(i).removeChild(i)}catch{D(i)}},te=function(i,d){try{ye(e.removed,{attribute:d.getAttributeNode(i),from:d})}catch{ye(e.removed,{attribute:null,from:d})}if(d.removeAttribute(i),i==="is")if(ne||_e)try{G(d)}catch{}else try{d.setAttribute(i,"")}catch{}},Dt=function(i){let d=null,h=null;if(Je)i="<remove></remove>"+i;else{let w=lt(i,/^[\r\n\t ]+/);h=w&&w[0]}fe==="application/xhtml+xml"&&pe===Z&&(i='<html xmlns="http://www.w3.org/1999/xhtml"><head></head><body>'+i+"</body></html>");let _=A?A.createHTML(i):i;if(pe===Z)try{d=new b().parseFromString(_,fe)}catch{}if(!d||!d.documentElement){d=Q.createDocument(pe,"template",null);try{d.documentElement.innerHTML=at?U:_}catch{}}let I=d.body||d.documentElement;return i&&h&&I.insertBefore(t.createTextNode(h),I.childNodes[0]||null),pe===Z?Se.call(d,ee?"html":"body")[0]:ee?d.documentElement:I},It=function(i){return he.call(i.ownerDocument||i,i,m.SHOW_ELEMENT|m.SHOW_COMMENT|m.SHOW_TEXT|m.SHOW_PROCESSING_INSTRUCTION|m.SHOW_CDATA_SECTION,null)},st=function(i){return i instanceof M&&(typeof i.nodeName!="string"||typeof i.textContent!="string"||typeof i.removeChild!="function"||!(i.attributes instanceof y)||typeof i.removeAttribute!="function"||typeof i.setAttribute!="function"||typeof i.namespaceURI!="string"||typeof i.insertBefore!="function"||typeof i.hasChildNodes!="function")},Ot=function(i){return typeof l=="function"&&i instanceof l};function j(u,i,d){He(u,h=>{h.call(e,i,d,le)})}let Ht=function(i){let d=null;if(j(O.beforeSanitizeElements,i,null),st(i))return G(i),!0;let h=E(i.nodeName);if(j(O.uponSanitizeElement,i,{tagName:h,allowedTags:P}),Le&&i.hasChildNodes()&&!Ot(i.firstElementChild)&&H(/<[/\w!]/g,i.innerHTML)&&H(/<[/\w!]/g,i.textContent)||i.nodeType===ve.progressingInstruction||Le&&i.nodeType===ve.comment&&H(/<[/\w]/g,i.data))return G(i),!0;if(!(re.tagCheck instanceof Function&&re.tagCheck(h))&&(!P[h]||me[h])){if(!me[h]&&Nt(h)&&(x.tagNameCheck instanceof RegExp&&H(x.tagNameCheck,h)||x.tagNameCheck instanceof Function&&x.tagNameCheck(h)))return!1;if(Qe&&!Y[h]){let _=S(i)||i.parentNode,I=$(i)||i.childNodes;if(I&&_){let w=I.length;for(let z=w-1;z>=0;--z){let q=T(I[z],!0);q.t=(i.t||0)+1,_.insertBefore(q,X(i))}}}return G(i),!0}return i instanceof c&&!Aa(i)||(h==="noscript"||h==="noembed"||h==="noframes")&&H(/<\/no(script|embed|frames)/i,i.innerHTML)?(G(i),!0):(se&&i.nodeType===ve.text&&(d=i.textContent,He([We,$e,Ze],_=>{d=be(d,_," ")}),i.textContent!==d&&(ye(e.removed,{element:i.cloneNode()}),i.textContent=d)),j(O.afterSanitizeElements,i,null),!1)},Ft=function(i,d,h){if(Tt&&(d==="id"||d==="name")&&(h in t||h in Ma))return!1;if(!(qe&&!je[d]&&H(da,d))){if(!(St&&H(ca,d))){if(!(re.attributeCheck instanceof Function&&re.attributeCheck(d,i))){if(!C[d]||je[d]){if(!(Nt(i)&&(x.tagNameCheck instanceof RegExp&&H(x.tagNameCheck,i)||x.tagNameCheck instanceof Function&&x.tagNameCheck(i))&&(x.attributeNameCheck instanceof RegExp&&H(x.attributeNameCheck,d)||x.attributeNameCheck instanceof Function&&x.attributeNameCheck(d,i))||d==="is"&&x.allowCustomizedBuiltInElements&&(x.tagNameCheck instanceof RegExp&&H(x.tagNameCheck,h)||x.tagNameCheck instanceof Function&&x.tagNameCheck(h))))return!1}else if(!tt[d]){if(!H(Mt,be(h,bt,""))){if(!((d==="src"||d==="xlink:href"||d==="href")&&i!=="script"&&Oa(h,"data:")===0&&wt[i])){if(!(Lt&&!H(ha,be(h,bt,"")))){if(h)return!1}}}}}}}return!0},Nt=function(i){return i!=="annotation-xml"&&lt(i,ma)},zt=function(i){j(O.beforeSanitizeAttributes,i,null);let{attributes:d}=i;if(!d||st(i))return;let h={attrName:"",attrValue:"",keepAttr:!0,allowedAttributes:C,forceKeepAttr:void 0},_=d.length;for(;_--;){let I=d[_],{name:w,namespaceURI:z,value:q}=I,de=E(w),nt=q,R=w==="value"?nt:Ha(nt);if(h.attrName=de,h.attrValue=R,h.keepAttr=!0,h.forceKeepAttr=void 0,j(O.uponSanitizeAttribute,i,h),R=h.attrValue,xt&&(de==="id"||de==="name")&&(te(w,i),R=ua+R),Le&&H(/((--!?|])>)|<\/(style|title|textarea)/i,R)){te(w,i);continue}if(de==="attributename"&&lt(R,"href")){te(w,i);continue}if(h.forceKeepAttr)continue;if(!h.keepAttr){te(w,i);continue}if(!_t&&H(/\/>/i,R)){te(w,i);continue}se&&He([We,$e,Ze],Vt=>{R=be(R,Vt," ")});let Bt=E(i.nodeName);if(!Ft(Bt,de,R)){te(w,i);continue}if(A&&typeof f=="object"&&typeof f.getAttributeType=="function"&&!z)switch(f.getAttributeType(Bt,de)){case"TrustedHTML":{R=A.createHTML(R);break}case"TrustedScriptURL":{R=A.createScriptURL(R);break}}if(R!==nt)try{z?i.setAttributeNS(z,w,R):i.setAttribute(w,R),st(i)?G(i):$t(e.removed)}catch{te(w,i)}}j(O.afterSanitizeAttributes,i,null)},va=function u(i){let d=null,h=It(i);for(j(O.beforeSanitizeShadowDOM,i,null);d=h.nextNode();)j(O.uponSanitizeShadowNode,d,null),Ht(d),zt(d),d.content instanceof r&&u(d.content);j(O.afterSanitizeShadowDOM,i,null)};return e.sanitize=function(u){let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},d=null,h=null,_=null,I=null;if(at=!u,at&&(u="<!-->"),typeof u!="string"&&!Ot(u))if(typeof u.toString=="function"){if(u=u.toString(),typeof u!="string")throw Me("dirty is not a string, aborting")}else throw Me("toString is not a function");if(!e.isSupported)return u;if(Xe||rt(i),e.removed=[],typeof u=="string"&&(ue=!1),ue){if(u.nodeName){let q=E(u.nodeName);if(!P[q]||me[q])throw Me("root node is forbidden and cannot be sanitized in-place")}}else if(u instanceof l)d=Dt("<!---->"),h=d.ownerDocument.importNode(u,!0),h.nodeType===ve.element&&h.nodeName==="BODY"||h.nodeName==="HTML"?d=h:d.appendChild(h);else{if(!ne&&!se&&!ee&&u.indexOf("<")===-1)return A&&Te?A.createHTML(u):u;if(d=Dt(u),!d)return ne?null:Te?U:""}d&&Je&&G(d.firstChild);let w=It(ue?u:d);for(;_=w.nextNode();)Ht(_),zt(_),_.content instanceof r&&va(_.content);if(ue)return u;if(ne){if(_e)for(I=ie.call(d.ownerDocument);d.firstChild;)I.appendChild(d.firstChild);else I=d;return(C.shadowroot||C.shadowrootmode)&&(I=la.call(a,I,!0)),I}let z=ee?d.outerHTML:d.innerHTML;return ee&&P["!doctype"]&&d.ownerDocument&&d.ownerDocument.doctype&&d.ownerDocument.doctype.name&&H(aa,d.ownerDocument.doctype.name)&&(z="<!DOCTYPE "+d.ownerDocument.doctype.name+`>
`+z),se&&He([We,$e,Ze],q=>{z=be(z,q," ")}),A&&Te?A.createHTML(z):z},e.setConfig=function(){let u=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};rt(u),Xe=!0},e.clearConfig=function(){le=null,Xe=!1},e.isValidAttribute=function(u,i,d){le||rt({});let h=E(u),_=E(i);return Ft(h,_,d)},e.addHook=function(u,i){typeof i=="function"&&ye(O[u],i)},e.removeHook=function(u,i){if(i!==void 0){let d=Da(O[u],i);return d===-1?void 0:Ia(O[u],d,1)[0]}return $t(O[u])},e.removeHooks=function(u){O[u]=[]},e.removeAllHooks=function(){O=Qt()},e}var J=ia();var ze=class{constructor(e){this.app=e,o.cacheElements(["stats-panel"])}updateStatsForSelection(){if(this.app.selectedPathIds.size===0){let n=window.KMLHeatmap.calculateFilteredStatistics({pathInfo:this.app.fullPathInfo||[],segments:this.app.fullPathSegments||[],year:this.app.selectedYear,aircraft:this.app.selectedAircraft,coordinateCount:this.app.currentData?.original_points});n&&this.updateStatsPanel(n,!1);return}let e=(this.app.fullPathInfo||[]).filter(n=>this.app.selectedPathIds.has(n.id)),t=(this.app.fullPathSegments||[]).filter(n=>this.app.selectedPathIds.has(n.path_id));if(t.length===0)return;let a=new Set;for(let n of t)n.coords&&n.coords.length===2&&(a.add(JSON.stringify(n.coords[0])),a.add(JSON.stringify(n.coords[1])));let s=a.size,r=window.KMLHeatmap.calculateFilteredStatistics({pathInfo:e,segments:t,year:"all",aircraft:"all",coordinateCount:s});this.updateStatsPanel(r,!0)}updateStatsPanel(e,t){let a="";t?(a+='<p style="margin:0 0 10px 0; font-weight:bold; font-size:15px;">\u{1F4CA} Selected Paths Statistics</p>',a+='<div style="background-color: #3a5a7a; padding: 4px 8px; margin-bottom: 8px; border-radius: 3px; font-size: 11px; color: #a0c0e0;">Showing stats for '+e.num_paths+" selected path(s)</div>"):a+='<p style="margin:0 0 10px 0; font-weight:bold; font-size:15px;">\u{1F4CA} Flight Statistics</p>',a+='<div style="margin-bottom: 8px;"><strong>Data Points:</strong> '+e.total_points.toLocaleString()+"</div>",a+='<div style="margin-bottom: 8px;"><strong>Flights:</strong> '+e.num_paths+"</div>",e.airport_names&&e.airport_names.length>0&&(a+='<div style="margin-bottom: 8px; max-height: 150px; overflow-y: auto;"><strong>Airports ('+e.num_airports+"):</strong><br>",e.airport_names.forEach(n=>{a+='<span style="margin-left: 10px;">\u2022 '+n+"</span><br>"}),a+="</div>"),e.num_aircraft&&e.num_aircraft>0&&e.aircraft_list&&e.aircraft_list.length>0&&(a+='<div style="margin-bottom: 8px; max-height: 150px; overflow-y: auto;"><strong>Aircrafts ('+e.num_aircraft+"):</strong><br>",e.aircraft_list.forEach(n=>{let l=n.type?" ("+n.type+")":"";a+='<span style="margin-left: 10px;">\u2022 '+n.registration+l+" - "+n.flights+" flight(s)</span><br>"}),a+="</div>"),e.total_flight_time_str&&(a+='<div style="margin-bottom: 8px;"><strong>Total Flight Time:</strong> '+e.total_flight_time_str+"</div>");let s=(e.total_distance_nm*1.852).toFixed(1);if(a+='<div style="margin-bottom: 8px;"><strong>Distance:</strong> '+e.total_distance_nm.toFixed(1)+" nm ("+s+" km)</div>",e.num_paths>0){let n=(e.total_distance_nm/e.num_paths).toFixed(1),l=(parseFloat(n)*1.852).toFixed(1);a+='<div style="margin-bottom: 8px;"><strong>Average Distance per Trip:</strong> '+n+" nm ("+l+" km)</div>"}if(e.longest_flight_nm&&e.longest_flight_nm>0){let n=(e.longest_flight_km||0).toFixed(1);a+='<div style="margin-bottom: 8px;"><strong>Longest Flight:</strong> '+e.longest_flight_nm.toFixed(1)+" nm ("+n+" km)</div>"}if(e.average_groundspeed_knots&&e.average_groundspeed_knots>0){let n=Math.round(e.average_groundspeed_knots*1.852);a+='<div style="margin-bottom: 8px;"><strong>Average Groundspeed:</strong> '+Math.round(e.average_groundspeed_knots)+" kt ("+n+" km/h)</div>"}if(e.cruise_speed_knots&&e.cruise_speed_knots>0){let n=Math.round(e.cruise_speed_knots*1.852);a+='<div style="margin-bottom: 8px;"><strong>Cruise Speed (>1000ft AGL):</strong> '+Math.round(e.cruise_speed_knots)+" kt ("+n+" km/h)</div>"}if(e.max_groundspeed_knots&&e.max_groundspeed_knots>0){let n=Math.round(e.max_groundspeed_knots*1.852);a+='<div style="margin-bottom: 8px;"><strong>Max Groundspeed:</strong> '+Math.round(e.max_groundspeed_knots)+" kt ("+n+" km/h)</div>"}if(e.max_altitude_ft){let n=Math.round(e.max_altitude_ft*.3048);if(a+='<div style="margin-bottom: 8px;"><strong>Max Altitude (MSL):</strong> '+Math.round(e.max_altitude_ft)+" ft ("+n+" m)</div>",e.total_altitude_gain_ft){let l=Math.round(e.total_altitude_gain_ft*.3048);a+='<div style="margin-bottom: 8px;"><strong>Elevation Gain:</strong> '+Math.round(e.total_altitude_gain_ft)+" ft ("+l+" m)</div>"}}if(e.most_common_cruise_altitude_ft&&e.most_common_cruise_altitude_ft>0){let n=Math.round(e.most_common_cruise_altitude_m||0);a+='<div style="margin-bottom: 8px;"><strong>Most Common Cruise Altitude (AGL):</strong> '+e.most_common_cruise_altitude_ft.toLocaleString()+" ft ("+n.toLocaleString()+" m)</div>"}let r=o.get("stats-panel");r&&(r.innerHTML=J.sanitize(a))}toggleStats(){let e=o.get("stats-panel");e&&(e.classList.contains("visible")?(e.classList.remove("visible"),setTimeout(()=>{e.style.display="none",this.app.stateManager.saveMapState()},300)):(e.style.display="block",e.offsetHeight,e.classList.add("visible"),this.app.stateManager.saveMapState()))}};function ae(p,e=50){p&&setTimeout(()=>{p.invalidateSize()},e)}var Be=class{constructor(e){this.app=e}togglePathSelection(e){this.app.selectedPathIds.has(e)?this.app.selectedPathIds.delete(e):this.app.selectedPathIds.add(e),this.app.altitudeVisible&&(this.app.layerManager.redrawAltitudePaths(),ae(this.app.map)),this.app.airspeedVisible&&(this.app.layerManager.redrawAirspeedPaths(),ae(this.app.map)),this.app.replayManager.updateReplayButtonState(),this.app.stateManager.saveMapState()}selectPathsByAirport(e){let t=this.app.airportToPaths[e];t&&t.forEach(a=>{this.app.selectedPathIds.add(a)}),this.app.altitudeVisible&&(this.app.layerManager.redrawAltitudePaths(),ae(this.app.map)),this.app.airspeedVisible&&(this.app.layerManager.redrawAirspeedPaths(),ae(this.app.map)),this.app.replayManager.updateReplayButtonState(),this.app.stateManager.saveMapState()}clearSelection(){this.app.selectedPathIds.clear(),this.app.altitudeVisible&&(this.app.layerManager.redrawAltitudePaths(),ae(this.app.map)),this.app.airspeedVisible&&(this.app.layerManager.redrawAirspeedPaths(),ae(this.app.map)),this.app.replayManager.updateReplayButtonState(),this.app.stateManager.saveMapState()}};var Ve=class{constructor(e){this.app=e}calculateAirportFlightCounts(){return window.KMLHeatmap.calculateAirportFlightCounts(this.app.fullPathInfo??[],this.app.selectedYear,this.app.selectedAircraft)}updateAirportPopups(){if(!this.app.allAirportsData||!this.app.airportMarkers)return;let e=this.calculateAirportFlightCounts(),t=null,a=0;Object.keys(e).forEach(s=>{let r=e[s];r!==void 0&&r>a&&(a=r,t=s)}),this.app.allAirportsData.forEach(s=>{let r=this.app.airportMarkers[s.name];if(!r)return;let n=e[s.name]||0,l=s.name===t,c=window.KMLHeatmap.ddToDms(s.lat,!0),m=window.KMLHeatmap.ddToDms(s.lon,!1),y=`https://www.google.com/maps?q=${s.lat},${s.lon}`,M=`
            <div style="
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
                min-width: 220px;
                padding: 8px 4px;
                background-color: #2b2b2b;
                color: #ffffff;
            ">
                <div style="
                    font-size: 15px;
                    font-weight: bold;
                    color: #28a745;
                    margin-bottom: 10px;
                    padding-bottom: 8px;
                    border-bottom: 2px solid #28a745;
                    display: flex;
                    align-items: center;
                    gap: 6px;
                ">
                    <span style="font-size: 18px;">\u{1F6EB}</span>
                    <span>${s.name||"Unknown"}</span>
                    ${l?'<span style="font-size: 12px; background: #007bff; color: white; padding: 2px 6px; border-radius: 3px; margin-left: 4px;">HOME</span>':""}
                </div>
                <div style="margin-bottom: 8px;">
                    <div style="font-size: 11px; color: #999; margin-bottom: 2px; text-transform: uppercase; letter-spacing: 0.5px;">Coordinates</div>
                    <a href="${y}"
                       target="_blank"
                       style="
                           color: #4facfe;
                           text-decoration: none;
                           font-size: 12px;
                           font-family: monospace;
                           display: flex;
                           align-items: center;
                           gap: 4px;
                       "
                       onmouseover="this.style.textDecoration='underline'"
                       onmouseout="this.style.textDecoration='none'">
                        <span>\u{1F4CD}</span>
                        <span>${c}<br>${m}</span>
                    </a>
                </div>
                <div style="
                    background: linear-gradient(135deg, rgba(79, 172, 254, 0.15) 0%, rgba(0, 242, 254, 0.15) 100%);
                    padding: 8px 10px;
                    border-radius: 6px;
                    border-left: 3px solid #4facfe;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                ">
                    <span style="font-size: 12px; color: #ccc; font-weight: 500;">Total Flights</span>
                    <span style="font-size: 16px; font-weight: bold; color: #4facfe;">${n}</span>
                </div>
            </div>`;r.setPopupContent(M)})}updateAirportOpacity(){let e=this.app.selectedYear!=="all"||this.app.selectedAircraft!=="all",t=this.app.selectedPathIds.size>0;if(!e&&!t){Object.keys(this.app.airportMarkers).forEach(s=>{let r=this.app.airportMarkers[s];r&&(r.setOpacity(1),this.app.airportLayer.hasLayer(r)||r.addTo(this.app.airportLayer))});return}let a=new Set;e&&this.app.fullPathInfo&&this.app.fullPathInfo.forEach(s=>{let r=this.app.selectedYear==="all"||s.year&&s.year.toString()===this.app.selectedYear,n=this.app.selectedAircraft==="all"||s.aircraft_registration===this.app.selectedAircraft;r&&n&&(s.start_airport&&a.add(s.start_airport),s.end_airport&&a.add(s.end_airport))}),t&&this.app.selectedPathIds.forEach(s=>{if(this.app.fullPathInfo){let r=this.app.fullPathInfo.find(n=>n.id===s);r&&(r.start_airport&&a.add(r.start_airport),r.end_airport&&a.add(r.end_airport))}else{let r=this.app.pathToAirports[s];r&&(r.start&&a.add(r.start),r.end&&a.add(r.end))}}),Object.keys(this.app.airportMarkers).forEach(s=>{let r=this.app.airportMarkers[s];r&&(a.has(s)?(r.setOpacity(1),this.app.airportLayer.hasLayer(r)||r.addTo(this.app.airportLayer)):this.app.airportLayer.hasLayer(r)&&this.app.airportLayer.removeLayer(r))})}updateAirportMarkerSizes(){if(!this.app.map)return;let e=this.app.map.getZoom(),t="";e>=14?t="xlarge":e>=12?t="large":e>=10?t="medium":e>=8?t="medium-small":e>=6&&(t="small"),document.querySelectorAll(".airport-marker-container").forEach(a=>{let s=a.querySelector(".airport-marker"),r=a.querySelector(".airport-label");!s||!r||(e<5?r.style.display="none":r.style.display="",a.classList.remove("airport-marker-container-small","airport-marker-container-medium-small","airport-marker-container-medium","airport-marker-container-large","airport-marker-container-xlarge"),s.classList.remove("airport-marker-small","airport-marker-medium-small","airport-marker-medium","airport-marker-large","airport-marker-xlarge"),r.classList.remove("airport-label-small","airport-label-medium-small","airport-label-medium","airport-label-large","airport-label-xlarge"),t&&(a.classList.add("airport-marker-container-"+t),s.classList.add("airport-marker-"+t),r.classList.add("airport-label-"+t)))})}};var W=Re(ge(),1);var Ue=class{constructor(e){this.app=e,o.cacheElements(["replay-controls","replay-btn","replay-play-btn","replay-pause-btn","replay-slider","replay-slider-start","replay-slider-end","replay-time-display","replay-speed","replay-autozoom-btn","altitude-btn","altitude-legend"]),this.replayActive=!1,this.replayPlaying=!1,this.replayCurrentTime=0,this.replayMaxTime=0,this.replaySpeed=50,this.replayInterval=null,this.replayLayer=null,this.replaySegments=[],this.replayAirplaneMarker=null,this.replayLastDrawnIndex=-1,this.replayLastBearing=null,this.replayAnimationFrameId=null,this.replayLastFrameTime=null,this.replayColorMinAlt=0,this.replayColorMaxAlt=1e4,this.replayColorMinSpeed=0,this.replayColorMaxSpeed=200,this.replayAutoZoom=!1,this.replayLastZoom=null,this.replayRecenterTimestamps=[]}toggleReplay(){let e=o.get("replay-controls");if(e)if(this.replayActive){this.stopReplay(),e.style.display="none",this.replayActive=!1;let t=o.get("replay-btn");if(t&&(t.textContent="\u25B6\uFE0F Replay"),document.body.classList.remove("replay-active"),this.replayAirplaneMarker&&this.app.map&&(this.app.map.removeLayer(this.replayAirplaneMarker),this.replayAirplaneMarker=null),this.replayLayer&&this.app.map&&this.app.map.removeLayer(this.replayLayer),this.restoreLayerVisibility(),!this.app.altitudeVisible&&!this.app.airspeedVisible&&this.app.map){this.app.altitudeVisible=!0;let a=o.get("altitude-btn");a&&(a.style.opacity="1.0");let s=o.get("altitude-legend");s&&(s.style.display="block"),this.app.map.addLayer(this.app.altitudeLayer)}setTimeout(()=>{this.app.altitudeVisible?this.app.layerManager.redrawAltitudePaths():this.app.airspeedVisible&&this.app.layerManager.redrawAirspeedPaths(),this.app.map&&this.app.map.invalidateSize()},100),this.updateReplayButtonState(),this.app.stateManager.saveMapState()}else{if(this.app.selectedPathIds.size!==1)return;if(this.initializeReplay()){e.style.display="block",this.replayActive=!0;let t=o.get("replay-btn");t&&(t.textContent="\u23F9\uFE0F Replay",t.style.opacity="1.0");let a=o.get("replay-autozoom-btn");a&&(a.style.opacity=this.replayAutoZoom?"1.0":"0.5",a.title=this.replayAutoZoom?"Auto-zoom enabled":"Auto-zoom disabled"),document.body.classList.add("replay-active"),this.hideOtherLayersDuringReplay(),this.app.stateManager.saveMapState()}}}updateReplayButtonState(){let e=o.get("replay-btn");if(!e)return;let t=this.app.fullStats&&this.app.fullStats.max_groundspeed_knots!==void 0&&this.app.fullStats.max_groundspeed_knots>0;this.app.selectedPathIds.size===1&&t?(e.style.opacity="1.0",e.disabled=!1,e.setAttribute("aria-disabled","false")):(e.style.opacity="0.5",e.disabled=!0,e.setAttribute("aria-disabled","true"))}updateReplayAirplanePopup(){if(!this.replayAirplaneMarker||!this.replayActive)return;let e=null;for(let v=0;v<this.replaySegments.length;v++){let T=this.replaySegments[v];if(T&&(T.time||0)<=this.replayCurrentTime)e=T;else break}if(!e&&this.replaySegments.length>0&&(e=this.replaySegments[0]),!e)return;let t=`<div style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif; min-width: 180px; padding: 8px 4px; background-color: #2b2b2b; color: #ffffff;">`;t+='<div style="font-size: 14px; font-weight: bold; color: #4facfe; margin-bottom: 8px; padding-bottom: 6px; border-bottom: 2px solid #4facfe; display: flex; align-items: center; gap: 6px;">',t+='<span style="font-size: 16px;">\u2708\uFE0F</span>',t+="<span>Current Position</span>",t+="</div>";let a=e.altitude_ft||0,s=Math.round(a/50)*50,r=Math.round(s*.3048),n=window.KMLHeatmap.getColorForAltitude(a,this.replayColorMinAlt,this.replayColorMaxAlt),l=n.replace("rgb(","rgba(").replace(")",", 0.15)");t+='<div style="margin-bottom: 8px;">',t+='<div style="font-size: 11px; color: #999; margin-bottom: 2px; text-transform: uppercase; letter-spacing: 0.5px;">Altitude (MSL)</div>',t+='<div style="background: '+l+"; padding: 6px 8px; border-radius: 6px; border-left: 3px solid "+n+';">',t+='<span style="font-size: 16px; font-weight: bold; color: '+n+';">'+s.toLocaleString()+" ft</span>",t+='<span style="font-size: 12px; color: #ccc; margin-left: 6px;">('+r.toLocaleString()+" m)</span>",t+="</div>",t+="</div>";let c=e.groundspeed_knots||0,m=c*1.852,y=Math.round(c),M=Math.round(m),b=window.KMLHeatmap.getColorForAirspeed(c,this.replayColorMinSpeed,this.replayColorMaxSpeed),f=b.replace("rgb(","rgba(").replace(")",", 0.15)");t+='<div style="margin-bottom: 8px;">',t+='<div style="font-size: 11px; color: #999; margin-bottom: 2px; text-transform: uppercase; letter-spacing: 0.5px;">Groundspeed</div>',t+='<div style="background: '+f+"; padding: 6px 8px; border-radius: 6px; border-left: 3px solid "+b+';">',t+='<span style="font-size: 16px; font-weight: bold; color: '+b+';">'+y.toLocaleString()+" kt</span>",t+='<span style="font-size: 12px; color: #ccc; margin-left: 6px;">('+M.toLocaleString()+" km/h)</span>",t+="</div>",t+="</div>",t+="</div>",this.replayAirplaneMarker.getPopup()?this.replayAirplaneMarker.getPopup().setContent(t):this.replayAirplaneMarker.bindPopup(t,{autoPanPadding:[50,50]}),this.replayAirplaneMarker.openPopup()}initializeReplay(){if(!this.app.fullPathSegments)return alert("No flight data available for replay. Please wait for data to load or refresh the page."),!1;let e=Array.from(this.app.selectedPathIds)[0];if(this.replaySegments=this.app.fullPathSegments.filter(m=>m.path_id===e&&m.time!==void 0&&m.time!==null),this.replaySegments.length===0)return!1;if(this.replaySegments.sort((m,y)=>(m.time||0)-(y.time||0)),this.app.currentData&&this.app.currentData.path_segments){let m=this.app.currentData.path_segments.filter(y=>y.path_id===e);if(m.length>0){let y=m.map(f=>f.altitude_ft||0),M=window.KMLHeatmap.findMinMax(y);this.replayColorMinAlt=M.min,this.replayColorMaxAlt=M.max;let b=m.map(f=>f.groundspeed_knots||0).filter(f=>f>0);if(b.length>0){let f=window.KMLHeatmap.findMinMax(b);this.replayColorMinSpeed=f.min,this.replayColorMaxSpeed=f.max}else this.replayColorMinSpeed=this.app.airspeedRange.min,this.replayColorMaxSpeed=this.app.airspeedRange.max}else{let y=this.replaySegments.map(f=>f.altitude_ft||0),M=window.KMLHeatmap.findMinMax(y);this.replayColorMinAlt=M.min,this.replayColorMaxAlt=M.max;let b=this.replaySegments.map(f=>f.groundspeed_knots||0).filter(f=>f>0);if(b.length>0){let f=window.KMLHeatmap.findMinMax(b);this.replayColorMinSpeed=f.min,this.replayColorMaxSpeed=f.max}else this.replayColorMinSpeed=this.app.airspeedRange.min,this.replayColorMaxSpeed=this.app.airspeedRange.max}}let t=this.replaySegments[this.replaySegments.length-1];this.replayMaxTime=t?.time||0;let a=o.get("replay-slider");a&&(a.max=this.replayMaxTime.toString());let s=o.get("replay-slider-end");s&&(s.textContent=window.KMLHeatmap.formatTime(this.replayMaxTime)),this.app.layerManager.updateAltitudeLegend(this.replayColorMinAlt,this.replayColorMaxAlt),this.app.layerManager.updateAirspeedLegend(this.replayColorMinSpeed,this.replayColorMaxSpeed),this.replayLayer||(this.replayLayer=W.layerGroup()),this.replayLayer.clearLayers(),this.app.map&&this.replayLayer.addTo(this.app.map),this.replayAirplaneMarker&&this.app.map&&(this.app.map.removeLayer(this.replayAirplaneMarker),this.replayAirplaneMarker=null);let r=W.divIcon({html:'<div class="replay-airplane-icon">\u2708\uFE0F</div>',iconSize:[32,32],iconAnchor:[16,16],className:""}),l=this.replaySegments[0]?.coords?.[0];if(!l||!this.app.map)return!1;this.replayAirplaneMarker=W.marker([l[0],l[1]],{icon:r,zIndexOffset:1e3}),this.replayAirplaneMarker.addTo(this.app.map);let c=this.replayAirplaneMarker.getElement();return c&&(c.style.transition="transform 0.08s linear",c.style.cursor="pointer",c.style.pointerEvents="auto",c.addEventListener("click",m=>{m.stopPropagation(),this.replayAirplaneMarker.isPopupOpen()?this.replayAirplaneMarker.closePopup():this.updateReplayAirplanePopup()})),this.replayCurrentTime=0,this.replayLastDrawnIndex=-1,this.replayLastBearing=null,this.replayAutoZoom&&this.app.map?(this.app.map.setView([l[0],l[1]],16,{animate:!0,duration:.8}),this.replayLastZoom=16):this.app.map&&this.app.map.panTo([l[0],l[1]],{animate:!0,duration:.8}),this.updateReplayDisplay(),!0}hideOtherLayersDuringReplay(){if(!this.app.map)return;this.app.heatmapLayer&&this.app.heatmapVisible&&this.app.map.removeLayer(this.app.heatmapLayer),this.app.altitudeVisible&&this.app.map.removeLayer(this.app.altitudeLayer),this.app.airspeedVisible&&this.app.map.removeLayer(this.app.airspeedLayer),["heatmap-btn","airports-btn","aviation-btn","year-select","aircraft-select"].forEach(t=>{let a=document.getElementById(t);a&&(a.disabled=!0)})}restoreLayerVisibility(){if(!this.app.map)return;this.app.heatmapLayer&&this.app.heatmapVisible&&(this.app.map.addLayer(this.app.heatmapLayer),this.app.heatmapLayer.e&&(this.app.heatmapLayer.e.style.pointerEvents="none")),this.app.altitudeVisible&&(this.app.map.addLayer(this.app.altitudeLayer),setTimeout(()=>{this.app.layerManager.redrawAltitudePaths(),this.app.map&&this.app.map.invalidateSize()},50)),this.app.airspeedVisible&&(this.app.map.addLayer(this.app.airspeedLayer),setTimeout(()=>{this.app.layerManager.redrawAirspeedPaths(),this.app.map&&this.app.map.invalidateSize()},50)),["heatmap-btn","airports-btn","aviation-btn","year-select","aircraft-select"].forEach(t=>{let a=document.getElementById(t);a&&(a.disabled=!1)})}playReplay(){if(!this.replayActive||!this.app.map)return;if(this.replayCurrentTime>=this.replayMaxTime){if(this.replayCurrentTime=0,this.replayLastDrawnIndex=-1,this.replayLayer&&this.replayLayer.clearLayers(),this.replayAirplaneMarker&&this.replaySegments.length>0&&this.app.map){let r=this.replaySegments[0]?.coords?.[0];r&&(this.replayAirplaneMarker.setLatLng([r[0],r[1]]),this.replayAutoZoom&&(this.app.map.setView([r[0],r[1]],16,{animate:!0,duration:.5}),this.replayLastZoom=16))}this.replayRecenterTimestamps=[],this.replayLastBearing=null}this.replayPlaying=!0;let e=o.get("replay-play-btn"),t=o.get("replay-pause-btn");e&&(e.style.display="none"),t&&(t.style.display="inline-block"),this.replayLastFrameTime=null;let a=s=>{if(!this.replayPlaying)return;this.replayLastFrameTime===null&&(this.replayLastFrameTime=s);let r=s-this.replayLastFrameTime;this.replayLastFrameTime=s;let n=r/1e3*this.replaySpeed;if(this.replayCurrentTime+=n,this.replayCurrentTime>=this.replayMaxTime){if(this.replayCurrentTime=this.replayMaxTime,this.pauseReplay(),this.replaySegments.length>0&&this.app.map){let l=[];if(this.replaySegments.forEach(c=>{c.coords&&c.coords.length>0&&c.coords.forEach(m=>{l.push(m)})}),l.length>0){let c=W.latLngBounds(l);this.app.map.fitBounds(c,{padding:[50,50],animate:!0,duration:1})}}}else this.replayAnimationFrameId=requestAnimationFrame(a);this.updateReplayDisplay()};this.replayAnimationFrameId=requestAnimationFrame(a),this.app.stateManager.saveMapState()}pauseReplay(){this.replayPlaying=!1;let e=o.get("replay-play-btn"),t=o.get("replay-pause-btn");e&&(e.style.display="inline-block"),t&&(t.style.display="none"),this.replayAnimationFrameId&&(cancelAnimationFrame(this.replayAnimationFrameId),this.replayAnimationFrameId=null),this.replayLastFrameTime=null,this.app.stateManager.saveMapState()}stopReplay(){if(this.pauseReplay(),this.replayCurrentTime=0,this.replayLastDrawnIndex=-1,this.replayLastBearing=null,this.replayRecenterTimestamps=[],this.replayLayer&&this.replayLayer.clearLayers(),this.replayAirplaneMarker&&this.replaySegments.length>0){let t=this.replaySegments[0]?.coords?.[0];t&&this.replayAirplaneMarker.setLatLng([t[0],t[1]])}this.updateReplayDisplay()}seekReplay(e){let t=parseFloat(e);t<this.replayCurrentTime&&(this.replayLayer&&this.replayLayer.clearLayers(),this.replayLastDrawnIndex=-1),this.replayCurrentTime=t,this.updateReplayDisplay(!0),this.app.stateManager.saveMapState()}changeReplaySpeed(){let e=o.get("replay-speed");e&&(this.replaySpeed=parseFloat(e.value),this.app.stateManager.saveMapState())}toggleAutoZoom(){this.replayAutoZoom=!this.replayAutoZoom;let e=o.get("replay-autozoom-btn");e&&(e.style.opacity=this.replayAutoZoom?"1.0":"0.5",e.title=this.replayAutoZoom?"Auto-zoom enabled":"Auto-zoom disabled"),this.app.stateManager.saveMapState()}updateReplayDisplay(e=!1){let t=o.get("replay-time-display");t&&(t.textContent=window.KMLHeatmap.formatTime(this.replayCurrentTime)+" / "+window.KMLHeatmap.formatTime(this.replayMaxTime));let a=o.get("replay-slider");a&&(a.value=this.replayCurrentTime.toString());let s=o.get("replay-slider-start");s&&(s.textContent=window.KMLHeatmap.formatTime(this.replayCurrentTime));let r=null,n=null,l=-1;for(let c=0;c<this.replaySegments.length;c++){let m=this.replaySegments[c];if(m&&(m.time||0)<=this.replayCurrentTime)r=m,l=c;else if(m){n=m;break}}if(this.replayLayer){let c=this.app.airspeedVisible&&!this.app.altitudeVisible;for(let m=0;m<this.replaySegments.length;m++){let y=this.replaySegments[m];if(y)if((y.time||0)<=this.replayCurrentTime&&this.replayCurrentTime>0){if(m>this.replayLastDrawnIndex){let M;c&&(y.groundspeed_knots||0)>0?M=window.KMLHeatmap.getColorForAltitude(y.groundspeed_knots??0,this.replayColorMinSpeed,this.replayColorMaxSpeed):M=window.KMLHeatmap.getColorForAltitude(y.altitude_ft??0,this.replayColorMinAlt,this.replayColorMaxAlt),W.polyline(y.coords||[],{color:M,weight:3,opacity:.8}).addTo(this.replayLayer),this.replayLastDrawnIndex=m}}else break}}if(this.replayAirplaneMarker&&this.app.map&&!this.app.map.hasLayer(this.replayAirplaneMarker)&&this.replayAirplaneMarker.addTo(this.app.map),this.replayAirplaneMarker&&this.app.map){if(r){let c,m=0;if(n&&(r.time||0)<this.replayCurrentTime){let b=(this.replayCurrentTime-(r.time||0))/((n.time||0)-(r.time||0)),f=r.coords?.[1]?.[0]||0,v=r.coords?.[1]?.[1]||0,T=n.coords?.[0]?.[0]||0,D=n.coords?.[0]?.[1]||0;c=[f+(T-f)*b,v+(D-v)*b],m=window.KMLHeatmap.calculateBearing(f,v,T,D)}else{c=r.coords?.[1]||[0,0];let b=r.coords?.[0]?.[0]||0,f=r.coords?.[0]?.[1]||0,v=r.coords?.[1]?.[0]||0,T=r.coords?.[1]?.[1]||0;m=window.KMLHeatmap.calculateBearing(b,f,v,T)}let y=window.KMLHeatmap.calculateSmoothedBearing(this.replaySegments,l,5);if(y!==null?(m=y,this.replayLastBearing=m):this.replayLastBearing!==null&&(m=this.replayLastBearing),this.replayAirplaneMarker.setLatLng(c),this.replayPlaying||e){let b=this.app.map.getSize(),f=this.app.map.latLngToContainerPoint(c),v=.1,T=b.x*v,D=b.y*v,X=!1;if((f.x<T||f.x>b.x-T||f.y<D||f.y>b.y-D)&&(X=!0),e&&(X=!0),X){this.app.map.panTo(c,{animate:!0,duration:.5,easeLinearity:.25,noMoveStart:!0});let $=Date.now();this.replayRecenterTimestamps.push($);let S=$-3e4;this.replayRecenterTimestamps=this.replayRecenterTimestamps.filter(A=>A>S)}if(this.replayAutoZoom){let S=Date.now()-3e4;if(this.replayRecenterTimestamps=this.replayRecenterTimestamps.filter(U=>U>S),this.replayRecenterTimestamps.length>2){let Q=Date.now()-5e3;if(this.replayRecenterTimestamps.filter(ie=>ie>=Q).length>2&&this.replayLastZoom!==null&&this.replayLastZoom>9){let Se=Math.max(9,this.replayLastZoom-1);this.app.map.setZoom(Se,{animate:!0,duration:.5}),this.replayLastZoom=Se,this.replayRecenterTimestamps=[]}}}}let M=this.replayAirplaneMarker.getElement();if(M){let b=M.querySelector(".replay-airplane-icon");if(b){let f=m-45;b.style.transform="translate3d(0,0,0) rotate("+f+"deg)"}}}else if(this.replaySegments.length>0){let m=this.replaySegments[0]?.coords?.[0];m&&this.replayAirplaneMarker.setLatLng([m[0],m[1]])}}this.replayAirplaneMarker&&this.replayAirplaneMarker.getPopup()&&this.replayAirplaneMarker.isPopupOpen()&&this.updateReplayAirplanePopup()}};function ra(p,e,t){return`
            <div class="stat-card">
                <div class="stat-value">${p.total_flights}</div>
                <div class="stat-label">Flights</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">${p.num_airports}</div>
                <div class="stat-label">Airports</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">${p.total_distance_nm.toFixed(0)}</div>
                <div class="stat-label">Nautical Miles</div>
            </div>
            ${t?`
            <div class="stat-card">
                <div class="stat-value">${p.flight_time}</div>
                <div class="stat-label">Flight Time</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">${(e?.max_groundspeed_knots||0).toFixed(0)} kt</div>
                <div class="stat-label">Max Groundspeed</div>
            </div>
            `:""}
            <div class="stat-card">
                <div class="stat-value">${Math.round((e?.max_altitude_m||0)/.3048).toLocaleString()} ft</div>
                <div class="stat-label">Max Altitude (MSL)</div>
            </div>
        `}function sa(p){let e='<div class="fun-facts-title">\u2728 Facts</div>';return p.forEach(t=>{e+=`<div class="fun-fact" data-category="${t.category}"><span class="fun-fact-icon">${t.icon}</span><span class="fun-fact-text">${t.text}</span></div>`}),e}function Xa(p){return p>=.75?"fleet-aircraft-high":p>=.5?"fleet-aircraft-medium-high":p>=.25?"fleet-aircraft-medium-low":"fleet-aircraft-low"}function na(p){if(!p.aircraft_list||p.aircraft_list.length===0)return"";let e='<div class="aircraft-fleet-title">\u2708\uFE0F Fleet</div>',t=p.aircraft_list[0]?.flights??0,a=p.aircraft_list[p.aircraft_list.length-1]?.flights??0,s=t-a;return p.aircraft_list.forEach(r=>{let n=r.model||r.type||"",l=s>0?(r.flights-a)/s:1,c=Xa(l),m=r.flight_time_str||"---";e+=`
                    <div class="fleet-aircraft ${c}">
                        <div class="fleet-aircraft-info">
                            <div class="fleet-aircraft-model">${n}</div>
                            <div class="fleet-aircraft-registration">${r.registration}</div>
                        </div>
                        <div class="fleet-aircraft-stats">
                            <div class="fleet-aircraft-flights">${r.flights} flights</div>
                            <div class="fleet-aircraft-time">${m}</div>
                        </div>
                    </div>
                `}),e}function oa(p){let e='<div class="top-airports-title">\u{1F3E0} Home Base</div>';return e+=`
                <div class="top-airport">
                    <div class="top-airport-name">${p.name}</div>
                    <div class="top-airport-count">${p.flight_count} flights</div>
                </div>
            `,e}function pa(p){if(p.length===0)return"";let e='<div class="airports-grid-title">\u{1F5FA}\uFE0F Destinations</div><div class="airport-badges">';return p.forEach(t=>{e+=`<div class="airport-badge">${t}</div>`}),e+="</div>",e}var Ye=class{constructor(e){this.app=e,this.originalMapParent=null,this.originalMapIndex=null,o.cacheElements(["wrapped-title","wrapped-year","wrapped-stats","wrapped-fun-facts","wrapped-aircraft-fleet","wrapped-top-airports","wrapped-airports-grid","map","wrapped-map-container","wrapped-modal","stats-btn","export-btn","wrapped-btn","heatmap-btn","airports-btn","altitude-btn","airspeed-btn","aviation-btn","year-filter","aircraft-filter","stats-panel","altitude-legend","airspeed-legend","loading"])}showWrapped(){if(!this.app.map)return;let e=this.app.selectedYear,t=window.KMLHeatmap.calculateYearStats(this.app.fullPathInfo||[],this.app.fullPathSegments||[],e,this.app.fullStats),a=o.get("wrapped-title"),s=o.get("wrapped-year");e==="all"?(a&&(a.textContent="\u2728 Your Flight History"),s&&(s.textContent="All Years")):(a&&(a.textContent="\u2728 Your Year in Flight"),s&&(s.textContent=e));let r=this.app.fullStats!==null&&this.app.fullStats.max_groundspeed_knots!==void 0&&this.app.fullStats.max_groundspeed_knots>0,n=ra(t,this.app.fullStats??null,r),l=o.get("wrapped-stats");l&&(l.innerHTML=J.sanitize(n));let c=window.KMLHeatmap.generateFunFacts(t,this.app.fullStats),m=sa(c),y=o.get("wrapped-fun-facts");if(y&&(y.innerHTML=J.sanitize(m)),t.aircraft_list&&t.aircraft_list.length>0){let T=na(t),D=o.get("wrapped-aircraft-fleet");D&&(D.innerHTML=J.sanitize(T))}if(t.airport_names&&t.airport_names.length>0){let T;if(e==="all")T=this.app.fullPathInfo||[];else{let S=e.toString();T=(this.app.fullPathInfo||[]).filter(A=>A.year&&A.year.toString()===S)}let D={};T.forEach(S=>{S.start_airport&&(D[S.start_airport]=(D[S.start_airport]||0)+1),S.end_airport&&(D[S.end_airport]=(D[S.end_airport]||0)+1)});let X=t.airport_names.map(S=>({name:S,flight_count:D[S]||0}));X.sort((S,A)=>A.flight_count-S.flight_count);let $=X[0];if($){let S=oa($),A=o.get("wrapped-top-airports");A&&(A.innerHTML=J.sanitize(S));let U=t.airport_names.filter(ie=>ie!==$.name),Q=pa(U),he=o.get("wrapped-airports-grid");he&&(he.innerHTML=J.sanitize(Q))}}let M=o.get("map"),b=o.get("wrapped-map-container");if(!M||!b)return;this.originalMapParent||(this.originalMapParent=M.parentNode,this.originalMapIndex=Array.from(this.originalMapParent.children).indexOf(M)),this.app.map.fitBounds(this.app.config.bounds,{padding:[80,80]}),[document.querySelector(".leaflet-control-zoom"),o.get("stats-btn"),o.get("export-btn"),o.get("wrapped-btn"),o.get("heatmap-btn"),o.get("airports-btn"),o.get("altitude-btn"),o.get("airspeed-btn"),o.get("aviation-btn"),o.get("year-filter"),o.get("aircraft-filter"),o.get("stats-panel"),o.get("altitude-legend"),o.get("airspeed-legend"),o.get("loading")].forEach(T=>{T&&(T.style.display="none")});let v=o.get("wrapped-modal");v&&(v.style.display="flex"),setTimeout(()=>{b.appendChild(M),M.style.width="100%",M.style.height="100%",M.style.borderRadius="12px",M.style.overflow="hidden",b.offsetHeight,setTimeout(()=>{this.app.map.invalidateSize(),this.app.map.fitBounds(this.app.config.bounds,{padding:[80,80]}),this.app.stateManager&&this.app.stateManager.saveMapState()},100)},50)}closeWrapped(e){if(!e||e.target.id==="wrapped-modal"){let t=o.get("map");if(!t)return;if(this.originalMapParent&&this.originalMapIndex!==null){let s=Array.from(this.originalMapParent.children);if(this.originalMapIndex>=s.length)this.originalMapParent.appendChild(t);else{let n=s[this.originalMapIndex];n&&this.originalMapParent.insertBefore(t,n)}if(t.style.width="",t.style.height="",t.style.borderRadius="",t.style.overflow="",[document.querySelector(".leaflet-control-zoom"),o.get("stats-btn"),o.get("export-btn"),o.get("wrapped-btn"),o.get("heatmap-btn"),o.get("airports-btn"),o.get("altitude-btn"),o.get("airspeed-btn"),o.get("year-filter"),o.get("aircraft-filter"),o.get("stats-panel"),o.get("altitude-legend"),o.get("airspeed-legend"),o.get("loading")].forEach(n=>{n&&(n.style.display="")}),this.app.config.openaipApiKey){let n=o.get("aviation-btn");n&&(n.style.display="")}setTimeout(()=>{this.app.map&&this.app.map.invalidateSize(),this.app.stateManager&&this.app.stateManager.saveMapState()},100)}let a=o.get("wrapped-modal");a&&(a.style.display="none")}}};var yt=Re(ge(),1);var Ge=class{constructor(e){this.app=e,o.cacheElements(["heatmap-btn","altitude-btn","airspeed-btn","airports-btn","aviation-btn","altitude-legend","airspeed-legend","export-btn","hide-buttons-btn","map","stats-btn","wrapped-btn","replay-btn","year-filter","aircraft-filter","stats-panel","loading"])}toggleHeatmap(){if(this.app.map){if(this.app.heatmapVisible){this.app.heatmapLayer&&this.app.map.removeLayer(this.app.heatmapLayer),this.app.heatmapVisible=!1;let e=o.get("heatmap-btn");e&&(e.style.opacity="0.5")}else{this.app.heatmapLayer&&(this.app.map.addLayer(this.app.heatmapLayer),this.app.heatmapLayer.e&&(this.app.heatmapLayer.e.style.pointerEvents="none")),this.app.heatmapVisible=!0;let e=o.get("heatmap-btn");e&&(e.style.opacity="1.0")}this.app.stateManager.saveMapState()}}toggleAltitude(){if(this.app.map){if(this.app.altitudeVisible){if(this.app.replayManager.replayActive&&!this.app.airspeedVisible)return;this.app.map.removeLayer(this.app.altitudeLayer),this.app.altitudeVisible=!1;let e=o.get("altitude-btn");e&&(e.style.opacity="0.5");let t=o.get("altitude-legend");t&&(t.style.display="none")}else{if(this.app.airspeedVisible){this.app.replayManager.replayActive||this.app.map.removeLayer(this.app.airspeedLayer),this.app.airspeedVisible=!1;let a=o.get("airspeed-btn");a&&(a.style.opacity="0.5");let s=o.get("airspeed-legend");s&&(s.style.display="none")}if(!this.app.replayManager.replayActive)this.app.map.addLayer(this.app.altitudeLayer),this.app.layerManager.redrawAltitudePaths();else{let a=this.app.replayManager.replayCurrentTime,s=this.app.replayManager.replayLastDrawnIndex;this.app.replayManager.replayLayer&&this.app.replayManager.replayLayer.clearLayers(),this.app.replayManager.replayLastDrawnIndex=-1;for(let r=0;r<=s&&r<this.app.replayManager.replaySegments.length;r++){let n=this.app.replayManager.replaySegments[r];if(n&&(n.time||0)<=a){let l=window.KMLHeatmap.getColorForAltitude(n.altitude_ft||0,this.app.replayManager.replayColorMinAlt,this.app.replayManager.replayColorMaxAlt);yt.polyline(n.coords||[],{color:l,weight:3,opacity:.8}).addTo(this.app.replayManager.replayLayer),this.app.replayManager.replayLastDrawnIndex=r}}}this.app.altitudeVisible=!0;let e=o.get("altitude-btn");e&&(e.style.opacity="1.0");let t=o.get("altitude-legend");t&&(t.style.display="block")}this.app.replayManager.replayActive&&this.app.replayManager.replayAirplaneMarker&&this.app.replayManager.replayAirplaneMarker.isPopupOpen()&&this.app.replayManager.updateReplayAirplanePopup(),this.app.stateManager.saveMapState()}}toggleAirspeed(){if(this.app.map){if(this.app.airspeedVisible){if(this.app.replayManager.replayActive&&!this.app.altitudeVisible)return;this.app.map.removeLayer(this.app.airspeedLayer),this.app.airspeedVisible=!1;let e=o.get("airspeed-btn");e&&(e.style.opacity="0.5");let t=o.get("airspeed-legend");t&&(t.style.display="none")}else{if(this.app.altitudeVisible){this.app.replayManager.replayActive||this.app.map.removeLayer(this.app.altitudeLayer),this.app.altitudeVisible=!1;let a=o.get("altitude-btn");a&&(a.style.opacity="0.5");let s=o.get("altitude-legend");s&&(s.style.display="none")}if(!this.app.replayManager.replayActive)this.app.map.addLayer(this.app.airspeedLayer),this.app.layerManager.redrawAirspeedPaths();else{let a=this.app.replayManager.replayCurrentTime,s=this.app.replayManager.replayLastDrawnIndex;this.app.replayManager.replayLayer&&this.app.replayManager.replayLayer.clearLayers(),this.app.replayManager.replayLastDrawnIndex=-1;for(let r=0;r<=s&&r<this.app.replayManager.replaySegments.length;r++){let n=this.app.replayManager.replaySegments[r];if(n&&(n.time||0)<=a&&(n.groundspeed_knots||0)>0){let l=window.KMLHeatmap.getColorForAltitude(n.groundspeed_knots||0,this.app.replayManager.replayColorMinSpeed,this.app.replayManager.replayColorMaxSpeed);yt.polyline(n.coords||[],{color:l,weight:3,opacity:.8}).addTo(this.app.replayManager.replayLayer),this.app.replayManager.replayLastDrawnIndex=r}}}this.app.airspeedVisible=!0;let e=o.get("airspeed-btn");e&&(e.style.opacity="1.0");let t=o.get("airspeed-legend");t&&(t.style.display="block")}this.app.replayManager.replayActive&&this.app.replayManager.replayAirplaneMarker&&this.app.replayManager.replayAirplaneMarker.isPopupOpen()&&this.app.replayManager.updateReplayAirplanePopup(),this.app.stateManager.saveMapState()}}toggleAirports(){if(this.app.map){if(this.app.airportsVisible){this.app.map.removeLayer(this.app.airportLayer),this.app.airportsVisible=!1;let e=o.get("airports-btn");e&&(e.style.opacity="0.5")}else{this.app.map.addLayer(this.app.airportLayer),this.app.airportsVisible=!0;let e=o.get("airports-btn");e&&(e.style.opacity="1.0")}this.app.stateManager.saveMapState()}}toggleAviation(){if(this.app.map&&this.app.config.openaipApiKey&&this.app.openaipLayers["Aviation Data"]){if(this.app.aviationVisible){this.app.map.removeLayer(this.app.openaipLayers["Aviation Data"]),this.app.aviationVisible=!1;let e=o.get("aviation-btn");e&&(e.style.opacity="0.5")}else{this.app.map.addLayer(this.app.openaipLayers["Aviation Data"]),this.app.aviationVisible=!0;let e=o.get("aviation-btn");e&&(e.style.opacity="1.0")}this.app.stateManager.saveMapState()}}toggleButtonsVisibility(){let e=document.querySelectorAll(".toggleable-btn"),t=o.get("hide-buttons-btn");this.app.buttonsHidden?(e.forEach(a=>{a.classList.remove("buttons-hidden")}),t&&(t.textContent="\u{1F53C}"),this.app.buttonsHidden=!1):(e.forEach(a=>{a.classList.add("buttons-hidden")}),t&&(t.textContent="\u{1F53D}"),this.app.buttonsHidden=!0),this.app.altitudeVisible&&this.app.layerManager.redrawAltitudePaths(),this.app.airspeedVisible&&this.app.layerManager.redrawAirspeedPaths(),this.app.stateManager.saveMapState()}exportMap(){let e=o.get("export-btn");if(!e)return;e.disabled=!0,e.textContent="\u23F3 Exporting...";let t=o.get("map");if(!t)return;let a=[document.querySelector(".leaflet-control-zoom"),o.get("stats-btn"),o.get("export-btn"),o.get("wrapped-btn"),o.get("replay-btn"),o.get("year-filter"),o.get("aircraft-filter"),o.get("heatmap-btn"),o.get("altitude-btn"),o.get("airspeed-btn"),o.get("airports-btn"),o.get("aviation-btn"),o.get("stats-panel"),o.get("altitude-legend"),o.get("airspeed-legend"),o.get("loading")],s=a.map(r=>r?r.style.display:null);a.forEach(r=>{r&&(r.style.display="none")}),setTimeout(()=>{window.domtoimage?.toJpeg(t,{width:t.offsetWidth*2,height:t.offsetHeight*2,bgcolor:"#1a1a1a",quality:.95}).then(r=>{a.forEach((l,c)=>{l&&(l.style.display=s[c]||"")}),e.disabled=!1,e.textContent="\u{1F4F7} Export";let n=document.createElement("a");n.download="heatmap_"+new Date().toISOString().slice(0,19).replace(/[:.]/g,"-")+".jpg",n.href=r,n.click()}).catch(r=>{a.forEach((n,l)=>{n&&(n.style.display=s[l]||"")}),alert("Export failed: "+r.message),e.disabled=!1,e.textContent="\u{1F4F7} Export"})},200)}};var Ke=class{constructor(e){this.config=e,this.selectedYear="all",this.selectedAircraft="all",this.allAirportsData=[],this.isInitializing=!0,this.map=null,this.heatmapLayer=null,this.altitudeLayer=k.layerGroup(),this.airspeedLayer=k.layerGroup(),this.airportLayer=k.layerGroup(),this.altitudeRenderer=k.svg(),this.airspeedRenderer=k.svg(),this.currentData=null,this.fullStats=null,this.fullPathInfo=null,this.fullPathSegments=null,this.altitudeRange={min:0,max:1e4},this.airspeedRange={min:0,max:200},this.heatmapVisible=!0,this.altitudeVisible=!1,this.airspeedVisible=!1,this.airportsVisible=!0,this.aviationVisible=!1,this.buttonsHidden=!1,this.selectedPathIds=new Set,this.pathSegments={},this.pathToAirports={},this.airportToPaths={},this.airportMarkers={},this.openaipLayers={},this.savedState=null,this.restoredYearFromState=!1,this.stateManager=null,this.dataManager=null,this.layerManager=null,this.filterManager=null,this.statsManager=null,this.pathSelection=null,this.airportManager=null,this.replayManager=null,this.wrappedManager=null,this.uiToggles=null}async initialize(){if(this.stateManager=new De(this),this.savedState=this.stateManager.loadState(),this.savedState&&(this.savedState.selectedYear!==void 0&&(this.selectedYear=this.savedState.selectedYear,this.restoredYearFromState=!0),this.savedState.selectedAircraft&&(this.selectedAircraft=this.savedState.selectedAircraft),this.savedState.selectedPathIds&&this.savedState.selectedPathIds.length>0&&this.savedState.selectedPathIds.forEach(e=>{let t=typeof e=="string"?parseInt(e,10):e;this.selectedPathIds.add(t)}),this.savedState.heatmapVisible!==void 0&&(this.heatmapVisible=this.savedState.heatmapVisible),this.savedState.altitudeVisible!==void 0&&(this.altitudeVisible=this.savedState.altitudeVisible),this.savedState.airspeedVisible!==void 0&&(this.airspeedVisible=this.savedState.airspeedVisible),this.savedState.airportsVisible!==void 0&&(this.airportsVisible=this.savedState.airportsVisible),this.savedState.aviationVisible!==void 0&&(this.aviationVisible=this.savedState.aviationVisible),this.savedState.buttonsHidden!==void 0&&(this.buttonsHidden=this.savedState.buttonsHidden)),this.map=k.map("map",{center:this.config.center,zoom:10,zoomSnap:.25,zoomDelta:.25,wheelPxPerZoomLevel:120,preferCanvas:!0}),this.config.stadiaApiKey?k.tileLayer("https://tiles.stadiamaps.com/tiles/alidade_smooth_dark/{z}/{x}/{y}{r}.png?api_key="+this.config.stadiaApiKey,{attribution:'&copy; <a href="https://stadiamaps.com/">Stadia Maps</a>'}).addTo(this.map):k.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png",{attribution:"&copy; OpenStreetMap contributors, &copy; CARTO"}).addTo(this.map),this.savedState&&this.savedState.center&&this.savedState.zoom?this.map.setView([this.savedState.center.lat,this.savedState.center.lng],this.savedState.zoom):this.map.fitBounds(this.config.bounds,{padding:[30,30]}),this.config.openaipApiKey&&(this.openaipLayers["Aviation Data"]=k.tileLayer("https://{s}.api.tiles.openaip.net/api/data/openaip/{z}/{x}/{y}.png?apiKey="+this.config.openaipApiKey,{attribution:'&copy; <a href="https://www.openaip.net">OpenAIP</a>',maxZoom:18,minZoom:7,subdomains:["a","b","c"]})),this.airportsVisible&&this.airportLayer.addTo(this.map),document.getElementById("heatmap-btn").style.opacity=this.heatmapVisible?"1.0":"0.5",document.getElementById("altitude-btn").style.opacity=this.altitudeVisible?"1.0":"0.5",document.getElementById("airspeed-btn").style.opacity=this.airspeedVisible?"1.0":"0.5",document.getElementById("airports-btn").style.opacity=this.airportsVisible?"1.0":"0.5",document.getElementById("aviation-btn").style.opacity=this.aviationVisible?"1.0":"0.5",this.config.openaipApiKey&&(document.getElementById("aviation-btn").style.display="block"),this.dataManager=new ke(this),this.layerManager=new Ie(this),this.filterManager=new Oe(this),this.statsManager=new ze(this),this.pathSelection=new Be(this),this.airportManager=new Ve(this),this.replayManager=new Ue(this),this.wrappedManager=new Ye(this),this.uiToggles=new Ge(this),await this.loadInitialData(),this.setupEventHandlers(),this.isInitializing=!1,this.savedState&&this.savedState.buttonsHidden){let e=document.querySelectorAll(".toggleable-btn"),t=document.getElementById("hide-buttons-btn");e.forEach(a=>{a.classList.add("buttons-hidden")}),t&&(t.textContent="\u{1F53D}")}this.savedState&&this.savedState.wrappedVisible&&setTimeout(()=>{this.wrappedManager&&this.wrappedManager.showWrapped()},500),this.stateManager.saveMapState()}async loadInitialData(){let e=await this.dataManager.loadAirports();this.allAirportsData=e;let t=await this.dataManager.loadMetadata();if(t&&t.available_years){let r=document.getElementById("year-select");if(t.available_years.forEach(n=>{let l=document.createElement("option");l.value=n.toString(),l.textContent="\u{1F4C5} "+n,r.appendChild(l)}),this.selectedYear==="all"&&!this.restoredYearFromState){let n=t.available_years[t.available_years.length-1];n!==void 0&&(this.selectedYear=n.toString())}this.selectedYear&&this.selectedYear!=="all"&&(r.value=this.selectedYear)}this.createAirportMarkers(e),t&&t.stats&&(this.fullStats=t.stats);try{let r=await this.dataManager.loadData("data",this.selectedYear);r&&r.path_info&&(this.fullPathInfo=r.path_info),r&&r.path_segments&&(this.fullPathSegments=r.path_segments)}catch(r){Kt("Failed to load full path data:",r)}if(this.filterManager.updateAircraftDropdown(),this.airportManager.updateAirportPopups(),this.fullStats){let r=window.KMLHeatmap.calculateFilteredStatistics({pathInfo:this.fullPathInfo??[],segments:this.fullPathSegments??[],year:this.selectedYear,aircraft:this.selectedAircraft,coordinateCount:this.currentData?.original_points});this.statsManager.updateStatsPanel(r,!1)}this.airportManager.updateAirportOpacity();let a=t&&t.max_groundspeed_knots!==void 0&&t.max_groundspeed_knots>0;a&&(this.airspeedRange.min=t.min_groundspeed_knots,this.airspeedRange.max=t.max_groundspeed_knots,this.layerManager.updateAirspeedLegend(this.airspeedRange.min,this.airspeedRange.max));let s=o.get("airspeed-btn");if(s&&(a?(s.disabled=!1,s.style.opacity=this.airspeedVisible?"1.0":"0.5"):(s.disabled=!0,s.style.opacity="0.3")),await this.dataManager.updateLayers(),this.airportManager.updateAirportMarkerSizes(),this.altitudeVisible&&(this.map.addLayer(this.altitudeLayer),document.getElementById("altitude-legend").style.display="block"),this.airspeedVisible&&(this.map.addLayer(this.airspeedLayer),document.getElementById("airspeed-legend").style.display="block"),this.aviationVisible&&this.config.openaipApiKey&&this.openaipLayers["Aviation Data"]&&this.map.addLayer(this.openaipLayers["Aviation Data"]),this.selectedPathIds.size>0&&this.replayManager.updateReplayButtonState(),this.savedState&&this.savedState.statsPanelVisible){let r=document.getElementById("stats-panel");r.style.display="block",r.offsetHeight,r.classList.add("visible")}}createAirportMarkers(e){let t=null;e.length>0&&(t=e.reduce((a,s)=>{let r=s,n=a,l=r.flight_count??0,c=n?.flight_count??0;return l>c?s:a})),e.forEach(a=>{let s=a.name?a.name.match(/\b([A-Z]{4})\b/):null,r=s?s[1]:"APT",n=t&&a.name===t.name,l=n?" airport-marker-home":"",c=n?" airport-label-home":"",m='<div class="airport-marker-container"><div class="airport-marker'+l+'"></div><div class="airport-label'+c+'">'+r+"</div></div>",y=window.KMLHeatmap.ddToDms(a.lat,!0),M=window.KMLHeatmap.ddToDms(a.lon,!1),b=`https://www.google.com/maps?q=${a.lat},${a.lon}`,f=`
            <div style="
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
                min-width: 220px;
                padding: 8px 4px;
                background-color: #2b2b2b;
                color: #ffffff;
            ">
                <div style="
                    font-size: 15px;
                    font-weight: bold;
                    color: #28a745;
                    margin-bottom: 10px;
                    padding-bottom: 8px;
                    border-bottom: 2px solid #28a745;
                    display: flex;
                    align-items: center;
                    gap: 6px;
                ">
                    <span style="font-size: 18px;">\u{1F6EB}</span>
                    <span>${a.name||"Unknown"}</span>
                    ${n?'<span style="font-size: 12px; background: #007bff; color: white; padding: 2px 6px; border-radius: 3px; margin-left: 4px;">HOME</span>':""}
                </div>
                <div style="margin-bottom: 8px;">
                    <div style="font-size: 11px; color: #999; margin-bottom: 2px; text-transform: uppercase; letter-spacing: 0.5px;">Coordinates</div>
                    <a href="${b}"
                       target="_blank"
                       style="
                           color: #4facfe;
                           text-decoration: none;
                           font-size: 12px;
                           font-family: monospace;
                           display: flex;
                           align-items: center;
                           gap: 4px;
                       "
                       onmouseover="this.style.textDecoration='underline'"
                       onmouseout="this.style.textDecoration='none'">
                        <span>\u{1F4CD}</span>
                        <span>${y}<br>${M}</span>
                    </a>
                </div>
                <div style="
                    background: linear-gradient(135deg, rgba(79, 172, 254, 0.15) 0%, rgba(0, 242, 254, 0.15) 100%);
                    padding: 8px 10px;
                    border-radius: 6px;
                    border-left: 3px solid #4facfe;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                ">
                    <span style="font-size: 12px; color: #ccc; font-weight: 500;">Total Flights</span>
                    <span style="font-size: 16px; font-weight: bold; color: #4facfe;">${a.flight_count||0}</span>
                </div>
            </div>`,v=k.marker([a.lat,a.lon],{icon:k.divIcon({html:m,iconSize:[12,12],iconAnchor:[6,6],popupAnchor:[0,-6],className:""})}).bindPopup(f,{autoPanPadding:[50,50]});v.on("click",T=>{this.replayManager.replayActive||this.pathSelection.selectPathsByAirport(a.name)}),v.addTo(this.airportLayer),this.airportMarkers[a.name]=v})}setupEventHandlers(){this.map.on("moveend",()=>this.stateManager.saveMapState()),this.map.on("zoomend",()=>{this.stateManager.saveMapState(),this.airportManager.updateAirportMarkerSizes()}),this.map.on("click",e=>{this.replayManager.replayActive&&this.replayManager.replayAirplaneMarker&&this.replayManager.replayAirplaneMarker.isPopupOpen()&&this.replayManager.replayAirplaneMarker.closePopup(),!this.replayManager.replayActive&&this.selectedPathIds.size>0&&this.pathSelection.clearSelection()})}toggleHeatmap(){this.uiToggles.toggleHeatmap()}toggleStats(){this.statsManager.toggleStats()}toggleAltitude(){this.uiToggles.toggleAltitude()}toggleAirspeed(){this.uiToggles.toggleAirspeed()}toggleAirports(){this.uiToggles.toggleAirports()}toggleAviation(){this.uiToggles.toggleAviation()}toggleReplay(){this.replayManager.toggleReplay()}filterByYear(){this.filterManager.filterByYear()}filterByAircraft(){this.filterManager.filterByAircraft()}togglePathSelection(e){this.pathSelection.togglePathSelection(Number(e))}exportMap(){this.uiToggles.exportMap()}showWrapped(){this.wrappedManager.showWrapped()}closeWrapped(e){this.wrappedManager.closeWrapped(e)}toggleButtonsVisibility(){this.uiToggles.toggleButtonsVisibility()}playReplay(){this.replayManager.playReplay()}pauseReplay(){this.replayManager.pauseReplay()}stopReplay(){this.replayManager.stopReplay()}seekReplay(e){this.replayManager.seekReplay(e)}changeReplaySpeed(){this.replayManager.changeReplaySpeed()}toggleAutoZoom(){this.replayManager.toggleAutoZoom()}};typeof window<"u"&&(window.initMapApp=async p=>{let e=new Ke(p);window.mapApp=e,await e.initialize(),window.toggleHeatmap=()=>e.toggleHeatmap(),window.toggleStats=()=>e.toggleStats(),window.toggleAltitude=()=>e.toggleAltitude(),window.toggleAirspeed=()=>e.toggleAirspeed(),window.toggleAirports=()=>e.toggleAirports(),window.toggleAviation=()=>e.toggleAviation(),window.toggleReplay=()=>e.toggleReplay(),window.filterByYear=()=>e.filterByYear(),window.filterByAircraft=()=>e.filterByAircraft(),window.togglePathSelection=t=>e.togglePathSelection(t),window.exportMap=()=>e.exportMap(),window.showWrapped=()=>e.showWrapped(),window.closeWrapped=t=>e.closeWrapped(t),window.toggleButtonsVisibility=()=>e.toggleButtonsVisibility(),window.playReplay=()=>e.playReplay(),window.pauseReplay=()=>e.pauseReplay(),window.stopReplay=()=>e.stopReplay(),window.seekReplay=t=>e.seekReplay(String(t)),window.changeReplaySpeed=()=>e.changeReplaySpeed(),window.toggleAutoZoom=()=>e.toggleAutoZoom()});typeof window<"u"&&window.MAP_CONFIG&&window.initMapApp&&window.initMapApp(window.MAP_CONFIG);return Pa(Ja);})();
/*! Bundled license information:

dompurify/dist/purify.es.mjs:
  (*! @license DOMPurify 3.3.1 | (c) Cure53 and other contributors | Released under the Apache license 2.0 and Mozilla Public License 2.0 | github.com/cure53/DOMPurify/blob/3.3.1/LICENSE *)
*/
