"use strict";var MapAppModule=(()=>{var ga=Object.create;var Pe=Object.defineProperty;var ya=Object.getOwnPropertyDescriptor;var ba=Object.getOwnPropertyNames;var Ma=Object.getPrototypeOf,Aa=Object.prototype.hasOwnProperty;var va=(c,e)=>()=>(e||c((e={exports:{}}).exports,e),e.exports),Sa=(c,e)=>{for(var t in e)Pe(c,t,{get:e[t],enumerable:!0})},Vt=(c,e,t,a)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of ba(e))!Aa.call(c,s)&&s!==t&&Pe(c,s,{get:()=>e[s],enumerable:!(a=ya(e,s))||a.enumerable});return c};var Ce=(c,e,t)=>(t=c!=null?ga(Ma(c)):{},Vt(e||!c||!c.__esModule?Pe(t,"default",{value:c,enumerable:!0}):t,c)),La=c=>Vt(Pe({},"__esModule",{value:!0}),c);var fe=va(($a,Ut)=>{Ut.exports=window.L});var Wa={};Sa(Wa,{MapApp:()=>Ge});var O=Ce(fe(),1);function Yt(...c){console.warn(...c)}function Gt(...c){console.error(...c)}var nt=class{constructor(){this.cache=new Map}get(e){if(this.cache.has(e)){let a=this.cache.get(e);if(document.contains(a))return a;this.cache.delete(e)}let t=document.getElementById(e);return t&&this.cache.set(e,t),t}cacheElements(e){e.forEach(t=>{let a=document.getElementById(t);a&&this.cache.set(t,a)})}clear(){this.cache.clear()}remove(e){this.cache.delete(e)}has(e){return this.cache.has(e)}get size(){return this.cache.size}},o=new nt;var Re=class{constructor(e){this.app=e,o.cacheElements(["loading"]),this.dataLoader=new window.KMLHeatmap.DataLoader({dataDir:e.config.dataDir,showLoading:()=>this.showLoading(),hideLoading:()=>this.hideLoading()}),this.loadedData={},this.currentData=null}showLoading(){let e=o.get("loading");e&&(e.style.display="block")}hideLoading(){let e=o.get("loading");e&&(e.style.display="none")}async loadData(e,t){return await this.dataLoader.loadData(e,t)}async loadAirports(){return await this.dataLoader.loadAirports()}async loadMetadata(){return await this.dataLoader.loadMetadata()}async updateLayers(){if(!this.app.map)return;let e=await this.loadData("data",this.app.selectedYear);if(!e)return;this.currentData=e,this.app.currentData=e;let t=e.coordinates;if((this.app.selectedYear!=="all"||this.app.selectedAircraft!=="all")&&e.path_segments){let a=new Set;e.path_info&&e.path_info.forEach(r=>{let n=this.app.selectedYear==="all"||r.year&&r.year.toString()===this.app.selectedYear,p=this.app.selectedAircraft==="all"||r.aircraft_registration===this.app.selectedAircraft;n&&p&&a.add(r.id)});let s=new Set;e.path_segments.forEach(r=>{if(a.has(r.path_id)){let n=r.coords;n&&n.length===2&&(s.add(JSON.stringify(n[0])),s.add(JSON.stringify(n[1])))}}),t=Array.from(s).map(r=>JSON.parse(r))}if(this.app.heatmapLayer&&this.app.heatmapLayer.remove(),this.app.heatmapLayer=L.heatLayer(t,{radius:10,blur:15,minOpacity:.25,maxOpacity:.6,max:1,gradient:{0:"blue",.3:"cyan",.5:"lime",.7:"yellow",1:"red"}}),this.app.heatmapLayer.e&&(this.app.heatmapLayer.e.style.pointerEvents="none"),this.app.heatmapVisible&&!this.app.replayManager.replayActive&&this.app.heatmapLayer.addTo(this.app.map),this.app.pathToAirports={},this.app.airportToPaths={},e.path_info&&e.path_info.forEach(a=>{let s=a.id;this.app.pathToAirports[s]={start:a.start_airport,end:a.end_airport},a.start_airport&&(this.app.airportToPaths[a.start_airport]||(this.app.airportToPaths[a.start_airport]=new Set),this.app.airportToPaths[a.start_airport].add(s)),a.end_airport&&(this.app.airportToPaths[a.end_airport]||(this.app.airportToPaths[a.end_airport]=new Set),this.app.airportToPaths[a.end_airport].add(s))}),e.path_segments&&e.path_segments.length>0){let a=e.path_segments.map(n=>n.altitude_ft||0),s=a[0]??0,r=a[0]??0;for(let n=1;n<a.length;n++){let p=a[n]??0;p<s&&(s=p),p>r&&(r=p)}this.app.altitudeRange.min=s,this.app.altitudeRange.max=r}this.app.layerManager.redrawAltitudePaths(),this.app.airspeedVisible&&this.app.layerManager.redrawAirspeedPaths()}};var ke=class{constructor(e){this.app=e,o.cacheElements(["stats-panel","wrapped-modal"])}saveMapState(){if(!this.app.map)return;let e=o.get("stats-panel"),t=o.get("wrapped-modal"),a={center:this.app.map.getCenter(),zoom:this.app.map.getZoom(),heatmapVisible:this.app.heatmapVisible,altitudeVisible:this.app.altitudeVisible,airspeedVisible:this.app.airspeedVisible,airportsVisible:this.app.airportsVisible,aviationVisible:this.app.aviationVisible,selectedYear:this.app.selectedYear,selectedAircraft:this.app.selectedAircraft,selectedPathIds:Array.from(this.app.selectedPathIds),statsPanelVisible:e?e.classList.contains("visible"):!1,wrappedVisible:t?t.style.display==="flex":!1,buttonsHidden:this.app.buttonsHidden};try{localStorage.setItem("kml-heatmap-state",JSON.stringify(a))}catch{}this.updateUrl(a)}loadMapState(){try{let e=localStorage.getItem("kml-heatmap-state");if(e)return JSON.parse(e)}catch{}return null}updateUrl(e){let t=window.KMLHeatmap.encodeStateToUrl(e),a=t?"?"+t:window.location.pathname;try{history.replaceState(null,"",a)}catch{}}loadState(){let e=window.KMLHeatmap.parseUrlParams(new URLSearchParams(window.location.search));return e&&Object.keys(e).length>0?e:this.loadMapState()}};var ce=Ce(fe(),1);var De=class{constructor(e){this.app=e,o.cacheElements(["legend-min","legend-max","airspeed-legend-min","airspeed-legend-max"])}redrawAltitudePaths(){if(!this.app.currentData)return;this.app.altitudeLayer.clearLayers(),this.app.pathSegments={};let e,t;if(this.app.selectedPathIds.size>0){let a=this.app.currentData.path_segments.filter(s=>this.app.selectedPathIds.has(s.path_id));if(a.length>0){let s=a.map(p=>p.altitude_ft||0),r=s[0]??0,n=s[0]??0;for(let p=1;p<s.length;p++){let d=s[p]??0;d<r&&(r=d),d>n&&(n=d)}e=r,t=n}else e=this.app.altitudeRange.min,t=this.app.altitudeRange.max}else e=this.app.altitudeRange.min,t=this.app.altitudeRange.max;this.app.currentData.path_segments.forEach(a=>{let s=a.path_id,r=this.app.currentData.path_info.find(m=>m.id===s);if(this.app.selectedYear!=="all"&&r&&r.year&&r.year.toString()!==this.app.selectedYear||this.app.selectedAircraft!=="all"&&r&&r.aircraft_registration!==this.app.selectedAircraft)return;let n=this.app.selectedPathIds.has(s);if(this.app.selectedPathIds.size>0&&!n&&this.app.buttonsHidden)return;let p=window.KMLHeatmap.getColorForAltitude(a.altitude_ft??0,e,t);ce.polyline(a.coords||[],{color:p,weight:n?6:4,opacity:n?1:this.app.selectedPathIds.size>0?.1:.85,renderer:this.app.altitudeRenderer,interactive:!0}).bindPopup("Altitude: "+a.altitude_ft+" ft ("+a.altitude_m+" m)").addTo(this.app.altitudeLayer).on("click",m=>{ce.DomEvent.stopPropagation(m),this.app.pathSelection.togglePathSelection(s)}),this.app.pathSegments[s]||(this.app.pathSegments[s]=[]),this.app.pathSegments[s].push(a)}),this.updateAltitudeLegend(e,t),this.app.airportManager.updateAirportOpacity(),this.app.statsManager.updateStatsForSelection()}redrawAirspeedPaths(){if(!this.app.currentData){Yt("redrawAirspeedPaths: No current data available");return}this.app.airspeedLayer.clearLayers();let e,t;if(this.app.selectedPathIds.size>0){let a=this.app.currentData.path_segments.filter(s=>this.app.selectedPathIds.has(s.path_id)&&(s.groundspeed_knots||0)>0);if(a.length>0){let s=a.map(p=>p.groundspeed_knots||0),r=s[0]??0,n=s[0]??0;for(let p=1;p<s.length;p++){let d=s[p]??0;d<r&&(r=d),d>n&&(n=d)}e=r,t=n}else e=this.app.airspeedRange.min,t=this.app.airspeedRange.max}else e=this.app.airspeedRange.min,t=this.app.airspeedRange.max;this.app.currentData.path_segments.forEach(a=>{let s=a.path_id,r=this.app.currentData.path_info.find(n=>n.id===s);if(!(this.app.selectedYear!=="all"&&r&&r.year&&r.year.toString()!==this.app.selectedYear)&&!(this.app.selectedAircraft!=="all"&&r&&r.aircraft_registration!==this.app.selectedAircraft)&&(a.groundspeed_knots||0)>0){let n=this.app.selectedPathIds.has(s);if(this.app.selectedPathIds.size>0&&!n&&this.app.buttonsHidden)return;let p=window.KMLHeatmap.getColorForAirspeed(a.groundspeed_knots??0,e,t),d=Math.round((a.groundspeed_knots||0)*1.852);ce.polyline(a.coords||[],{color:p,weight:n?6:4,opacity:n?1:this.app.selectedPathIds.size>0?.1:.85,renderer:this.app.airspeedRenderer,interactive:!0}).bindPopup("Groundspeed: "+a.groundspeed_knots+" kt ("+d+" km/h)").addTo(this.app.airspeedLayer).on("click",b=>{ce.DomEvent.stopPropagation(b),this.app.pathSelection.togglePathSelection(s)})}}),this.updateAirspeedLegend(e,t),this.app.airportManager.updateAirportOpacity(),this.app.statsManager.updateStatsForSelection()}updateAltitudeLegend(e,t){let a=Math.round(e),s=Math.round(t),r=Math.round(e*.3048),n=Math.round(t*.3048),p=o.get("legend-min"),d=o.get("legend-max");p&&(p.textContent=a.toLocaleString()+" ft ("+r.toLocaleString()+" m)"),d&&(d.textContent=s.toLocaleString()+" ft ("+n.toLocaleString()+" m)")}updateAirspeedLegend(e,t){let a=Math.round(e),s=Math.round(t),r=Math.round(e*1.852),n=Math.round(t*1.852),p=o.get("airspeed-legend-min"),d=o.get("airspeed-legend-max");p&&(p.textContent=a.toLocaleString()+" kt ("+r.toLocaleString()+" km/h)"),d&&(d.textContent=s.toLocaleString()+" kt ("+n.toLocaleString()+" km/h)")}};var Ie=class{constructor(e){this.app=e,o.cacheElements(["aircraft-select","year-select"])}updateAircraftDropdown(){if(!this.app.fullPathInfo)return;let e=o.get("aircraft-select");if(!e)return;let t=this.app.selectedAircraft;for(;e.options.length>1;)e.remove(1);let a;this.app.selectedYear==="all"?a=this.app.fullPathInfo:a=this.app.fullPathInfo.filter(p=>p.year&&p.year.toString()===this.app.selectedYear);let s={};a.forEach(p=>{if(p.aircraft_registration){let d=p.aircraft_registration;s[d]||(s[d]={registration:d,type:p.aircraft_type,flights:0}),s[d].flights+=1}});let r=Object.values(s).sort((p,d)=>d.flights-p.flights),n=!1;r.forEach(p=>{let d=document.createElement("option");d.value=p.registration;let m=p.type?" ("+p.type+")":"";d.textContent="\u2708\uFE0F "+p.registration+m,e.appendChild(d),p.registration===t&&(n=!0)}),!n&&t!=="all"?(this.app.selectedAircraft="all",e.value="all"):e.value=t}async filterByYear(){let e=o.get("year-select");if(!e)return;this.app.selectedYear=e.value,this.app.dataManager.loadedData={},this.app.altitudeLayer.clearLayers(),this.app.pathSegments={},this.app.isInitializing||this.app.selectedPathIds.clear(),await this.app.dataManager.updateLayers();let t=await this.app.dataManager.loadData("data",this.app.selectedYear);t&&(this.app.fullPathInfo=t.path_info||[],this.app.fullPathSegments=t.path_segments||[]),this.updateAircraftDropdown();let a=window.KMLHeatmap.calculateFilteredStatistics({pathInfo:this.app.fullPathInfo??[],segments:this.app.fullPathSegments??[],year:this.app.selectedYear,aircraft:this.app.selectedAircraft,coordinateCount:this.app.currentData?.original_points});this.app.statsManager.updateStatsPanel(a,!1),this.app.airportManager.updateAirportOpacity(),this.app.airportManager.updateAirportPopups(),this.app.isInitializing||this.app.stateManager.saveMapState()}async filterByAircraft(){let e=o.get("aircraft-select");if(!e)return;this.app.selectedAircraft=e.value,this.app.altitudeLayer.clearLayers(),this.app.pathSegments={},this.app.isInitializing||this.app.selectedPathIds.clear(),await this.app.dataManager.updateLayers();let t=window.KMLHeatmap.calculateFilteredStatistics({pathInfo:this.app.fullPathInfo??[],segments:this.app.fullPathSegments??[],year:this.app.selectedYear,aircraft:this.app.selectedAircraft,coordinateCount:this.app.currentData?.original_points});this.app.statsManager.updateStatsPanel(t,!1),this.app.airportManager.updateAirportOpacity(),this.app.airportManager.updateAirportPopups(),this.app.isInitializing||this.app.stateManager.saveMapState()}};var{entries:Qt,setPrototypeOf:Wt,isFrozen:_a,getPrototypeOf:Ta,getOwnPropertyDescriptor:xa}=Object,{freeze:z,seal:G,create:mt}=Object,{apply:ut,construct:ft}=typeof Reflect<"u"&&Reflect;z||(z=function(e){return e});G||(G=function(e){return e});ut||(ut=function(e,t){for(var a=arguments.length,s=new Array(a>2?a-2:0),r=2;r<a;r++)s[r-2]=arguments[r];return e.apply(t,s)});ft||(ft=function(e){for(var t=arguments.length,a=new Array(t>1?t-1:0),s=1;s<t;s++)a[s-1]=arguments[s];return new e(...a)});var Oe=B(Array.prototype.forEach),wa=B(Array.prototype.lastIndexOf),Kt=B(Array.prototype.pop),ge=B(Array.prototype.push),Ea=B(Array.prototype.splice),He=B(String.prototype.toLowerCase),ot=B(String.prototype.toString),pt=B(String.prototype.match),ye=B(String.prototype.replace),Pa=B(String.prototype.indexOf),Ca=B(String.prototype.trim),K=B(Object.prototype.hasOwnProperty),N=B(RegExp.prototype.test),be=Ra(TypeError);function B(c){return function(e){e instanceof RegExp&&(e.lastIndex=0);for(var t=arguments.length,a=new Array(t>1?t-1:0),s=1;s<t;s++)a[s-1]=arguments[s];return ut(c,e,a)}}function Ra(c){return function(){for(var e=arguments.length,t=new Array(e),a=0;a<e;a++)t[a]=arguments[a];return ft(c,t)}}function y(c,e){let t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:He;Wt&&Wt(c,null);let a=e.length;for(;a--;){let s=e[a];if(typeof s=="string"){let r=t(s);r!==s&&(_a(e)||(e[a]=r),s=r)}c[s]=!0}return c}function ka(c){for(let e=0;e<c.length;e++)K(c,e)||(c[e]=null);return c}function j(c){let e=mt(null);for(let[t,a]of Qt(c))K(c,t)&&(Array.isArray(a)?e[t]=ka(a):a&&typeof a=="object"&&a.constructor===Object?e[t]=j(a):e[t]=a);return e}function Me(c,e){for(;c!==null;){let a=xa(c,e);if(a){if(a.get)return B(a.get);if(typeof a.value=="function")return B(a.value)}c=Ta(c)}function t(){return null}return t}var $t=z(["a","abbr","acronym","address","area","article","aside","audio","b","bdi","bdo","big","blink","blockquote","body","br","button","canvas","caption","center","cite","code","col","colgroup","content","data","datalist","dd","decorator","del","details","dfn","dialog","dir","div","dl","dt","element","em","fieldset","figcaption","figure","font","footer","form","h1","h2","h3","h4","h5","h6","head","header","hgroup","hr","html","i","img","input","ins","kbd","label","legend","li","main","map","mark","marquee","menu","menuitem","meter","nav","nobr","ol","optgroup","option","output","p","picture","pre","progress","q","rp","rt","ruby","s","samp","search","section","select","shadow","slot","small","source","spacer","span","strike","strong","style","sub","summary","sup","table","tbody","td","template","textarea","tfoot","th","thead","time","tr","track","tt","u","ul","var","video","wbr"]),lt=z(["svg","a","altglyph","altglyphdef","altglyphitem","animatecolor","animatemotion","animatetransform","circle","clippath","defs","desc","ellipse","enterkeyhint","exportparts","filter","font","g","glyph","glyphref","hkern","image","inputmode","line","lineargradient","marker","mask","metadata","mpath","part","path","pattern","polygon","polyline","radialgradient","rect","stop","style","switch","symbol","text","textpath","title","tref","tspan","view","vkern"]),dt=z(["feBlend","feColorMatrix","feComponentTransfer","feComposite","feConvolveMatrix","feDiffuseLighting","feDisplacementMap","feDistantLight","feDropShadow","feFlood","feFuncA","feFuncB","feFuncG","feFuncR","feGaussianBlur","feImage","feMerge","feMergeNode","feMorphology","feOffset","fePointLight","feSpecularLighting","feSpotLight","feTile","feTurbulence"]),Da=z(["animate","color-profile","cursor","discard","font-face","font-face-format","font-face-name","font-face-src","font-face-uri","foreignobject","hatch","hatchpath","mesh","meshgradient","meshpatch","meshrow","missing-glyph","script","set","solidcolor","unknown","use"]),ct=z(["math","menclose","merror","mfenced","mfrac","mglyph","mi","mlabeledtr","mmultiscripts","mn","mo","mover","mpadded","mphantom","mroot","mrow","ms","mspace","msqrt","mstyle","msub","msup","msubsup","mtable","mtd","mtext","mtr","munder","munderover","mprescripts"]),Ia=z(["maction","maligngroup","malignmark","mlongdiv","mscarries","mscarry","msgroup","mstack","msline","msrow","semantics","annotation","annotation-xml","mprescripts","none"]),Zt=z(["#text"]),jt=z(["accept","action","align","alt","autocapitalize","autocomplete","autopictureinpicture","autoplay","background","bgcolor","border","capture","cellpadding","cellspacing","checked","cite","class","clear","color","cols","colspan","controls","controlslist","coords","crossorigin","datetime","decoding","default","dir","disabled","disablepictureinpicture","disableremoteplayback","download","draggable","enctype","enterkeyhint","exportparts","face","for","headers","height","hidden","high","href","hreflang","id","inert","inputmode","integrity","ismap","kind","label","lang","list","loading","loop","low","max","maxlength","media","method","min","minlength","multiple","muted","name","nonce","noshade","novalidate","nowrap","open","optimum","part","pattern","placeholder","playsinline","popover","popovertarget","popovertargetaction","poster","preload","pubdate","radiogroup","readonly","rel","required","rev","reversed","role","rows","rowspan","spellcheck","scope","selected","shape","size","sizes","slot","span","srclang","start","src","srcset","step","style","summary","tabindex","title","translate","type","usemap","valign","value","width","wrap","xmlns","slot"]),ht=z(["accent-height","accumulate","additive","alignment-baseline","amplitude","ascent","attributename","attributetype","azimuth","basefrequency","baseline-shift","begin","bias","by","class","clip","clippathunits","clip-path","clip-rule","color","color-interpolation","color-interpolation-filters","color-profile","color-rendering","cx","cy","d","dx","dy","diffuseconstant","direction","display","divisor","dur","edgemode","elevation","end","exponent","fill","fill-opacity","fill-rule","filter","filterunits","flood-color","flood-opacity","font-family","font-size","font-size-adjust","font-stretch","font-style","font-variant","font-weight","fx","fy","g1","g2","glyph-name","glyphref","gradientunits","gradienttransform","height","href","id","image-rendering","in","in2","intercept","k","k1","k2","k3","k4","kerning","keypoints","keysplines","keytimes","lang","lengthadjust","letter-spacing","kernelmatrix","kernelunitlength","lighting-color","local","marker-end","marker-mid","marker-start","markerheight","markerunits","markerwidth","maskcontentunits","maskunits","max","mask","mask-type","media","method","mode","min","name","numoctaves","offset","operator","opacity","order","orient","orientation","origin","overflow","paint-order","path","pathlength","patterncontentunits","patterntransform","patternunits","points","preservealpha","preserveaspectratio","primitiveunits","r","rx","ry","radius","refx","refy","repeatcount","repeatdur","restart","result","rotate","scale","seed","shape-rendering","slope","specularconstant","specularexponent","spreadmethod","startoffset","stddeviation","stitchtiles","stop-color","stop-opacity","stroke-dasharray","stroke-dashoffset","stroke-linecap","stroke-linejoin","stroke-miterlimit","stroke-opacity","stroke","stroke-width","style","surfacescale","systemlanguage","tabindex","tablevalues","targetx","targety","transform","transform-origin","text-anchor","text-decoration","text-rendering","textlength","type","u1","u2","unicode","values","viewbox","visibility","version","vert-adv-y","vert-origin-x","vert-origin-y","width","word-spacing","wrap","writing-mode","xchannelselector","ychannelselector","x","x1","x2","xmlns","y","y1","y2","z","zoomandpan"]),qt=z(["accent","accentunder","align","bevelled","close","columnsalign","columnlines","columnspan","denomalign","depth","dir","display","displaystyle","encoding","fence","frame","height","href","id","largeop","length","linethickness","lspace","lquote","mathbackground","mathcolor","mathsize","mathvariant","maxsize","minsize","movablelimits","notation","numalign","open","rowalign","rowlines","rowspacing","rowspan","rspace","rquote","scriptlevel","scriptminsize","scriptsizemultiplier","selection","separator","separators","stretchy","subscriptshift","supscriptshift","symmetric","voffset","width","xmlns"]),Fe=z(["xlink:href","xml:id","xlink:title","xml:space","xmlns:xlink"]),Oa=G(/\{\{[\w\W]*|[\w\W]*\}\}/gm),Fa=G(/<%[\w\W]*|[\w\W]*%>/gm),Ha=G(/\$\{[\w\W]*/gm),Na=G(/^data-[\-\w.\u00B7-\uFFFF]+$/),za=G(/^aria-[\-\w]+$/),ea=G(/^(?:(?:(?:f|ht)tps?|mailto|tel|callto|sms|cid|xmpp|matrix):|[^a-z]|[a-z+.\-]+(?:[^a-z+.\-:]|$))/i),Ba=G(/^(?:\w+script|data):/i),Va=G(/[\u0000-\u0020\u00A0\u1680\u180E\u2000-\u2029\u205F\u3000]/g),ta=G(/^html$/i),Ua=G(/^[a-z][.\w]*(-[.\w]+)+$/i),Xt=Object.freeze({__proto__:null,ARIA_ATTR:za,ATTR_WHITESPACE:Va,CUSTOM_ELEMENT:Ua,DATA_ATTR:Na,DOCTYPE_NAME:ta,ERB_EXPR:Fa,IS_ALLOWED_URI:ea,IS_SCRIPT_OR_DATA:Ba,MUSTACHE_EXPR:Oa,TMPLIT_EXPR:Ha}),Ae={element:1,attribute:2,text:3,cdataSection:4,entityReference:5,entityNode:6,progressingInstruction:7,comment:8,document:9,documentType:10,documentFragment:11,notation:12},Ya=function(){return typeof window>"u"?null:window},Ga=function(e,t){if(typeof e!="object"||typeof e.createPolicy!="function")return null;let a=null,s="data-tt-policy-suffix";t&&t.hasAttribute(s)&&(a=t.getAttribute(s));let r="dompurify"+(a?"#"+a:"");try{return e.createPolicy(r,{createHTML(n){return n},createScriptURL(n){return n}})}catch{return console.warn("TrustedTypes policy "+r+" could not be created."),null}},Jt=function(){return{afterSanitizeAttributes:[],afterSanitizeElements:[],afterSanitizeShadowDOM:[],beforeSanitizeAttributes:[],beforeSanitizeElements:[],beforeSanitizeShadowDOM:[],uponSanitizeAttribute:[],uponSanitizeElement:[],uponSanitizeShadowNode:[]}};function aa(){let c=arguments.length>0&&arguments[0]!==void 0?arguments[0]:Ya(),e=u=>aa(u);if(e.version="3.3.1",e.removed=[],!c||!c.document||c.document.nodeType!==Ae.document||!c.Element)return e.isSupported=!1,e;let{document:t}=c,a=t,s=a.currentScript,{DocumentFragment:r,HTMLTemplateElement:n,Node:p,Element:d,NodeFilter:m,NamedNodeMap:b=c.NamedNodeMap||c.MozNamedAttrMap,HTMLFormElement:S,DOMParser:v,trustedTypes:M}=c,f=d.prototype,g=Me(f,"cloneNode"),x=Me(f,"remove"),w=Me(f,"nextSibling"),U=Me(f,"childNodes"),_=Me(f,"parentNode");if(typeof n=="function"){let u=t.createElement("template");u.content&&u.content.ownerDocument&&(t=u.content.ownerDocument)}let A,Y="",{implementation:R,createNodeIterator:W,createDocumentFragment:ee,getElementsByTagName:ve}=t,{importNode:ia}=a,H=Jt();e.isSupported=typeof Qt=="function"&&typeof _=="function"&&R&&R.createHTMLDocument!==void 0;let{MUSTACHE_EXPR:We,ERB_EXPR:Ke,TMPLIT_EXPR:$e,DATA_ATTR:ra,ARIA_ATTR:sa,IS_SCRIPT_OR_DATA:na,ATTR_WHITESPACE:yt,CUSTOM_ELEMENT:oa}=Xt,{IS_ALLOWED_URI:bt}=Xt,k=null,Mt=y({},[...$t,...lt,...dt,...ct,...Zt]),D=null,At=y({},[...jt,...ht,...qt,...Fe]),E=Object.seal(mt(null,{tagNameCheck:{writable:!0,configurable:!1,enumerable:!0,value:null},attributeNameCheck:{writable:!0,configurable:!1,enumerable:!0,value:null},allowCustomizedBuiltInElements:{writable:!0,configurable:!1,enumerable:!0,value:!1}})),he=null,Ze=null,re=Object.seal(mt(null,{tagCheck:{writable:!0,configurable:!1,enumerable:!0,value:null},attributeCheck:{writable:!0,configurable:!1,enumerable:!0,value:null}})),vt=!0,je=!0,St=!1,Lt=!0,se=!1,Se=!0,ae=!1,qe=!1,Xe=!1,ne=!1,Le=!1,_e=!1,_t=!0,Tt=!1,pa="user-content-",Je=!0,me=!1,oe={},$=null,Qe=y({},["annotation-xml","audio","colgroup","desc","foreignobject","head","iframe","math","mi","mn","mo","ms","mtext","noembed","noframes","noscript","plaintext","script","style","svg","template","thead","title","video","xmp"]),xt=null,wt=y({},["audio","video","img","source","image","track"]),et=null,Et=y({},["alt","class","for","id","label","name","pattern","placeholder","role","summary","title","value","style","xmlns"]),Te="http://www.w3.org/1998/Math/MathML",xe="http://www.w3.org/2000/svg",X="http://www.w3.org/1999/xhtml",pe=X,tt=!1,at=null,la=y({},[Te,xe,X],ot),we=y({},["mi","mo","mn","ms","mtext"]),Ee=y({},["annotation-xml"]),da=y({},["title","style","font","a","script"]),ue=null,ca=["application/xhtml+xml","text/html"],ha="text/html",C=null,le=null,ma=t.createElement("form"),Pt=function(i){return i instanceof RegExp||i instanceof Function},it=function(){let i=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};if(!(le&&le===i)){if((!i||typeof i!="object")&&(i={}),i=j(i),ue=ca.indexOf(i.PARSER_MEDIA_TYPE)===-1?ha:i.PARSER_MEDIA_TYPE,C=ue==="application/xhtml+xml"?ot:He,k=K(i,"ALLOWED_TAGS")?y({},i.ALLOWED_TAGS,C):Mt,D=K(i,"ALLOWED_ATTR")?y({},i.ALLOWED_ATTR,C):At,at=K(i,"ALLOWED_NAMESPACES")?y({},i.ALLOWED_NAMESPACES,ot):la,et=K(i,"ADD_URI_SAFE_ATTR")?y(j(Et),i.ADD_URI_SAFE_ATTR,C):Et,xt=K(i,"ADD_DATA_URI_TAGS")?y(j(wt),i.ADD_DATA_URI_TAGS,C):wt,$=K(i,"FORBID_CONTENTS")?y({},i.FORBID_CONTENTS,C):Qe,he=K(i,"FORBID_TAGS")?y({},i.FORBID_TAGS,C):j({}),Ze=K(i,"FORBID_ATTR")?y({},i.FORBID_ATTR,C):j({}),oe=K(i,"USE_PROFILES")?i.USE_PROFILES:!1,vt=i.ALLOW_ARIA_ATTR!==!1,je=i.ALLOW_DATA_ATTR!==!1,St=i.ALLOW_UNKNOWN_PROTOCOLS||!1,Lt=i.ALLOW_SELF_CLOSE_IN_ATTR!==!1,se=i.SAFE_FOR_TEMPLATES||!1,Se=i.SAFE_FOR_XML!==!1,ae=i.WHOLE_DOCUMENT||!1,ne=i.RETURN_DOM||!1,Le=i.RETURN_DOM_FRAGMENT||!1,_e=i.RETURN_TRUSTED_TYPE||!1,Xe=i.FORCE_BODY||!1,_t=i.SANITIZE_DOM!==!1,Tt=i.SANITIZE_NAMED_PROPS||!1,Je=i.KEEP_CONTENT!==!1,me=i.IN_PLACE||!1,bt=i.ALLOWED_URI_REGEXP||ea,pe=i.NAMESPACE||X,we=i.MATHML_TEXT_INTEGRATION_POINTS||we,Ee=i.HTML_INTEGRATION_POINTS||Ee,E=i.CUSTOM_ELEMENT_HANDLING||{},i.CUSTOM_ELEMENT_HANDLING&&Pt(i.CUSTOM_ELEMENT_HANDLING.tagNameCheck)&&(E.tagNameCheck=i.CUSTOM_ELEMENT_HANDLING.tagNameCheck),i.CUSTOM_ELEMENT_HANDLING&&Pt(i.CUSTOM_ELEMENT_HANDLING.attributeNameCheck)&&(E.attributeNameCheck=i.CUSTOM_ELEMENT_HANDLING.attributeNameCheck),i.CUSTOM_ELEMENT_HANDLING&&typeof i.CUSTOM_ELEMENT_HANDLING.allowCustomizedBuiltInElements=="boolean"&&(E.allowCustomizedBuiltInElements=i.CUSTOM_ELEMENT_HANDLING.allowCustomizedBuiltInElements),se&&(je=!1),Le&&(ne=!0),oe&&(k=y({},Zt),D=[],oe.html===!0&&(y(k,$t),y(D,jt)),oe.svg===!0&&(y(k,lt),y(D,ht),y(D,Fe)),oe.svgFilters===!0&&(y(k,dt),y(D,ht),y(D,Fe)),oe.mathMl===!0&&(y(k,ct),y(D,qt),y(D,Fe))),i.ADD_TAGS&&(typeof i.ADD_TAGS=="function"?re.tagCheck=i.ADD_TAGS:(k===Mt&&(k=j(k)),y(k,i.ADD_TAGS,C))),i.ADD_ATTR&&(typeof i.ADD_ATTR=="function"?re.attributeCheck=i.ADD_ATTR:(D===At&&(D=j(D)),y(D,i.ADD_ATTR,C))),i.ADD_URI_SAFE_ATTR&&y(et,i.ADD_URI_SAFE_ATTR,C),i.FORBID_CONTENTS&&($===Qe&&($=j($)),y($,i.FORBID_CONTENTS,C)),i.ADD_FORBID_CONTENTS&&($===Qe&&($=j($)),y($,i.ADD_FORBID_CONTENTS,C)),Je&&(k["#text"]=!0),ae&&y(k,["html","head","body"]),k.table&&(y(k,["tbody"]),delete he.tbody),i.TRUSTED_TYPES_POLICY){if(typeof i.TRUSTED_TYPES_POLICY.createHTML!="function")throw be('TRUSTED_TYPES_POLICY configuration option must provide a "createHTML" hook.');if(typeof i.TRUSTED_TYPES_POLICY.createScriptURL!="function")throw be('TRUSTED_TYPES_POLICY configuration option must provide a "createScriptURL" hook.');A=i.TRUSTED_TYPES_POLICY,Y=A.createHTML("")}else A===void 0&&(A=Ga(M,s)),A!==null&&typeof Y=="string"&&(Y=A.createHTML(""));z&&z(i),le=i}},Ct=y({},[...lt,...dt,...Da]),Rt=y({},[...ct,...Ia]),ua=function(i){let l=_(i);(!l||!l.tagName)&&(l={namespaceURI:pe,tagName:"template"});let h=He(i.tagName),T=He(l.tagName);return at[i.namespaceURI]?i.namespaceURI===xe?l.namespaceURI===X?h==="svg":l.namespaceURI===Te?h==="svg"&&(T==="annotation-xml"||we[T]):!!Ct[h]:i.namespaceURI===Te?l.namespaceURI===X?h==="math":l.namespaceURI===xe?h==="math"&&Ee[T]:!!Rt[h]:i.namespaceURI===X?l.namespaceURI===xe&&!Ee[T]||l.namespaceURI===Te&&!we[T]?!1:!Rt[h]&&(da[h]||!Ct[h]):!!(ue==="application/xhtml+xml"&&at[i.namespaceURI]):!1},Z=function(i){ge(e.removed,{element:i});try{_(i).removeChild(i)}catch{x(i)}},ie=function(i,l){try{ge(e.removed,{attribute:l.getAttributeNode(i),from:l})}catch{ge(e.removed,{attribute:null,from:l})}if(l.removeAttribute(i),i==="is")if(ne||Le)try{Z(l)}catch{}else try{l.setAttribute(i,"")}catch{}},kt=function(i){let l=null,h=null;if(Xe)i="<remove></remove>"+i;else{let P=pt(i,/^[\r\n\t ]+/);h=P&&P[0]}ue==="application/xhtml+xml"&&pe===X&&(i='<html xmlns="http://www.w3.org/1999/xhtml"><head></head><body>'+i+"</body></html>");let T=A?A.createHTML(i):i;if(pe===X)try{l=new v().parseFromString(T,ue)}catch{}if(!l||!l.documentElement){l=R.createDocument(pe,"template",null);try{l.documentElement.innerHTML=tt?Y:T}catch{}}let F=l.body||l.documentElement;return i&&h&&F.insertBefore(t.createTextNode(h),F.childNodes[0]||null),pe===X?ve.call(l,ae?"html":"body")[0]:ae?l.documentElement:F},Dt=function(i){return W.call(i.ownerDocument||i,i,m.SHOW_ELEMENT|m.SHOW_COMMENT|m.SHOW_TEXT|m.SHOW_PROCESSING_INSTRUCTION|m.SHOW_CDATA_SECTION,null)},rt=function(i){return i instanceof S&&(typeof i.nodeName!="string"||typeof i.textContent!="string"||typeof i.removeChild!="function"||!(i.attributes instanceof b)||typeof i.removeAttribute!="function"||typeof i.setAttribute!="function"||typeof i.namespaceURI!="string"||typeof i.insertBefore!="function"||typeof i.hasChildNodes!="function")},It=function(i){return typeof p=="function"&&i instanceof p};function J(u,i,l){Oe(u,h=>{h.call(e,i,l,le)})}let Ot=function(i){let l=null;if(J(H.beforeSanitizeElements,i,null),rt(i))return Z(i),!0;let h=C(i.nodeName);if(J(H.uponSanitizeElement,i,{tagName:h,allowedTags:k}),Se&&i.hasChildNodes()&&!It(i.firstElementChild)&&N(/<[/\w!]/g,i.innerHTML)&&N(/<[/\w!]/g,i.textContent)||i.nodeType===Ae.progressingInstruction||Se&&i.nodeType===Ae.comment&&N(/<[/\w]/g,i.data))return Z(i),!0;if(!(re.tagCheck instanceof Function&&re.tagCheck(h))&&(!k[h]||he[h])){if(!he[h]&&Ht(h)&&(E.tagNameCheck instanceof RegExp&&N(E.tagNameCheck,h)||E.tagNameCheck instanceof Function&&E.tagNameCheck(h)))return!1;if(Je&&!$[h]){let T=_(i)||i.parentNode,F=U(i)||i.childNodes;if(F&&T){let P=F.length;for(let V=P-1;V>=0;--V){let Q=g(F[V],!0);Q.t=(i.t||0)+1,T.insertBefore(Q,w(i))}}}return Z(i),!0}return i instanceof d&&!ua(i)||(h==="noscript"||h==="noembed"||h==="noframes")&&N(/<\/no(script|embed|frames)/i,i.innerHTML)?(Z(i),!0):(se&&i.nodeType===Ae.text&&(l=i.textContent,Oe([We,Ke,$e],T=>{l=ye(l,T," ")}),i.textContent!==l&&(ge(e.removed,{element:i.cloneNode()}),i.textContent=l)),J(H.afterSanitizeElements,i,null),!1)},Ft=function(i,l,h){if(_t&&(l==="id"||l==="name")&&(h in t||h in ma))return!1;if(!(je&&!Ze[l]&&N(ra,l))){if(!(vt&&N(sa,l))){if(!(re.attributeCheck instanceof Function&&re.attributeCheck(l,i))){if(!D[l]||Ze[l]){if(!(Ht(i)&&(E.tagNameCheck instanceof RegExp&&N(E.tagNameCheck,i)||E.tagNameCheck instanceof Function&&E.tagNameCheck(i))&&(E.attributeNameCheck instanceof RegExp&&N(E.attributeNameCheck,l)||E.attributeNameCheck instanceof Function&&E.attributeNameCheck(l,i))||l==="is"&&E.allowCustomizedBuiltInElements&&(E.tagNameCheck instanceof RegExp&&N(E.tagNameCheck,h)||E.tagNameCheck instanceof Function&&E.tagNameCheck(h))))return!1}else if(!et[l]){if(!N(bt,ye(h,yt,""))){if(!((l==="src"||l==="xlink:href"||l==="href")&&i!=="script"&&Pa(h,"data:")===0&&xt[i])){if(!(St&&!N(na,ye(h,yt,"")))){if(h)return!1}}}}}}}return!0},Ht=function(i){return i!=="annotation-xml"&&pt(i,oa)},Nt=function(i){J(H.beforeSanitizeAttributes,i,null);let{attributes:l}=i;if(!l||rt(i))return;let h={attrName:"",attrValue:"",keepAttr:!0,allowedAttributes:D,forceKeepAttr:void 0},T=l.length;for(;T--;){let F=l[T],{name:P,namespaceURI:V,value:Q}=F,de=C(P),st=Q,I=P==="value"?st:Ca(st);if(h.attrName=de,h.attrValue=I,h.keepAttr=!0,h.forceKeepAttr=void 0,J(H.uponSanitizeAttribute,i,h),I=h.attrValue,Tt&&(de==="id"||de==="name")&&(ie(P,i),I=pa+I),Se&&N(/((--!?|])>)|<\/(style|title|textarea)/i,I)){ie(P,i);continue}if(de==="attributename"&&pt(I,"href")){ie(P,i);continue}if(h.forceKeepAttr)continue;if(!h.keepAttr){ie(P,i);continue}if(!Lt&&N(/\/>/i,I)){ie(P,i);continue}se&&Oe([We,Ke,$e],Bt=>{I=ye(I,Bt," ")});let zt=C(i.nodeName);if(!Ft(zt,de,I)){ie(P,i);continue}if(A&&typeof M=="object"&&typeof M.getAttributeType=="function"&&!V)switch(M.getAttributeType(zt,de)){case"TrustedHTML":{I=A.createHTML(I);break}case"TrustedScriptURL":{I=A.createScriptURL(I);break}}if(I!==st)try{V?i.setAttributeNS(V,P,I):i.setAttribute(P,I),rt(i)?Z(i):Kt(e.removed)}catch{ie(P,i)}}J(H.afterSanitizeAttributes,i,null)},fa=function u(i){let l=null,h=Dt(i);for(J(H.beforeSanitizeShadowDOM,i,null);l=h.nextNode();)J(H.uponSanitizeShadowNode,l,null),Ot(l),Nt(l),l.content instanceof r&&u(l.content);J(H.afterSanitizeShadowDOM,i,null)};return e.sanitize=function(u){let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},l=null,h=null,T=null,F=null;if(tt=!u,tt&&(u="<!-->"),typeof u!="string"&&!It(u))if(typeof u.toString=="function"){if(u=u.toString(),typeof u!="string")throw be("dirty is not a string, aborting")}else throw be("toString is not a function");if(!e.isSupported)return u;if(qe||it(i),e.removed=[],typeof u=="string"&&(me=!1),me){if(u.nodeName){let Q=C(u.nodeName);if(!k[Q]||he[Q])throw be("root node is forbidden and cannot be sanitized in-place")}}else if(u instanceof p)l=kt("<!---->"),h=l.ownerDocument.importNode(u,!0),h.nodeType===Ae.element&&h.nodeName==="BODY"||h.nodeName==="HTML"?l=h:l.appendChild(h);else{if(!ne&&!se&&!ae&&u.indexOf("<")===-1)return A&&_e?A.createHTML(u):u;if(l=kt(u),!l)return ne?null:_e?Y:""}l&&Xe&&Z(l.firstChild);let P=Dt(me?u:l);for(;T=P.nextNode();)Ot(T),Nt(T),T.content instanceof r&&fa(T.content);if(me)return u;if(ne){if(Le)for(F=ee.call(l.ownerDocument);l.firstChild;)F.appendChild(l.firstChild);else F=l;return(D.shadowroot||D.shadowrootmode)&&(F=ia.call(a,F,!0)),F}let V=ae?l.outerHTML:l.innerHTML;return ae&&k["!doctype"]&&l.ownerDocument&&l.ownerDocument.doctype&&l.ownerDocument.doctype.name&&N(ta,l.ownerDocument.doctype.name)&&(V="<!DOCTYPE "+l.ownerDocument.doctype.name+`>
`+V),se&&Oe([We,Ke,$e],Q=>{V=ye(V,Q," ")}),A&&_e?A.createHTML(V):V},e.setConfig=function(){let u=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};it(u),qe=!0},e.clearConfig=function(){le=null,qe=!1},e.isValidAttribute=function(u,i,l){le||it({});let h=C(u),T=C(i);return Ft(h,T,l)},e.addHook=function(u,i){typeof i=="function"&&ge(H[u],i)},e.removeHook=function(u,i){if(i!==void 0){let l=wa(H[u],i);return l===-1?void 0:Ea(H[u],l,1)[0]}return Kt(H[u])},e.removeHooks=function(u){H[u]=[]},e.removeAllHooks=function(){H=Jt()},e}var te=aa();var Ne=class{constructor(e){this.app=e,o.cacheElements(["stats-panel"])}updateStatsForSelection(){if(this.app.selectedPathIds.size===0){let n=window.KMLHeatmap.calculateFilteredStatistics({pathInfo:this.app.fullPathInfo||[],segments:this.app.fullPathSegments||[],year:this.app.selectedYear,aircraft:this.app.selectedAircraft,coordinateCount:this.app.currentData?.original_points});n&&this.updateStatsPanel(n,!1);return}let e=(this.app.fullPathInfo||[]).filter(n=>this.app.selectedPathIds.has(n.id)),t=(this.app.fullPathSegments||[]).filter(n=>this.app.selectedPathIds.has(n.path_id));if(t.length===0)return;let a=new Set;for(let n of t)n.coords&&n.coords.length===2&&(a.add(JSON.stringify(n.coords[0])),a.add(JSON.stringify(n.coords[1])));let s=a.size,r=window.KMLHeatmap.calculateFilteredStatistics({pathInfo:e,segments:t,year:"all",aircraft:"all",coordinateCount:s});this.updateStatsPanel(r,!0)}updateStatsPanel(e,t){let a="";t?(a+='<p style="margin:0 0 10px 0; font-weight:bold; font-size:15px;">\u{1F4CA} Selected Paths Statistics</p>',a+='<div style="background-color: #3a5a7a; padding: 4px 8px; margin-bottom: 8px; border-radius: 3px; font-size: 11px; color: #a0c0e0;">Showing stats for '+e.num_paths+" selected path(s)</div>"):a+='<p style="margin:0 0 10px 0; font-weight:bold; font-size:15px;">\u{1F4CA} Flight Statistics</p>',a+='<div style="margin-bottom: 8px;"><strong>Data Points:</strong> '+e.total_points.toLocaleString()+"</div>",a+='<div style="margin-bottom: 8px;"><strong>Flights:</strong> '+e.num_paths+"</div>",e.airport_names&&e.airport_names.length>0&&(a+='<div style="margin-bottom: 8px; max-height: 150px; overflow-y: auto;"><strong>Airports ('+e.num_airports+"):</strong><br>",e.airport_names.forEach(n=>{a+='<span style="margin-left: 10px;">\u2022 '+n+"</span><br>"}),a+="</div>"),e.num_aircraft&&e.num_aircraft>0&&e.aircraft_list&&e.aircraft_list.length>0&&(a+='<div style="margin-bottom: 8px; max-height: 150px; overflow-y: auto;"><strong>Aircrafts ('+e.num_aircraft+"):</strong><br>",e.aircraft_list.forEach(n=>{let p=n.type?" ("+n.type+")":"";a+='<span style="margin-left: 10px;">\u2022 '+n.registration+p+" - "+n.flights+" flight(s)</span><br>"}),a+="</div>"),e.total_flight_time_str&&(a+='<div style="margin-bottom: 8px;"><strong>Total Flight Time:</strong> '+e.total_flight_time_str+"</div>");let s=(e.total_distance_nm*1.852).toFixed(1);if(a+='<div style="margin-bottom: 8px;"><strong>Distance:</strong> '+e.total_distance_nm.toFixed(1)+" nm ("+s+" km)</div>",e.num_paths>0){let n=(e.total_distance_nm/e.num_paths).toFixed(1),p=(parseFloat(n)*1.852).toFixed(1);a+='<div style="margin-bottom: 8px;"><strong>Average Distance per Trip:</strong> '+n+" nm ("+p+" km)</div>"}if(e.longest_flight_nm&&e.longest_flight_nm>0){let n=(e.longest_flight_km||0).toFixed(1);a+='<div style="margin-bottom: 8px;"><strong>Longest Flight:</strong> '+e.longest_flight_nm.toFixed(1)+" nm ("+n+" km)</div>"}if(e.average_groundspeed_knots&&e.average_groundspeed_knots>0){let n=Math.round(e.average_groundspeed_knots*1.852);a+='<div style="margin-bottom: 8px;"><strong>Average Groundspeed:</strong> '+Math.round(e.average_groundspeed_knots)+" kt ("+n+" km/h)</div>"}if(e.cruise_speed_knots&&e.cruise_speed_knots>0){let n=Math.round(e.cruise_speed_knots*1.852);a+='<div style="margin-bottom: 8px;"><strong>Cruise Speed (>1000ft AGL):</strong> '+Math.round(e.cruise_speed_knots)+" kt ("+n+" km/h)</div>"}if(e.max_groundspeed_knots&&e.max_groundspeed_knots>0){let n=Math.round(e.max_groundspeed_knots*1.852);a+='<div style="margin-bottom: 8px;"><strong>Max Groundspeed:</strong> '+Math.round(e.max_groundspeed_knots)+" kt ("+n+" km/h)</div>"}if(e.max_altitude_ft){let n=Math.round(e.max_altitude_ft*.3048);if(a+='<div style="margin-bottom: 8px;"><strong>Max Altitude (MSL):</strong> '+Math.round(e.max_altitude_ft)+" ft ("+n+" m)</div>",e.total_altitude_gain_ft){let p=Math.round(e.total_altitude_gain_ft*.3048);a+='<div style="margin-bottom: 8px;"><strong>Elevation Gain:</strong> '+Math.round(e.total_altitude_gain_ft)+" ft ("+p+" m)</div>"}}if(e.most_common_cruise_altitude_ft&&e.most_common_cruise_altitude_ft>0){let n=Math.round(e.most_common_cruise_altitude_m||0);a+='<div style="margin-bottom: 8px;"><strong>Most Common Cruise Altitude (AGL):</strong> '+e.most_common_cruise_altitude_ft.toLocaleString()+" ft ("+n.toLocaleString()+" m)</div>"}let r=o.get("stats-panel");r&&(r.innerHTML=te.sanitize(a))}toggleStats(){let e=o.get("stats-panel");e&&(e.classList.contains("visible")?(e.classList.remove("visible"),setTimeout(()=>{e.style.display="none",this.app.stateManager.saveMapState()},300)):(e.style.display="block",e.offsetHeight,e.classList.add("visible"),this.app.stateManager.saveMapState()))}};var ze=class{constructor(e){this.app=e}togglePathSelection(e){this.app.selectedPathIds.has(e)?this.app.selectedPathIds.delete(e):this.app.selectedPathIds.add(e),this.app.altitudeVisible&&(this.app.layerManager.redrawAltitudePaths(),setTimeout(()=>{this.app.map.invalidateSize()},50)),this.app.airspeedVisible&&(this.app.layerManager.redrawAirspeedPaths(),setTimeout(()=>{this.app.map.invalidateSize()},50)),this.app.replayManager.updateReplayButtonState(),this.app.stateManager.saveMapState()}selectPathsByAirport(e){let t=this.app.airportToPaths[e];t&&t.forEach(a=>{this.app.selectedPathIds.add(a)}),this.app.altitudeVisible&&(this.app.layerManager.redrawAltitudePaths(),setTimeout(()=>{this.app.map.invalidateSize()},50)),this.app.airspeedVisible&&(this.app.layerManager.redrawAirspeedPaths(),setTimeout(()=>{this.app.map.invalidateSize()},50)),this.app.replayManager.updateReplayButtonState(),this.app.stateManager.saveMapState()}clearSelection(){this.app.selectedPathIds.clear(),this.app.altitudeVisible&&(this.app.layerManager.redrawAltitudePaths(),setTimeout(()=>{this.app.map.invalidateSize()},50)),this.app.airspeedVisible&&(this.app.layerManager.redrawAirspeedPaths(),setTimeout(()=>{this.app.map.invalidateSize()},50)),this.app.replayManager.updateReplayButtonState(),this.app.stateManager.saveMapState()}};var Be=class{constructor(e){this.app=e}calculateAirportFlightCounts(){return window.KMLHeatmap.calculateAirportFlightCounts(this.app.fullPathInfo??[],this.app.selectedYear,this.app.selectedAircraft)}updateAirportPopups(){if(!this.app.allAirportsData||!this.app.airportMarkers)return;let e=this.calculateAirportFlightCounts(),t=null,a=0;Object.keys(e).forEach(s=>{let r=e[s];r!==void 0&&r>a&&(a=r,t=s)}),this.app.allAirportsData.forEach(s=>{let r=this.app.airportMarkers[s.name];if(!r)return;let n=e[s.name]||0,p=s.name===t,d=window.KMLHeatmap.ddToDms(s.lat,!0),m=window.KMLHeatmap.ddToDms(s.lon,!1),b=`https://www.google.com/maps?q=${s.lat},${s.lon}`,S=`
            <div style="
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
                min-width: 220px;
                padding: 8px 4px;
                background-color: #2b2b2b;
                color: #ffffff;
            ">
                <div style="
                    font-size: 15px;
                    font-weight: bold;
                    color: #28a745;
                    margin-bottom: 10px;
                    padding-bottom: 8px;
                    border-bottom: 2px solid #28a745;
                    display: flex;
                    align-items: center;
                    gap: 6px;
                ">
                    <span style="font-size: 18px;">\u{1F6EB}</span>
                    <span>${s.name||"Unknown"}</span>
                    ${p?'<span style="font-size: 12px; background: #007bff; color: white; padding: 2px 6px; border-radius: 3px; margin-left: 4px;">HOME</span>':""}
                </div>
                <div style="margin-bottom: 8px;">
                    <div style="font-size: 11px; color: #999; margin-bottom: 2px; text-transform: uppercase; letter-spacing: 0.5px;">Coordinates</div>
                    <a href="${b}"
                       target="_blank"
                       style="
                           color: #4facfe;
                           text-decoration: none;
                           font-size: 12px;
                           font-family: monospace;
                           display: flex;
                           align-items: center;
                           gap: 4px;
                       "
                       onmouseover="this.style.textDecoration='underline'"
                       onmouseout="this.style.textDecoration='none'">
                        <span>\u{1F4CD}</span>
                        <span>${d}<br>${m}</span>
                    </a>
                </div>
                <div style="
                    background: linear-gradient(135deg, rgba(79, 172, 254, 0.15) 0%, rgba(0, 242, 254, 0.15) 100%);
                    padding: 8px 10px;
                    border-radius: 6px;
                    border-left: 3px solid #4facfe;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                ">
                    <span style="font-size: 12px; color: #ccc; font-weight: 500;">Total Flights</span>
                    <span style="font-size: 16px; font-weight: bold; color: #4facfe;">${n}</span>
                </div>
            </div>`;r.setPopupContent(S)})}updateAirportOpacity(){let e=this.app.selectedYear!=="all"||this.app.selectedAircraft!=="all",t=this.app.selectedPathIds.size>0;if(!e&&!t){Object.keys(this.app.airportMarkers).forEach(s=>{let r=this.app.airportMarkers[s];r&&(r.setOpacity(1),this.app.airportLayer.hasLayer(r)||r.addTo(this.app.airportLayer))});return}let a=new Set;e&&this.app.fullPathInfo&&this.app.fullPathInfo.forEach(s=>{let r=this.app.selectedYear==="all"||s.year&&s.year.toString()===this.app.selectedYear,n=this.app.selectedAircraft==="all"||s.aircraft_registration===this.app.selectedAircraft;r&&n&&(s.start_airport&&a.add(s.start_airport),s.end_airport&&a.add(s.end_airport))}),t&&this.app.selectedPathIds.forEach(s=>{if(this.app.fullPathInfo){let r=this.app.fullPathInfo.find(n=>n.id===s);r&&(r.start_airport&&a.add(r.start_airport),r.end_airport&&a.add(r.end_airport))}else{let r=this.app.pathToAirports[s];r&&(r.start&&a.add(r.start),r.end&&a.add(r.end))}}),Object.keys(this.app.airportMarkers).forEach(s=>{let r=this.app.airportMarkers[s];r&&(a.has(s)?(r.setOpacity(1),this.app.airportLayer.hasLayer(r)||r.addTo(this.app.airportLayer)):this.app.airportLayer.hasLayer(r)&&this.app.airportLayer.removeLayer(r))})}updateAirportMarkerSizes(){if(!this.app.map)return;let e=this.app.map.getZoom(),t="";e>=14?t="xlarge":e>=12?t="large":e>=10?t="medium":e>=8?t="medium-small":e>=6&&(t="small"),document.querySelectorAll(".airport-marker-container").forEach(a=>{let s=a.querySelector(".airport-marker"),r=a.querySelector(".airport-label");!s||!r||(e<5?r.style.display="none":r.style.display="",a.classList.remove("airport-marker-container-small","airport-marker-container-medium-small","airport-marker-container-medium","airport-marker-container-large","airport-marker-container-xlarge"),s.classList.remove("airport-marker-small","airport-marker-medium-small","airport-marker-medium","airport-marker-large","airport-marker-xlarge"),r.classList.remove("airport-label-small","airport-label-medium-small","airport-label-medium","airport-label-large","airport-label-xlarge"),t&&(a.classList.add("airport-marker-container-"+t),s.classList.add("airport-marker-"+t),r.classList.add("airport-label-"+t)))})}};var q=Ce(fe(),1);var Ve=class{constructor(e){this.app=e,o.cacheElements(["replay-controls","replay-btn","replay-play-btn","replay-pause-btn","replay-slider","replay-slider-start","replay-slider-end","replay-time-display","replay-speed","replay-autozoom-btn","altitude-btn","altitude-legend"]),this.replayActive=!1,this.replayPlaying=!1,this.replayCurrentTime=0,this.replayMaxTime=0,this.replaySpeed=50,this.replayInterval=null,this.replayLayer=null,this.replaySegments=[],this.replayAirplaneMarker=null,this.replayLastDrawnIndex=-1,this.replayLastBearing=null,this.replayAnimationFrameId=null,this.replayLastFrameTime=null,this.replayColorMinAlt=0,this.replayColorMaxAlt=1e4,this.replayColorMinSpeed=0,this.replayColorMaxSpeed=200,this.replayAutoZoom=!1,this.replayLastZoom=null,this.replayRecenterTimestamps=[]}toggleReplay(){let e=o.get("replay-controls");if(e)if(this.replayActive){this.stopReplay(),e.style.display="none",this.replayActive=!1;let t=o.get("replay-btn");if(t&&(t.textContent="\u25B6\uFE0F Replay"),document.body.classList.remove("replay-active"),this.replayAirplaneMarker&&this.app.map&&(this.app.map.removeLayer(this.replayAirplaneMarker),this.replayAirplaneMarker=null),this.replayLayer&&this.app.map&&this.app.map.removeLayer(this.replayLayer),this.restoreLayerVisibility(),!this.app.altitudeVisible&&!this.app.airspeedVisible&&this.app.map){this.app.altitudeVisible=!0;let a=o.get("altitude-btn");a&&(a.style.opacity="1.0");let s=o.get("altitude-legend");s&&(s.style.display="block"),this.app.map.addLayer(this.app.altitudeLayer)}setTimeout(()=>{this.app.altitudeVisible?this.app.layerManager.redrawAltitudePaths():this.app.airspeedVisible&&this.app.layerManager.redrawAirspeedPaths(),this.app.map&&this.app.map.invalidateSize()},100),this.updateReplayButtonState(),this.app.stateManager.saveMapState()}else{if(this.app.selectedPathIds.size!==1)return;if(this.initializeReplay()){e.style.display="block",this.replayActive=!0;let t=o.get("replay-btn");t&&(t.textContent="\u23F9\uFE0F Replay",t.style.opacity="1.0");let a=o.get("replay-autozoom-btn");a&&(a.style.opacity=this.replayAutoZoom?"1.0":"0.5",a.title=this.replayAutoZoom?"Auto-zoom enabled":"Auto-zoom disabled"),document.body.classList.add("replay-active"),this.hideOtherLayersDuringReplay(),this.app.stateManager.saveMapState()}}}updateReplayButtonState(){let e=o.get("replay-btn");if(!e)return;let t=this.app.fullStats&&this.app.fullStats.max_groundspeed_knots!==void 0&&this.app.fullStats.max_groundspeed_knots>0;this.app.selectedPathIds.size===1&&t?(e.style.opacity="1.0",e.disabled=!1,e.setAttribute("aria-disabled","false")):(e.style.opacity="0.5",e.disabled=!0,e.setAttribute("aria-disabled","true"))}updateReplayAirplanePopup(){if(!this.replayAirplaneMarker||!this.replayActive)return;let e=null;for(let f=0;f<this.replaySegments.length;f++){let g=this.replaySegments[f];if(g&&(g.time||0)<=this.replayCurrentTime)e=g;else break}if(!e&&this.replaySegments.length>0&&(e=this.replaySegments[0]),!e)return;let t=`<div style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif; min-width: 180px; padding: 8px 4px; background-color: #2b2b2b; color: #ffffff;">`;t+='<div style="font-size: 14px; font-weight: bold; color: #4facfe; margin-bottom: 8px; padding-bottom: 6px; border-bottom: 2px solid #4facfe; display: flex; align-items: center; gap: 6px;">',t+='<span style="font-size: 16px;">\u2708\uFE0F</span>',t+="<span>Current Position</span>",t+="</div>";let a=e.altitude_ft||0,s=Math.round(a/50)*50,r=Math.round(s*.3048),n=window.KMLHeatmap.getColorForAltitude(a,this.replayColorMinAlt,this.replayColorMaxAlt),p=n.replace("rgb(","rgba(").replace(")",", 0.15)");t+='<div style="margin-bottom: 8px;">',t+='<div style="font-size: 11px; color: #999; margin-bottom: 2px; text-transform: uppercase; letter-spacing: 0.5px;">Altitude (MSL)</div>',t+='<div style="background: '+p+"; padding: 6px 8px; border-radius: 6px; border-left: 3px solid "+n+';">',t+='<span style="font-size: 16px; font-weight: bold; color: '+n+';">'+s.toLocaleString()+" ft</span>",t+='<span style="font-size: 12px; color: #ccc; margin-left: 6px;">('+r.toLocaleString()+" m)</span>",t+="</div>",t+="</div>";let d=e.groundspeed_knots||0,m=d*1.852,b=Math.round(d),S=Math.round(m),v=window.KMLHeatmap.getColorForAirspeed(d,this.replayColorMinSpeed,this.replayColorMaxSpeed),M=v.replace("rgb(","rgba(").replace(")",", 0.15)");t+='<div style="margin-bottom: 8px;">',t+='<div style="font-size: 11px; color: #999; margin-bottom: 2px; text-transform: uppercase; letter-spacing: 0.5px;">Groundspeed</div>',t+='<div style="background: '+M+"; padding: 6px 8px; border-radius: 6px; border-left: 3px solid "+v+';">',t+='<span style="font-size: 16px; font-weight: bold; color: '+v+';">'+b.toLocaleString()+" kt</span>",t+='<span style="font-size: 12px; color: #ccc; margin-left: 6px;">('+S.toLocaleString()+" km/h)</span>",t+="</div>",t+="</div>",t+="</div>",this.replayAirplaneMarker.getPopup()?this.replayAirplaneMarker.getPopup().setContent(t):this.replayAirplaneMarker.bindPopup(t,{autoPanPadding:[50,50]}),this.replayAirplaneMarker.openPopup()}initializeReplay(){if(!this.app.fullPathSegments)return alert("No flight data available for replay. Please wait for data to load or refresh the page."),!1;let e=Array.from(this.app.selectedPathIds)[0];if(this.replaySegments=this.app.fullPathSegments.filter(m=>m.path_id===e&&m.time!==void 0&&m.time!==null),this.replaySegments.length===0)return!1;if(this.replaySegments.sort((m,b)=>(m.time||0)-(b.time||0)),this.app.currentData&&this.app.currentData.path_segments){let m=this.app.currentData.path_segments.filter(b=>b.path_id===e);if(m.length>0){let b=m.map(f=>f.altitude_ft||0),S=b[0]??0,v=b[0]??0;for(let f=1;f<b.length;f++){let g=b[f]??0;g<S&&(S=g),g>v&&(v=g)}this.replayColorMinAlt=S,this.replayColorMaxAlt=v;let M=m.map(f=>f.groundspeed_knots||0).filter(f=>f>0);if(M.length>0){let f=M[0]??0,g=M[0]??0;for(let x=1;x<M.length;x++){let w=M[x]??0;w<f&&(f=w),w>g&&(g=w)}this.replayColorMinSpeed=f,this.replayColorMaxSpeed=g}else this.replayColorMinSpeed=this.app.airspeedRange.min,this.replayColorMaxSpeed=this.app.airspeedRange.max}else{let b=this.replaySegments.map(f=>f.altitude_ft||0),S=b[0]??0,v=b[0]??0;for(let f=1;f<b.length;f++){let g=b[f]??0;g<S&&(S=g),g>v&&(v=g)}this.replayColorMinAlt=S,this.replayColorMaxAlt=v;let M=this.replaySegments.map(f=>f.groundspeed_knots||0).filter(f=>f>0);if(M.length>0){let f=M[0]??0,g=M[0]??0;for(let x=1;x<M.length;x++){let w=M[x]??0;w<f&&(f=w),w>g&&(g=w)}this.replayColorMinSpeed=f,this.replayColorMaxSpeed=g}else this.replayColorMinSpeed=this.app.airspeedRange.min,this.replayColorMaxSpeed=this.app.airspeedRange.max}}let t=this.replaySegments[this.replaySegments.length-1];this.replayMaxTime=t?.time||0;let a=o.get("replay-slider");a&&(a.max=this.replayMaxTime.toString());let s=o.get("replay-slider-end");s&&(s.textContent=window.KMLHeatmap.formatTime(this.replayMaxTime)),this.app.layerManager.updateAltitudeLegend(this.replayColorMinAlt,this.replayColorMaxAlt),this.app.layerManager.updateAirspeedLegend(this.replayColorMinSpeed,this.replayColorMaxSpeed),this.replayLayer||(this.replayLayer=q.layerGroup()),this.replayLayer.clearLayers(),this.app.map&&this.replayLayer.addTo(this.app.map),this.replayAirplaneMarker&&this.app.map&&(this.app.map.removeLayer(this.replayAirplaneMarker),this.replayAirplaneMarker=null);let r=q.divIcon({html:'<div class="replay-airplane-icon">\u2708\uFE0F</div>',iconSize:[32,32],iconAnchor:[16,16],className:""}),p=this.replaySegments[0]?.coords?.[0];if(!p||!this.app.map)return!1;this.replayAirplaneMarker=q.marker([p[0],p[1]],{icon:r,zIndexOffset:1e3}),this.replayAirplaneMarker.addTo(this.app.map);let d=this.replayAirplaneMarker.getElement();return d&&(d.style.transition="transform 0.08s linear",d.style.cursor="pointer",d.style.pointerEvents="auto",d.addEventListener("click",m=>{m.stopPropagation(),this.replayAirplaneMarker.isPopupOpen()?this.replayAirplaneMarker.closePopup():this.updateReplayAirplanePopup()})),this.replayCurrentTime=0,this.replayLastDrawnIndex=-1,this.replayLastBearing=null,this.replayAutoZoom&&this.app.map?(this.app.map.setView([p[0],p[1]],16,{animate:!0,duration:.8}),this.replayLastZoom=16):this.app.map&&this.app.map.panTo([p[0],p[1]],{animate:!0,duration:.8}),this.updateReplayDisplay(),!0}hideOtherLayersDuringReplay(){if(!this.app.map)return;this.app.heatmapLayer&&this.app.heatmapVisible&&this.app.map.removeLayer(this.app.heatmapLayer),this.app.altitudeVisible&&this.app.map.removeLayer(this.app.altitudeLayer),this.app.airspeedVisible&&this.app.map.removeLayer(this.app.airspeedLayer),["heatmap-btn","airports-btn","aviation-btn","year-select","aircraft-select"].forEach(t=>{let a=document.getElementById(t);a&&(a.disabled=!0)})}restoreLayerVisibility(){if(!this.app.map)return;this.app.heatmapLayer&&this.app.heatmapVisible&&(this.app.map.addLayer(this.app.heatmapLayer),this.app.heatmapLayer.e&&(this.app.heatmapLayer.e.style.pointerEvents="none")),this.app.altitudeVisible&&(this.app.map.addLayer(this.app.altitudeLayer),setTimeout(()=>{this.app.layerManager.redrawAltitudePaths(),this.app.map&&this.app.map.invalidateSize()},50)),this.app.airspeedVisible&&(this.app.map.addLayer(this.app.airspeedLayer),setTimeout(()=>{this.app.layerManager.redrawAirspeedPaths(),this.app.map&&this.app.map.invalidateSize()},50)),["heatmap-btn","airports-btn","aviation-btn","year-select","aircraft-select"].forEach(t=>{let a=document.getElementById(t);a&&(a.disabled=!1)})}playReplay(){if(!this.replayActive||!this.app.map)return;if(this.replayCurrentTime>=this.replayMaxTime){if(this.replayCurrentTime=0,this.replayLastDrawnIndex=-1,this.replayLayer&&this.replayLayer.clearLayers(),this.replayAirplaneMarker&&this.replaySegments.length>0&&this.app.map){let r=this.replaySegments[0]?.coords?.[0];r&&(this.replayAirplaneMarker.setLatLng([r[0],r[1]]),this.replayAutoZoom&&(this.app.map.setView([r[0],r[1]],16,{animate:!0,duration:.5}),this.replayLastZoom=16))}this.replayRecenterTimestamps=[],this.replayLastBearing=null}this.replayPlaying=!0;let e=o.get("replay-play-btn"),t=o.get("replay-pause-btn");e&&(e.style.display="none"),t&&(t.style.display="inline-block"),this.replayLastFrameTime=null;let a=s=>{if(!this.replayPlaying)return;this.replayLastFrameTime===null&&(this.replayLastFrameTime=s);let r=s-this.replayLastFrameTime;this.replayLastFrameTime=s;let n=r/1e3*this.replaySpeed;if(this.replayCurrentTime+=n,this.replayCurrentTime>=this.replayMaxTime){if(this.replayCurrentTime=this.replayMaxTime,this.pauseReplay(),this.replaySegments.length>0&&this.app.map){let p=[];if(this.replaySegments.forEach(d=>{d.coords&&d.coords.length>0&&d.coords.forEach(m=>{p.push(m)})}),p.length>0){let d=q.latLngBounds(p);this.app.map.fitBounds(d,{padding:[50,50],animate:!0,duration:1})}}}else this.replayAnimationFrameId=requestAnimationFrame(a);this.updateReplayDisplay()};this.replayAnimationFrameId=requestAnimationFrame(a),this.app.stateManager.saveMapState()}pauseReplay(){this.replayPlaying=!1;let e=o.get("replay-play-btn"),t=o.get("replay-pause-btn");e&&(e.style.display="inline-block"),t&&(t.style.display="none"),this.replayAnimationFrameId&&(cancelAnimationFrame(this.replayAnimationFrameId),this.replayAnimationFrameId=null),this.replayLastFrameTime=null,this.app.stateManager.saveMapState()}stopReplay(){if(this.pauseReplay(),this.replayCurrentTime=0,this.replayLastDrawnIndex=-1,this.replayLastBearing=null,this.replayRecenterTimestamps=[],this.replayLayer&&this.replayLayer.clearLayers(),this.replayAirplaneMarker&&this.replaySegments.length>0){let t=this.replaySegments[0]?.coords?.[0];t&&this.replayAirplaneMarker.setLatLng([t[0],t[1]])}this.updateReplayDisplay()}seekReplay(e){let t=parseFloat(e);t<this.replayCurrentTime&&(this.replayLayer&&this.replayLayer.clearLayers(),this.replayLastDrawnIndex=-1),this.replayCurrentTime=t,this.updateReplayDisplay(!0),this.app.stateManager.saveMapState()}changeReplaySpeed(){let e=o.get("replay-speed");e&&(this.replaySpeed=parseFloat(e.value),this.app.stateManager.saveMapState())}toggleAutoZoom(){this.replayAutoZoom=!this.replayAutoZoom;let e=o.get("replay-autozoom-btn");e&&(e.style.opacity=this.replayAutoZoom?"1.0":"0.5",e.title=this.replayAutoZoom?"Auto-zoom enabled":"Auto-zoom disabled"),this.app.stateManager.saveMapState()}updateReplayDisplay(e=!1){let t=o.get("replay-time-display");t&&(t.textContent=window.KMLHeatmap.formatTime(this.replayCurrentTime)+" / "+window.KMLHeatmap.formatTime(this.replayMaxTime));let a=o.get("replay-slider");a&&(a.value=this.replayCurrentTime.toString());let s=o.get("replay-slider-start");s&&(s.textContent=window.KMLHeatmap.formatTime(this.replayCurrentTime));let r=null,n=null,p=-1;for(let d=0;d<this.replaySegments.length;d++){let m=this.replaySegments[d];if(m&&(m.time||0)<=this.replayCurrentTime)r=m,p=d;else if(m){n=m;break}}if(this.replayLayer){let d=this.app.airspeedVisible&&!this.app.altitudeVisible;for(let m=0;m<this.replaySegments.length;m++){let b=this.replaySegments[m];if(b)if((b.time||0)<=this.replayCurrentTime&&this.replayCurrentTime>0){if(m>this.replayLastDrawnIndex){let S;d&&(b.groundspeed_knots||0)>0?S=window.KMLHeatmap.getColorForAltitude(b.groundspeed_knots??0,this.replayColorMinSpeed,this.replayColorMaxSpeed):S=window.KMLHeatmap.getColorForAltitude(b.altitude_ft??0,this.replayColorMinAlt,this.replayColorMaxAlt),q.polyline(b.coords||[],{color:S,weight:3,opacity:.8}).addTo(this.replayLayer),this.replayLastDrawnIndex=m}}else break}}if(this.replayAirplaneMarker&&this.app.map&&!this.app.map.hasLayer(this.replayAirplaneMarker)&&this.replayAirplaneMarker.addTo(this.app.map),this.replayAirplaneMarker&&this.app.map){if(r){let d,m=0;if(n&&(r.time||0)<this.replayCurrentTime){let v=(this.replayCurrentTime-(r.time||0))/((n.time||0)-(r.time||0)),M=r.coords?.[1]?.[0]||0,f=r.coords?.[1]?.[1]||0,g=n.coords?.[0]?.[0]||0,x=n.coords?.[0]?.[1]||0;d=[M+(g-M)*v,f+(x-f)*v],m=window.KMLHeatmap.calculateBearing(M,f,g,x)}else{d=r.coords?.[1]||[0,0];let v=r.coords?.[0]?.[0]||0,M=r.coords?.[0]?.[1]||0,f=r.coords?.[1]?.[0]||0,g=r.coords?.[1]?.[1]||0;m=window.KMLHeatmap.calculateBearing(v,M,f,g)}let b=window.KMLHeatmap.calculateSmoothedBearing(this.replaySegments,p,5);if(b!==null?(m=b,this.replayLastBearing=m):this.replayLastBearing!==null&&(m=this.replayLastBearing),this.replayAirplaneMarker.setLatLng(d),this.replayPlaying||e){let v=this.app.map.getSize(),M=this.app.map.latLngToContainerPoint(d),f=.1,g=v.x*f,x=v.y*f,w=!1;if((M.x<g||M.x>v.x-g||M.y<x||M.y>v.y-x)&&(w=!0),e&&(w=!0),w){this.app.map.panTo(d,{animate:!0,duration:.5,easeLinearity:.25,noMoveStart:!0});let U=Date.now();this.replayRecenterTimestamps.push(U);let _=U-3e4;this.replayRecenterTimestamps=this.replayRecenterTimestamps.filter(A=>A>_)}if(this.replayAutoZoom){let _=Date.now()-3e4;if(this.replayRecenterTimestamps=this.replayRecenterTimestamps.filter(Y=>Y>_),this.replayRecenterTimestamps.length>2){let R=Date.now()-5e3;if(this.replayRecenterTimestamps.filter(ee=>ee>=R).length>2&&this.replayLastZoom!==null&&this.replayLastZoom>9){let ve=Math.max(9,this.replayLastZoom-1);this.app.map.setZoom(ve,{animate:!0,duration:.5}),this.replayLastZoom=ve,this.replayRecenterTimestamps=[]}}}}let S=this.replayAirplaneMarker.getElement();if(S){let v=S.querySelector(".replay-airplane-icon");if(v){let M=m-45;v.style.transform="translate3d(0,0,0) rotate("+M+"deg)"}}}else if(this.replaySegments.length>0){let m=this.replaySegments[0]?.coords?.[0];m&&this.replayAirplaneMarker.setLatLng([m[0],m[1]])}}this.replayAirplaneMarker&&this.replayAirplaneMarker.getPopup()&&this.replayAirplaneMarker.isPopupOpen()&&this.updateReplayAirplanePopup()}};var Ue=class{constructor(e){this.app=e,this.originalMapParent=null,this.originalMapIndex=null,o.cacheElements(["wrapped-title","wrapped-year","wrapped-stats","wrapped-fun-facts","wrapped-aircraft-fleet","wrapped-top-airports","wrapped-airports-grid","map","wrapped-map-container","wrapped-modal","stats-btn","export-btn","wrapped-btn","heatmap-btn","airports-btn","altitude-btn","airspeed-btn","aviation-btn","year-filter","aircraft-filter","stats-panel","altitude-legend","airspeed-legend","loading"])}showWrapped(){if(!this.app.map)return;let e=this.app.selectedYear,t=window.KMLHeatmap.calculateYearStats(this.app.fullPathInfo||[],this.app.fullPathSegments||[],e,this.app.fullStats),a=o.get("wrapped-title"),s=o.get("wrapped-year");e==="all"?(a&&(a.textContent="\u2728 Your Flight History"),s&&(s.textContent="All Years")):(a&&(a.textContent="\u2728 Your Year in Flight"),s&&(s.textContent=e));let r=this.app.fullStats&&this.app.fullStats.max_groundspeed_knots!==void 0&&this.app.fullStats.max_groundspeed_knots>0,n=`
            <div class="stat-card">
                <div class="stat-value">${t.total_flights}</div>
                <div class="stat-label">Flights</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">${t.num_airports}</div>
                <div class="stat-label">Airports</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">${t.total_distance_nm.toFixed(0)}</div>
                <div class="stat-label">Nautical Miles</div>
            </div>
            ${r?`
            <div class="stat-card">
                <div class="stat-value">${t.flight_time}</div>
                <div class="stat-label">Flight Time</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">${(this.app.fullStats?.max_groundspeed_knots||0).toFixed(0)} kt</div>
                <div class="stat-label">Max Groundspeed</div>
            </div>
            `:""}
            <div class="stat-card">
                <div class="stat-value">${Math.round((this.app.fullStats?.max_altitude_m||0)/.3048).toLocaleString()} ft</div>
                <div class="stat-label">Max Altitude (MSL)</div>
            </div>
        `,p=o.get("wrapped-stats");p&&(p.innerHTML=te.sanitize(n));let d=window.KMLHeatmap.generateFunFacts(t,this.app.fullStats),m='<div class="fun-facts-title">\u2728 Facts</div>';d.forEach(g=>{m+=`<div class="fun-fact" data-category="${g.category}"><span class="fun-fact-icon">${g.icon}</span><span class="fun-fact-text">${g.text}</span></div>`});let b=o.get("wrapped-fun-facts");if(b&&(b.innerHTML=te.sanitize(m)),t.aircraft_list&&t.aircraft_list.length>0){let g='<div class="aircraft-fleet-title">\u2708\uFE0F Fleet</div>',x=t.aircraft_list[0]?.flights??0,w=t.aircraft_list[t.aircraft_list.length-1]?.flights??0,U=x-w;t.aircraft_list.forEach(A=>{let Y=A.model||A.type||"",R=U>0?(A.flights-w)/U:1,W;R>=.75?W="fleet-aircraft-high":R>=.5?W="fleet-aircraft-medium-high":R>=.25?W="fleet-aircraft-medium-low":W="fleet-aircraft-low";let ee=A.flight_time_str||"---";g+=`
                    <div class="fleet-aircraft ${W}">
                        <div class="fleet-aircraft-info">
                            <div class="fleet-aircraft-model">${Y}</div>
                            <div class="fleet-aircraft-registration">${A.registration}</div>
                        </div>
                        <div class="fleet-aircraft-stats">
                            <div class="fleet-aircraft-flights">${A.flights} flights</div>
                            <div class="fleet-aircraft-time">${ee}</div>
                        </div>
                    </div>
                `});let _=o.get("wrapped-aircraft-fleet");_&&(_.innerHTML=te.sanitize(g))}if(t.airport_names&&t.airport_names.length>0){let g;if(e==="all")g=this.app.fullPathInfo||[];else{let _=e.toString();g=(this.app.fullPathInfo||[]).filter(A=>A.year&&A.year.toString()===_)}let x={};g.forEach(_=>{_.start_airport&&(x[_.start_airport]=(x[_.start_airport]||0)+1),_.end_airport&&(x[_.end_airport]=(x[_.end_airport]||0)+1)});let w=t.airport_names.map(_=>({name:_,flight_count:x[_]||0}));w.sort((_,A)=>A.flight_count-_.flight_count);let U=w[0];if(U){let _='<div class="top-airports-title">\u{1F3E0} Home Base</div>';_+=`
                <div class="top-airport">
                    <div class="top-airport-name">${U.name}</div>
                    <div class="top-airport-count">${U.flight_count} flights</div>
                </div>
            `;let A=o.get("wrapped-top-airports");A&&(A.innerHTML=te.sanitize(_));let Y=t.airport_names.filter(R=>R!==U.name);if(Y.length>0){let R='<div class="airports-grid-title">\u{1F5FA}\uFE0F Destinations</div><div class="airport-badges">';Y.forEach(ee=>{R+=`<div class="airport-badge">${ee}</div>`}),R+="</div>";let W=o.get("wrapped-airports-grid");W&&(W.innerHTML=te.sanitize(R))}else{let R=o.get("wrapped-airports-grid");R&&(R.innerHTML="")}}}let S=o.get("map"),v=o.get("wrapped-map-container");if(!S||!v)return;this.originalMapParent||(this.originalMapParent=S.parentNode,this.originalMapIndex=Array.from(this.originalMapParent.children).indexOf(S)),this.app.map.fitBounds(this.app.config.bounds,{padding:[80,80]}),[document.querySelector(".leaflet-control-zoom"),o.get("stats-btn"),o.get("export-btn"),o.get("wrapped-btn"),o.get("heatmap-btn"),o.get("airports-btn"),o.get("altitude-btn"),o.get("airspeed-btn"),o.get("aviation-btn"),o.get("year-filter"),o.get("aircraft-filter"),o.get("stats-panel"),o.get("altitude-legend"),o.get("airspeed-legend"),o.get("loading")].forEach(g=>{g&&(g.style.display="none")});let f=o.get("wrapped-modal");f&&(f.style.display="flex"),setTimeout(()=>{v.appendChild(S),S.style.width="100%",S.style.height="100%",S.style.borderRadius="12px",S.style.overflow="hidden",v.offsetHeight,setTimeout(()=>{this.app.map.invalidateSize(),this.app.map.fitBounds(this.app.config.bounds,{padding:[80,80]}),this.app.stateManager&&this.app.stateManager.saveMapState()},100)},50)}closeWrapped(e){if(!e||e.target.id==="wrapped-modal"){let t=o.get("map");if(!t)return;if(this.originalMapParent&&this.originalMapIndex!==null){let s=Array.from(this.originalMapParent.children);if(this.originalMapIndex>=s.length)this.originalMapParent.appendChild(t);else{let n=s[this.originalMapIndex];n&&this.originalMapParent.insertBefore(t,n)}if(t.style.width="",t.style.height="",t.style.borderRadius="",t.style.overflow="",[document.querySelector(".leaflet-control-zoom"),o.get("stats-btn"),o.get("export-btn"),o.get("wrapped-btn"),o.get("heatmap-btn"),o.get("airports-btn"),o.get("altitude-btn"),o.get("airspeed-btn"),o.get("year-filter"),o.get("aircraft-filter"),o.get("stats-panel"),o.get("altitude-legend"),o.get("airspeed-legend"),o.get("loading")].forEach(n=>{n&&(n.style.display="")}),this.app.config.openaipApiKey){let n=o.get("aviation-btn");n&&(n.style.display="")}setTimeout(()=>{this.app.map&&this.app.map.invalidateSize(),this.app.stateManager&&this.app.stateManager.saveMapState()},100)}let a=o.get("wrapped-modal");a&&(a.style.display="none")}}};var gt=Ce(fe(),1);var Ye=class{constructor(e){this.app=e,o.cacheElements(["heatmap-btn","altitude-btn","airspeed-btn","airports-btn","aviation-btn","altitude-legend","airspeed-legend","export-btn","hide-buttons-btn","map","stats-btn","wrapped-btn","replay-btn","year-filter","aircraft-filter","stats-panel","loading"])}toggleHeatmap(){if(this.app.map){if(this.app.heatmapVisible){this.app.heatmapLayer&&this.app.map.removeLayer(this.app.heatmapLayer),this.app.heatmapVisible=!1;let e=o.get("heatmap-btn");e&&(e.style.opacity="0.5")}else{this.app.heatmapLayer&&(this.app.map.addLayer(this.app.heatmapLayer),this.app.heatmapLayer.e&&(this.app.heatmapLayer.e.style.pointerEvents="none")),this.app.heatmapVisible=!0;let e=o.get("heatmap-btn");e&&(e.style.opacity="1.0")}this.app.stateManager.saveMapState()}}toggleAltitude(){if(this.app.map){if(this.app.altitudeVisible){if(this.app.replayManager.replayActive&&!this.app.airspeedVisible)return;this.app.map.removeLayer(this.app.altitudeLayer),this.app.altitudeVisible=!1;let e=o.get("altitude-btn");e&&(e.style.opacity="0.5");let t=o.get("altitude-legend");t&&(t.style.display="none")}else{if(this.app.airspeedVisible){this.app.replayManager.replayActive||this.app.map.removeLayer(this.app.airspeedLayer),this.app.airspeedVisible=!1;let a=o.get("airspeed-btn");a&&(a.style.opacity="0.5");let s=o.get("airspeed-legend");s&&(s.style.display="none")}if(!this.app.replayManager.replayActive)this.app.map.addLayer(this.app.altitudeLayer),this.app.layerManager.redrawAltitudePaths();else{let a=this.app.replayManager.replayCurrentTime,s=this.app.replayManager.replayLastDrawnIndex;this.app.replayManager.replayLayer&&this.app.replayManager.replayLayer.clearLayers(),this.app.replayManager.replayLastDrawnIndex=-1;for(let r=0;r<=s&&r<this.app.replayManager.replaySegments.length;r++){let n=this.app.replayManager.replaySegments[r];if(n&&(n.time||0)<=a){let p=window.KMLHeatmap.getColorForAltitude(n.altitude_ft||0,this.app.replayManager.replayColorMinAlt,this.app.replayManager.replayColorMaxAlt);gt.polyline(n.coords||[],{color:p,weight:3,opacity:.8}).addTo(this.app.replayManager.replayLayer),this.app.replayManager.replayLastDrawnIndex=r}}}this.app.altitudeVisible=!0;let e=o.get("altitude-btn");e&&(e.style.opacity="1.0");let t=o.get("altitude-legend");t&&(t.style.display="block")}this.app.replayManager.replayActive&&this.app.replayManager.replayAirplaneMarker&&this.app.replayManager.replayAirplaneMarker.isPopupOpen()&&this.app.replayManager.updateReplayAirplanePopup(),this.app.stateManager.saveMapState()}}toggleAirspeed(){if(this.app.map){if(this.app.airspeedVisible){if(this.app.replayManager.replayActive&&!this.app.altitudeVisible)return;this.app.map.removeLayer(this.app.airspeedLayer),this.app.airspeedVisible=!1;let e=o.get("airspeed-btn");e&&(e.style.opacity="0.5");let t=o.get("airspeed-legend");t&&(t.style.display="none")}else{if(this.app.altitudeVisible){this.app.replayManager.replayActive||this.app.map.removeLayer(this.app.altitudeLayer),this.app.altitudeVisible=!1;let a=o.get("altitude-btn");a&&(a.style.opacity="0.5");let s=o.get("altitude-legend");s&&(s.style.display="none")}if(!this.app.replayManager.replayActive)this.app.map.addLayer(this.app.airspeedLayer),this.app.layerManager.redrawAirspeedPaths();else{let a=this.app.replayManager.replayCurrentTime,s=this.app.replayManager.replayLastDrawnIndex;this.app.replayManager.replayLayer&&this.app.replayManager.replayLayer.clearLayers(),this.app.replayManager.replayLastDrawnIndex=-1;for(let r=0;r<=s&&r<this.app.replayManager.replaySegments.length;r++){let n=this.app.replayManager.replaySegments[r];if(n&&(n.time||0)<=a&&(n.groundspeed_knots||0)>0){let p=window.KMLHeatmap.getColorForAltitude(n.groundspeed_knots||0,this.app.replayManager.replayColorMinSpeed,this.app.replayManager.replayColorMaxSpeed);gt.polyline(n.coords||[],{color:p,weight:3,opacity:.8}).addTo(this.app.replayManager.replayLayer),this.app.replayManager.replayLastDrawnIndex=r}}}this.app.airspeedVisible=!0;let e=o.get("airspeed-btn");e&&(e.style.opacity="1.0");let t=o.get("airspeed-legend");t&&(t.style.display="block")}this.app.replayManager.replayActive&&this.app.replayManager.replayAirplaneMarker&&this.app.replayManager.replayAirplaneMarker.isPopupOpen()&&this.app.replayManager.updateReplayAirplanePopup(),this.app.stateManager.saveMapState()}}toggleAirports(){if(this.app.map){if(this.app.airportsVisible){this.app.map.removeLayer(this.app.airportLayer),this.app.airportsVisible=!1;let e=o.get("airports-btn");e&&(e.style.opacity="0.5")}else{this.app.map.addLayer(this.app.airportLayer),this.app.airportsVisible=!0;let e=o.get("airports-btn");e&&(e.style.opacity="1.0")}this.app.stateManager.saveMapState()}}toggleAviation(){if(this.app.map&&this.app.config.openaipApiKey&&this.app.openaipLayers["Aviation Data"]){if(this.app.aviationVisible){this.app.map.removeLayer(this.app.openaipLayers["Aviation Data"]),this.app.aviationVisible=!1;let e=o.get("aviation-btn");e&&(e.style.opacity="0.5")}else{this.app.map.addLayer(this.app.openaipLayers["Aviation Data"]),this.app.aviationVisible=!0;let e=o.get("aviation-btn");e&&(e.style.opacity="1.0")}this.app.stateManager.saveMapState()}}toggleButtonsVisibility(){let e=document.querySelectorAll(".toggleable-btn"),t=o.get("hide-buttons-btn");this.app.buttonsHidden?(e.forEach(a=>{a.classList.remove("buttons-hidden")}),t&&(t.textContent="\u{1F53C}"),this.app.buttonsHidden=!1):(e.forEach(a=>{a.classList.add("buttons-hidden")}),t&&(t.textContent="\u{1F53D}"),this.app.buttonsHidden=!0),this.app.altitudeVisible&&this.app.layerManager.redrawAltitudePaths(),this.app.airspeedVisible&&this.app.layerManager.redrawAirspeedPaths(),this.app.stateManager.saveMapState()}exportMap(){let e=o.get("export-btn");if(!e)return;e.disabled=!0,e.textContent="\u23F3 Exporting...";let t=o.get("map");if(!t)return;let a=[document.querySelector(".leaflet-control-zoom"),o.get("stats-btn"),o.get("export-btn"),o.get("wrapped-btn"),o.get("replay-btn"),o.get("year-filter"),o.get("aircraft-filter"),o.get("heatmap-btn"),o.get("altitude-btn"),o.get("airspeed-btn"),o.get("airports-btn"),o.get("aviation-btn"),o.get("stats-panel"),o.get("altitude-legend"),o.get("airspeed-legend"),o.get("loading")],s=a.map(r=>r?r.style.display:null);a.forEach(r=>{r&&(r.style.display="none")}),setTimeout(()=>{window.domtoimage?.toJpeg(t,{width:t.offsetWidth*2,height:t.offsetHeight*2,bgcolor:"#1a1a1a",quality:.95}).then(r=>{a.forEach((p,d)=>{p&&(p.style.display=s[d]||"")}),e.disabled=!1,e.textContent="\u{1F4F7} Export";let n=document.createElement("a");n.download="heatmap_"+new Date().toISOString().slice(0,19).replace(/[:.]/g,"-")+".jpg",n.href=r,n.click()}).catch(r=>{a.forEach((n,p)=>{n&&(n.style.display=s[p]||"")}),alert("Export failed: "+r.message),e.disabled=!1,e.textContent="\u{1F4F7} Export"})},200)}};var Ge=class{constructor(e){this.config=e,this.selectedYear="all",this.selectedAircraft="all",this.allAirportsData=[],this.isInitializing=!0,this.map=null,this.heatmapLayer=null,this.altitudeLayer=O.layerGroup(),this.airspeedLayer=O.layerGroup(),this.airportLayer=O.layerGroup(),this.altitudeRenderer=O.svg(),this.airspeedRenderer=O.svg(),this.currentData=null,this.fullStats=null,this.fullPathInfo=null,this.fullPathSegments=null,this.altitudeRange={min:0,max:1e4},this.airspeedRange={min:0,max:200},this.heatmapVisible=!0,this.altitudeVisible=!1,this.airspeedVisible=!1,this.airportsVisible=!0,this.aviationVisible=!1,this.buttonsHidden=!1,this.selectedPathIds=new Set,this.pathSegments={},this.pathToAirports={},this.airportToPaths={},this.airportMarkers={},this.openaipLayers={},this.savedState=null,this.restoredYearFromState=!1,this.stateManager=null,this.dataManager=null,this.layerManager=null,this.filterManager=null,this.statsManager=null,this.pathSelection=null,this.airportManager=null,this.replayManager=null,this.wrappedManager=null,this.uiToggles=null}async initialize(){if(this.stateManager=new ke(this),this.savedState=this.stateManager.loadState(),this.savedState&&(this.savedState.selectedYear!==void 0&&(this.selectedYear=this.savedState.selectedYear,this.restoredYearFromState=!0),this.savedState.selectedAircraft&&(this.selectedAircraft=this.savedState.selectedAircraft),this.savedState.selectedPathIds&&this.savedState.selectedPathIds.length>0&&this.savedState.selectedPathIds.forEach(e=>{let t=typeof e=="string"?parseInt(e,10):e;this.selectedPathIds.add(t)}),this.savedState.heatmapVisible!==void 0&&(this.heatmapVisible=this.savedState.heatmapVisible),this.savedState.altitudeVisible!==void 0&&(this.altitudeVisible=this.savedState.altitudeVisible),this.savedState.airspeedVisible!==void 0&&(this.airspeedVisible=this.savedState.airspeedVisible),this.savedState.airportsVisible!==void 0&&(this.airportsVisible=this.savedState.airportsVisible),this.savedState.aviationVisible!==void 0&&(this.aviationVisible=this.savedState.aviationVisible),this.savedState.buttonsHidden!==void 0&&(this.buttonsHidden=this.savedState.buttonsHidden)),this.map=O.map("map",{center:this.config.center,zoom:10,zoomSnap:.25,zoomDelta:.25,wheelPxPerZoomLevel:120,preferCanvas:!0}),this.config.stadiaApiKey?O.tileLayer("https://tiles.stadiamaps.com/tiles/alidade_smooth_dark/{z}/{x}/{y}{r}.png?api_key="+this.config.stadiaApiKey,{attribution:'&copy; <a href="https://stadiamaps.com/">Stadia Maps</a>'}).addTo(this.map):O.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png",{attribution:"&copy; OpenStreetMap contributors, &copy; CARTO"}).addTo(this.map),this.savedState&&this.savedState.center&&this.savedState.zoom?this.map.setView([this.savedState.center.lat,this.savedState.center.lng],this.savedState.zoom):this.map.fitBounds(this.config.bounds,{padding:[30,30]}),this.config.openaipApiKey&&(this.openaipLayers["Aviation Data"]=O.tileLayer("https://{s}.api.tiles.openaip.net/api/data/openaip/{z}/{x}/{y}.png?apiKey="+this.config.openaipApiKey,{attribution:'&copy; <a href="https://www.openaip.net">OpenAIP</a>',maxZoom:18,minZoom:7,subdomains:["a","b","c"]})),this.airportsVisible&&this.airportLayer.addTo(this.map),document.getElementById("heatmap-btn").style.opacity=this.heatmapVisible?"1.0":"0.5",document.getElementById("altitude-btn").style.opacity=this.altitudeVisible?"1.0":"0.5",document.getElementById("airspeed-btn").style.opacity=this.airspeedVisible?"1.0":"0.5",document.getElementById("airports-btn").style.opacity=this.airportsVisible?"1.0":"0.5",document.getElementById("aviation-btn").style.opacity=this.aviationVisible?"1.0":"0.5",this.config.openaipApiKey&&(document.getElementById("aviation-btn").style.display="block"),this.dataManager=new Re(this),this.layerManager=new De(this),this.filterManager=new Ie(this),this.statsManager=new Ne(this),this.pathSelection=new ze(this),this.airportManager=new Be(this),this.replayManager=new Ve(this),this.wrappedManager=new Ue(this),this.uiToggles=new Ye(this),await this.loadInitialData(),this.setupEventHandlers(),this.isInitializing=!1,this.savedState&&this.savedState.buttonsHidden){let e=document.querySelectorAll(".toggleable-btn"),t=document.getElementById("hide-buttons-btn");e.forEach(a=>{a.classList.add("buttons-hidden")}),t&&(t.textContent="\u{1F53D}")}this.savedState&&this.savedState.wrappedVisible&&setTimeout(()=>{this.wrappedManager&&this.wrappedManager.showWrapped()},500),this.stateManager.saveMapState()}async loadInitialData(){let e=await this.dataManager.loadAirports();this.allAirportsData=e;let t=await this.dataManager.loadMetadata();if(t&&t.available_years){let r=document.getElementById("year-select");if(t.available_years.forEach(n=>{let p=document.createElement("option");p.value=n.toString(),p.textContent="\u{1F4C5} "+n,r.appendChild(p)}),this.selectedYear==="all"&&!this.restoredYearFromState){let n=t.available_years[t.available_years.length-1];n!==void 0&&(this.selectedYear=n.toString())}this.selectedYear&&this.selectedYear!=="all"&&(r.value=this.selectedYear)}this.createAirportMarkers(e),t&&t.stats&&(this.fullStats=t.stats);try{let r=await this.dataManager.loadData("data",this.selectedYear);r&&r.path_info&&(this.fullPathInfo=r.path_info),r&&r.path_segments&&(this.fullPathSegments=r.path_segments)}catch(r){Gt("Failed to load full path data:",r)}if(this.filterManager.updateAircraftDropdown(),this.airportManager.updateAirportPopups(),this.fullStats){let r=window.KMLHeatmap.calculateFilteredStatistics({pathInfo:this.fullPathInfo??[],segments:this.fullPathSegments??[],year:this.selectedYear,aircraft:this.selectedAircraft,coordinateCount:this.currentData?.original_points});this.statsManager.updateStatsPanel(r,!1)}this.airportManager.updateAirportOpacity();let a=t&&t.max_groundspeed_knots!==void 0&&t.max_groundspeed_knots>0;a&&(this.airspeedRange.min=t.min_groundspeed_knots,this.airspeedRange.max=t.max_groundspeed_knots,this.layerManager.updateAirspeedLegend(this.airspeedRange.min,this.airspeedRange.max));let s=o.get("airspeed-btn");if(s&&(a?(s.disabled=!1,s.style.opacity=this.airspeedVisible?"1.0":"0.5"):(s.disabled=!0,s.style.opacity="0.3")),await this.dataManager.updateLayers(),this.airportManager.updateAirportMarkerSizes(),this.altitudeVisible&&(this.map.addLayer(this.altitudeLayer),document.getElementById("altitude-legend").style.display="block"),this.airspeedVisible&&(this.map.addLayer(this.airspeedLayer),document.getElementById("airspeed-legend").style.display="block"),this.aviationVisible&&this.config.openaipApiKey&&this.openaipLayers["Aviation Data"]&&this.map.addLayer(this.openaipLayers["Aviation Data"]),this.selectedPathIds.size>0&&this.replayManager.updateReplayButtonState(),this.savedState&&this.savedState.statsPanelVisible){let r=document.getElementById("stats-panel");r.style.display="block",r.offsetHeight,r.classList.add("visible")}}createAirportMarkers(e){let t=null;e.length>0&&(t=e.reduce((a,s)=>{let r=s,n=a,p=r.flight_count??0,d=n?.flight_count??0;return p>d?s:a})),e.forEach(a=>{let s=a.name?a.name.match(/\b([A-Z]{4})\b/):null,r=s?s[1]:"APT",n=t&&a.name===t.name,p=n?" airport-marker-home":"",d=n?" airport-label-home":"",m='<div class="airport-marker-container"><div class="airport-marker'+p+'"></div><div class="airport-label'+d+'">'+r+"</div></div>",b=window.KMLHeatmap.ddToDms(a.lat,!0),S=window.KMLHeatmap.ddToDms(a.lon,!1),v=`https://www.google.com/maps?q=${a.lat},${a.lon}`,M=`
            <div style="
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
                min-width: 220px;
                padding: 8px 4px;
                background-color: #2b2b2b;
                color: #ffffff;
            ">
                <div style="
                    font-size: 15px;
                    font-weight: bold;
                    color: #28a745;
                    margin-bottom: 10px;
                    padding-bottom: 8px;
                    border-bottom: 2px solid #28a745;
                    display: flex;
                    align-items: center;
                    gap: 6px;
                ">
                    <span style="font-size: 18px;">\u{1F6EB}</span>
                    <span>${a.name||"Unknown"}</span>
                    ${n?'<span style="font-size: 12px; background: #007bff; color: white; padding: 2px 6px; border-radius: 3px; margin-left: 4px;">HOME</span>':""}
                </div>
                <div style="margin-bottom: 8px;">
                    <div style="font-size: 11px; color: #999; margin-bottom: 2px; text-transform: uppercase; letter-spacing: 0.5px;">Coordinates</div>
                    <a href="${v}"
                       target="_blank"
                       style="
                           color: #4facfe;
                           text-decoration: none;
                           font-size: 12px;
                           font-family: monospace;
                           display: flex;
                           align-items: center;
                           gap: 4px;
                       "
                       onmouseover="this.style.textDecoration='underline'"
                       onmouseout="this.style.textDecoration='none'">
                        <span>\u{1F4CD}</span>
                        <span>${b}<br>${S}</span>
                    </a>
                </div>
                <div style="
                    background: linear-gradient(135deg, rgba(79, 172, 254, 0.15) 0%, rgba(0, 242, 254, 0.15) 100%);
                    padding: 8px 10px;
                    border-radius: 6px;
                    border-left: 3px solid #4facfe;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                ">
                    <span style="font-size: 12px; color: #ccc; font-weight: 500;">Total Flights</span>
                    <span style="font-size: 16px; font-weight: bold; color: #4facfe;">${a.flight_count||0}</span>
                </div>
            </div>`,f=O.marker([a.lat,a.lon],{icon:O.divIcon({html:m,iconSize:[12,12],iconAnchor:[6,6],popupAnchor:[0,-6],className:""})}).bindPopup(M,{autoPanPadding:[50,50]});f.on("click",g=>{this.replayManager.replayActive||this.pathSelection.selectPathsByAirport(a.name)}),f.addTo(this.airportLayer),this.airportMarkers[a.name]=f})}setupEventHandlers(){this.map.on("moveend",()=>this.stateManager.saveMapState()),this.map.on("zoomend",()=>{this.stateManager.saveMapState(),this.airportManager.updateAirportMarkerSizes()}),this.map.on("click",e=>{this.replayManager.replayActive&&this.replayManager.replayAirplaneMarker&&this.replayManager.replayAirplaneMarker.isPopupOpen()&&this.replayManager.replayAirplaneMarker.closePopup(),!this.replayManager.replayActive&&this.selectedPathIds.size>0&&this.pathSelection.clearSelection()})}toggleHeatmap(){this.uiToggles.toggleHeatmap()}toggleStats(){this.statsManager.toggleStats()}toggleAltitude(){this.uiToggles.toggleAltitude()}toggleAirspeed(){this.uiToggles.toggleAirspeed()}toggleAirports(){this.uiToggles.toggleAirports()}toggleAviation(){this.uiToggles.toggleAviation()}toggleReplay(){this.replayManager.toggleReplay()}filterByYear(){this.filterManager.filterByYear()}filterByAircraft(){this.filterManager.filterByAircraft()}togglePathSelection(e){this.pathSelection.togglePathSelection(Number(e))}exportMap(){this.uiToggles.exportMap()}showWrapped(){this.wrappedManager.showWrapped()}closeWrapped(e){this.wrappedManager.closeWrapped(e)}toggleButtonsVisibility(){this.uiToggles.toggleButtonsVisibility()}playReplay(){this.replayManager.playReplay()}pauseReplay(){this.replayManager.pauseReplay()}stopReplay(){this.replayManager.stopReplay()}seekReplay(e){this.replayManager.seekReplay(e)}changeReplaySpeed(){this.replayManager.changeReplaySpeed()}toggleAutoZoom(){this.replayManager.toggleAutoZoom()}};typeof window<"u"&&(window.initMapApp=async c=>{let e=new Ge(c);window.mapApp=e,await e.initialize(),window.toggleHeatmap=()=>e.toggleHeatmap(),window.toggleStats=()=>e.toggleStats(),window.toggleAltitude=()=>e.toggleAltitude(),window.toggleAirspeed=()=>e.toggleAirspeed(),window.toggleAirports=()=>e.toggleAirports(),window.toggleAviation=()=>e.toggleAviation(),window.toggleReplay=()=>e.toggleReplay(),window.filterByYear=()=>e.filterByYear(),window.filterByAircraft=()=>e.filterByAircraft(),window.togglePathSelection=t=>e.togglePathSelection(t),window.exportMap=()=>e.exportMap(),window.showWrapped=()=>e.showWrapped(),window.closeWrapped=t=>e.closeWrapped(t),window.toggleButtonsVisibility=()=>e.toggleButtonsVisibility(),window.playReplay=()=>e.playReplay(),window.pauseReplay=()=>e.pauseReplay(),window.stopReplay=()=>e.stopReplay(),window.seekReplay=t=>e.seekReplay(String(t)),window.changeReplaySpeed=()=>e.changeReplaySpeed(),window.toggleAutoZoom=()=>e.toggleAutoZoom()});typeof window<"u"&&window.MAP_CONFIG&&window.initMapApp&&window.initMapApp(window.MAP_CONFIG);return La(Wa);})();
/*! Bundled license information:

dompurify/dist/purify.es.mjs:
  (*! @license DOMPurify 3.3.1 | (c) Cure53 and other contributors | Released under the Apache license 2.0 and Mozilla Public License 2.0 | github.com/cure53/DOMPurify/blob/3.3.1/LICENSE *)
*/
