"use strict";var MapAppModule=(()=>{var wa=Object.create;var ke=Object.defineProperty;var Ea=Object.getOwnPropertyDescriptor;var Pa=Object.getOwnPropertyNames;var Ca=Object.getPrototypeOf,Ra=Object.prototype.hasOwnProperty;var ka=(n,e)=>()=>(e||n((e={exports:{}}).exports,e),e.exports),Da=(n,e)=>{for(var a in e)ke(n,a,{get:e[a],enumerable:!0})},Wt=(n,e,a,t)=>{if(e&&typeof e=="object"||typeof e=="function")for(let r of Pa(e))!Ra.call(n,r)&&r!==a&&ke(n,r,{get:()=>e[r],enumerable:!(t=Ea(e,r))||t.enumerable});return n};var me=(n,e,a)=>(a=n!=null?wa(Ca(n)):{},Wt(e||!n||!n.__esModule?ke(a,"default",{value:n,enumerable:!0}):a,n)),Ia=n=>Wt(ke({},"__esModule",{value:!0}),n);var ae=ka((si,$t)=>{$t.exports=window.L});var ii={};Da(ii,{MapApp:()=>Ze});var z=me(ae(),1);var dt=class{constructor(){this.cache=new Map}get(e){if(this.cache.has(e)){let t=this.cache.get(e);if(document.contains(t))return t;this.cache.delete(e)}let a=document.getElementById(e);return a&&this.cache.set(e,a),a}cacheElements(e){e.forEach(a=>{let t=document.getElementById(a);t&&this.cache.set(a,t)})}clear(){this.cache.clear()}remove(e){this.cache.delete(e)}has(e){return this.cache.has(e)}get size(){return this.cache.size}},l=new dt;var De=class{constructor(e){this.app=e,l.cacheElements(["loading"]),this.dataLoader=new window.KMLHeatmap.DataLoader({dataDir:e.config.dataDir,showLoading:()=>this.showLoading(),hideLoading:()=>this.hideLoading()}),this.loadedData={},this.currentData=null}showLoading(){let e=l.get("loading");e&&(e.style.display="block")}hideLoading(){let e=l.get("loading");e&&(e.style.display="none")}async loadData(e,a){return await this.dataLoader.loadData(e,a)}async loadAirports(){return await this.dataLoader.loadAirports()}async loadMetadata(){return await this.dataLoader.loadMetadata()}async updateLayers(){if(!this.app.map)return;let e=await this.loadData("data",this.app.selectedYear);if(!e)return;this.currentData=e,this.app.currentData=e;let a=e.coordinates;if((this.app.selectedYear!=="all"||this.app.selectedAircraft!=="all")&&e.path_segments){let t=new Set;e.path_info&&e.path_info.forEach(s=>{let o=this.app.selectedYear==="all"||s.year&&s.year.toString()===this.app.selectedYear,p=this.app.selectedAircraft==="all"||s.aircraft_registration===this.app.selectedAircraft;o&&p&&t.add(s.id)});let r=new Set;e.path_segments.forEach(s=>{if(t.has(s.path_id)){let o=s.coords;o&&o.length===2&&(r.add(JSON.stringify(o[0])),r.add(JSON.stringify(o[1])))}}),a=Array.from(r).map(s=>JSON.parse(s))}if(this.app.heatmapLayer&&this.app.heatmapLayer.remove(),this.app.heatmapLayer=L.heatLayer(a,{radius:10,blur:15,minOpacity:.25,maxOpacity:.6,max:1,gradient:{0:"blue",.3:"cyan",.5:"lime",.7:"yellow",1:"red"}}),this.app.heatmapLayer.e&&(this.app.heatmapLayer.e.style.pointerEvents="none"),this.app.heatmapVisible&&!this.app.replayManager.replayActive&&this.app.heatmapLayer.addTo(this.app.map),this.app.pathToAirports={},this.app.airportToPaths={},e.path_info&&e.path_info.forEach(t=>{let r=t.id;this.app.pathToAirports[r]={start:t.start_airport,end:t.end_airport},t.start_airport&&(this.app.airportToPaths[t.start_airport]||(this.app.airportToPaths[t.start_airport]=new Set),this.app.airportToPaths[t.start_airport].add(r)),t.end_airport&&(this.app.airportToPaths[t.end_airport]||(this.app.airportToPaths[t.end_airport]=new Set),this.app.airportToPaths[t.end_airport].add(r))}),e.path_segments&&e.path_segments.length>0){let t=e.path_segments.map(o=>o.altitude_ft||0),r=t[0]??0,s=t[0]??0;for(let o=1;o<t.length;o++){let p=t[o]??0;p<r&&(r=p),p>s&&(s=p)}this.app.altitudeRange.min=r,this.app.altitudeRange.max=s}this.app.layerManager.redrawAltitudePaths(),this.app.airspeedVisible&&this.app.layerManager.redrawAirspeedPaths()}};var Ie=class{constructor(e){this.app=e,l.cacheElements(["stats-panel","wrapped-modal"])}saveMapState(){if(!this.app.map)return;let e=l.get("stats-panel"),a=l.get("wrapped-modal"),t={center:this.app.map.getCenter(),zoom:this.app.map.getZoom(),heatmapVisible:this.app.heatmapVisible,altitudeVisible:this.app.altitudeVisible,airspeedVisible:this.app.airspeedVisible,airportsVisible:this.app.airportsVisible,aviationVisible:this.app.aviationVisible,selectedYear:this.app.selectedYear,selectedAircraft:this.app.selectedAircraft,selectedPathIds:Array.from(this.app.selectedPathIds),statsPanelVisible:e?e.classList.contains("visible"):!1,wrappedVisible:a?a.style.display==="flex":!1,buttonsHidden:this.app.buttonsHidden};try{localStorage.setItem("kml-heatmap-state",JSON.stringify(t))}catch{}this.updateUrl(t)}loadMapState(){try{let e=localStorage.getItem("kml-heatmap-state");if(e)return JSON.parse(e)}catch{}return null}updateUrl(e){let a=window.KMLHeatmap.encodeStateToUrl(e),t=a?"?"+a:window.location.pathname;try{history.replaceState(null,"",t)}catch{}}loadState(){let e=window.KMLHeatmap.parseUrlParams(new URLSearchParams(window.location.search));return e&&Object.keys(e).length>0?e:this.loadMapState()}};var he=me(ae(),1);function Zt(...n){console.warn(...n)}function jt(...n){console.error(...n)}var Oe=class{constructor(e){this.app=e,l.cacheElements(["legend-min","legend-max","airspeed-legend-min","airspeed-legend-max"])}redrawAltitudePaths(){if(!this.app.currentData)return;this.app.altitudeLayer.clearLayers(),this.app.pathSegments={};let e,a;if(this.app.selectedPathIds.size>0){let t=this.app.currentData.path_segments.filter(r=>this.app.selectedPathIds.has(r.path_id));if(t.length>0){let r=t.map(p=>p.altitude_ft||0),s=r[0]??0,o=r[0]??0;for(let p=1;p<r.length;p++){let c=r[p]??0;c<s&&(s=c),c>o&&(o=c)}e=s,a=o}else e=this.app.altitudeRange.min,a=this.app.altitudeRange.max}else e=this.app.altitudeRange.min,a=this.app.altitudeRange.max;this.app.currentData.path_segments.forEach(t=>{let r=t.path_id,s=this.app.currentData.path_info.find(u=>u.id===r);if(this.app.selectedYear!=="all"&&s&&s.year&&s.year.toString()!==this.app.selectedYear||this.app.selectedAircraft!=="all"&&s&&s.aircraft_registration!==this.app.selectedAircraft)return;let o=this.app.selectedPathIds.has(r);if(this.app.selectedPathIds.size>0&&!o&&this.app.buttonsHidden)return;let p=window.KMLHeatmap.getColorForAltitude(t.altitude_ft??0,e,a);he.polyline(t.coords||[],{color:p,weight:o?6:4,opacity:o?1:this.app.selectedPathIds.size>0?.1:.85,renderer:this.app.altitudeRenderer,interactive:!0}).bindPopup("Altitude: "+t.altitude_ft+" ft ("+t.altitude_m+" m)").addTo(this.app.altitudeLayer).on("click",u=>{he.DomEvent.stopPropagation(u),this.app.pathSelection.togglePathSelection(r)}),this.app.pathSegments[r]||(this.app.pathSegments[r]=[]),this.app.pathSegments[r].push(t)}),this.updateAltitudeLegend(e,a),this.app.airportManager.updateAirportOpacity(),this.app.statsManager.updateStatsForSelection()}redrawAirspeedPaths(){if(!this.app.currentData){Zt("redrawAirspeedPaths: No current data available");return}this.app.airspeedLayer.clearLayers();let e,a;if(this.app.selectedPathIds.size>0){let t=this.app.currentData.path_segments.filter(r=>this.app.selectedPathIds.has(r.path_id)&&(r.groundspeed_knots||0)>0);if(t.length>0){let r=t.map(p=>p.groundspeed_knots||0),s=r[0]??0,o=r[0]??0;for(let p=1;p<r.length;p++){let c=r[p]??0;c<s&&(s=c),c>o&&(o=c)}e=s,a=o}else e=this.app.airspeedRange.min,a=this.app.airspeedRange.max}else e=this.app.airspeedRange.min,a=this.app.airspeedRange.max;this.app.currentData.path_segments.forEach(t=>{let r=t.path_id,s=this.app.currentData.path_info.find(o=>o.id===r);if(!(this.app.selectedYear!=="all"&&s&&s.year&&s.year.toString()!==this.app.selectedYear)&&!(this.app.selectedAircraft!=="all"&&s&&s.aircraft_registration!==this.app.selectedAircraft)&&(t.groundspeed_knots||0)>0){let o=this.app.selectedPathIds.has(r);if(this.app.selectedPathIds.size>0&&!o&&this.app.buttonsHidden)return;let p=window.KMLHeatmap.getColorForAirspeed(t.groundspeed_knots??0,e,a),c=Math.round((t.groundspeed_knots||0)*1.852);he.polyline(t.coords||[],{color:p,weight:o?6:4,opacity:o?1:this.app.selectedPathIds.size>0?.1:.85,renderer:this.app.airspeedRenderer,interactive:!0}).bindPopup("Groundspeed: "+t.groundspeed_knots+" kt ("+c+" km/h)").addTo(this.app.airspeedLayer).on("click",f=>{he.DomEvent.stopPropagation(f),this.app.pathSelection.togglePathSelection(r)})}}),this.updateAirspeedLegend(e,a),this.app.airportManager.updateAirportOpacity(),this.app.statsManager.updateStatsForSelection()}updateAltitudeLegend(e,a){let t=Math.round(e),r=Math.round(a),s=Math.round(e*.3048),o=Math.round(a*.3048),p=l.get("legend-min"),c=l.get("legend-max");p&&(p.textContent=t+" ft ("+s+" m)"),c&&(c.textContent=r+" ft ("+o+" m)")}updateAirspeedLegend(e,a){let t=Math.round(e),r=Math.round(a),s=Math.round(e*1.852),o=Math.round(a*1.852),p=l.get("airspeed-legend-min"),c=l.get("airspeed-legend-max");p&&(p.textContent=t+" kt ("+s+" km/h)"),c&&(c.textContent=r+" kt ("+o+" km/h)")}};var He=class{constructor(e){this.app=e,l.cacheElements(["aircraft-select","year-select"])}updateAircraftDropdown(){if(!this.app.fullPathInfo)return;let e=l.get("aircraft-select");if(!e)return;let a=this.app.selectedAircraft;for(;e.options.length>1;)e.remove(1);let t;this.app.selectedYear==="all"?t=this.app.fullPathInfo:t=this.app.fullPathInfo.filter(p=>p.year&&p.year.toString()===this.app.selectedYear);let r={};t.forEach(p=>{if(p.aircraft_registration){let c=p.aircraft_registration;r[c]||(r[c]={registration:c,type:p.aircraft_type,flights:0}),r[c].flights+=1}});let s=Object.values(r).sort((p,c)=>c.flights-p.flights),o=!1;s.forEach(p=>{let c=document.createElement("option");c.value=p.registration;let u=p.type?" ("+p.type+")":"";c.textContent="\u2708\uFE0F "+p.registration+u,e.appendChild(c),p.registration===a&&(o=!0)}),!o&&a!=="all"?(this.app.selectedAircraft="all",e.value="all"):e.value=a}async filterByYear(){let e=l.get("year-select");if(!e)return;this.app.selectedYear=e.value,this.app.dataManager.loadedData={},this.app.altitudeLayer.clearLayers(),this.app.pathSegments={},this.app.isInitializing||this.app.selectedPathIds.clear(),await this.app.dataManager.updateLayers();let a=await this.app.dataManager.loadData("data",this.app.selectedYear);a&&(this.app.fullPathInfo=a.path_info||[],this.app.fullPathSegments=a.path_segments||[]),this.updateAircraftDropdown();let t=window.KMLHeatmap.calculateFilteredStatistics({pathInfo:this.app.fullPathInfo??[],segments:this.app.fullPathSegments??[],year:this.app.selectedYear,aircraft:this.app.selectedAircraft,coordinateCount:this.app.currentData?.original_points});this.app.statsManager.updateStatsPanel(t,!1),this.app.airportManager.updateAirportOpacity(),this.app.airportManager.updateAirportPopups(),this.app.isInitializing||this.app.stateManager.saveMapState()}async filterByAircraft(){let e=l.get("aircraft-select");if(!e)return;this.app.selectedAircraft=e.value,this.app.altitudeLayer.clearLayers(),this.app.pathSegments={},this.app.isInitializing||this.app.selectedPathIds.clear(),await this.app.dataManager.updateLayers();let a=window.KMLHeatmap.calculateFilteredStatistics({pathInfo:this.app.fullPathInfo??[],segments:this.app.fullPathSegments??[],year:this.app.selectedYear,aircraft:this.app.selectedAircraft,coordinateCount:this.app.currentData?.original_points});this.app.statsManager.updateStatsPanel(a,!1),this.app.airportManager.updateAirportOpacity(),this.app.airportManager.updateAirportPopups(),this.app.isInitializing||this.app.stateManager.saveMapState()}};var{entries:ra,setPrototypeOf:qt,isFrozen:Oa,getPrototypeOf:Ha,getOwnPropertyDescriptor:Fa}=Object,{freeze:H,seal:B,create:yt}=Object,{apply:bt,construct:At}=typeof Reflect<"u"&&Reflect;H||(H=function(e){return e});B||(B=function(e){return e});bt||(bt=function(e,a){for(var t=arguments.length,r=new Array(t>2?t-2:0),s=2;s<t;s++)r[s-2]=arguments[s];return e.apply(a,r)});At||(At=function(e){for(var a=arguments.length,t=new Array(a>1?a-1:0),r=1;r<a;r++)t[r-1]=arguments[r];return new e(...t)});var Fe=F(Array.prototype.forEach),Na=F(Array.prototype.lastIndexOf),Xt=F(Array.prototype.pop),ye=F(Array.prototype.push),za=F(Array.prototype.splice),ze=F(String.prototype.toLowerCase),ct=F(String.prototype.toString),mt=F(String.prototype.match),be=F(String.prototype.replace),Ba=F(String.prototype.indexOf),Va=F(String.prototype.trim),V=F(Object.prototype.hasOwnProperty),O=F(RegExp.prototype.test),Ae=Ua(TypeError);function F(n){return function(e){e instanceof RegExp&&(e.lastIndex=0);for(var a=arguments.length,t=new Array(a>1?a-1:0),r=1;r<a;r++)t[r-1]=arguments[r];return bt(n,e,t)}}function Ua(n){return function(){for(var e=arguments.length,a=new Array(e),t=0;t<e;t++)a[t]=arguments[t];return At(n,a)}}function y(n,e){let a=arguments.length>2&&arguments[2]!==void 0?arguments[2]:ze;qt&&qt(n,null);let t=e.length;for(;t--;){let r=e[t];if(typeof r=="string"){let s=a(r);s!==r&&(Oa(e)||(e[t]=s),r=s)}n[r]=!0}return n}function Ya(n){for(let e=0;e<n.length;e++)V(n,e)||(n[e]=null);return n}function W(n){let e=yt(null);for(let[a,t]of ra(n))V(n,a)&&(Array.isArray(t)?e[a]=Ya(t):t&&typeof t=="object"&&t.constructor===Object?e[a]=W(t):e[a]=t);return e}function Me(n,e){for(;n!==null;){let t=Fa(n,e);if(t){if(t.get)return F(t.get);if(typeof t.value=="function")return F(t.value)}n=Ha(n)}function a(){return null}return a}var Jt=H(["a","abbr","acronym","address","area","article","aside","audio","b","bdi","bdo","big","blink","blockquote","body","br","button","canvas","caption","center","cite","code","col","colgroup","content","data","datalist","dd","decorator","del","details","dfn","dialog","dir","div","dl","dt","element","em","fieldset","figcaption","figure","font","footer","form","h1","h2","h3","h4","h5","h6","head","header","hgroup","hr","html","i","img","input","ins","kbd","label","legend","li","main","map","mark","marquee","menu","menuitem","meter","nav","nobr","ol","optgroup","option","output","p","picture","pre","progress","q","rp","rt","ruby","s","samp","search","section","select","shadow","slot","small","source","spacer","span","strike","strong","style","sub","summary","sup","table","tbody","td","template","textarea","tfoot","th","thead","time","tr","track","tt","u","ul","var","video","wbr"]),ht=H(["svg","a","altglyph","altglyphdef","altglyphitem","animatecolor","animatemotion","animatetransform","circle","clippath","defs","desc","ellipse","enterkeyhint","exportparts","filter","font","g","glyph","glyphref","hkern","image","inputmode","line","lineargradient","marker","mask","metadata","mpath","part","path","pattern","polygon","polyline","radialgradient","rect","stop","style","switch","symbol","text","textpath","title","tref","tspan","view","vkern"]),ut=H(["feBlend","feColorMatrix","feComponentTransfer","feComposite","feConvolveMatrix","feDiffuseLighting","feDisplacementMap","feDistantLight","feDropShadow","feFlood","feFuncA","feFuncB","feFuncG","feFuncR","feGaussianBlur","feImage","feMerge","feMergeNode","feMorphology","feOffset","fePointLight","feSpecularLighting","feSpotLight","feTile","feTurbulence"]),Ga=H(["animate","color-profile","cursor","discard","font-face","font-face-format","font-face-name","font-face-src","font-face-uri","foreignobject","hatch","hatchpath","mesh","meshgradient","meshpatch","meshrow","missing-glyph","script","set","solidcolor","unknown","use"]),ft=H(["math","menclose","merror","mfenced","mfrac","mglyph","mi","mlabeledtr","mmultiscripts","mn","mo","mover","mpadded","mphantom","mroot","mrow","ms","mspace","msqrt","mstyle","msub","msup","msubsup","mtable","mtd","mtext","mtr","munder","munderover","mprescripts"]),Ka=H(["maction","maligngroup","malignmark","mlongdiv","mscarries","mscarry","msgroup","mstack","msline","msrow","semantics","annotation","annotation-xml","mprescripts","none"]),Qt=H(["#text"]),ea=H(["accept","action","align","alt","autocapitalize","autocomplete","autopictureinpicture","autoplay","background","bgcolor","border","capture","cellpadding","cellspacing","checked","cite","class","clear","color","cols","colspan","controls","controlslist","coords","crossorigin","datetime","decoding","default","dir","disabled","disablepictureinpicture","disableremoteplayback","download","draggable","enctype","enterkeyhint","exportparts","face","for","headers","height","hidden","high","href","hreflang","id","inert","inputmode","integrity","ismap","kind","label","lang","list","loading","loop","low","max","maxlength","media","method","min","minlength","multiple","muted","name","nonce","noshade","novalidate","nowrap","open","optimum","part","pattern","placeholder","playsinline","popover","popovertarget","popovertargetaction","poster","preload","pubdate","radiogroup","readonly","rel","required","rev","reversed","role","rows","rowspan","spellcheck","scope","selected","shape","size","sizes","slot","span","srclang","start","src","srcset","step","style","summary","tabindex","title","translate","type","usemap","valign","value","width","wrap","xmlns","slot"]),gt=H(["accent-height","accumulate","additive","alignment-baseline","amplitude","ascent","attributename","attributetype","azimuth","basefrequency","baseline-shift","begin","bias","by","class","clip","clippathunits","clip-path","clip-rule","color","color-interpolation","color-interpolation-filters","color-profile","color-rendering","cx","cy","d","dx","dy","diffuseconstant","direction","display","divisor","dur","edgemode","elevation","end","exponent","fill","fill-opacity","fill-rule","filter","filterunits","flood-color","flood-opacity","font-family","font-size","font-size-adjust","font-stretch","font-style","font-variant","font-weight","fx","fy","g1","g2","glyph-name","glyphref","gradientunits","gradienttransform","height","href","id","image-rendering","in","in2","intercept","k","k1","k2","k3","k4","kerning","keypoints","keysplines","keytimes","lang","lengthadjust","letter-spacing","kernelmatrix","kernelunitlength","lighting-color","local","marker-end","marker-mid","marker-start","markerheight","markerunits","markerwidth","maskcontentunits","maskunits","max","mask","mask-type","media","method","mode","min","name","numoctaves","offset","operator","opacity","order","orient","orientation","origin","overflow","paint-order","path","pathlength","patterncontentunits","patterntransform","patternunits","points","preservealpha","preserveaspectratio","primitiveunits","r","rx","ry","radius","refx","refy","repeatcount","repeatdur","restart","result","rotate","scale","seed","shape-rendering","slope","specularconstant","specularexponent","spreadmethod","startoffset","stddeviation","stitchtiles","stop-color","stop-opacity","stroke-dasharray","stroke-dashoffset","stroke-linecap","stroke-linejoin","stroke-miterlimit","stroke-opacity","stroke","stroke-width","style","surfacescale","systemlanguage","tabindex","tablevalues","targetx","targety","transform","transform-origin","text-anchor","text-decoration","text-rendering","textlength","type","u1","u2","unicode","values","viewbox","visibility","version","vert-adv-y","vert-origin-x","vert-origin-y","width","word-spacing","wrap","writing-mode","xchannelselector","ychannelselector","x","x1","x2","xmlns","y","y1","y2","z","zoomandpan"]),ta=H(["accent","accentunder","align","bevelled","close","columnsalign","columnlines","columnspan","denomalign","depth","dir","display","displaystyle","encoding","fence","frame","height","href","id","largeop","length","linethickness","lspace","lquote","mathbackground","mathcolor","mathsize","mathvariant","maxsize","minsize","movablelimits","notation","numalign","open","rowalign","rowlines","rowspacing","rowspan","rspace","rquote","scriptlevel","scriptminsize","scriptsizemultiplier","selection","separator","separators","stretchy","subscriptshift","supscriptshift","symmetric","voffset","width","xmlns"]),Ne=H(["xlink:href","xml:id","xlink:title","xml:space","xmlns:xlink"]),Wa=B(/\{\{[\w\W]*|[\w\W]*\}\}/gm),$a=B(/<%[\w\W]*|[\w\W]*%>/gm),Za=B(/\$\{[\w\W]*/gm),ja=B(/^data-[\-\w.\u00B7-\uFFFF]+$/),qa=B(/^aria-[\-\w]+$/),sa=B(/^(?:(?:(?:f|ht)tps?|mailto|tel|callto|sms|cid|xmpp|matrix):|[^a-z]|[a-z+.\-]+(?:[^a-z+.\-:]|$))/i),Xa=B(/^(?:\w+script|data):/i),Ja=B(/[\u0000-\u0020\u00A0\u1680\u180E\u2000-\u2029\u205F\u3000]/g),na=B(/^html$/i),Qa=B(/^[a-z][.\w]*(-[.\w]+)+$/i),aa=Object.freeze({__proto__:null,ARIA_ATTR:qa,ATTR_WHITESPACE:Ja,CUSTOM_ELEMENT:Qa,DATA_ATTR:ja,DOCTYPE_NAME:na,ERB_EXPR:$a,IS_ALLOWED_URI:sa,IS_SCRIPT_OR_DATA:Xa,MUSTACHE_EXPR:Wa,TMPLIT_EXPR:Za}),ve={element:1,attribute:2,text:3,cdataSection:4,entityReference:5,entityNode:6,progressingInstruction:7,comment:8,document:9,documentType:10,documentFragment:11,notation:12},ei=function(){return typeof window>"u"?null:window},ti=function(e,a){if(typeof e!="object"||typeof e.createPolicy!="function")return null;let t=null,r="data-tt-policy-suffix";a&&a.hasAttribute(r)&&(t=a.getAttribute(r));let s="dompurify"+(t?"#"+t:"");try{return e.createPolicy(s,{createHTML(o){return o},createScriptURL(o){return o}})}catch{return console.warn("TrustedTypes policy "+s+" could not be created."),null}},ia=function(){return{afterSanitizeAttributes:[],afterSanitizeElements:[],afterSanitizeShadowDOM:[],beforeSanitizeAttributes:[],beforeSanitizeElements:[],beforeSanitizeShadowDOM:[],uponSanitizeAttribute:[],uponSanitizeElement:[],uponSanitizeShadowNode:[]}};function oa(){let n=arguments.length>0&&arguments[0]!==void 0?arguments[0]:ei(),e=h=>oa(h);if(e.version="3.3.1",e.removed=[],!n||!n.document||n.document.nodeType!==ve.document||!n.Element)return e.isSupported=!1,e;let{document:a}=n,t=a,r=t.currentScript,{DocumentFragment:s,HTMLTemplateElement:o,Node:p,Element:c,NodeFilter:u,NamedNodeMap:f=n.NamedNodeMap||n.MozNamedAttrMap,HTMLFormElement:b,DOMParser:T,trustedTypes:g}=n,A=c.prototype,v=Me(A,"cloneNode"),x=Me(A,"remove"),U=Me(A,"nextSibling"),$=Me(A,"childNodes"),S=Me(A,"parentNode");if(typeof o=="function"){let h=a.createElement("template");h.content&&h.content.ownerDocument&&(a=h.content.ownerDocument)}let M,Y="",{implementation:X,createNodeIterator:re,createDocumentFragment:Se,getElementsByTagName:Le}=a,{importNode:_e}=t,I=ia();e.isSupported=typeof ra=="function"&&typeof S=="function"&&X&&X.createHTMLDocument!==void 0;let{MUSTACHE_EXPR:je,ERB_EXPR:qe,TMPLIT_EXPR:Xe,DATA_ATTR:fa,ARIA_ATTR:ga,IS_SCRIPT_OR_DATA:ya,ATTR_WHITESPACE:St,CUSTOM_ELEMENT:ba}=aa,{IS_ALLOWED_URI:Lt}=aa,C=null,_t=y({},[...Jt,...ht,...ut,...ft,...Qt]),R=null,Tt=y({},[...ea,...gt,...ta,...Ne]),w=Object.seal(yt(null,{tagNameCheck:{writable:!0,configurable:!1,enumerable:!0,value:null},attributeNameCheck:{writable:!0,configurable:!1,enumerable:!0,value:null},allowCustomizedBuiltInElements:{writable:!0,configurable:!1,enumerable:!0,value:!1}})),ue=null,Je=null,se=Object.seal(yt(null,{tagCheck:{writable:!0,configurable:!1,enumerable:!0,value:null},attributeCheck:{writable:!0,configurable:!1,enumerable:!0,value:null}})),xt=!0,Qe=!0,wt=!1,Et=!0,ne=!1,Te=!0,ee=!1,et=!1,tt=!1,oe=!1,xe=!1,we=!1,Pt=!0,Ct=!1,Aa="user-content-",at=!0,fe=!1,le={},G=null,it=y({},["annotation-xml","audio","colgroup","desc","foreignobject","head","iframe","math","mi","mn","mo","ms","mtext","noembed","noframes","noscript","plaintext","script","style","svg","template","thead","title","video","xmp"]),Rt=null,kt=y({},["audio","video","img","source","image","track"]),rt=null,Dt=y({},["alt","class","for","id","label","name","pattern","placeholder","role","summary","title","value","style","xmlns"]),Ee="http://www.w3.org/1998/Math/MathML",Pe="http://www.w3.org/2000/svg",Z="http://www.w3.org/1999/xhtml",pe=Z,st=!1,nt=null,Ma=y({},[Ee,Pe,Z],ct),Ce=y({},["mi","mo","mn","ms","mtext"]),Re=y({},["annotation-xml"]),va=y({},["title","style","font","a","script"]),ge=null,Sa=["application/xhtml+xml","text/html"],La="text/html",P=null,de=null,_a=a.createElement("form"),It=function(i){return i instanceof RegExp||i instanceof Function},ot=function(){let i=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};if(!(de&&de===i)){if((!i||typeof i!="object")&&(i={}),i=W(i),ge=Sa.indexOf(i.PARSER_MEDIA_TYPE)===-1?La:i.PARSER_MEDIA_TYPE,P=ge==="application/xhtml+xml"?ct:ze,C=V(i,"ALLOWED_TAGS")?y({},i.ALLOWED_TAGS,P):_t,R=V(i,"ALLOWED_ATTR")?y({},i.ALLOWED_ATTR,P):Tt,nt=V(i,"ALLOWED_NAMESPACES")?y({},i.ALLOWED_NAMESPACES,ct):Ma,rt=V(i,"ADD_URI_SAFE_ATTR")?y(W(Dt),i.ADD_URI_SAFE_ATTR,P):Dt,Rt=V(i,"ADD_DATA_URI_TAGS")?y(W(kt),i.ADD_DATA_URI_TAGS,P):kt,G=V(i,"FORBID_CONTENTS")?y({},i.FORBID_CONTENTS,P):it,ue=V(i,"FORBID_TAGS")?y({},i.FORBID_TAGS,P):W({}),Je=V(i,"FORBID_ATTR")?y({},i.FORBID_ATTR,P):W({}),le=V(i,"USE_PROFILES")?i.USE_PROFILES:!1,xt=i.ALLOW_ARIA_ATTR!==!1,Qe=i.ALLOW_DATA_ATTR!==!1,wt=i.ALLOW_UNKNOWN_PROTOCOLS||!1,Et=i.ALLOW_SELF_CLOSE_IN_ATTR!==!1,ne=i.SAFE_FOR_TEMPLATES||!1,Te=i.SAFE_FOR_XML!==!1,ee=i.WHOLE_DOCUMENT||!1,oe=i.RETURN_DOM||!1,xe=i.RETURN_DOM_FRAGMENT||!1,we=i.RETURN_TRUSTED_TYPE||!1,tt=i.FORCE_BODY||!1,Pt=i.SANITIZE_DOM!==!1,Ct=i.SANITIZE_NAMED_PROPS||!1,at=i.KEEP_CONTENT!==!1,fe=i.IN_PLACE||!1,Lt=i.ALLOWED_URI_REGEXP||sa,pe=i.NAMESPACE||Z,Ce=i.MATHML_TEXT_INTEGRATION_POINTS||Ce,Re=i.HTML_INTEGRATION_POINTS||Re,w=i.CUSTOM_ELEMENT_HANDLING||{},i.CUSTOM_ELEMENT_HANDLING&&It(i.CUSTOM_ELEMENT_HANDLING.tagNameCheck)&&(w.tagNameCheck=i.CUSTOM_ELEMENT_HANDLING.tagNameCheck),i.CUSTOM_ELEMENT_HANDLING&&It(i.CUSTOM_ELEMENT_HANDLING.attributeNameCheck)&&(w.attributeNameCheck=i.CUSTOM_ELEMENT_HANDLING.attributeNameCheck),i.CUSTOM_ELEMENT_HANDLING&&typeof i.CUSTOM_ELEMENT_HANDLING.allowCustomizedBuiltInElements=="boolean"&&(w.allowCustomizedBuiltInElements=i.CUSTOM_ELEMENT_HANDLING.allowCustomizedBuiltInElements),ne&&(Qe=!1),xe&&(oe=!0),le&&(C=y({},Qt),R=[],le.html===!0&&(y(C,Jt),y(R,ea)),le.svg===!0&&(y(C,ht),y(R,gt),y(R,Ne)),le.svgFilters===!0&&(y(C,ut),y(R,gt),y(R,Ne)),le.mathMl===!0&&(y(C,ft),y(R,ta),y(R,Ne))),i.ADD_TAGS&&(typeof i.ADD_TAGS=="function"?se.tagCheck=i.ADD_TAGS:(C===_t&&(C=W(C)),y(C,i.ADD_TAGS,P))),i.ADD_ATTR&&(typeof i.ADD_ATTR=="function"?se.attributeCheck=i.ADD_ATTR:(R===Tt&&(R=W(R)),y(R,i.ADD_ATTR,P))),i.ADD_URI_SAFE_ATTR&&y(rt,i.ADD_URI_SAFE_ATTR,P),i.FORBID_CONTENTS&&(G===it&&(G=W(G)),y(G,i.FORBID_CONTENTS,P)),i.ADD_FORBID_CONTENTS&&(G===it&&(G=W(G)),y(G,i.ADD_FORBID_CONTENTS,P)),at&&(C["#text"]=!0),ee&&y(C,["html","head","body"]),C.table&&(y(C,["tbody"]),delete ue.tbody),i.TRUSTED_TYPES_POLICY){if(typeof i.TRUSTED_TYPES_POLICY.createHTML!="function")throw Ae('TRUSTED_TYPES_POLICY configuration option must provide a "createHTML" hook.');if(typeof i.TRUSTED_TYPES_POLICY.createScriptURL!="function")throw Ae('TRUSTED_TYPES_POLICY configuration option must provide a "createScriptURL" hook.');M=i.TRUSTED_TYPES_POLICY,Y=M.createHTML("")}else M===void 0&&(M=ti(g,r)),M!==null&&typeof Y=="string"&&(Y=M.createHTML(""));H&&H(i),de=i}},Ot=y({},[...ht,...ut,...Ga]),Ht=y({},[...ft,...Ka]),Ta=function(i){let d=S(i);(!d||!d.tagName)&&(d={namespaceURI:pe,tagName:"template"});let m=ze(i.tagName),_=ze(d.tagName);return nt[i.namespaceURI]?i.namespaceURI===Pe?d.namespaceURI===Z?m==="svg":d.namespaceURI===Ee?m==="svg"&&(_==="annotation-xml"||Ce[_]):!!Ot[m]:i.namespaceURI===Ee?d.namespaceURI===Z?m==="math":d.namespaceURI===Pe?m==="math"&&Re[_]:!!Ht[m]:i.namespaceURI===Z?d.namespaceURI===Pe&&!Re[_]||d.namespaceURI===Ee&&!Ce[_]?!1:!Ht[m]&&(va[m]||!Ot[m]):!!(ge==="application/xhtml+xml"&&nt[i.namespaceURI]):!1},K=function(i){ye(e.removed,{element:i});try{S(i).removeChild(i)}catch{x(i)}},te=function(i,d){try{ye(e.removed,{attribute:d.getAttributeNode(i),from:d})}catch{ye(e.removed,{attribute:null,from:d})}if(d.removeAttribute(i),i==="is")if(oe||xe)try{K(d)}catch{}else try{d.setAttribute(i,"")}catch{}},Ft=function(i){let d=null,m=null;if(tt)i="<remove></remove>"+i;else{let E=mt(i,/^[\r\n\t ]+/);m=E&&E[0]}ge==="application/xhtml+xml"&&pe===Z&&(i='<html xmlns="http://www.w3.org/1999/xhtml"><head></head><body>'+i+"</body></html>");let _=M?M.createHTML(i):i;if(pe===Z)try{d=new T().parseFromString(_,ge)}catch{}if(!d||!d.documentElement){d=X.createDocument(pe,"template",null);try{d.documentElement.innerHTML=st?Y:_}catch{}}let D=d.body||d.documentElement;return i&&m&&D.insertBefore(a.createTextNode(m),D.childNodes[0]||null),pe===Z?Le.call(d,ee?"html":"body")[0]:ee?d.documentElement:D},Nt=function(i){return re.call(i.ownerDocument||i,i,u.SHOW_ELEMENT|u.SHOW_COMMENT|u.SHOW_TEXT|u.SHOW_PROCESSING_INSTRUCTION|u.SHOW_CDATA_SECTION,null)},lt=function(i){return i instanceof b&&(typeof i.nodeName!="string"||typeof i.textContent!="string"||typeof i.removeChild!="function"||!(i.attributes instanceof f)||typeof i.removeAttribute!="function"||typeof i.setAttribute!="function"||typeof i.namespaceURI!="string"||typeof i.insertBefore!="function"||typeof i.hasChildNodes!="function")},zt=function(i){return typeof p=="function"&&i instanceof p};function j(h,i,d){Fe(h,m=>{m.call(e,i,d,de)})}let Bt=function(i){let d=null;if(j(I.beforeSanitizeElements,i,null),lt(i))return K(i),!0;let m=P(i.nodeName);if(j(I.uponSanitizeElement,i,{tagName:m,allowedTags:C}),Te&&i.hasChildNodes()&&!zt(i.firstElementChild)&&O(/<[/\w!]/g,i.innerHTML)&&O(/<[/\w!]/g,i.textContent)||i.nodeType===ve.progressingInstruction||Te&&i.nodeType===ve.comment&&O(/<[/\w]/g,i.data))return K(i),!0;if(!(se.tagCheck instanceof Function&&se.tagCheck(m))&&(!C[m]||ue[m])){if(!ue[m]&&Ut(m)&&(w.tagNameCheck instanceof RegExp&&O(w.tagNameCheck,m)||w.tagNameCheck instanceof Function&&w.tagNameCheck(m)))return!1;if(at&&!G[m]){let _=S(i)||i.parentNode,D=$(i)||i.childNodes;if(D&&_){let E=D.length;for(let N=E-1;N>=0;--N){let q=v(D[N],!0);q.t=(i.t||0)+1,_.insertBefore(q,U(i))}}}return K(i),!0}return i instanceof c&&!Ta(i)||(m==="noscript"||m==="noembed"||m==="noframes")&&O(/<\/no(script|embed|frames)/i,i.innerHTML)?(K(i),!0):(ne&&i.nodeType===ve.text&&(d=i.textContent,Fe([je,qe,Xe],_=>{d=be(d,_," ")}),i.textContent!==d&&(ye(e.removed,{element:i.cloneNode()}),i.textContent=d)),j(I.afterSanitizeElements,i,null),!1)},Vt=function(i,d,m){if(Pt&&(d==="id"||d==="name")&&(m in a||m in _a))return!1;if(!(Qe&&!Je[d]&&O(fa,d))){if(!(xt&&O(ga,d))){if(!(se.attributeCheck instanceof Function&&se.attributeCheck(d,i))){if(!R[d]||Je[d]){if(!(Ut(i)&&(w.tagNameCheck instanceof RegExp&&O(w.tagNameCheck,i)||w.tagNameCheck instanceof Function&&w.tagNameCheck(i))&&(w.attributeNameCheck instanceof RegExp&&O(w.attributeNameCheck,d)||w.attributeNameCheck instanceof Function&&w.attributeNameCheck(d,i))||d==="is"&&w.allowCustomizedBuiltInElements&&(w.tagNameCheck instanceof RegExp&&O(w.tagNameCheck,m)||w.tagNameCheck instanceof Function&&w.tagNameCheck(m))))return!1}else if(!rt[d]){if(!O(Lt,be(m,St,""))){if(!((d==="src"||d==="xlink:href"||d==="href")&&i!=="script"&&Ba(m,"data:")===0&&Rt[i])){if(!(wt&&!O(ya,be(m,St,"")))){if(m)return!1}}}}}}}return!0},Ut=function(i){return i!=="annotation-xml"&&mt(i,ba)},Yt=function(i){j(I.beforeSanitizeAttributes,i,null);let{attributes:d}=i;if(!d||lt(i))return;let m={attrName:"",attrValue:"",keepAttr:!0,allowedAttributes:R,forceKeepAttr:void 0},_=d.length;for(;_--;){let D=d[_],{name:E,namespaceURI:N,value:q}=D,ce=P(E),pt=q,k=E==="value"?pt:Va(pt);if(m.attrName=ce,m.attrValue=k,m.keepAttr=!0,m.forceKeepAttr=void 0,j(I.uponSanitizeAttribute,i,m),k=m.attrValue,Ct&&(ce==="id"||ce==="name")&&(te(E,i),k=Aa+k),Te&&O(/((--!?|])>)|<\/(style|title|textarea)/i,k)){te(E,i);continue}if(ce==="attributename"&&mt(k,"href")){te(E,i);continue}if(m.forceKeepAttr)continue;if(!m.keepAttr){te(E,i);continue}if(!Et&&O(/\/>/i,k)){te(E,i);continue}ne&&Fe([je,qe,Xe],Kt=>{k=be(k,Kt," ")});let Gt=P(i.nodeName);if(!Vt(Gt,ce,k)){te(E,i);continue}if(M&&typeof g=="object"&&typeof g.getAttributeType=="function"&&!N)switch(g.getAttributeType(Gt,ce)){case"TrustedHTML":{k=M.createHTML(k);break}case"TrustedScriptURL":{k=M.createScriptURL(k);break}}if(k!==pt)try{N?i.setAttributeNS(N,E,k):i.setAttribute(E,k),lt(i)?K(i):Xt(e.removed)}catch{te(E,i)}}j(I.afterSanitizeAttributes,i,null)},xa=function h(i){let d=null,m=Nt(i);for(j(I.beforeSanitizeShadowDOM,i,null);d=m.nextNode();)j(I.uponSanitizeShadowNode,d,null),Bt(d),Yt(d),d.content instanceof s&&h(d.content);j(I.afterSanitizeShadowDOM,i,null)};return e.sanitize=function(h){let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},d=null,m=null,_=null,D=null;if(st=!h,st&&(h="<!-->"),typeof h!="string"&&!zt(h))if(typeof h.toString=="function"){if(h=h.toString(),typeof h!="string")throw Ae("dirty is not a string, aborting")}else throw Ae("toString is not a function");if(!e.isSupported)return h;if(et||ot(i),e.removed=[],typeof h=="string"&&(fe=!1),fe){if(h.nodeName){let q=P(h.nodeName);if(!C[q]||ue[q])throw Ae("root node is forbidden and cannot be sanitized in-place")}}else if(h instanceof p)d=Ft("<!---->"),m=d.ownerDocument.importNode(h,!0),m.nodeType===ve.element&&m.nodeName==="BODY"||m.nodeName==="HTML"?d=m:d.appendChild(m);else{if(!oe&&!ne&&!ee&&h.indexOf("<")===-1)return M&&we?M.createHTML(h):h;if(d=Ft(h),!d)return oe?null:we?Y:""}d&&tt&&K(d.firstChild);let E=Nt(fe?h:d);for(;_=E.nextNode();)Bt(_),Yt(_),_.content instanceof s&&xa(_.content);if(fe)return h;if(oe){if(xe)for(D=Se.call(d.ownerDocument);d.firstChild;)D.appendChild(d.firstChild);else D=d;return(R.shadowroot||R.shadowrootmode)&&(D=_e.call(t,D,!0)),D}let N=ee?d.outerHTML:d.innerHTML;return ee&&C["!doctype"]&&d.ownerDocument&&d.ownerDocument.doctype&&d.ownerDocument.doctype.name&&O(na,d.ownerDocument.doctype.name)&&(N="<!DOCTYPE "+d.ownerDocument.doctype.name+`>
`+N),ne&&Fe([je,qe,Xe],q=>{N=be(N,q," ")}),M&&we?M.createHTML(N):N},e.setConfig=function(){let h=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};ot(h),et=!0},e.clearConfig=function(){de=null,et=!1},e.isValidAttribute=function(h,i,d){de||ot({});let m=P(h),_=P(i);return Vt(m,_,d)},e.addHook=function(h,i){typeof i=="function"&&ye(I[h],i)},e.removeHook=function(h,i){if(i!==void 0){let d=Na(I[h],i);return d===-1?void 0:za(I[h],d,1)[0]}return Xt(I[h])},e.removeHooks=function(h){I[h]=[]},e.removeAllHooks=function(){I=ia()},e}var J=oa();var Be=class{constructor(e){this.app=e,l.cacheElements(["stats-panel"])}updateStatsForSelection(){if(this.app.selectedPathIds.size===0){let o=window.KMLHeatmap.calculateFilteredStatistics({pathInfo:this.app.fullPathInfo||[],segments:this.app.fullPathSegments||[],year:this.app.selectedYear,aircraft:this.app.selectedAircraft,coordinateCount:this.app.currentData?.original_points});o&&this.updateStatsPanel(o,!1);return}let e=(this.app.fullPathInfo||[]).filter(o=>this.app.selectedPathIds.has(o.id)),a=(this.app.fullPathSegments||[]).filter(o=>this.app.selectedPathIds.has(o.path_id));if(a.length===0)return;let t=new Set;for(let o of a)o.coords&&o.coords.length===2&&(t.add(JSON.stringify(o.coords[0])),t.add(JSON.stringify(o.coords[1])));let r=t.size,s=window.KMLHeatmap.calculateFilteredStatistics({pathInfo:e,segments:a,year:"all",aircraft:"all",coordinateCount:r});this.updateStatsPanel(s,!0)}updateStatsPanel(e,a){let t="";a?(t+='<p style="margin:0 0 10px 0; font-weight:bold; font-size:15px;">\u{1F4CA} Selected Paths Statistics</p>',t+='<div style="background-color: #3a5a7a; padding: 4px 8px; margin-bottom: 8px; border-radius: 3px; font-size: 11px; color: #a0c0e0;">Showing stats for '+e.num_paths+" selected path(s)</div>"):t+='<p style="margin:0 0 10px 0; font-weight:bold; font-size:15px;">\u{1F4CA} Flight Statistics</p>',t+='<div style="margin-bottom: 8px;"><strong>Data Points:</strong> '+e.total_points+"</div>",t+='<div style="margin-bottom: 8px;"><strong>Flights:</strong> '+e.num_paths+"</div>",e.airport_names&&e.airport_names.length>0&&(t+='<div style="margin-bottom: 8px; max-height: 150px; overflow-y: auto;"><strong>Airports ('+e.num_airports+"):</strong><br>",e.airport_names.forEach(o=>{t+='<span style="margin-left: 10px;">\u2022 '+o+"</span><br>"}),t+="</div>"),e.num_aircraft&&e.num_aircraft>0&&e.aircraft_list&&e.aircraft_list.length>0&&(t+='<div style="margin-bottom: 8px; max-height: 150px; overflow-y: auto;"><strong>Aircrafts ('+e.num_aircraft+"):</strong><br>",e.aircraft_list.forEach(o=>{let p=o.type?" ("+o.type+")":"";t+='<span style="margin-left: 10px;">\u2022 '+o.registration+p+" - "+o.flights+" flight(s)</span><br>"}),t+="</div>"),e.total_flight_time_str&&(t+='<div style="margin-bottom: 8px;"><strong>Total Flight Time:</strong> '+e.total_flight_time_str+"</div>");let r=(e.total_distance_nm*1.852).toFixed(1);if(t+='<div style="margin-bottom: 8px;"><strong>Distance:</strong> '+e.total_distance_nm.toFixed(1)+" nm ("+r+" km)</div>",e.num_paths>0){let o=(e.total_distance_nm/e.num_paths).toFixed(1),p=(parseFloat(o)*1.852).toFixed(1);t+='<div style="margin-bottom: 8px;"><strong>Average Distance per Trip:</strong> '+o+" nm ("+p+" km)</div>"}if(e.longest_flight_nm&&e.longest_flight_nm>0){let o=(e.longest_flight_km||0).toFixed(1);t+='<div style="margin-bottom: 8px;"><strong>Longest Flight:</strong> '+e.longest_flight_nm.toFixed(1)+" nm ("+o+" km)</div>"}if(e.average_groundspeed_knots&&e.average_groundspeed_knots>0){let o=Math.round(e.average_groundspeed_knots*1.852);t+='<div style="margin-bottom: 8px;"><strong>Average Groundspeed:</strong> '+Math.round(e.average_groundspeed_knots)+" kt ("+o+" km/h)</div>"}if(e.cruise_speed_knots&&e.cruise_speed_knots>0){let o=Math.round(e.cruise_speed_knots*1.852);t+='<div style="margin-bottom: 8px;"><strong>Cruise Speed (>1000ft AGL):</strong> '+Math.round(e.cruise_speed_knots)+" kt ("+o+" km/h)</div>"}if(e.max_groundspeed_knots&&e.max_groundspeed_knots>0){let o=Math.round(e.max_groundspeed_knots*1.852);t+='<div style="margin-bottom: 8px;"><strong>Max Groundspeed:</strong> '+Math.round(e.max_groundspeed_knots)+" kt ("+o+" km/h)</div>"}if(e.max_altitude_ft){let o=Math.round(e.max_altitude_ft*.3048);if(t+='<div style="margin-bottom: 8px;"><strong>Max Altitude (MSL):</strong> '+Math.round(e.max_altitude_ft)+" ft ("+o+" m)</div>",e.total_altitude_gain_ft){let p=Math.round(e.total_altitude_gain_ft*.3048);t+='<div style="margin-bottom: 8px;"><strong>Elevation Gain:</strong> '+Math.round(e.total_altitude_gain_ft)+" ft ("+p+" m)</div>"}}if(e.most_common_cruise_altitude_ft&&e.most_common_cruise_altitude_ft>0){let o=Math.round(e.most_common_cruise_altitude_m||0);t+='<div style="margin-bottom: 8px;"><strong>Most Common Cruise Altitude (AGL):</strong> '+e.most_common_cruise_altitude_ft+" ft ("+o+" m)</div>"}let s=l.get("stats-panel");s&&(s.innerHTML=J.sanitize(t))}toggleStats(){let e=l.get("stats-panel");e&&(e.classList.contains("visible")?(e.classList.remove("visible"),setTimeout(()=>{e.style.display="none",this.app.stateManager.saveMapState()},300)):(e.style.display="block",e.offsetHeight,e.classList.add("visible"),this.app.stateManager.saveMapState()))}};function ie(n,e=50){n&&setTimeout(()=>{n.invalidateSize()},e)}var Ve=class{constructor(e){this.app=e}togglePathSelection(e){this.app.selectedPathIds.has(e)?this.app.selectedPathIds.delete(e):this.app.selectedPathIds.add(e),this.app.altitudeVisible&&(this.app.layerManager.redrawAltitudePaths(),ie(this.app.map)),this.app.airspeedVisible&&(this.app.layerManager.redrawAirspeedPaths(),ie(this.app.map)),this.app.replayManager.updateReplayButtonState(),this.app.stateManager.saveMapState()}selectPathsByAirport(e){let a=this.app.airportToPaths[e];a&&a.forEach(t=>{this.app.selectedPathIds.add(t)}),this.app.altitudeVisible&&(this.app.layerManager.redrawAltitudePaths(),ie(this.app.map)),this.app.airspeedVisible&&(this.app.layerManager.redrawAirspeedPaths(),ie(this.app.map)),this.app.replayManager.updateReplayButtonState(),this.app.stateManager.saveMapState()}clearSelection(){this.app.selectedPathIds.clear(),this.app.altitudeVisible&&(this.app.layerManager.redrawAltitudePaths(),ie(this.app.map)),this.app.airspeedVisible&&(this.app.layerManager.redrawAirspeedPaths(),ie(this.app.map)),this.app.replayManager.updateReplayButtonState(),this.app.stateManager.saveMapState()}};var Ue=class{constructor(e){this.app=e}calculateAirportFlightCounts(){return window.KMLHeatmap.calculateAirportFlightCounts(this.app.fullPathInfo??[],this.app.selectedYear,this.app.selectedAircraft)}updateAirportPopups(){if(!this.app.allAirportsData||!this.app.airportMarkers)return;let e=this.calculateAirportFlightCounts(),a=null,t=0;Object.keys(e).forEach(r=>{let s=e[r];s!==void 0&&s>t&&(t=s,a=r)}),this.app.allAirportsData.forEach(r=>{let s=this.app.airportMarkers[r.name];if(!s)return;let o=e[r.name]||0,p=r.name===a,c=window.KMLHeatmap.ddToDms(r.lat,!0),u=window.KMLHeatmap.ddToDms(r.lon,!1),f=`https://www.google.com/maps?q=${r.lat},${r.lon}`,b=`
            <div style="
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
                min-width: 220px;
                padding: 8px 4px;
                background-color: #2b2b2b;
                color: #ffffff;
            ">
                <div style="
                    font-size: 15px;
                    font-weight: bold;
                    color: #28a745;
                    margin-bottom: 10px;
                    padding-bottom: 8px;
                    border-bottom: 2px solid #28a745;
                    display: flex;
                    align-items: center;
                    gap: 6px;
                ">
                    <span style="font-size: 18px;">\u{1F6EB}</span>
                    <span>${r.name||"Unknown"}</span>
                    ${p?'<span style="font-size: 12px; background: #007bff; color: white; padding: 2px 6px; border-radius: 3px; margin-left: 4px;">HOME</span>':""}
                </div>
                <div style="margin-bottom: 8px;">
                    <div style="font-size: 11px; color: #999; margin-bottom: 2px; text-transform: uppercase; letter-spacing: 0.5px;">Coordinates</div>
                    <a href="${f}"
                       target="_blank"
                       style="
                           color: #4facfe;
                           text-decoration: none;
                           font-size: 12px;
                           font-family: monospace;
                           display: flex;
                           align-items: center;
                           gap: 4px;
                       "
                       onmouseover="this.style.textDecoration='underline'"
                       onmouseout="this.style.textDecoration='none'">
                        <span>\u{1F4CD}</span>
                        <span>${c}<br>${u}</span>
                    </a>
                </div>
                <div style="
                    background: linear-gradient(135deg, rgba(79, 172, 254, 0.15) 0%, rgba(0, 242, 254, 0.15) 100%);
                    padding: 8px 10px;
                    border-radius: 6px;
                    border-left: 3px solid #4facfe;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                ">
                    <span style="font-size: 12px; color: #ccc; font-weight: 500;">Total Flights</span>
                    <span style="font-size: 16px; font-weight: bold; color: #4facfe;">${o}</span>
                </div>
            </div>`;s.setPopupContent(b)})}updateAirportOpacity(){let e=this.app.selectedYear!=="all"||this.app.selectedAircraft!=="all",a=this.app.selectedPathIds.size>0;if(!e&&!a){Object.keys(this.app.airportMarkers).forEach(r=>{let s=this.app.airportMarkers[r];s&&(s.setOpacity(1),this.app.airportLayer.hasLayer(s)||s.addTo(this.app.airportLayer))});return}let t=new Set;e&&this.app.fullPathInfo&&this.app.fullPathInfo.forEach(r=>{let s=this.app.selectedYear==="all"||r.year&&r.year.toString()===this.app.selectedYear,o=this.app.selectedAircraft==="all"||r.aircraft_registration===this.app.selectedAircraft;s&&o&&(r.start_airport&&t.add(r.start_airport),r.end_airport&&t.add(r.end_airport))}),a&&this.app.selectedPathIds.forEach(r=>{if(this.app.fullPathInfo){let s=this.app.fullPathInfo.find(o=>o.id===r);s&&(s.start_airport&&t.add(s.start_airport),s.end_airport&&t.add(s.end_airport))}else{let s=this.app.pathToAirports[r];s&&(s.start&&t.add(s.start),s.end&&t.add(s.end))}}),Object.keys(this.app.airportMarkers).forEach(r=>{let s=this.app.airportMarkers[r];s&&(t.has(r)?(s.setOpacity(1),this.app.airportLayer.hasLayer(s)||s.addTo(this.app.airportLayer)):this.app.airportLayer.hasLayer(s)&&this.app.airportLayer.removeLayer(s))})}updateAirportMarkerSizes(){if(!this.app.map)return;let e=this.app.map.getZoom(),a="";e>=14?a="xlarge":e>=12?a="large":e>=10?a="medium":e>=8?a="medium-small":e>=6&&(a="small"),document.querySelectorAll(".airport-marker-container").forEach(t=>{let r=t.querySelector(".airport-marker"),s=t.querySelector(".airport-label");!r||!s||(e<5?s.style.display="none":s.style.display="",t.classList.remove("airport-marker-container-small","airport-marker-container-medium-small","airport-marker-container-medium","airport-marker-container-large","airport-marker-container-xlarge"),r.classList.remove("airport-marker-small","airport-marker-medium-small","airport-marker-medium","airport-marker-large","airport-marker-xlarge"),s.classList.remove("airport-label-small","airport-label-medium-small","airport-label-medium","airport-label-large","airport-label-xlarge"),a&&(t.classList.add("airport-marker-container-"+a),r.classList.add("airport-marker-"+a),s.classList.add("airport-label-"+a)))})}};var Q=me(ae(),1);var la=me(ae(),1);var Ye=class{constructor(e){this.app=e}updateAirplanePopup(e){if(!e.replayAirplaneMarker||!e.replayActive)return;let a=null;for(let v=0;v<e.replaySegments.length;v++){let x=e.replaySegments[v];if(x&&(x.time||0)<=e.replayCurrentTime)a=x;else break}if(!a&&e.replaySegments.length>0&&(a=e.replaySegments[0]),!a)return;let t=`<div style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif; min-width: 180px; padding: 8px 4px; background-color: #2b2b2b; color: #ffffff;">`;t+='<div style="font-size: 14px; font-weight: bold; color: #4facfe; margin-bottom: 8px; padding-bottom: 6px; border-bottom: 2px solid #4facfe; display: flex; align-items: center; gap: 6px;">',t+='<span style="font-size: 16px;">\u2708\uFE0F</span>',t+="<span>Current Position</span>",t+="</div>";let r=a.altitude_ft||0,s=Math.round(r/50)*50,o=Math.round(s*.3048),p=window.KMLHeatmap.getColorForAltitude(r,e.replayColorMinAlt,e.replayColorMaxAlt),c=p.replace("rgb(","rgba(").replace(")",", 0.15)");t+='<div style="margin-bottom: 8px;">',t+='<div style="font-size: 11px; color: #999; margin-bottom: 2px; text-transform: uppercase; letter-spacing: 0.5px;">Altitude (MSL)</div>',t+='<div style="background: '+c+"; padding: 6px 8px; border-radius: 6px; border-left: 3px solid "+p+';">',t+='<span style="font-size: 16px; font-weight: bold; color: '+p+';">'+s+" ft</span>",t+='<span style="font-size: 12px; color: #ccc; margin-left: 6px;">('+o+" m)</span>",t+="</div>",t+="</div>";let u=a.groundspeed_knots||0,f=u*1.852,b=Math.round(u),T=Math.round(f),g=window.KMLHeatmap.getColorForAirspeed(u,e.replayColorMinSpeed,e.replayColorMaxSpeed),A=g.replace("rgb(","rgba(").replace(")",", 0.15)");t+='<div style="margin-bottom: 8px;">',t+='<div style="font-size: 11px; color: #999; margin-bottom: 2px; text-transform: uppercase; letter-spacing: 0.5px;">Groundspeed</div>',t+='<div style="background: '+A+"; padding: 6px 8px; border-radius: 6px; border-left: 3px solid "+g+';">',t+='<span style="font-size: 16px; font-weight: bold; color: '+g+';">'+b+" kt</span>",t+='<span style="font-size: 12px; color: #ccc; margin-left: 6px;">('+T+" km/h)</span>",t+="</div>",t+="</div>",t+="</div>",e.replayAirplaneMarker.getPopup()?e.replayAirplaneMarker.getPopup().setContent(t):e.replayAirplaneMarker.bindPopup(t,{autoPanPadding:[50,50]}),e.replayAirplaneMarker.openPopup()}updateDisplay(e,a=!1){let t=l.get("replay-time-display");t&&(t.textContent=window.KMLHeatmap.formatTime(e.replayCurrentTime)+" / "+window.KMLHeatmap.formatTime(e.replayMaxTime));let r=l.get("replay-slider");r&&(r.value=e.replayCurrentTime.toString());let s=l.get("replay-slider-start");s&&(s.textContent=window.KMLHeatmap.formatTime(e.replayCurrentTime));let o=null,p=null,c=-1;for(let u=0;u<e.replaySegments.length;u++){let f=e.replaySegments[u];if(f&&(f.time||0)<=e.replayCurrentTime)o=f,c=u;else if(f){p=f;break}}if(e.replayLayer){let u=this.app.airspeedVisible&&!this.app.altitudeVisible;for(let f=0;f<e.replaySegments.length;f++){let b=e.replaySegments[f];if(b)if((b.time||0)<=e.replayCurrentTime&&e.replayCurrentTime>0){if(f>e.replayLastDrawnIndex){let T;u&&(b.groundspeed_knots||0)>0?T=window.KMLHeatmap.getColorForAltitude(b.groundspeed_knots??0,e.replayColorMinSpeed,e.replayColorMaxSpeed):T=window.KMLHeatmap.getColorForAltitude(b.altitude_ft??0,e.replayColorMinAlt,e.replayColorMaxAlt),la.polyline(b.coords||[],{color:T,weight:3,opacity:.8}).addTo(e.replayLayer),e.replayLastDrawnIndex=f}}else break}}if(e.replayAirplaneMarker&&this.app.map&&!this.app.map.hasLayer(e.replayAirplaneMarker)&&e.replayAirplaneMarker.addTo(this.app.map),e.replayAirplaneMarker&&this.app.map){if(o){let u,f;if(p&&(o.time||0)<e.replayCurrentTime){let g=(e.replayCurrentTime-(o.time||0))/((p.time||0)-(o.time||0)),A=o.coords?.[1]?.[0]||0,v=o.coords?.[1]?.[1]||0,x=p.coords?.[0]?.[0]||0,U=p.coords?.[0]?.[1]||0;u=[A+(x-A)*g,v+(U-v)*g],f=window.KMLHeatmap.calculateBearing(A,v,x,U)}else{u=o.coords?.[1]||[0,0];let g=o.coords?.[0]?.[0]||0,A=o.coords?.[0]?.[1]||0,v=o.coords?.[1]?.[0]||0,x=o.coords?.[1]?.[1]||0;f=window.KMLHeatmap.calculateBearing(g,A,v,x)}let b=window.KMLHeatmap.calculateSmoothedBearing(e.replaySegments,c,5);if(b!==null?(f=b,e.replayLastBearing=f):e.replayLastBearing!==null&&(f=e.replayLastBearing),e.replayAirplaneMarker.setLatLng(u),e.replayPlaying||a){let g=this.app.map.getSize(),A=this.app.map.latLngToContainerPoint(u),v=.1,x=g.x*v,U=g.y*v,$=!1;if((A.x<x||A.x>g.x-x||A.y<U||A.y>g.y-U)&&($=!0),a&&($=!0),$){this.app.map.panTo(u,{animate:!0,duration:.5,easeLinearity:.25,noMoveStart:!0});let S=Date.now();e.replayRecenterTimestamps.push(S);let M=S-3e4;e.replayRecenterTimestamps=e.replayRecenterTimestamps.filter(Y=>Y>M)}if(e.replayAutoZoom){let M=Date.now()-3e4;if(e.replayRecenterTimestamps=e.replayRecenterTimestamps.filter(X=>X>M),e.replayRecenterTimestamps.length>2){let re=Date.now()-5e3;if(e.replayRecenterTimestamps.filter(Le=>Le>=re).length>2&&e.replayLastZoom!==null&&e.replayLastZoom>9){let _e=Math.max(9,e.replayLastZoom-1);this.app.map.setZoom(_e,{animate:!0,duration:.5}),e.replayLastZoom=_e,e.replayRecenterTimestamps=[]}}}}let T=e.replayAirplaneMarker.getElement();if(T){let g=T.querySelector(".replay-airplane-icon");if(g){let A=f-45;g.style.transform="translate3d(0,0,0) rotate("+A+"deg)"}}}else if(e.replaySegments.length>0){let f=e.replaySegments[0]?.coords?.[0];f&&e.replayAirplaneMarker.setLatLng([f[0],f[1]])}}e.replayAirplaneMarker&&e.replayAirplaneMarker.getPopup()&&e.replayAirplaneMarker.isPopupOpen()&&this.updateAirplanePopup(e)}};var Ge=class{constructor(e){this.app=e,this.renderer=new Ye(e),l.cacheElements(["replay-controls","replay-btn","replay-play-btn","replay-pause-btn","replay-slider","replay-slider-start","replay-slider-end","replay-time-display","replay-speed","replay-autozoom-btn","altitude-btn","altitude-legend"]),this.replayActive=!1,this.replayPlaying=!1,this.replayCurrentTime=0,this.replayMaxTime=0,this.replaySpeed=50,this.replayInterval=null,this.replayLayer=null,this.replaySegments=[],this.replayAirplaneMarker=null,this.replayLastDrawnIndex=-1,this.replayLastBearing=null,this.replayAnimationFrameId=null,this.replayLastFrameTime=null,this.replayColorMinAlt=0,this.replayColorMaxAlt=1e4,this.replayColorMinSpeed=0,this.replayColorMaxSpeed=200,this.replayAutoZoom=!1,this.replayLastZoom=null,this.replayRecenterTimestamps=[]}toggleReplay(){let e=l.get("replay-controls");if(e)if(this.replayActive){this.stopReplay(),e.style.display="none",this.replayActive=!1;let a=l.get("replay-btn");if(a&&(a.textContent="\u25B6\uFE0F Replay"),document.body.classList.remove("replay-active"),this.replayAirplaneMarker&&this.app.map&&(this.app.map.removeLayer(this.replayAirplaneMarker),this.replayAirplaneMarker=null),this.replayLayer&&this.app.map&&this.app.map.removeLayer(this.replayLayer),this.restoreLayerVisibility(),!this.app.altitudeVisible&&!this.app.airspeedVisible&&this.app.map){this.app.altitudeVisible=!0;let t=l.get("altitude-btn");t&&(t.style.opacity="1.0");let r=l.get("altitude-legend");r&&(r.style.display="block"),this.app.map.addLayer(this.app.altitudeLayer)}setTimeout(()=>{this.app.altitudeVisible?this.app.layerManager.redrawAltitudePaths():this.app.airspeedVisible&&this.app.layerManager.redrawAirspeedPaths(),this.app.map&&this.app.map.invalidateSize()},100),this.updateReplayButtonState(),this.app.stateManager.saveMapState()}else{if(this.app.selectedPathIds.size!==1)return;if(this.initializeReplay()){e.style.display="block",this.replayActive=!0;let a=l.get("replay-btn");a&&(a.textContent="\u23F9\uFE0F Replay",a.style.opacity="1.0");let t=l.get("replay-autozoom-btn");t&&(t.style.opacity=this.replayAutoZoom?"1.0":"0.5",t.title=this.replayAutoZoom?"Auto-zoom enabled":"Auto-zoom disabled"),document.body.classList.add("replay-active"),this.hideOtherLayersDuringReplay(),this.app.stateManager.saveMapState()}}}updateReplayButtonState(){let e=l.get("replay-btn");if(!e)return;let a=this.app.fullStats&&this.app.fullStats.max_groundspeed_knots!==void 0&&this.app.fullStats.max_groundspeed_knots>0;this.app.selectedPathIds.size===1&&a?(e.style.opacity="1.0",e.disabled=!1,e.setAttribute("aria-disabled","false")):(e.style.opacity="0.5",e.disabled=!0,e.setAttribute("aria-disabled","true"))}updateReplayAirplanePopup(){this.renderer.updateAirplanePopup(this)}initializeReplay(){if(!this.app.fullPathSegments)return alert("No flight data available for replay. Please wait for data to load or refresh the page."),!1;let e=Array.from(this.app.selectedPathIds)[0];if(this.replaySegments=this.app.fullPathSegments.filter(u=>u.path_id===e&&u.time!==void 0&&u.time!==null),this.replaySegments.length===0)return!1;if(this.replaySegments.sort((u,f)=>(u.time||0)-(f.time||0)),this.app.currentData&&this.app.currentData.path_segments){let u=this.app.currentData.path_segments.filter(f=>f.path_id===e);if(u.length>0){let f=u.map(g=>g.altitude_ft||0),b=window.KMLHeatmap.findMinMax(f);this.replayColorMinAlt=b.min,this.replayColorMaxAlt=b.max;let T=u.map(g=>g.groundspeed_knots||0).filter(g=>g>0);if(T.length>0){let g=window.KMLHeatmap.findMinMax(T);this.replayColorMinSpeed=g.min,this.replayColorMaxSpeed=g.max}else this.replayColorMinSpeed=this.app.airspeedRange.min,this.replayColorMaxSpeed=this.app.airspeedRange.max}else{let f=this.replaySegments.map(g=>g.altitude_ft||0),b=window.KMLHeatmap.findMinMax(f);this.replayColorMinAlt=b.min,this.replayColorMaxAlt=b.max;let T=this.replaySegments.map(g=>g.groundspeed_knots||0).filter(g=>g>0);if(T.length>0){let g=window.KMLHeatmap.findMinMax(T);this.replayColorMinSpeed=g.min,this.replayColorMaxSpeed=g.max}else this.replayColorMinSpeed=this.app.airspeedRange.min,this.replayColorMaxSpeed=this.app.airspeedRange.max}}let a=this.replaySegments[this.replaySegments.length-1];this.replayMaxTime=a?.time||0;let t=l.get("replay-slider");t&&(t.max=this.replayMaxTime.toString());let r=l.get("replay-slider-end");r&&(r.textContent=window.KMLHeatmap.formatTime(this.replayMaxTime)),this.app.layerManager.updateAltitudeLegend(this.replayColorMinAlt,this.replayColorMaxAlt),this.app.layerManager.updateAirspeedLegend(this.replayColorMinSpeed,this.replayColorMaxSpeed),this.replayLayer||(this.replayLayer=Q.layerGroup()),this.replayLayer.clearLayers(),this.app.map&&this.replayLayer.addTo(this.app.map),this.replayAirplaneMarker&&this.app.map&&(this.app.map.removeLayer(this.replayAirplaneMarker),this.replayAirplaneMarker=null);let s=Q.divIcon({html:'<div class="replay-airplane-icon">\u2708\uFE0F</div>',iconSize:[32,32],iconAnchor:[16,16],className:""}),p=this.replaySegments[0]?.coords?.[0];if(!p||!this.app.map)return!1;this.replayAirplaneMarker=Q.marker([p[0],p[1]],{icon:s,zIndexOffset:1e3}),this.replayAirplaneMarker.addTo(this.app.map);let c=this.replayAirplaneMarker.getElement();return c&&(c.style.transition="transform 0.08s linear",c.style.cursor="pointer",c.style.pointerEvents="auto",c.addEventListener("click",u=>{u.stopPropagation(),this.replayAirplaneMarker.isPopupOpen()?this.replayAirplaneMarker.closePopup():this.updateReplayAirplanePopup()})),this.replayCurrentTime=0,this.replayLastDrawnIndex=-1,this.replayLastBearing=null,this.replayAutoZoom&&this.app.map?(this.app.map.setView([p[0],p[1]],16,{animate:!0,duration:.8}),this.replayLastZoom=16):this.app.map&&this.app.map.panTo([p[0],p[1]],{animate:!0,duration:.8}),this.updateReplayDisplay(),!0}hideOtherLayersDuringReplay(){if(!this.app.map)return;this.app.heatmapLayer&&this.app.heatmapVisible&&this.app.map.removeLayer(this.app.heatmapLayer),this.app.altitudeVisible&&this.app.map.removeLayer(this.app.altitudeLayer),this.app.airspeedVisible&&this.app.map.removeLayer(this.app.airspeedLayer),["heatmap-btn","airports-btn","aviation-btn","year-select","aircraft-select"].forEach(a=>{let t=document.getElementById(a);t&&(t.disabled=!0)})}restoreLayerVisibility(){if(!this.app.map)return;this.app.heatmapLayer&&this.app.heatmapVisible&&(this.app.map.addLayer(this.app.heatmapLayer),this.app.heatmapLayer.e&&(this.app.heatmapLayer.e.style.pointerEvents="none")),this.app.altitudeVisible&&(this.app.map.addLayer(this.app.altitudeLayer),setTimeout(()=>{this.app.layerManager.redrawAltitudePaths(),this.app.map&&this.app.map.invalidateSize()},50)),this.app.airspeedVisible&&(this.app.map.addLayer(this.app.airspeedLayer),setTimeout(()=>{this.app.layerManager.redrawAirspeedPaths(),this.app.map&&this.app.map.invalidateSize()},50)),["heatmap-btn","airports-btn","aviation-btn","year-select","aircraft-select"].forEach(a=>{let t=document.getElementById(a);t&&(t.disabled=!1)})}playReplay(){if(!this.replayActive||!this.app.map)return;if(this.replayCurrentTime>=this.replayMaxTime){if(this.replayCurrentTime=0,this.replayLastDrawnIndex=-1,this.replayLayer&&this.replayLayer.clearLayers(),this.replayAirplaneMarker&&this.replaySegments.length>0&&this.app.map){let s=this.replaySegments[0]?.coords?.[0];s&&(this.replayAirplaneMarker.setLatLng([s[0],s[1]]),this.replayAutoZoom&&(this.app.map.setView([s[0],s[1]],16,{animate:!0,duration:.5}),this.replayLastZoom=16))}this.replayRecenterTimestamps=[],this.replayLastBearing=null}this.replayPlaying=!0;let e=l.get("replay-play-btn"),a=l.get("replay-pause-btn");e&&(e.style.display="none"),a&&(a.style.display="inline-block"),this.replayLastFrameTime=null;let t=r=>{if(!this.replayPlaying)return;this.replayLastFrameTime===null&&(this.replayLastFrameTime=r);let s=r-this.replayLastFrameTime;this.replayLastFrameTime=r;let o=s/1e3*this.replaySpeed;if(this.replayCurrentTime+=o,this.replayCurrentTime>=this.replayMaxTime){if(this.replayCurrentTime=this.replayMaxTime,this.pauseReplay(),this.replaySegments.length>0&&this.app.map){let p=[];if(this.replaySegments.forEach(c=>{c.coords&&c.coords.length>0&&c.coords.forEach(u=>{p.push(u)})}),p.length>0){let c=Q.latLngBounds(p);this.app.map.fitBounds(c,{padding:[50,50],animate:!0,duration:1})}}}else this.replayAnimationFrameId=requestAnimationFrame(t);this.updateReplayDisplay()};this.replayAnimationFrameId=requestAnimationFrame(t),this.app.stateManager.saveMapState()}pauseReplay(){this.replayPlaying=!1;let e=l.get("replay-play-btn"),a=l.get("replay-pause-btn");e&&(e.style.display="inline-block"),a&&(a.style.display="none"),this.replayAnimationFrameId&&(cancelAnimationFrame(this.replayAnimationFrameId),this.replayAnimationFrameId=null),this.replayLastFrameTime=null,this.app.stateManager.saveMapState()}stopReplay(){if(this.pauseReplay(),this.replayCurrentTime=0,this.replayLastDrawnIndex=-1,this.replayLastBearing=null,this.replayRecenterTimestamps=[],this.replayLayer&&this.replayLayer.clearLayers(),this.replayAirplaneMarker&&this.replaySegments.length>0){let a=this.replaySegments[0]?.coords?.[0];a&&this.replayAirplaneMarker.setLatLng([a[0],a[1]])}this.updateReplayDisplay()}seekReplay(e){let a=parseFloat(e);a<this.replayCurrentTime&&(this.replayLayer&&this.replayLayer.clearLayers(),this.replayLastDrawnIndex=-1),this.replayCurrentTime=a,this.updateReplayDisplay(!0),this.app.stateManager.saveMapState()}changeReplaySpeed(){let e=l.get("replay-speed");e&&(this.replaySpeed=parseFloat(e.value),this.app.stateManager.saveMapState())}toggleAutoZoom(){this.replayAutoZoom=!this.replayAutoZoom;let e=l.get("replay-autozoom-btn");e&&(e.style.opacity=this.replayAutoZoom?"1.0":"0.5",e.title=this.replayAutoZoom?"Auto-zoom enabled":"Auto-zoom disabled"),this.app.stateManager.saveMapState()}updateReplayDisplay(e=!1){this.renderer.updateDisplay(this,e)}};function pa(n,e,a){return`
            <div class="stat-card">
                <div class="stat-value">${n.total_flights}</div>
                <div class="stat-label">Flights</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">${n.num_airports}</div>
                <div class="stat-label">Airports</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">${n.total_distance_nm.toFixed(0)}</div>
                <div class="stat-label">Nautical Miles</div>
            </div>
            ${a?`
            <div class="stat-card">
                <div class="stat-value">${n.flight_time}</div>
                <div class="stat-label">Flight Time</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">${(e?.max_groundspeed_knots||0).toFixed(0)} kt</div>
                <div class="stat-label">Max Groundspeed</div>
            </div>
            `:""}
            <div class="stat-card">
                <div class="stat-value">${Math.round((e?.max_altitude_m||0)/.3048)} ft</div>
                <div class="stat-label">Max Altitude (MSL)</div>
            </div>
        `}function da(n){let e='<div class="fun-facts-title">\u2728 Facts</div>';return n.forEach(a=>{e+=`<div class="fun-fact" data-category="${a.category}"><span class="fun-fact-icon">${a.icon}</span><span class="fun-fact-text">${a.text}</span></div>`}),e}function ai(n){return n>=.75?"fleet-aircraft-high":n>=.5?"fleet-aircraft-medium-high":n>=.25?"fleet-aircraft-medium-low":"fleet-aircraft-low"}function ca(n){if(!n.aircraft_list||n.aircraft_list.length===0)return"";let e='<div class="aircraft-fleet-title">\u2708\uFE0F Fleet</div>',a=n.aircraft_list[0]?.flights??0,t=n.aircraft_list[n.aircraft_list.length-1]?.flights??0,r=a-t;return n.aircraft_list.forEach(s=>{let o=s.model||s.type||"",p=r>0?(s.flights-t)/r:1,c=ai(p),u=s.flight_time_str||"---";e+=`
                    <div class="fleet-aircraft ${c}">
                        <div class="fleet-aircraft-info">
                            <div class="fleet-aircraft-model">${o}</div>
                            <div class="fleet-aircraft-registration">${s.registration}</div>
                        </div>
                        <div class="fleet-aircraft-stats">
                            <div class="fleet-aircraft-flights">${s.flights} flights</div>
                            <div class="fleet-aircraft-time">${u}</div>
                        </div>
                    </div>
                `}),e}function ma(n){let e='<div class="top-airports-title">\u{1F3E0} Home Base</div>';return e+=`
                <div class="top-airport">
                    <div class="top-airport-name">${n.name}</div>
                    <div class="top-airport-count">${n.flight_count} flights</div>
                </div>
            `,e}function ha(n){if(n.length===0)return"";let e='<div class="airports-grid-title">\u{1F5FA}\uFE0F Destinations</div><div class="airport-badges">';return n.forEach(a=>{e+=`<div class="airport-badge">${a}</div>`}),e+="</div>",e}var Ke=class{constructor(e){this.app=e,this.originalMapParent=null,this.originalMapIndex=null,l.cacheElements(["wrapped-title","wrapped-year","wrapped-stats","wrapped-fun-facts","wrapped-aircraft-fleet","wrapped-top-airports","wrapped-airports-grid","map","wrapped-map-container","wrapped-modal","stats-btn","export-btn","wrapped-btn","heatmap-btn","airports-btn","altitude-btn","airspeed-btn","aviation-btn","year-filter","aircraft-filter","stats-panel","altitude-legend","airspeed-legend","loading"])}showWrapped(){if(!this.app.map)return;let e=this.app.selectedYear,a=window.KMLHeatmap.calculateYearStats(this.app.fullPathInfo||[],this.app.fullPathSegments||[],e,this.app.fullStats),t=l.get("wrapped-title"),r=l.get("wrapped-year");e==="all"?(t&&(t.textContent="\u2728 Your Flight History"),r&&(r.textContent="All Years")):(t&&(t.textContent="\u2728 Your Year in Flight"),r&&(r.textContent=e));let s=this.app.fullStats!==null&&this.app.fullStats.max_groundspeed_knots!==void 0&&this.app.fullStats.max_groundspeed_knots>0,o=pa(a,this.app.fullStats??null,s),p=l.get("wrapped-stats");p&&(p.innerHTML=J.sanitize(o));let c=window.KMLHeatmap.generateFunFacts(a,this.app.fullStats),u=da(c),f=l.get("wrapped-fun-facts");if(f&&(f.innerHTML=J.sanitize(u)),a.aircraft_list&&a.aircraft_list.length>0){let v=ca(a),x=l.get("wrapped-aircraft-fleet");x&&(x.innerHTML=J.sanitize(v))}if(a.airport_names&&a.airport_names.length>0){let v;if(e==="all")v=this.app.fullPathInfo||[];else{let S=e.toString();v=(this.app.fullPathInfo||[]).filter(M=>M.year&&M.year.toString()===S)}let x={};v.forEach(S=>{S.start_airport&&(x[S.start_airport]=(x[S.start_airport]||0)+1),S.end_airport&&(x[S.end_airport]=(x[S.end_airport]||0)+1)});let U=a.airport_names.map(S=>({name:S,flight_count:x[S]||0}));U.sort((S,M)=>M.flight_count-S.flight_count);let $=U[0];if($){let S=ma($),M=l.get("wrapped-top-airports");M&&(M.innerHTML=J.sanitize(S));let Y=a.airport_names.filter(Se=>Se!==$.name),X=ha(Y),re=l.get("wrapped-airports-grid");re&&(re.innerHTML=J.sanitize(X))}}let b=l.get("map"),T=l.get("wrapped-map-container");if(!b||!T)return;this.originalMapParent||(this.originalMapParent=b.parentNode,this.originalMapIndex=Array.from(this.originalMapParent.children).indexOf(b)),this.app.map.fitBounds(this.app.config.bounds,{padding:[80,80]}),[document.querySelector(".leaflet-control-zoom"),l.get("stats-btn"),l.get("export-btn"),l.get("wrapped-btn"),l.get("heatmap-btn"),l.get("airports-btn"),l.get("altitude-btn"),l.get("airspeed-btn"),l.get("aviation-btn"),l.get("year-filter"),l.get("aircraft-filter"),l.get("stats-panel"),l.get("altitude-legend"),l.get("airspeed-legend"),l.get("loading")].forEach(v=>{v&&(v.style.display="none")});let A=l.get("wrapped-modal");A&&(A.style.display="flex"),setTimeout(()=>{T.appendChild(b),b.style.width="100%",b.style.height="100%",b.style.borderRadius="12px",b.style.overflow="hidden",T.offsetHeight,setTimeout(()=>{this.app.map.invalidateSize(),this.app.map.fitBounds(this.app.config.bounds,{padding:[80,80]}),this.app.stateManager&&this.app.stateManager.saveMapState()},100)},50)}closeWrapped(e){if(!e||e.target.id==="wrapped-modal"){let a=l.get("map");if(!a)return;if(this.originalMapParent&&this.originalMapIndex!==null){let r=Array.from(this.originalMapParent.children);if(this.originalMapIndex>=r.length)this.originalMapParent.appendChild(a);else{let o=r[this.originalMapIndex];o&&this.originalMapParent.insertBefore(a,o)}if(a.style.width="",a.style.height="",a.style.borderRadius="",a.style.overflow="",[document.querySelector(".leaflet-control-zoom"),l.get("stats-btn"),l.get("export-btn"),l.get("wrapped-btn"),l.get("heatmap-btn"),l.get("airports-btn"),l.get("altitude-btn"),l.get("airspeed-btn"),l.get("year-filter"),l.get("aircraft-filter"),l.get("stats-panel"),l.get("altitude-legend"),l.get("airspeed-legend"),l.get("loading")].forEach(o=>{o&&(o.style.display="")}),this.app.config.openaipApiKey){let o=l.get("aviation-btn");o&&(o.style.display="")}setTimeout(()=>{this.app.map&&this.app.map.invalidateSize(),this.app.stateManager&&this.app.stateManager.saveMapState()},100)}let t=l.get("wrapped-modal");t&&(t.style.display="none")}}};var Mt=me(ae(),1);var We=class{constructor(e){this.app=e,l.cacheElements(["heatmap-btn","altitude-btn","airspeed-btn","airports-btn","aviation-btn","altitude-legend","airspeed-legend","export-btn","hide-buttons-btn","map","stats-btn","wrapped-btn","replay-btn","year-filter","aircraft-filter","stats-panel","loading"])}toggleHeatmap(){if(this.app.map){if(this.app.heatmapVisible){this.app.heatmapLayer&&this.app.map.removeLayer(this.app.heatmapLayer),this.app.heatmapVisible=!1;let e=l.get("heatmap-btn");e&&(e.style.opacity="0.5")}else{this.app.heatmapLayer&&(this.app.map.addLayer(this.app.heatmapLayer),this.app.heatmapLayer.e&&(this.app.heatmapLayer.e.style.pointerEvents="none")),this.app.heatmapVisible=!0;let e=l.get("heatmap-btn");e&&(e.style.opacity="1.0")}this.app.stateManager.saveMapState()}}toggleAltitude(){if(this.app.map){if(this.app.altitudeVisible){if(this.app.replayManager.replayActive&&!this.app.airspeedVisible)return;this.app.map.removeLayer(this.app.altitudeLayer),this.app.altitudeVisible=!1;let e=l.get("altitude-btn");e&&(e.style.opacity="0.5");let a=l.get("altitude-legend");a&&(a.style.display="none")}else{if(this.app.airspeedVisible){this.app.replayManager.replayActive||this.app.map.removeLayer(this.app.airspeedLayer),this.app.airspeedVisible=!1;let t=l.get("airspeed-btn");t&&(t.style.opacity="0.5");let r=l.get("airspeed-legend");r&&(r.style.display="none")}if(!this.app.replayManager.replayActive)this.app.map.addLayer(this.app.altitudeLayer),this.app.layerManager.redrawAltitudePaths();else{let t=this.app.replayManager.replayCurrentTime,r=this.app.replayManager.replayLastDrawnIndex;this.app.replayManager.replayLayer&&this.app.replayManager.replayLayer.clearLayers(),this.app.replayManager.replayLastDrawnIndex=-1;for(let s=0;s<=r&&s<this.app.replayManager.replaySegments.length;s++){let o=this.app.replayManager.replaySegments[s];if(o&&(o.time||0)<=t){let p=window.KMLHeatmap.getColorForAltitude(o.altitude_ft||0,this.app.replayManager.replayColorMinAlt,this.app.replayManager.replayColorMaxAlt);Mt.polyline(o.coords||[],{color:p,weight:3,opacity:.8}).addTo(this.app.replayManager.replayLayer),this.app.replayManager.replayLastDrawnIndex=s}}}this.app.altitudeVisible=!0;let e=l.get("altitude-btn");e&&(e.style.opacity="1.0");let a=l.get("altitude-legend");a&&(a.style.display="block")}this.app.replayManager.replayActive&&this.app.replayManager.replayAirplaneMarker&&this.app.replayManager.replayAirplaneMarker.isPopupOpen()&&this.app.replayManager.updateReplayAirplanePopup(),this.app.stateManager.saveMapState()}}toggleAirspeed(){if(this.app.map){if(this.app.airspeedVisible){if(this.app.replayManager.replayActive&&!this.app.altitudeVisible)return;this.app.map.removeLayer(this.app.airspeedLayer),this.app.airspeedVisible=!1;let e=l.get("airspeed-btn");e&&(e.style.opacity="0.5");let a=l.get("airspeed-legend");a&&(a.style.display="none")}else{if(this.app.altitudeVisible){this.app.replayManager.replayActive||this.app.map.removeLayer(this.app.altitudeLayer),this.app.altitudeVisible=!1;let t=l.get("altitude-btn");t&&(t.style.opacity="0.5");let r=l.get("altitude-legend");r&&(r.style.display="none")}if(!this.app.replayManager.replayActive)this.app.map.addLayer(this.app.airspeedLayer),this.app.layerManager.redrawAirspeedPaths();else{let t=this.app.replayManager.replayCurrentTime,r=this.app.replayManager.replayLastDrawnIndex;this.app.replayManager.replayLayer&&this.app.replayManager.replayLayer.clearLayers(),this.app.replayManager.replayLastDrawnIndex=-1;for(let s=0;s<=r&&s<this.app.replayManager.replaySegments.length;s++){let o=this.app.replayManager.replaySegments[s];if(o&&(o.time||0)<=t&&(o.groundspeed_knots||0)>0){let p=window.KMLHeatmap.getColorForAltitude(o.groundspeed_knots||0,this.app.replayManager.replayColorMinSpeed,this.app.replayManager.replayColorMaxSpeed);Mt.polyline(o.coords||[],{color:p,weight:3,opacity:.8}).addTo(this.app.replayManager.replayLayer),this.app.replayManager.replayLastDrawnIndex=s}}}this.app.airspeedVisible=!0;let e=l.get("airspeed-btn");e&&(e.style.opacity="1.0");let a=l.get("airspeed-legend");a&&(a.style.display="block")}this.app.replayManager.replayActive&&this.app.replayManager.replayAirplaneMarker&&this.app.replayManager.replayAirplaneMarker.isPopupOpen()&&this.app.replayManager.updateReplayAirplanePopup(),this.app.stateManager.saveMapState()}}toggleAirports(){if(this.app.map){if(this.app.airportsVisible){this.app.map.removeLayer(this.app.airportLayer),this.app.airportsVisible=!1;let e=l.get("airports-btn");e&&(e.style.opacity="0.5")}else{this.app.map.addLayer(this.app.airportLayer),this.app.airportsVisible=!0;let e=l.get("airports-btn");e&&(e.style.opacity="1.0")}this.app.stateManager.saveMapState()}}toggleAviation(){if(this.app.map&&this.app.config.openaipApiKey&&this.app.openaipLayers["Aviation Data"]){if(this.app.aviationVisible){this.app.map.removeLayer(this.app.openaipLayers["Aviation Data"]),this.app.aviationVisible=!1;let e=l.get("aviation-btn");e&&(e.style.opacity="0.5")}else{this.app.map.addLayer(this.app.openaipLayers["Aviation Data"]),this.app.aviationVisible=!0;let e=l.get("aviation-btn");e&&(e.style.opacity="1.0")}this.app.stateManager.saveMapState()}}toggleButtonsVisibility(){let e=document.querySelectorAll(".toggleable-btn"),a=l.get("hide-buttons-btn");this.app.buttonsHidden?(e.forEach(t=>{t.classList.remove("buttons-hidden")}),a&&(a.textContent="\u{1F53C}"),this.app.buttonsHidden=!1):(e.forEach(t=>{t.classList.add("buttons-hidden")}),a&&(a.textContent="\u{1F53D}"),this.app.buttonsHidden=!0),this.app.altitudeVisible&&this.app.layerManager.redrawAltitudePaths(),this.app.airspeedVisible&&this.app.layerManager.redrawAirspeedPaths(),this.app.stateManager.saveMapState()}exportMap(){let e=l.get("export-btn");if(!e)return;e.disabled=!0,e.textContent="\u23F3 Exporting...";let a=l.get("map");if(!a)return;let t=[document.querySelector(".leaflet-control-zoom"),l.get("stats-btn"),l.get("export-btn"),l.get("wrapped-btn"),l.get("replay-btn"),l.get("year-filter"),l.get("aircraft-filter"),l.get("heatmap-btn"),l.get("altitude-btn"),l.get("airspeed-btn"),l.get("airports-btn"),l.get("aviation-btn"),l.get("stats-panel"),l.get("altitude-legend"),l.get("airspeed-legend"),l.get("loading")],r=t.map(s=>s?s.style.display:null);t.forEach(s=>{s&&(s.style.display="none")}),setTimeout(()=>{window.domtoimage?.toJpeg(a,{width:a.offsetWidth*2,height:a.offsetHeight*2,bgcolor:"#1a1a1a",quality:.95}).then(s=>{t.forEach((p,c)=>{p&&(p.style.display=r[c]||"")}),e.disabled=!1,e.textContent="\u{1F4F7} Export";let o=document.createElement("a");o.download="heatmap_"+new Date().toISOString().slice(0,19).replace(/[:.]/g,"-")+".jpg",o.href=s,o.click()}).catch(s=>{t.forEach((o,p)=>{o&&(o.style.display=r[p]||"")}),alert("Export failed: "+s.message),e.disabled=!1,e.textContent="\u{1F4F7} Export"})},200)}};var $e=me(ae(),1);async function ua(n){let e=await n.dataManager.loadAirports();n.allAirportsData=e;let a=await n.dataManager.loadMetadata();if(a&&a.available_years){let s=document.getElementById("year-select");if(a.available_years.forEach(o=>{let p=document.createElement("option");p.value=o.toString(),p.textContent="\u{1F4C5} "+o,s.appendChild(p)}),n.selectedYear==="all"&&!n.restoredYearFromState){let o=a.available_years[a.available_years.length-1];o!==void 0&&(n.selectedYear=o.toString())}n.selectedYear&&n.selectedYear!=="all"&&(s.value=n.selectedYear)}vt(n,e),a&&a.stats&&(n.fullStats=a.stats);try{let s=await n.dataManager.loadData("data",n.selectedYear);s&&s.path_info&&(n.fullPathInfo=s.path_info),s&&s.path_segments&&(n.fullPathSegments=s.path_segments)}catch(s){jt("Failed to load full path data:",s)}if(n.filterManager.updateAircraftDropdown(),n.airportManager.updateAirportPopups(),n.fullStats){let s=window.KMLHeatmap.calculateFilteredStatistics({pathInfo:n.fullPathInfo??[],segments:n.fullPathSegments??[],year:n.selectedYear,aircraft:n.selectedAircraft,coordinateCount:n.currentData?.original_points});n.statsManager.updateStatsPanel(s,!1)}n.airportManager.updateAirportOpacity();let t=a&&a.max_groundspeed_knots!==void 0&&a.max_groundspeed_knots>0;t&&(n.airspeedRange.min=a.min_groundspeed_knots,n.airspeedRange.max=a.max_groundspeed_knots,n.layerManager.updateAirspeedLegend(n.airspeedRange.min,n.airspeedRange.max));let r=l.get("airspeed-btn");if(r&&(t?(r.disabled=!1,r.style.opacity=n.airspeedVisible?"1.0":"0.5"):(r.disabled=!0,r.style.opacity="0.3")),await n.dataManager.updateLayers(),n.airportManager.updateAirportMarkerSizes(),n.altitudeVisible&&(n.map.addLayer(n.altitudeLayer),document.getElementById("altitude-legend").style.display="block"),n.airspeedVisible&&(n.map.addLayer(n.airspeedLayer),document.getElementById("airspeed-legend").style.display="block"),n.aviationVisible&&n.config.openaipApiKey&&n.openaipLayers["Aviation Data"]&&n.map.addLayer(n.openaipLayers["Aviation Data"]),n.selectedPathIds.size>0&&n.replayManager.updateReplayButtonState(),n.savedState&&n.savedState.statsPanelVisible){let s=document.getElementById("stats-panel");s.style.display="block",s.offsetHeight,s.classList.add("visible")}}function vt(n,e){let a=null;e.length>0&&(a=e.reduce((t,r)=>{let s=r,o=t,p=s.flight_count??0,c=o?.flight_count??0;return p>c?r:t})),e.forEach(t=>{let r=t.name?t.name.match(/\b([A-Z]{4})\b/):null,s=r?r[1]:"APT",o=a&&t.name===a.name,p=o?" airport-marker-home":"",c=o?" airport-label-home":"",u='<div class="airport-marker-container"><div class="airport-marker'+p+'"></div><div class="airport-label'+c+'">'+s+"</div></div>",f=window.KMLHeatmap.ddToDms(t.lat,!0),b=window.KMLHeatmap.ddToDms(t.lon,!1),T=`https://www.google.com/maps?q=${t.lat},${t.lon}`,g=`
          <div style="
              font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
              min-width: 220px;
              padding: 8px 4px;
              background-color: #2b2b2b;
              color: #ffffff;
          ">
              <div style="
                  font-size: 15px;
                  font-weight: bold;
                  color: #28a745;
                  margin-bottom: 10px;
                  padding-bottom: 8px;
                  border-bottom: 2px solid #28a745;
                  display: flex;
                  align-items: center;
                  gap: 6px;
              ">
                  <span style="font-size: 18px;">\u{1F6EB}</span>
                  <span>${t.name||"Unknown"}</span>
                  ${o?'<span style="font-size: 12px; background: #007bff; color: white; padding: 2px 6px; border-radius: 3px; margin-left: 4px;">HOME</span>':""}
              </div>
              <div style="margin-bottom: 8px;">
                  <div style="font-size: 11px; color: #999; margin-bottom: 2px; text-transform: uppercase; letter-spacing: 0.5px;">Coordinates</div>
                  <a href="${T}"
                     target="_blank"
                     style="
                         color: #4facfe;
                         text-decoration: none;
                         font-size: 12px;
                         font-family: monospace;
                         display: flex;
                         align-items: center;
                         gap: 4px;
                     "
                     onmouseover="this.style.textDecoration='underline'"
                     onmouseout="this.style.textDecoration='none'">
                      <span>\u{1F4CD}</span>
                      <span>${f}<br>${b}</span>
                  </a>
              </div>
              <div style="
                  background: linear-gradient(135deg, rgba(79, 172, 254, 0.15) 0%, rgba(0, 242, 254, 0.15) 100%);
                  padding: 8px 10px;
                  border-radius: 6px;
                  border-left: 3px solid #4facfe;
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
              ">
                  <span style="font-size: 12px; color: #ccc; font-weight: 500;">Total Flights</span>
                  <span style="font-size: 16px; font-weight: bold; color: #4facfe;">${t.flight_count||0}</span>
              </div>
          </div>`,A=$e.marker([t.lat,t.lon],{icon:$e.divIcon({html:u,iconSize:[12,12],iconAnchor:[6,6],popupAnchor:[0,-6],className:""})}).bindPopup(g,{autoPanPadding:[50,50]});A.on("click",v=>{n.replayManager.replayActive||n.pathSelection.selectPathsByAirport(t.name)}),A.addTo(n.airportLayer),n.airportMarkers[t.name]=A})}var Ze=class{constructor(e){this.config=e,this.selectedYear="all",this.selectedAircraft="all",this.allAirportsData=[],this.isInitializing=!0,this.map=null,this.heatmapLayer=null,this.altitudeLayer=z.layerGroup(),this.airspeedLayer=z.layerGroup(),this.airportLayer=z.layerGroup(),this.altitudeRenderer=z.svg(),this.airspeedRenderer=z.svg(),this.currentData=null,this.fullStats=null,this.fullPathInfo=null,this.fullPathSegments=null,this.altitudeRange={min:0,max:1e4},this.airspeedRange={min:0,max:200},this.heatmapVisible=!0,this.altitudeVisible=!1,this.airspeedVisible=!1,this.airportsVisible=!0,this.aviationVisible=!1,this.buttonsHidden=!1,this.selectedPathIds=new Set,this.pathSegments={},this.pathToAirports={},this.airportToPaths={},this.airportMarkers={},this.openaipLayers={},this.savedState=null,this.restoredYearFromState=!1,this.stateManager=null,this.dataManager=null,this.layerManager=null,this.filterManager=null,this.statsManager=null,this.pathSelection=null,this.airportManager=null,this.replayManager=null,this.wrappedManager=null,this.uiToggles=null}async initialize(){if(this.stateManager=new Ie(this),this.savedState=this.stateManager.loadState(),this.savedState&&(this.savedState.selectedYear!==void 0&&(this.selectedYear=this.savedState.selectedYear,this.restoredYearFromState=!0),this.savedState.selectedAircraft&&(this.selectedAircraft=this.savedState.selectedAircraft),this.savedState.selectedPathIds&&this.savedState.selectedPathIds.length>0&&this.savedState.selectedPathIds.forEach(e=>{let a=typeof e=="string"?parseInt(e,10):e;this.selectedPathIds.add(a)}),this.savedState.heatmapVisible!==void 0&&(this.heatmapVisible=this.savedState.heatmapVisible),this.savedState.altitudeVisible!==void 0&&(this.altitudeVisible=this.savedState.altitudeVisible),this.savedState.airspeedVisible!==void 0&&(this.airspeedVisible=this.savedState.airspeedVisible),this.savedState.airportsVisible!==void 0&&(this.airportsVisible=this.savedState.airportsVisible),this.savedState.aviationVisible!==void 0&&(this.aviationVisible=this.savedState.aviationVisible),this.savedState.buttonsHidden!==void 0&&(this.buttonsHidden=this.savedState.buttonsHidden)),this.map=z.map("map",{center:this.config.center,zoom:10,zoomSnap:.25,zoomDelta:.25,wheelPxPerZoomLevel:120,preferCanvas:!0}),this.config.stadiaApiKey?z.tileLayer("https://tiles.stadiamaps.com/tiles/alidade_smooth_dark/{z}/{x}/{y}{r}.png?api_key="+this.config.stadiaApiKey,{attribution:'&copy; <a href="https://stadiamaps.com/">Stadia Maps</a>'}).addTo(this.map):z.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png",{attribution:"&copy; OpenStreetMap contributors, &copy; CARTO"}).addTo(this.map),this.savedState&&this.savedState.center&&this.savedState.zoom?this.map.setView([this.savedState.center.lat,this.savedState.center.lng],this.savedState.zoom):this.map.fitBounds(this.config.bounds,{padding:[30,30]}),this.config.openaipApiKey&&(this.openaipLayers["Aviation Data"]=z.tileLayer("https://{s}.api.tiles.openaip.net/api/data/openaip/{z}/{x}/{y}.png?apiKey="+this.config.openaipApiKey,{attribution:'&copy; <a href="https://www.openaip.net">OpenAIP</a>',maxZoom:18,minZoom:7,subdomains:["a","b","c"]})),this.airportsVisible&&this.airportLayer.addTo(this.map),document.getElementById("heatmap-btn").style.opacity=this.heatmapVisible?"1.0":"0.5",document.getElementById("altitude-btn").style.opacity=this.altitudeVisible?"1.0":"0.5",document.getElementById("airspeed-btn").style.opacity=this.airspeedVisible?"1.0":"0.5",document.getElementById("airports-btn").style.opacity=this.airportsVisible?"1.0":"0.5",document.getElementById("aviation-btn").style.opacity=this.aviationVisible?"1.0":"0.5",this.config.openaipApiKey&&(document.getElementById("aviation-btn").style.display="block"),this.dataManager=new De(this),this.layerManager=new Oe(this),this.filterManager=new He(this),this.statsManager=new Be(this),this.pathSelection=new Ve(this),this.airportManager=new Ue(this),this.replayManager=new Ge(this),this.wrappedManager=new Ke(this),this.uiToggles=new We(this),await this.loadInitialData(),this.setupEventHandlers(),this.isInitializing=!1,this.savedState&&this.savedState.buttonsHidden){let e=document.querySelectorAll(".toggleable-btn"),a=document.getElementById("hide-buttons-btn");e.forEach(t=>{t.classList.add("buttons-hidden")}),a&&(a.textContent="\u{1F53D}")}this.savedState&&this.savedState.wrappedVisible&&setTimeout(()=>{this.wrappedManager&&this.wrappedManager.showWrapped()},500),this.stateManager.saveMapState()}async loadInitialData(){await ua(this)}createAirportMarkers(e){vt(this,e)}setupEventHandlers(){this.map.on("moveend",()=>this.stateManager.saveMapState()),this.map.on("zoomend",()=>{this.stateManager.saveMapState(),this.airportManager.updateAirportMarkerSizes()}),this.map.on("click",e=>{this.replayManager.replayActive&&this.replayManager.replayAirplaneMarker&&this.replayManager.replayAirplaneMarker.isPopupOpen()&&this.replayManager.replayAirplaneMarker.closePopup(),!this.replayManager.replayActive&&this.selectedPathIds.size>0&&this.pathSelection.clearSelection()})}toggleHeatmap(){this.uiToggles.toggleHeatmap()}toggleStats(){this.statsManager.toggleStats()}toggleAltitude(){this.uiToggles.toggleAltitude()}toggleAirspeed(){this.uiToggles.toggleAirspeed()}toggleAirports(){this.uiToggles.toggleAirports()}toggleAviation(){this.uiToggles.toggleAviation()}toggleReplay(){this.replayManager.toggleReplay()}filterByYear(){this.filterManager.filterByYear()}filterByAircraft(){this.filterManager.filterByAircraft()}togglePathSelection(e){this.pathSelection.togglePathSelection(Number(e))}exportMap(){this.uiToggles.exportMap()}showWrapped(){this.wrappedManager.showWrapped()}closeWrapped(e){this.wrappedManager.closeWrapped(e)}toggleButtonsVisibility(){this.uiToggles.toggleButtonsVisibility()}playReplay(){this.replayManager.playReplay()}pauseReplay(){this.replayManager.pauseReplay()}stopReplay(){this.replayManager.stopReplay()}seekReplay(e){this.replayManager.seekReplay(e)}changeReplaySpeed(){this.replayManager.changeReplaySpeed()}toggleAutoZoom(){this.replayManager.toggleAutoZoom()}};typeof window<"u"&&(window.initMapApp=async n=>{let e=new Ze(n);return window.mapApp=e,await e.initialize(),window.toggleHeatmap=()=>e.toggleHeatmap(),window.toggleStats=()=>e.toggleStats(),window.toggleAltitude=()=>e.toggleAltitude(),window.toggleAirspeed=()=>e.toggleAirspeed(),window.toggleAirports=()=>e.toggleAirports(),window.toggleAviation=()=>e.toggleAviation(),window.toggleReplay=()=>e.toggleReplay(),window.filterByYear=()=>e.filterByYear(),window.filterByAircraft=()=>e.filterByAircraft(),window.togglePathSelection=a=>e.togglePathSelection(a),window.exportMap=()=>e.exportMap(),window.showWrapped=()=>e.showWrapped(),window.closeWrapped=a=>e.closeWrapped(a),window.toggleButtonsVisibility=()=>e.toggleButtonsVisibility(),window.playReplay=()=>e.playReplay(),window.pauseReplay=()=>e.pauseReplay(),window.stopReplay=()=>e.stopReplay(),window.seekReplay=a=>e.seekReplay(a),window.changeReplaySpeed=()=>e.changeReplaySpeed(),window.toggleAutoZoom=()=>e.toggleAutoZoom(),e});typeof window<"u"&&window.MAP_CONFIG&&window.initMapApp&&window.initMapApp(window.MAP_CONFIG);return Ia(ii);})();
/*! Bundled license information:

dompurify/dist/purify.es.mjs:
  (*! @license DOMPurify 3.3.1 | (c) Cure53 and other contributors | Released under the Apache license 2.0 and Mozilla Public License 2.0 | github.com/cure53/DOMPurify/blob/3.3.1/LICENSE *)
*/
