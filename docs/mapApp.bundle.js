"use strict";var MapAppModule=(()=>{var ua=Object.create;var Pe=Object.defineProperty;var fa=Object.getOwnPropertyDescriptor;var ga=Object.getOwnPropertyNames;var ya=Object.getPrototypeOf,Ma=Object.prototype.hasOwnProperty;var ba=(c,e)=>()=>(e||c((e={exports:{}}).exports,e),e.exports),Aa=(c,e)=>{for(var t in e)Pe(c,t,{get:e[t],enumerable:!0})},Vt=(c,e,t,a)=>{if(e&&typeof e=="object"||typeof e=="function")for(let r of ga(e))!Ma.call(c,r)&&r!==t&&Pe(c,r,{get:()=>e[r],enumerable:!(a=fa(e,r))||a.enumerable});return c};var Re=(c,e,t)=>(t=c!=null?ua(ya(c)):{},Vt(e||!c||!c.__esModule?Pe(t,"default",{value:c,enumerable:!0}):t,c)),va=c=>Vt(Pe({},"__esModule",{value:!0}),c);var ue=ba((Ka,Ut)=>{Ut.exports=window.L});var Ya={};Aa(Ya,{MapApp:()=>Ge});var F=Re(ue(),1);var nt=class{constructor(){this.cache=new Map}get(e){if(this.cache.has(e)){let a=this.cache.get(e);if(document.contains(a))return a;this.cache.delete(e)}let t=document.getElementById(e);return t&&this.cache.set(e,t),t}cacheElements(e){e.forEach(t=>{let a=document.getElementById(t);a&&this.cache.set(t,a)})}clear(){this.cache.clear()}remove(e){this.cache.delete(e)}has(e){return this.cache.has(e)}get size(){return this.cache.size}},n=new nt;var Ce=class{constructor(e){this.app=e,n.cacheElements(["loading"]),this.dataLoader=new window.KMLHeatmap.DataLoader({dataDir:e.config.dataDir,showLoading:()=>this.showLoading(),hideLoading:()=>this.hideLoading()}),this.loadedData={},this.currentData=null}showLoading(){let e=n.get("loading");e&&(e.style.display="block")}hideLoading(){let e=n.get("loading");e&&(e.style.display="none")}async loadData(e,t){return await this.dataLoader.loadData(e,t)}async loadAirports(){return await this.dataLoader.loadAirports()}async loadMetadata(){return await this.dataLoader.loadMetadata()}async updateLayers(){if(!this.app.map)return;let e=this.app.map.getZoom(),t=window.KMLHeatmap.getResolutionForZoom(e);if(t===this.app.currentResolution)return;this.app.currentResolution=t;let a=await this.loadData(t,this.app.selectedYear);if(!a)return;this.currentData=a,this.app.currentData=a;let r=a.coordinates;if((this.app.selectedYear!=="all"||this.app.selectedAircraft!=="all")&&a.path_segments){let s=new Set;a.path_info&&a.path_info.forEach(p=>{let d=this.app.selectedYear==="all"||p.year&&p.year.toString()===this.app.selectedYear,h=this.app.selectedAircraft==="all"||p.aircraft_registration===this.app.selectedAircraft;d&&h&&s.add(p.id)});let o=new Set;a.path_segments.forEach(p=>{if(s.has(p.path_id)){let d=p.coords;d&&d.length===2&&(o.add(JSON.stringify(d[0])),o.add(JSON.stringify(d[1])))}}),r=Array.from(o).map(p=>JSON.parse(p))}if(this.app.heatmapLayer&&this.app.map.removeLayer(this.app.heatmapLayer),this.app.heatmapLayer=L.heatLayer(r,{radius:10,blur:15,minOpacity:.25,maxOpacity:.6,max:1,gradient:{0:"blue",.3:"cyan",.5:"lime",.7:"yellow",1:"red"}}),this.app.heatmapLayer.e&&(this.app.heatmapLayer.e.style.pointerEvents="none"),this.app.heatmapVisible&&!this.app.replayManager.replayActive&&this.app.heatmapLayer.addTo(this.app.map),this.app.pathToAirports={},this.app.airportToPaths={},a.path_info&&a.path_info.forEach(s=>{let o=s.id;this.app.pathToAirports[o]={start:s.start_airport,end:s.end_airport},s.start_airport&&(this.app.airportToPaths[s.start_airport]||(this.app.airportToPaths[s.start_airport]=new Set),this.app.airportToPaths[s.start_airport].add(o)),s.end_airport&&(this.app.airportToPaths[s.end_airport]||(this.app.airportToPaths[s.end_airport]=new Set),this.app.airportToPaths[s.end_airport].add(o))}),a.path_segments&&a.path_segments.length>0){let s=a.path_segments.map(d=>d.altitude_ft||0),o=s[0]??0,p=s[0]??0;for(let d=1;d<s.length;d++){let h=s[d]??0;h<o&&(o=h),h>p&&(p=h)}this.app.altitudeRange.min=o,this.app.altitudeRange.max=p}this.app.layerManager.redrawAltitudePaths(),this.app.airspeedVisible&&this.app.layerManager.redrawAirspeedPaths()}};var ke=class{constructor(e){this.app=e,n.cacheElements(["stats-panel","wrapped-modal"])}saveMapState(){if(!this.app.map)return;let e=n.get("stats-panel"),t=n.get("wrapped-modal"),a={center:this.app.map.getCenter(),zoom:this.app.map.getZoom(),heatmapVisible:this.app.heatmapVisible,altitudeVisible:this.app.altitudeVisible,airspeedVisible:this.app.airspeedVisible,airportsVisible:this.app.airportsVisible,aviationVisible:this.app.aviationVisible,selectedYear:this.app.selectedYear,selectedAircraft:this.app.selectedAircraft,selectedPathIds:Array.from(this.app.selectedPathIds),statsPanelVisible:e?e.classList.contains("visible"):!1,wrappedVisible:t?t.style.display==="flex":!1,buttonsHidden:this.app.buttonsHidden};try{localStorage.setItem("kml-heatmap-state",JSON.stringify(a))}catch{}this.updateUrl(a)}loadMapState(){try{let e=localStorage.getItem("kml-heatmap-state");if(e)return JSON.parse(e)}catch{}return null}updateUrl(e){let t=window.KMLHeatmap.encodeStateToUrl(e),a=t?"?"+t:window.location.pathname;try{history.replaceState(null,"",a)}catch{}}loadState(){let e=window.KMLHeatmap.parseUrlParams(new URLSearchParams(window.location.search));return e&&Object.keys(e).length>0?e:this.loadMapState()}};var de=Re(ue(),1);var De=class{constructor(e){this.app=e,n.cacheElements(["legend-min","legend-max","airspeed-legend-min","airspeed-legend-max"])}redrawAltitudePaths(){if(!this.app.currentData)return;this.app.altitudeLayer.clearLayers(),this.app.pathSegments={};let e,t;if(this.app.selectedPathIds.size>0){let a=this.app.currentData.path_segments.filter(r=>this.app.selectedPathIds.has(r.path_id));if(a.length>0){let r=a.map(p=>p.altitude_ft||0),s=r[0]??0,o=r[0]??0;for(let p=1;p<r.length;p++){let d=r[p]??0;d<s&&(s=d),d>o&&(o=d)}e=s,t=o}else e=this.app.altitudeRange.min,t=this.app.altitudeRange.max}else e=this.app.altitudeRange.min,t=this.app.altitudeRange.max;this.app.currentData.path_segments.forEach(a=>{let r=a.path_id,s=this.app.currentData.path_info.find(h=>h.id===r);if(this.app.selectedYear!=="all"&&s&&s.year&&s.year.toString()!==this.app.selectedYear||this.app.selectedAircraft!=="all"&&s&&s.aircraft_registration!==this.app.selectedAircraft)return;let o=this.app.selectedPathIds.has(r);if(this.app.selectedPathIds.size>0&&!o&&this.app.buttonsHidden)return;let p=window.KMLHeatmap.getColorForAltitude(a.altitude_ft??0,e,t);de.polyline(a.coords||[],{color:p,weight:o?6:4,opacity:o?1:this.app.selectedPathIds.size>0?.1:.85,renderer:this.app.altitudeRenderer,interactive:!0}).bindPopup("Altitude: "+a.altitude_ft+" ft ("+a.altitude_m+" m)").addTo(this.app.altitudeLayer).on("click",h=>{de.DomEvent.stopPropagation(h),this.app.pathSelection.togglePathSelection(r)}),this.app.pathSegments[r]||(this.app.pathSegments[r]=[]),this.app.pathSegments[r].push(a)}),this.updateAltitudeLegend(e,t),this.app.airportManager.updateAirportOpacity(),this.app.statsManager.updateStatsForSelection()}redrawAirspeedPaths(){if(!this.app.currentData)return;this.app.airspeedLayer.clearLayers();let e,t;if(this.app.selectedPathIds.size>0){let a=this.app.currentData.path_segments.filter(r=>this.app.selectedPathIds.has(r.path_id)&&(r.groundspeed_knots||0)>0);if(a.length>0){let r=a.map(p=>p.groundspeed_knots||0),s=r[0]??0,o=r[0]??0;for(let p=1;p<r.length;p++){let d=r[p]??0;d<s&&(s=d),d>o&&(o=d)}e=s,t=o}else e=this.app.airspeedRange.min,t=this.app.airspeedRange.max}else e=this.app.airspeedRange.min,t=this.app.airspeedRange.max;this.app.currentData.path_segments.forEach(a=>{let r=a.path_id,s=this.app.currentData.path_info.find(o=>o.id===r);if(!(this.app.selectedYear!=="all"&&s&&s.year&&s.year.toString()!==this.app.selectedYear)&&!(this.app.selectedAircraft!=="all"&&s&&s.aircraft_registration!==this.app.selectedAircraft)&&(a.groundspeed_knots||0)>0){let o=this.app.selectedPathIds.has(r);if(this.app.selectedPathIds.size>0&&!o&&this.app.buttonsHidden)return;let p=window.KMLHeatmap.getColorForAirspeed(a.groundspeed_knots??0,e,t),d=Math.round((a.groundspeed_knots||0)*1.852);de.polyline(a.coords||[],{color:p,weight:o?6:4,opacity:o?1:this.app.selectedPathIds.size>0?.1:.85,renderer:this.app.airspeedRenderer,interactive:!0}).bindPopup("Groundspeed: "+a.groundspeed_knots+" kt ("+d+" km/h)").addTo(this.app.airspeedLayer).on("click",g=>{de.DomEvent.stopPropagation(g),this.app.pathSelection.togglePathSelection(r)})}}),this.updateAirspeedLegend(e,t),this.app.airportManager.updateAirportOpacity(),this.app.statsManager.updateStatsForSelection()}updateAltitudeLegend(e,t){let a=Math.round(e),r=Math.round(t),s=Math.round(e*.3048),o=Math.round(t*.3048),p=n.get("legend-min"),d=n.get("legend-max");p&&(p.textContent=a.toLocaleString()+" ft ("+s.toLocaleString()+" m)"),d&&(d.textContent=r.toLocaleString()+" ft ("+o.toLocaleString()+" m)")}updateAirspeedLegend(e,t){let a=Math.round(e),r=Math.round(t),s=Math.round(e*1.852),o=Math.round(t*1.852),p=n.get("airspeed-legend-min"),d=n.get("airspeed-legend-max");p&&(p.textContent=a.toLocaleString()+" kt ("+s.toLocaleString()+" km/h)"),d&&(d.textContent=r.toLocaleString()+" kt ("+o.toLocaleString()+" km/h)")}};var Ie=class{constructor(e){this.app=e,n.cacheElements(["aircraft-select","year-select"])}updateAircraftDropdown(){if(!this.app.fullPathInfo)return;let e=n.get("aircraft-select");if(!e)return;let t=this.app.selectedAircraft;for(;e.options.length>1;)e.remove(1);let a;this.app.selectedYear==="all"?a=this.app.fullPathInfo:a=this.app.fullPathInfo.filter(p=>p.year&&p.year.toString()===this.app.selectedYear);let r={};a.forEach(p=>{if(p.aircraft_registration){let d=p.aircraft_registration;r[d]||(r[d]={registration:d,type:p.aircraft_type,flights:0}),r[d].flights+=1}});let s=Object.values(r).sort((p,d)=>d.flights-p.flights),o=!1;s.forEach(p=>{let d=document.createElement("option");d.value=p.registration;let h=p.type?" ("+p.type+")":"";d.textContent="\u2708\uFE0F "+p.registration+h,e.appendChild(d),p.registration===t&&(o=!0)}),!o&&t!=="all"?(this.app.selectedAircraft="all",e.value="all"):e.value=t}async filterByYear(){let e=n.get("year-select");if(!e)return;this.app.selectedYear=e.value,this.app.dataManager.loadedData={},this.app.currentResolution=null,this.app.altitudeLayer.clearLayers(),this.app.pathSegments={},this.app.isInitializing||this.app.selectedPathIds.clear(),await this.app.dataManager.updateLayers();let t=await this.app.dataManager.loadData("z14_plus",this.app.selectedYear);t&&(this.app.fullPathInfo=t.path_info||[],this.app.fullPathSegments=t.path_segments||[]),this.updateAircraftDropdown();let a=window.KMLHeatmap.calculateFilteredStatistics({pathInfo:this.app.fullPathInfo??[],segments:this.app.fullPathSegments??[],year:this.app.selectedYear,aircraft:this.app.selectedAircraft});this.app.statsManager.updateStatsPanel(a,!1),this.app.airportManager.updateAirportOpacity(),this.app.airportManager.updateAirportPopups(),this.app.isInitializing||this.app.stateManager.saveMapState()}async filterByAircraft(){let e=n.get("aircraft-select");if(!e)return;this.app.selectedAircraft=e.value,this.app.altitudeLayer.clearLayers(),this.app.pathSegments={},this.app.isInitializing||this.app.selectedPathIds.clear(),this.app.currentResolution=null,await this.app.dataManager.updateLayers();let t=window.KMLHeatmap.calculateFilteredStatistics({pathInfo:this.app.fullPathInfo??[],segments:this.app.fullPathSegments??[],year:this.app.selectedYear,aircraft:this.app.selectedAircraft});this.app.statsManager.updateStatsPanel(t,!1),this.app.airportManager.updateAirportOpacity(),this.app.airportManager.updateAirportPopups(),this.app.isInitializing||this.app.stateManager.saveMapState()}};var{entries:Xt,setPrototypeOf:Yt,isFrozen:Sa,getPrototypeOf:La,getOwnPropertyDescriptor:_a}=Object,{freeze:B,seal:G,create:mt}=Object,{apply:ut,construct:ft}=typeof Reflect<"u"&&Reflect;B||(B=function(e){return e});G||(G=function(e){return e});ut||(ut=function(e,t){for(var a=arguments.length,r=new Array(a>2?a-2:0),s=2;s<a;s++)r[s-2]=arguments[s];return e.apply(t,r)});ft||(ft=function(e){for(var t=arguments.length,a=new Array(t>1?t-1:0),r=1;r<t;r++)a[r-1]=arguments[r];return new e(...a)});var Oe=V(Array.prototype.forEach),Ta=V(Array.prototype.lastIndexOf),Gt=V(Array.prototype.pop),fe=V(Array.prototype.push),wa=V(Array.prototype.splice),He=V(String.prototype.toLowerCase),ot=V(String.prototype.toString),pt=V(String.prototype.match),ge=V(String.prototype.replace),xa=V(String.prototype.indexOf),Ea=V(String.prototype.trim),K=V(Object.prototype.hasOwnProperty),z=V(RegExp.prototype.test),ye=Pa(TypeError);function V(c){return function(e){e instanceof RegExp&&(e.lastIndex=0);for(var t=arguments.length,a=new Array(t>1?t-1:0),r=1;r<t;r++)a[r-1]=arguments[r];return ut(c,e,a)}}function Pa(c){return function(){for(var e=arguments.length,t=new Array(e),a=0;a<e;a++)t[a]=arguments[a];return ft(c,t)}}function M(c,e){let t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:He;Yt&&Yt(c,null);let a=e.length;for(;a--;){let r=e[a];if(typeof r=="string"){let s=t(r);s!==r&&(Sa(e)||(e[a]=s),r=s)}c[r]=!0}return c}function Ra(c){for(let e=0;e<c.length;e++)K(c,e)||(c[e]=null);return c}function Z(c){let e=mt(null);for(let[t,a]of Xt(c))K(c,t)&&(Array.isArray(a)?e[t]=Ra(a):a&&typeof a=="object"&&a.constructor===Object?e[t]=Z(a):e[t]=a);return e}function Me(c,e){for(;c!==null;){let a=_a(c,e);if(a){if(a.get)return V(a.get);if(typeof a.value=="function")return V(a.value)}c=La(c)}function t(){return null}return t}var Kt=B(["a","abbr","acronym","address","area","article","aside","audio","b","bdi","bdo","big","blink","blockquote","body","br","button","canvas","caption","center","cite","code","col","colgroup","content","data","datalist","dd","decorator","del","details","dfn","dialog","dir","div","dl","dt","element","em","fieldset","figcaption","figure","font","footer","form","h1","h2","h3","h4","h5","h6","head","header","hgroup","hr","html","i","img","input","ins","kbd","label","legend","li","main","map","mark","marquee","menu","menuitem","meter","nav","nobr","ol","optgroup","option","output","p","picture","pre","progress","q","rp","rt","ruby","s","samp","search","section","select","shadow","slot","small","source","spacer","span","strike","strong","style","sub","summary","sup","table","tbody","td","template","textarea","tfoot","th","thead","time","tr","track","tt","u","ul","var","video","wbr"]),lt=B(["svg","a","altglyph","altglyphdef","altglyphitem","animatecolor","animatemotion","animatetransform","circle","clippath","defs","desc","ellipse","enterkeyhint","exportparts","filter","font","g","glyph","glyphref","hkern","image","inputmode","line","lineargradient","marker","mask","metadata","mpath","part","path","pattern","polygon","polyline","radialgradient","rect","stop","style","switch","symbol","text","textpath","title","tref","tspan","view","vkern"]),dt=B(["feBlend","feColorMatrix","feComponentTransfer","feComposite","feConvolveMatrix","feDiffuseLighting","feDisplacementMap","feDistantLight","feDropShadow","feFlood","feFuncA","feFuncB","feFuncG","feFuncR","feGaussianBlur","feImage","feMerge","feMergeNode","feMorphology","feOffset","fePointLight","feSpecularLighting","feSpotLight","feTile","feTurbulence"]),Ca=B(["animate","color-profile","cursor","discard","font-face","font-face-format","font-face-name","font-face-src","font-face-uri","foreignobject","hatch","hatchpath","mesh","meshgradient","meshpatch","meshrow","missing-glyph","script","set","solidcolor","unknown","use"]),ct=B(["math","menclose","merror","mfenced","mfrac","mglyph","mi","mlabeledtr","mmultiscripts","mn","mo","mover","mpadded","mphantom","mroot","mrow","ms","mspace","msqrt","mstyle","msub","msup","msubsup","mtable","mtd","mtext","mtr","munder","munderover","mprescripts"]),ka=B(["maction","maligngroup","malignmark","mlongdiv","mscarries","mscarry","msgroup","mstack","msline","msrow","semantics","annotation","annotation-xml","mprescripts","none"]),Wt=B(["#text"]),$t=B(["accept","action","align","alt","autocapitalize","autocomplete","autopictureinpicture","autoplay","background","bgcolor","border","capture","cellpadding","cellspacing","checked","cite","class","clear","color","cols","colspan","controls","controlslist","coords","crossorigin","datetime","decoding","default","dir","disabled","disablepictureinpicture","disableremoteplayback","download","draggable","enctype","enterkeyhint","exportparts","face","for","headers","height","hidden","high","href","hreflang","id","inert","inputmode","integrity","ismap","kind","label","lang","list","loading","loop","low","max","maxlength","media","method","min","minlength","multiple","muted","name","nonce","noshade","novalidate","nowrap","open","optimum","part","pattern","placeholder","playsinline","popover","popovertarget","popovertargetaction","poster","preload","pubdate","radiogroup","readonly","rel","required","rev","reversed","role","rows","rowspan","spellcheck","scope","selected","shape","size","sizes","slot","span","srclang","start","src","srcset","step","style","summary","tabindex","title","translate","type","usemap","valign","value","width","wrap","xmlns","slot"]),ht=B(["accent-height","accumulate","additive","alignment-baseline","amplitude","ascent","attributename","attributetype","azimuth","basefrequency","baseline-shift","begin","bias","by","class","clip","clippathunits","clip-path","clip-rule","color","color-interpolation","color-interpolation-filters","color-profile","color-rendering","cx","cy","d","dx","dy","diffuseconstant","direction","display","divisor","dur","edgemode","elevation","end","exponent","fill","fill-opacity","fill-rule","filter","filterunits","flood-color","flood-opacity","font-family","font-size","font-size-adjust","font-stretch","font-style","font-variant","font-weight","fx","fy","g1","g2","glyph-name","glyphref","gradientunits","gradienttransform","height","href","id","image-rendering","in","in2","intercept","k","k1","k2","k3","k4","kerning","keypoints","keysplines","keytimes","lang","lengthadjust","letter-spacing","kernelmatrix","kernelunitlength","lighting-color","local","marker-end","marker-mid","marker-start","markerheight","markerunits","markerwidth","maskcontentunits","maskunits","max","mask","mask-type","media","method","mode","min","name","numoctaves","offset","operator","opacity","order","orient","orientation","origin","overflow","paint-order","path","pathlength","patterncontentunits","patterntransform","patternunits","points","preservealpha","preserveaspectratio","primitiveunits","r","rx","ry","radius","refx","refy","repeatcount","repeatdur","restart","result","rotate","scale","seed","shape-rendering","slope","specularconstant","specularexponent","spreadmethod","startoffset","stddeviation","stitchtiles","stop-color","stop-opacity","stroke-dasharray","stroke-dashoffset","stroke-linecap","stroke-linejoin","stroke-miterlimit","stroke-opacity","stroke","stroke-width","style","surfacescale","systemlanguage","tabindex","tablevalues","targetx","targety","transform","transform-origin","text-anchor","text-decoration","text-rendering","textlength","type","u1","u2","unicode","values","viewbox","visibility","version","vert-adv-y","vert-origin-x","vert-origin-y","width","word-spacing","wrap","writing-mode","xchannelselector","ychannelselector","x","x1","x2","xmlns","y","y1","y2","z","zoomandpan"]),Zt=B(["accent","accentunder","align","bevelled","close","columnsalign","columnlines","columnspan","denomalign","depth","dir","display","displaystyle","encoding","fence","frame","height","href","id","largeop","length","linethickness","lspace","lquote","mathbackground","mathcolor","mathsize","mathvariant","maxsize","minsize","movablelimits","notation","numalign","open","rowalign","rowlines","rowspacing","rowspan","rspace","rquote","scriptlevel","scriptminsize","scriptsizemultiplier","selection","separator","separators","stretchy","subscriptshift","supscriptshift","symmetric","voffset","width","xmlns"]),Fe=B(["xlink:href","xml:id","xlink:title","xml:space","xmlns:xlink"]),Da=G(/\{\{[\w\W]*|[\w\W]*\}\}/gm),Ia=G(/<%[\w\W]*|[\w\W]*%>/gm),Oa=G(/\$\{[\w\W]*/gm),Fa=G(/^data-[\-\w.\u00B7-\uFFFF]+$/),Ha=G(/^aria-[\-\w]+$/),Jt=G(/^(?:(?:(?:f|ht)tps?|mailto|tel|callto|sms|cid|xmpp|matrix):|[^a-z]|[a-z+.\-]+(?:[^a-z+.\-:]|$))/i),Na=G(/^(?:\w+script|data):/i),za=G(/[\u0000-\u0020\u00A0\u1680\u180E\u2000-\u2029\u205F\u3000]/g),Qt=G(/^html$/i),Ba=G(/^[a-z][.\w]*(-[.\w]+)+$/i),jt=Object.freeze({__proto__:null,ARIA_ATTR:Ha,ATTR_WHITESPACE:za,CUSTOM_ELEMENT:Ba,DATA_ATTR:Fa,DOCTYPE_NAME:Qt,ERB_EXPR:Ia,IS_ALLOWED_URI:Jt,IS_SCRIPT_OR_DATA:Na,MUSTACHE_EXPR:Da,TMPLIT_EXPR:Oa}),be={element:1,attribute:2,text:3,cdataSection:4,entityReference:5,entityNode:6,progressingInstruction:7,comment:8,document:9,documentType:10,documentFragment:11,notation:12},Va=function(){return typeof window>"u"?null:window},Ua=function(e,t){if(typeof e!="object"||typeof e.createPolicy!="function")return null;let a=null,r="data-tt-policy-suffix";t&&t.hasAttribute(r)&&(a=t.getAttribute(r));let s="dompurify"+(a?"#"+a:"");try{return e.createPolicy(s,{createHTML(o){return o},createScriptURL(o){return o}})}catch{return null}},qt=function(){return{afterSanitizeAttributes:[],afterSanitizeElements:[],afterSanitizeShadowDOM:[],beforeSanitizeAttributes:[],beforeSanitizeElements:[],beforeSanitizeShadowDOM:[],uponSanitizeAttribute:[],uponSanitizeElement:[],uponSanitizeShadowNode:[]}};function ea(){let c=arguments.length>0&&arguments[0]!==void 0?arguments[0]:Va(),e=f=>ea(f);if(e.version="3.3.1",e.removed=[],!c||!c.document||c.document.nodeType!==be.document||!c.Element)return e.isSupported=!1,e;let{document:t}=c,a=t,r=a.currentScript,{DocumentFragment:s,HTMLTemplateElement:o,Node:p,Element:d,NodeFilter:h,NamedNodeMap:g=c.NamedNodeMap||c.MozNamedAttrMap,HTMLFormElement:v,DOMParser:A,trustedTypes:b}=c,m=d.prototype,y=Me(m,"cloneNode"),E=Me(m,"remove"),T=Me(m,"nextSibling"),S=Me(m,"childNodes"),w=Me(m,"parentNode");if(typeof o=="function"){let f=t.createElement("template");f.content&&f.content.ownerDocument&&(t=f.content.ownerDocument)}let x,P="",{implementation:U,createNodeIterator:ae,createDocumentFragment:Ae,getElementsByTagName:ve}=t,{importNode:ta}=a,N=qt();e.isSupported=typeof Xt=="function"&&typeof w=="function"&&U&&U.createHTMLDocument!==void 0;let{MUSTACHE_EXPR:Ke,ERB_EXPR:We,TMPLIT_EXPR:$e,DATA_ATTR:aa,ARIA_ATTR:ia,IS_SCRIPT_OR_DATA:ra,ATTR_WHITESPACE:yt,CUSTOM_ELEMENT:sa}=jt,{IS_ALLOWED_URI:Mt}=jt,D=null,bt=M({},[...Kt,...lt,...dt,...ct,...Wt]),I=null,At=M({},[...$t,...ht,...Zt,...Fe]),R=Object.seal(mt(null,{tagNameCheck:{writable:!0,configurable:!1,enumerable:!0,value:null},attributeNameCheck:{writable:!0,configurable:!1,enumerable:!0,value:null},allowCustomizedBuiltInElements:{writable:!0,configurable:!1,enumerable:!0,value:!1}})),ce=null,Ze=null,ie=Object.seal(mt(null,{tagCheck:{writable:!0,configurable:!1,enumerable:!0,value:null},attributeCheck:{writable:!0,configurable:!1,enumerable:!0,value:null}})),vt=!0,je=!0,St=!1,Lt=!0,re=!1,Se=!0,ee=!1,qe=!1,Xe=!1,se=!1,Le=!1,_e=!1,_t=!0,Tt=!1,na="user-content-",Je=!0,he=!1,ne={},W=null,Qe=M({},["annotation-xml","audio","colgroup","desc","foreignobject","head","iframe","math","mi","mn","mo","ms","mtext","noembed","noframes","noscript","plaintext","script","style","svg","template","thead","title","video","xmp"]),wt=null,xt=M({},["audio","video","img","source","image","track"]),et=null,Et=M({},["alt","class","for","id","label","name","pattern","placeholder","role","summary","title","value","style","xmlns"]),Te="http://www.w3.org/1998/Math/MathML",we="http://www.w3.org/2000/svg",q="http://www.w3.org/1999/xhtml",oe=q,tt=!1,at=null,oa=M({},[Te,we,q],ot),xe=M({},["mi","mo","mn","ms","mtext"]),Ee=M({},["annotation-xml"]),pa=M({},["title","style","font","a","script"]),me=null,la=["application/xhtml+xml","text/html"],da="text/html",k=null,pe=null,ca=t.createElement("form"),Pt=function(i){return i instanceof RegExp||i instanceof Function},it=function(){let i=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};if(!(pe&&pe===i)){if((!i||typeof i!="object")&&(i={}),i=Z(i),me=la.indexOf(i.PARSER_MEDIA_TYPE)===-1?da:i.PARSER_MEDIA_TYPE,k=me==="application/xhtml+xml"?ot:He,D=K(i,"ALLOWED_TAGS")?M({},i.ALLOWED_TAGS,k):bt,I=K(i,"ALLOWED_ATTR")?M({},i.ALLOWED_ATTR,k):At,at=K(i,"ALLOWED_NAMESPACES")?M({},i.ALLOWED_NAMESPACES,ot):oa,et=K(i,"ADD_URI_SAFE_ATTR")?M(Z(Et),i.ADD_URI_SAFE_ATTR,k):Et,wt=K(i,"ADD_DATA_URI_TAGS")?M(Z(xt),i.ADD_DATA_URI_TAGS,k):xt,W=K(i,"FORBID_CONTENTS")?M({},i.FORBID_CONTENTS,k):Qe,ce=K(i,"FORBID_TAGS")?M({},i.FORBID_TAGS,k):Z({}),Ze=K(i,"FORBID_ATTR")?M({},i.FORBID_ATTR,k):Z({}),ne=K(i,"USE_PROFILES")?i.USE_PROFILES:!1,vt=i.ALLOW_ARIA_ATTR!==!1,je=i.ALLOW_DATA_ATTR!==!1,St=i.ALLOW_UNKNOWN_PROTOCOLS||!1,Lt=i.ALLOW_SELF_CLOSE_IN_ATTR!==!1,re=i.SAFE_FOR_TEMPLATES||!1,Se=i.SAFE_FOR_XML!==!1,ee=i.WHOLE_DOCUMENT||!1,se=i.RETURN_DOM||!1,Le=i.RETURN_DOM_FRAGMENT||!1,_e=i.RETURN_TRUSTED_TYPE||!1,Xe=i.FORCE_BODY||!1,_t=i.SANITIZE_DOM!==!1,Tt=i.SANITIZE_NAMED_PROPS||!1,Je=i.KEEP_CONTENT!==!1,he=i.IN_PLACE||!1,Mt=i.ALLOWED_URI_REGEXP||Jt,oe=i.NAMESPACE||q,xe=i.MATHML_TEXT_INTEGRATION_POINTS||xe,Ee=i.HTML_INTEGRATION_POINTS||Ee,R=i.CUSTOM_ELEMENT_HANDLING||{},i.CUSTOM_ELEMENT_HANDLING&&Pt(i.CUSTOM_ELEMENT_HANDLING.tagNameCheck)&&(R.tagNameCheck=i.CUSTOM_ELEMENT_HANDLING.tagNameCheck),i.CUSTOM_ELEMENT_HANDLING&&Pt(i.CUSTOM_ELEMENT_HANDLING.attributeNameCheck)&&(R.attributeNameCheck=i.CUSTOM_ELEMENT_HANDLING.attributeNameCheck),i.CUSTOM_ELEMENT_HANDLING&&typeof i.CUSTOM_ELEMENT_HANDLING.allowCustomizedBuiltInElements=="boolean"&&(R.allowCustomizedBuiltInElements=i.CUSTOM_ELEMENT_HANDLING.allowCustomizedBuiltInElements),re&&(je=!1),Le&&(se=!0),ne&&(D=M({},Wt),I=[],ne.html===!0&&(M(D,Kt),M(I,$t)),ne.svg===!0&&(M(D,lt),M(I,ht),M(I,Fe)),ne.svgFilters===!0&&(M(D,dt),M(I,ht),M(I,Fe)),ne.mathMl===!0&&(M(D,ct),M(I,Zt),M(I,Fe))),i.ADD_TAGS&&(typeof i.ADD_TAGS=="function"?ie.tagCheck=i.ADD_TAGS:(D===bt&&(D=Z(D)),M(D,i.ADD_TAGS,k))),i.ADD_ATTR&&(typeof i.ADD_ATTR=="function"?ie.attributeCheck=i.ADD_ATTR:(I===At&&(I=Z(I)),M(I,i.ADD_ATTR,k))),i.ADD_URI_SAFE_ATTR&&M(et,i.ADD_URI_SAFE_ATTR,k),i.FORBID_CONTENTS&&(W===Qe&&(W=Z(W)),M(W,i.FORBID_CONTENTS,k)),i.ADD_FORBID_CONTENTS&&(W===Qe&&(W=Z(W)),M(W,i.ADD_FORBID_CONTENTS,k)),Je&&(D["#text"]=!0),ee&&M(D,["html","head","body"]),D.table&&(M(D,["tbody"]),delete ce.tbody),i.TRUSTED_TYPES_POLICY){if(typeof i.TRUSTED_TYPES_POLICY.createHTML!="function")throw ye('TRUSTED_TYPES_POLICY configuration option must provide a "createHTML" hook.');if(typeof i.TRUSTED_TYPES_POLICY.createScriptURL!="function")throw ye('TRUSTED_TYPES_POLICY configuration option must provide a "createScriptURL" hook.');x=i.TRUSTED_TYPES_POLICY,P=x.createHTML("")}else x===void 0&&(x=Ua(b,r)),x!==null&&typeof P=="string"&&(P=x.createHTML(""));B&&B(i),pe=i}},Rt=M({},[...lt,...dt,...Ca]),Ct=M({},[...ct,...ka]),ha=function(i){let l=w(i);(!l||!l.tagName)&&(l={namespaceURI:oe,tagName:"template"});let u=He(i.tagName),_=He(l.tagName);return at[i.namespaceURI]?i.namespaceURI===we?l.namespaceURI===q?u==="svg":l.namespaceURI===Te?u==="svg"&&(_==="annotation-xml"||xe[_]):!!Rt[u]:i.namespaceURI===Te?l.namespaceURI===q?u==="math":l.namespaceURI===we?u==="math"&&Ee[_]:!!Ct[u]:i.namespaceURI===q?l.namespaceURI===we&&!Ee[_]||l.namespaceURI===Te&&!xe[_]?!1:!Ct[u]&&(pa[u]||!Rt[u]):!!(me==="application/xhtml+xml"&&at[i.namespaceURI]):!1},$=function(i){fe(e.removed,{element:i});try{w(i).removeChild(i)}catch{E(i)}},te=function(i,l){try{fe(e.removed,{attribute:l.getAttributeNode(i),from:l})}catch{fe(e.removed,{attribute:null,from:l})}if(l.removeAttribute(i),i==="is")if(se||Le)try{$(l)}catch{}else try{l.setAttribute(i,"")}catch{}},kt=function(i){let l=null,u=null;if(Xe)i="<remove></remove>"+i;else{let C=pt(i,/^[\r\n\t ]+/);u=C&&C[0]}me==="application/xhtml+xml"&&oe===q&&(i='<html xmlns="http://www.w3.org/1999/xhtml"><head></head><body>'+i+"</body></html>");let _=x?x.createHTML(i):i;if(oe===q)try{l=new A().parseFromString(_,me)}catch{}if(!l||!l.documentElement){l=U.createDocument(oe,"template",null);try{l.documentElement.innerHTML=tt?P:_}catch{}}let H=l.body||l.documentElement;return i&&u&&H.insertBefore(t.createTextNode(u),H.childNodes[0]||null),oe===q?ve.call(l,ee?"html":"body")[0]:ee?l.documentElement:H},Dt=function(i){return ae.call(i.ownerDocument||i,i,h.SHOW_ELEMENT|h.SHOW_COMMENT|h.SHOW_TEXT|h.SHOW_PROCESSING_INSTRUCTION|h.SHOW_CDATA_SECTION,null)},rt=function(i){return i instanceof v&&(typeof i.nodeName!="string"||typeof i.textContent!="string"||typeof i.removeChild!="function"||!(i.attributes instanceof g)||typeof i.removeAttribute!="function"||typeof i.setAttribute!="function"||typeof i.namespaceURI!="string"||typeof i.insertBefore!="function"||typeof i.hasChildNodes!="function")},It=function(i){return typeof p=="function"&&i instanceof p};function X(f,i,l){Oe(f,u=>{u.call(e,i,l,pe)})}let Ot=function(i){let l=null;if(X(N.beforeSanitizeElements,i,null),rt(i))return $(i),!0;let u=k(i.nodeName);if(X(N.uponSanitizeElement,i,{tagName:u,allowedTags:D}),Se&&i.hasChildNodes()&&!It(i.firstElementChild)&&z(/<[/\w!]/g,i.innerHTML)&&z(/<[/\w!]/g,i.textContent)||i.nodeType===be.progressingInstruction||Se&&i.nodeType===be.comment&&z(/<[/\w]/g,i.data))return $(i),!0;if(!(ie.tagCheck instanceof Function&&ie.tagCheck(u))&&(!D[u]||ce[u])){if(!ce[u]&&Ht(u)&&(R.tagNameCheck instanceof RegExp&&z(R.tagNameCheck,u)||R.tagNameCheck instanceof Function&&R.tagNameCheck(u)))return!1;if(Je&&!W[u]){let _=w(i)||i.parentNode,H=S(i)||i.childNodes;if(H&&_){let C=H.length;for(let Y=C-1;Y>=0;--Y){let J=y(H[Y],!0);J.t=(i.t||0)+1,_.insertBefore(J,T(i))}}}return $(i),!0}return i instanceof d&&!ha(i)||(u==="noscript"||u==="noembed"||u==="noframes")&&z(/<\/no(script|embed|frames)/i,i.innerHTML)?($(i),!0):(re&&i.nodeType===be.text&&(l=i.textContent,Oe([Ke,We,$e],_=>{l=ge(l,_," ")}),i.textContent!==l&&(fe(e.removed,{element:i.cloneNode()}),i.textContent=l)),X(N.afterSanitizeElements,i,null),!1)},Ft=function(i,l,u){if(_t&&(l==="id"||l==="name")&&(u in t||u in ca))return!1;if(!(je&&!Ze[l]&&z(aa,l))){if(!(vt&&z(ia,l))){if(!(ie.attributeCheck instanceof Function&&ie.attributeCheck(l,i))){if(!I[l]||Ze[l]){if(!(Ht(i)&&(R.tagNameCheck instanceof RegExp&&z(R.tagNameCheck,i)||R.tagNameCheck instanceof Function&&R.tagNameCheck(i))&&(R.attributeNameCheck instanceof RegExp&&z(R.attributeNameCheck,l)||R.attributeNameCheck instanceof Function&&R.attributeNameCheck(l,i))||l==="is"&&R.allowCustomizedBuiltInElements&&(R.tagNameCheck instanceof RegExp&&z(R.tagNameCheck,u)||R.tagNameCheck instanceof Function&&R.tagNameCheck(u))))return!1}else if(!et[l]){if(!z(Mt,ge(u,yt,""))){if(!((l==="src"||l==="xlink:href"||l==="href")&&i!=="script"&&xa(u,"data:")===0&&wt[i])){if(!(St&&!z(ra,ge(u,yt,"")))){if(u)return!1}}}}}}}return!0},Ht=function(i){return i!=="annotation-xml"&&pt(i,sa)},Nt=function(i){X(N.beforeSanitizeAttributes,i,null);let{attributes:l}=i;if(!l||rt(i))return;let u={attrName:"",attrValue:"",keepAttr:!0,allowedAttributes:I,forceKeepAttr:void 0},_=l.length;for(;_--;){let H=l[_],{name:C,namespaceURI:Y,value:J}=H,le=k(C),st=J,O=C==="value"?st:Ea(st);if(u.attrName=le,u.attrValue=O,u.keepAttr=!0,u.forceKeepAttr=void 0,X(N.uponSanitizeAttribute,i,u),O=u.attrValue,Tt&&(le==="id"||le==="name")&&(te(C,i),O=na+O),Se&&z(/((--!?|])>)|<\/(style|title|textarea)/i,O)){te(C,i);continue}if(le==="attributename"&&pt(O,"href")){te(C,i);continue}if(u.forceKeepAttr)continue;if(!u.keepAttr){te(C,i);continue}if(!Lt&&z(/\/>/i,O)){te(C,i);continue}re&&Oe([Ke,We,$e],Bt=>{O=ge(O,Bt," ")});let zt=k(i.nodeName);if(!Ft(zt,le,O)){te(C,i);continue}if(x&&typeof b=="object"&&typeof b.getAttributeType=="function"&&!Y)switch(b.getAttributeType(zt,le)){case"TrustedHTML":{O=x.createHTML(O);break}case"TrustedScriptURL":{O=x.createScriptURL(O);break}}if(O!==st)try{Y?i.setAttributeNS(Y,C,O):i.setAttribute(C,O),rt(i)?$(i):Gt(e.removed)}catch{te(C,i)}}X(N.afterSanitizeAttributes,i,null)},ma=function f(i){let l=null,u=Dt(i);for(X(N.beforeSanitizeShadowDOM,i,null);l=u.nextNode();)X(N.uponSanitizeShadowNode,l,null),Ot(l),Nt(l),l.content instanceof s&&f(l.content);X(N.afterSanitizeShadowDOM,i,null)};return e.sanitize=function(f){let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},l=null,u=null,_=null,H=null;if(tt=!f,tt&&(f="<!-->"),typeof f!="string"&&!It(f))if(typeof f.toString=="function"){if(f=f.toString(),typeof f!="string")throw ye("dirty is not a string, aborting")}else throw ye("toString is not a function");if(!e.isSupported)return f;if(qe||it(i),e.removed=[],typeof f=="string"&&(he=!1),he){if(f.nodeName){let J=k(f.nodeName);if(!D[J]||ce[J])throw ye("root node is forbidden and cannot be sanitized in-place")}}else if(f instanceof p)l=kt("<!---->"),u=l.ownerDocument.importNode(f,!0),u.nodeType===be.element&&u.nodeName==="BODY"||u.nodeName==="HTML"?l=u:l.appendChild(u);else{if(!se&&!re&&!ee&&f.indexOf("<")===-1)return x&&_e?x.createHTML(f):f;if(l=kt(f),!l)return se?null:_e?P:""}l&&Xe&&$(l.firstChild);let C=Dt(he?f:l);for(;_=C.nextNode();)Ot(_),Nt(_),_.content instanceof s&&ma(_.content);if(he)return f;if(se){if(Le)for(H=Ae.call(l.ownerDocument);l.firstChild;)H.appendChild(l.firstChild);else H=l;return(I.shadowroot||I.shadowrootmode)&&(H=ta.call(a,H,!0)),H}let Y=ee?l.outerHTML:l.innerHTML;return ee&&D["!doctype"]&&l.ownerDocument&&l.ownerDocument.doctype&&l.ownerDocument.doctype.name&&z(Qt,l.ownerDocument.doctype.name)&&(Y="<!DOCTYPE "+l.ownerDocument.doctype.name+`>
`+Y),re&&Oe([Ke,We,$e],J=>{Y=ge(Y,J," ")}),x&&_e?x.createHTML(Y):Y},e.setConfig=function(){let f=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};it(f),qe=!0},e.clearConfig=function(){pe=null,qe=!1},e.isValidAttribute=function(f,i,l){pe||it({});let u=k(f),_=k(i);return Ft(u,_,l)},e.addHook=function(f,i){typeof i=="function"&&fe(N[f],i)},e.removeHook=function(f,i){if(i!==void 0){let l=Ta(N[f],i);return l===-1?void 0:wa(N[f],l,1)[0]}return Gt(N[f])},e.removeHooks=function(f){N[f]=[]},e.removeAllHooks=function(){N=qt()},e}var Q=ea();var Ne=class{constructor(e){this.app=e,n.cacheElements(["stats-panel"])}updateStatsForSelection(){if(this.app.selectedPathIds.size===0){let r=window.KMLHeatmap.calculateFilteredStatistics({pathInfo:this.app.fullPathInfo||[],segments:this.app.fullPathSegments||[],year:this.app.selectedYear,aircraft:this.app.selectedAircraft});r&&this.updateStatsPanel(r,!1);return}let e=(this.app.fullPathInfo||[]).filter(r=>this.app.selectedPathIds.has(r.id)),t=(this.app.fullPathSegments||[]).filter(r=>this.app.selectedPathIds.has(r.path_id));if(t.length===0)return;let a=window.KMLHeatmap.calculateFilteredStatistics({pathInfo:e,segments:t,year:"all",aircraft:"all"});this.updateStatsPanel(a,!0)}updateStatsPanel(e,t){let a="";t?(a+='<p style="margin:0 0 10px 0; font-weight:bold; font-size:15px;">\u{1F4CA} Selected Paths Statistics</p>',a+='<div style="background-color: #3a5a7a; padding: 4px 8px; margin-bottom: 8px; border-radius: 3px; font-size: 11px; color: #a0c0e0;">Showing stats for '+e.num_paths+" selected path(s)</div>"):a+='<p style="margin:0 0 10px 0; font-weight:bold; font-size:15px;">\u{1F4CA} Flight Statistics</p>',a+='<div style="margin-bottom: 8px;"><strong>Data Points:</strong> '+e.total_points.toLocaleString()+"</div>",a+='<div style="margin-bottom: 8px;"><strong>Flights:</strong> '+e.num_paths+"</div>",e.airport_names&&e.airport_names.length>0&&(a+='<div style="margin-bottom: 8px; max-height: 150px; overflow-y: auto;"><strong>Airports ('+e.num_airports+"):</strong><br>",e.airport_names.forEach(o=>{a+='<span style="margin-left: 10px;">\u2022 '+o+"</span><br>"}),a+="</div>"),e.num_aircraft&&e.num_aircraft>0&&e.aircraft_list&&e.aircraft_list.length>0&&(a+='<div style="margin-bottom: 8px; max-height: 150px; overflow-y: auto;"><strong>Aircrafts ('+e.num_aircraft+"):</strong><br>",e.aircraft_list.forEach(o=>{let p=o.type?" ("+o.type+")":"";a+='<span style="margin-left: 10px;">\u2022 '+o.registration+p+" - "+o.flights+" flight(s)</span><br>"}),a+="</div>"),e.total_flight_time_str&&(a+='<div style="margin-bottom: 8px;"><strong>Total Flight Time:</strong> '+e.total_flight_time_str+"</div>");let r=(e.total_distance_nm*1.852).toFixed(1);if(a+='<div style="margin-bottom: 8px;"><strong>Distance:</strong> '+e.total_distance_nm.toFixed(1)+" nm ("+r+" km)</div>",e.num_paths>0){let o=(e.total_distance_nm/e.num_paths).toFixed(1),p=(parseFloat(o)*1.852).toFixed(1);a+='<div style="margin-bottom: 8px;"><strong>Average Distance per Trip:</strong> '+o+" nm ("+p+" km)</div>"}if(e.longest_flight_nm&&e.longest_flight_nm>0){let o=(e.longest_flight_km||0).toFixed(1);a+='<div style="margin-bottom: 8px;"><strong>Longest Flight:</strong> '+e.longest_flight_nm.toFixed(1)+" nm ("+o+" km)</div>"}if(e.average_groundspeed_knots&&e.average_groundspeed_knots>0){let o=Math.round(e.average_groundspeed_knots*1.852);a+='<div style="margin-bottom: 8px;"><strong>Average Groundspeed:</strong> '+Math.round(e.average_groundspeed_knots)+" kt ("+o+" km/h)</div>"}if(e.cruise_speed_knots&&e.cruise_speed_knots>0){let o=Math.round(e.cruise_speed_knots*1.852);a+='<div style="margin-bottom: 8px;"><strong>Cruise Speed (>1000ft AGL):</strong> '+Math.round(e.cruise_speed_knots)+" kt ("+o+" km/h)</div>"}if(e.max_groundspeed_knots&&e.max_groundspeed_knots>0){let o=Math.round(e.max_groundspeed_knots*1.852);a+='<div style="margin-bottom: 8px;"><strong>Max Groundspeed:</strong> '+Math.round(e.max_groundspeed_knots)+" kt ("+o+" km/h)</div>"}if(e.max_altitude_ft){let o=Math.round(e.max_altitude_ft*.3048);if(a+='<div style="margin-bottom: 8px;"><strong>Max Altitude (MSL):</strong> '+Math.round(e.max_altitude_ft)+" ft ("+o+" m)</div>",e.total_altitude_gain_ft){let p=Math.round(e.total_altitude_gain_ft*.3048);a+='<div style="margin-bottom: 8px;"><strong>Elevation Gain:</strong> '+Math.round(e.total_altitude_gain_ft)+" ft ("+p+" m)</div>"}}if(e.most_common_cruise_altitude_ft&&e.most_common_cruise_altitude_ft>0){let o=Math.round(e.most_common_cruise_altitude_m||0);a+='<div style="margin-bottom: 8px;"><strong>Most Common Cruise Altitude (AGL):</strong> '+e.most_common_cruise_altitude_ft.toLocaleString()+" ft ("+o.toLocaleString()+" m)</div>"}let s=n.get("stats-panel");s&&(s.innerHTML=Q.sanitize(a))}toggleStats(){let e=n.get("stats-panel");e&&(e.classList.contains("visible")?(e.classList.remove("visible"),setTimeout(()=>{e.style.display="none",this.app.stateManager.saveMapState()},300)):(e.style.display="block",e.offsetHeight,e.classList.add("visible"),this.app.stateManager.saveMapState()))}};var ze=class{constructor(e){this.app=e}togglePathSelection(e){this.app.selectedPathIds.has(e)?this.app.selectedPathIds.delete(e):this.app.selectedPathIds.add(e),this.app.altitudeVisible&&(this.app.layerManager.redrawAltitudePaths(),setTimeout(()=>{this.app.map.invalidateSize()},50)),this.app.airspeedVisible&&(this.app.layerManager.redrawAirspeedPaths(),setTimeout(()=>{this.app.map.invalidateSize()},50)),this.app.replayManager.updateReplayButtonState(),this.app.stateManager.saveMapState()}selectPathsByAirport(e){let t=this.app.airportToPaths[e];t&&t.forEach(a=>{this.app.selectedPathIds.add(a)}),this.app.altitudeVisible&&(this.app.layerManager.redrawAltitudePaths(),setTimeout(()=>{this.app.map.invalidateSize()},50)),this.app.airspeedVisible&&(this.app.layerManager.redrawAirspeedPaths(),setTimeout(()=>{this.app.map.invalidateSize()},50)),this.app.replayManager.updateReplayButtonState(),this.app.stateManager.saveMapState()}clearSelection(){this.app.selectedPathIds.clear(),this.app.altitudeVisible&&(this.app.layerManager.redrawAltitudePaths(),setTimeout(()=>{this.app.map.invalidateSize()},50)),this.app.airspeedVisible&&(this.app.layerManager.redrawAirspeedPaths(),setTimeout(()=>{this.app.map.invalidateSize()},50)),this.app.replayManager.updateReplayButtonState(),this.app.stateManager.saveMapState()}};var Be=class{constructor(e){this.app=e}calculateAirportFlightCounts(){return window.KMLHeatmap.calculateAirportFlightCounts(this.app.fullPathInfo??[],this.app.selectedYear,this.app.selectedAircraft)}updateAirportPopups(){if(!this.app.allAirportsData||!this.app.airportMarkers)return;let e=this.calculateAirportFlightCounts(),t=null,a=0;Object.keys(e).forEach(r=>{let s=e[r];s!==void 0&&s>a&&(a=s,t=r)}),this.app.allAirportsData.forEach(r=>{let s=this.app.airportMarkers[r.name];if(!s)return;let o=e[r.name]||0,p=r.name===t,d=window.KMLHeatmap.ddToDms(r.lat,!0),h=window.KMLHeatmap.ddToDms(r.lon,!1),g=`https://www.google.com/maps?q=${r.lat},${r.lon}`,v=`
            <div style="
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
                min-width: 220px;
                padding: 8px 4px;
                background-color: #2b2b2b;
                color: #ffffff;
            ">
                <div style="
                    font-size: 15px;
                    font-weight: bold;
                    color: #28a745;
                    margin-bottom: 10px;
                    padding-bottom: 8px;
                    border-bottom: 2px solid #28a745;
                    display: flex;
                    align-items: center;
                    gap: 6px;
                ">
                    <span style="font-size: 18px;">\u{1F6EB}</span>
                    <span>${r.name||"Unknown"}</span>
                    ${p?'<span style="font-size: 12px; background: #007bff; color: white; padding: 2px 6px; border-radius: 3px; margin-left: 4px;">HOME</span>':""}
                </div>
                <div style="margin-bottom: 8px;">
                    <div style="font-size: 11px; color: #999; margin-bottom: 2px; text-transform: uppercase; letter-spacing: 0.5px;">Coordinates</div>
                    <a href="${g}"
                       target="_blank"
                       style="
                           color: #4facfe;
                           text-decoration: none;
                           font-size: 12px;
                           font-family: monospace;
                           display: flex;
                           align-items: center;
                           gap: 4px;
                       "
                       onmouseover="this.style.textDecoration='underline'"
                       onmouseout="this.style.textDecoration='none'">
                        <span>\u{1F4CD}</span>
                        <span>${d}<br>${h}</span>
                    </a>
                </div>
                <div style="
                    background: linear-gradient(135deg, rgba(79, 172, 254, 0.15) 0%, rgba(0, 242, 254, 0.15) 100%);
                    padding: 8px 10px;
                    border-radius: 6px;
                    border-left: 3px solid #4facfe;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                ">
                    <span style="font-size: 12px; color: #ccc; font-weight: 500;">Total Flights</span>
                    <span style="font-size: 16px; font-weight: bold; color: #4facfe;">${o}</span>
                </div>
            </div>`;s.setPopupContent(v)})}updateAirportOpacity(){let e=this.app.selectedYear!=="all"||this.app.selectedAircraft!=="all",t=this.app.selectedPathIds.size>0;if(!e&&!t){Object.keys(this.app.airportMarkers).forEach(r=>{let s=this.app.airportMarkers[r];s&&(s.setOpacity(1),this.app.airportLayer.hasLayer(s)||s.addTo(this.app.airportLayer))});return}let a=new Set;e&&this.app.fullPathInfo&&this.app.fullPathInfo.forEach(r=>{let s=this.app.selectedYear==="all"||r.year&&r.year.toString()===this.app.selectedYear,o=this.app.selectedAircraft==="all"||r.aircraft_registration===this.app.selectedAircraft;s&&o&&(r.start_airport&&a.add(r.start_airport),r.end_airport&&a.add(r.end_airport))}),t&&this.app.selectedPathIds.forEach(r=>{if(this.app.fullPathInfo){let s=this.app.fullPathInfo.find(o=>o.id===r);s&&(s.start_airport&&a.add(s.start_airport),s.end_airport&&a.add(s.end_airport))}else{let s=this.app.pathToAirports[r];s&&(s.start&&a.add(s.start),s.end&&a.add(s.end))}}),Object.keys(this.app.airportMarkers).forEach(r=>{let s=this.app.airportMarkers[r];s&&(a.has(r)?(s.setOpacity(1),this.app.airportLayer.hasLayer(s)||s.addTo(this.app.airportLayer)):this.app.airportLayer.hasLayer(s)&&this.app.airportLayer.removeLayer(s))})}updateAirportMarkerSizes(){if(!this.app.map)return;let e=this.app.map.getZoom(),t="";e>=14?t="xlarge":e>=12?t="large":e>=10?t="medium":e>=8?t="medium-small":e>=6&&(t="small"),document.querySelectorAll(".airport-marker-container").forEach(a=>{let r=a.querySelector(".airport-marker"),s=a.querySelector(".airport-label");!r||!s||(e<5?s.style.display="none":s.style.display="",a.classList.remove("airport-marker-container-small","airport-marker-container-medium-small","airport-marker-container-medium","airport-marker-container-large","airport-marker-container-xlarge"),r.classList.remove("airport-marker-small","airport-marker-medium-small","airport-marker-medium","airport-marker-large","airport-marker-xlarge"),s.classList.remove("airport-label-small","airport-label-medium-small","airport-label-medium","airport-label-large","airport-label-xlarge"),t&&(a.classList.add("airport-marker-container-"+t),r.classList.add("airport-marker-"+t),s.classList.add("airport-label-"+t)))})}};var j=Re(ue(),1);var Ve=class{constructor(e){this.app=e,n.cacheElements(["replay-controls","replay-btn","replay-play-btn","replay-pause-btn","replay-slider","replay-slider-start","replay-slider-end","replay-time-display","replay-speed","replay-autozoom-btn","altitude-btn","altitude-legend"]),this.replayActive=!1,this.replayPlaying=!1,this.replayCurrentTime=0,this.replayMaxTime=0,this.replaySpeed=50,this.replayInterval=null,this.replayLayer=null,this.replaySegments=[],this.replayAirplaneMarker=null,this.replayLastDrawnIndex=-1,this.replayLastBearing=null,this.replayAnimationFrameId=null,this.replayLastFrameTime=null,this.replayColorMinAlt=0,this.replayColorMaxAlt=1e4,this.replayColorMinSpeed=0,this.replayColorMaxSpeed=200,this.replayAutoZoom=!1,this.replayLastZoom=null,this.replayRecenterTimestamps=[]}toggleReplay(){let e=n.get("replay-controls");if(e)if(this.replayActive){this.stopReplay(),e.style.display="none",this.replayActive=!1;let t=n.get("replay-btn");if(t&&(t.textContent="\u25B6\uFE0F Replay"),document.body.classList.remove("replay-active"),this.replayAirplaneMarker&&this.app.map&&(this.app.map.removeLayer(this.replayAirplaneMarker),this.replayAirplaneMarker=null),this.replayLayer&&this.app.map&&this.app.map.removeLayer(this.replayLayer),this.restoreLayerVisibility(),!this.app.altitudeVisible&&!this.app.airspeedVisible&&this.app.map){this.app.altitudeVisible=!0;let a=n.get("altitude-btn");a&&(a.style.opacity="1.0");let r=n.get("altitude-legend");r&&(r.style.display="block"),this.app.map.addLayer(this.app.altitudeLayer)}setTimeout(()=>{this.app.altitudeVisible?this.app.layerManager.redrawAltitudePaths():this.app.airspeedVisible&&this.app.layerManager.redrawAirspeedPaths(),this.app.map&&this.app.map.invalidateSize()},100),this.updateReplayButtonState(),this.app.stateManager.saveMapState()}else{if(this.app.selectedPathIds.size!==1)return;if(this.initializeReplay()){e.style.display="block",this.replayActive=!0;let t=n.get("replay-btn");t&&(t.textContent="\u23F9\uFE0F Replay",t.style.opacity="1.0");let a=n.get("replay-autozoom-btn");a&&(a.style.opacity=this.replayAutoZoom?"1.0":"0.5",a.title=this.replayAutoZoom?"Auto-zoom enabled":"Auto-zoom disabled"),document.body.classList.add("replay-active"),this.hideOtherLayersDuringReplay(),this.app.stateManager.saveMapState()}}}updateReplayButtonState(){let e=n.get("replay-btn");e&&(this.app.selectedPathIds.size===1?e.style.opacity="1.0":e.style.opacity="0.5")}updateReplayAirplanePopup(){if(!this.replayAirplaneMarker||!this.replayActive)return;let e=null;for(let m=0;m<this.replaySegments.length;m++){let y=this.replaySegments[m];if(y&&(y.time||0)<=this.replayCurrentTime)e=y;else break}if(!e&&this.replaySegments.length>0&&(e=this.replaySegments[0]),!e)return;let t=`<div style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif; min-width: 180px; padding: 8px 4px; background-color: #2b2b2b; color: #ffffff;">`;t+='<div style="font-size: 14px; font-weight: bold; color: #4facfe; margin-bottom: 8px; padding-bottom: 6px; border-bottom: 2px solid #4facfe; display: flex; align-items: center; gap: 6px;">',t+='<span style="font-size: 16px;">\u2708\uFE0F</span>',t+="<span>Current Position</span>",t+="</div>";let a=e.altitude_ft||0,r=Math.round(a/50)*50,s=Math.round(r*.3048),o=window.KMLHeatmap.getColorForAltitude(a,this.replayColorMinAlt,this.replayColorMaxAlt),p=o.replace("rgb(","rgba(").replace(")",", 0.15)");t+='<div style="margin-bottom: 8px;">',t+='<div style="font-size: 11px; color: #999; margin-bottom: 2px; text-transform: uppercase; letter-spacing: 0.5px;">Altitude (MSL)</div>',t+='<div style="background: '+p+"; padding: 6px 8px; border-radius: 6px; border-left: 3px solid "+o+';">',t+='<span style="font-size: 16px; font-weight: bold; color: '+o+';">'+r.toLocaleString()+" ft</span>",t+='<span style="font-size: 12px; color: #ccc; margin-left: 6px;">('+s.toLocaleString()+" m)</span>",t+="</div>",t+="</div>";let d=e.groundspeed_knots||0,h=d*1.852,g=Math.round(d),v=Math.round(h),A=window.KMLHeatmap.getColorForAirspeed(d,this.replayColorMinSpeed,this.replayColorMaxSpeed),b=A.replace("rgb(","rgba(").replace(")",", 0.15)");t+='<div style="margin-bottom: 8px;">',t+='<div style="font-size: 11px; color: #999; margin-bottom: 2px; text-transform: uppercase; letter-spacing: 0.5px;">Groundspeed</div>',t+='<div style="background: '+b+"; padding: 6px 8px; border-radius: 6px; border-left: 3px solid "+A+';">',t+='<span style="font-size: 16px; font-weight: bold; color: '+A+';">'+g.toLocaleString()+" kt</span>",t+='<span style="font-size: 12px; color: #ccc; margin-left: 6px;">('+v.toLocaleString()+" km/h)</span>",t+="</div>",t+="</div>",t+="</div>",this.replayAirplaneMarker.getPopup()?this.replayAirplaneMarker.getPopup().setContent(t):this.replayAirplaneMarker.bindPopup(t,{autoPanPadding:[50,50]}),this.replayAirplaneMarker.openPopup()}initializeReplay(){if(!this.app.fullPathSegments)return alert("No flight data available for replay. Please wait for data to load or refresh the page."),!1;let e=Array.from(this.app.selectedPathIds)[0];if(this.replaySegments=this.app.fullPathSegments.filter(h=>h.path_id===e&&h.time!==void 0&&h.time!==null),this.replaySegments.length===0)return alert("No timestamp data available for this path. The flight may not have timing information."),!1;if(this.replaySegments.sort((h,g)=>(h.time||0)-(g.time||0)),this.app.currentData&&this.app.currentData.path_segments){let h=this.app.currentData.path_segments.filter(g=>g.path_id===e);if(h.length>0){let g=h.map(m=>m.altitude_ft||0),v=g[0]??0,A=g[0]??0;for(let m=1;m<g.length;m++){let y=g[m]??0;y<v&&(v=y),y>A&&(A=y)}this.replayColorMinAlt=v,this.replayColorMaxAlt=A;let b=h.map(m=>m.groundspeed_knots||0).filter(m=>m>0);if(b.length>0){let m=b[0]??0,y=b[0]??0;for(let E=1;E<b.length;E++){let T=b[E]??0;T<m&&(m=T),T>y&&(y=T)}this.replayColorMinSpeed=m,this.replayColorMaxSpeed=y}else this.replayColorMinSpeed=this.app.airspeedRange.min,this.replayColorMaxSpeed=this.app.airspeedRange.max}else{let g=this.replaySegments.map(m=>m.altitude_ft||0),v=g[0]??0,A=g[0]??0;for(let m=1;m<g.length;m++){let y=g[m]??0;y<v&&(v=y),y>A&&(A=y)}this.replayColorMinAlt=v,this.replayColorMaxAlt=A;let b=this.replaySegments.map(m=>m.groundspeed_knots||0).filter(m=>m>0);if(b.length>0){let m=b[0]??0,y=b[0]??0;for(let E=1;E<b.length;E++){let T=b[E]??0;T<m&&(m=T),T>y&&(y=T)}this.replayColorMinSpeed=m,this.replayColorMaxSpeed=y}else this.replayColorMinSpeed=this.app.airspeedRange.min,this.replayColorMaxSpeed=this.app.airspeedRange.max}}let t=this.replaySegments[this.replaySegments.length-1];this.replayMaxTime=t?.time||0;let a=n.get("replay-slider");a&&(a.max=this.replayMaxTime.toString());let r=n.get("replay-slider-end");r&&(r.textContent=window.KMLHeatmap.formatTime(this.replayMaxTime)),this.app.layerManager.updateAltitudeLegend(this.replayColorMinAlt,this.replayColorMaxAlt),this.app.layerManager.updateAirspeedLegend(this.replayColorMinSpeed,this.replayColorMaxSpeed),this.replayLayer||(this.replayLayer=j.layerGroup()),this.replayLayer.clearLayers(),this.app.map&&this.replayLayer.addTo(this.app.map),this.replayAirplaneMarker&&this.app.map&&(this.app.map.removeLayer(this.replayAirplaneMarker),this.replayAirplaneMarker=null);let s=j.divIcon({html:'<div class="replay-airplane-icon">\u2708\uFE0F</div>',iconSize:[32,32],iconAnchor:[16,16],className:""}),p=this.replaySegments[0]?.coords?.[0];if(!p||!this.app.map)return!1;this.replayAirplaneMarker=j.marker([p[0],p[1]],{icon:s,zIndexOffset:1e3}),this.replayAirplaneMarker.addTo(this.app.map);let d=this.replayAirplaneMarker.getElement();return d&&(d.style.transition="transform 0.08s linear",d.style.cursor="pointer",d.style.pointerEvents="auto",d.addEventListener("click",h=>{h.stopPropagation(),this.replayAirplaneMarker.isPopupOpen()?this.replayAirplaneMarker.closePopup():this.updateReplayAirplanePopup()})),this.replayCurrentTime=0,this.replayLastDrawnIndex=-1,this.replayLastBearing=null,this.replayAutoZoom&&this.app.map?(this.app.map.setView([p[0],p[1]],16,{animate:!0,duration:.8}),this.replayLastZoom=16):this.app.map&&this.app.map.panTo([p[0],p[1]],{animate:!0,duration:.8}),this.updateReplayDisplay(),!0}hideOtherLayersDuringReplay(){if(!this.app.map)return;this.app.heatmapLayer&&this.app.heatmapVisible&&this.app.map.removeLayer(this.app.heatmapLayer),this.app.altitudeVisible&&this.app.map.removeLayer(this.app.altitudeLayer),this.app.airspeedVisible&&this.app.map.removeLayer(this.app.airspeedLayer),["heatmap-btn","airports-btn","aviation-btn","year-select","aircraft-select"].forEach(t=>{let a=document.getElementById(t);a&&(a.disabled=!0)})}restoreLayerVisibility(){if(!this.app.map)return;this.app.heatmapLayer&&this.app.heatmapVisible&&(this.app.map.addLayer(this.app.heatmapLayer),this.app.heatmapLayer.e&&(this.app.heatmapLayer.e.style.pointerEvents="none")),this.app.altitudeVisible&&(this.app.map.addLayer(this.app.altitudeLayer),setTimeout(()=>{this.app.layerManager.redrawAltitudePaths(),this.app.map&&this.app.map.invalidateSize()},50)),this.app.airspeedVisible&&(this.app.map.addLayer(this.app.airspeedLayer),setTimeout(()=>{this.app.layerManager.redrawAirspeedPaths(),this.app.map&&this.app.map.invalidateSize()},50)),["heatmap-btn","airports-btn","aviation-btn","year-select","aircraft-select"].forEach(t=>{let a=document.getElementById(t);a&&(a.disabled=!1)})}playReplay(){if(!this.replayActive||!this.app.map)return;if(this.replayCurrentTime>=this.replayMaxTime){if(this.replayCurrentTime=0,this.replayLastDrawnIndex=-1,this.replayLayer&&this.replayLayer.clearLayers(),this.replayAirplaneMarker&&this.replaySegments.length>0&&this.app.map){let s=this.replaySegments[0]?.coords?.[0];s&&(this.replayAirplaneMarker.setLatLng([s[0],s[1]]),this.replayAutoZoom&&(this.app.map.setView([s[0],s[1]],16,{animate:!0,duration:.5}),this.replayLastZoom=16))}this.replayRecenterTimestamps=[],this.replayLastBearing=null}this.replayPlaying=!0;let e=n.get("replay-play-btn"),t=n.get("replay-pause-btn");e&&(e.style.display="none"),t&&(t.style.display="inline-block"),this.replayLastFrameTime=null;let a=r=>{if(!this.replayPlaying)return;this.replayLastFrameTime===null&&(this.replayLastFrameTime=r);let s=r-this.replayLastFrameTime;this.replayLastFrameTime=r;let o=s/1e3*this.replaySpeed;if(this.replayCurrentTime+=o,this.replayCurrentTime>=this.replayMaxTime){if(this.replayCurrentTime=this.replayMaxTime,this.pauseReplay(),this.replaySegments.length>0&&this.app.map){let p=[];if(this.replaySegments.forEach(d=>{d.coords&&d.coords.length>0&&d.coords.forEach(h=>{p.push(h)})}),p.length>0){let d=j.latLngBounds(p);this.app.map.fitBounds(d,{padding:[50,50],animate:!0,duration:1})}}}else this.replayAnimationFrameId=requestAnimationFrame(a);this.updateReplayDisplay()};this.replayAnimationFrameId=requestAnimationFrame(a),this.app.stateManager.saveMapState()}pauseReplay(){this.replayPlaying=!1;let e=n.get("replay-play-btn"),t=n.get("replay-pause-btn");e&&(e.style.display="inline-block"),t&&(t.style.display="none"),this.replayAnimationFrameId&&(cancelAnimationFrame(this.replayAnimationFrameId),this.replayAnimationFrameId=null),this.replayLastFrameTime=null,this.app.stateManager.saveMapState()}stopReplay(){if(this.pauseReplay(),this.replayCurrentTime=0,this.replayLastDrawnIndex=-1,this.replayLastBearing=null,this.replayRecenterTimestamps=[],this.replayLayer&&this.replayLayer.clearLayers(),this.replayAirplaneMarker&&this.replaySegments.length>0){let t=this.replaySegments[0]?.coords?.[0];t&&this.replayAirplaneMarker.setLatLng([t[0],t[1]])}this.updateReplayDisplay()}seekReplay(e){let t=parseFloat(e);t<this.replayCurrentTime&&(this.replayLayer&&this.replayLayer.clearLayers(),this.replayLastDrawnIndex=-1),this.replayCurrentTime=t,this.updateReplayDisplay(!0),this.app.stateManager.saveMapState()}changeReplaySpeed(){let e=n.get("replay-speed");e&&(this.replaySpeed=parseFloat(e.value),this.app.stateManager.saveMapState())}toggleAutoZoom(){this.replayAutoZoom=!this.replayAutoZoom;let e=n.get("replay-autozoom-btn");e&&(e.style.opacity=this.replayAutoZoom?"1.0":"0.5",e.title=this.replayAutoZoom?"Auto-zoom enabled":"Auto-zoom disabled"),this.app.stateManager.saveMapState()}updateReplayDisplay(e=!1){let t=n.get("replay-time-display");t&&(t.textContent=window.KMLHeatmap.formatTime(this.replayCurrentTime)+" / "+window.KMLHeatmap.formatTime(this.replayMaxTime));let a=n.get("replay-slider");a&&(a.value=this.replayCurrentTime.toString());let r=n.get("replay-slider-start");r&&(r.textContent=window.KMLHeatmap.formatTime(this.replayCurrentTime));let s=null,o=null,p=-1;for(let d=0;d<this.replaySegments.length;d++){let h=this.replaySegments[d];if(h&&(h.time||0)<=this.replayCurrentTime)s=h,p=d;else if(h){o=h;break}}if(this.replayLayer){let d=this.app.airspeedVisible&&!this.app.altitudeVisible;for(let h=0;h<this.replaySegments.length;h++){let g=this.replaySegments[h];if(g)if((g.time||0)<=this.replayCurrentTime&&this.replayCurrentTime>0){if(h>this.replayLastDrawnIndex){let v;d&&(g.groundspeed_knots||0)>0?v=window.KMLHeatmap.getColorForAltitude(g.groundspeed_knots??0,this.replayColorMinSpeed,this.replayColorMaxSpeed):v=window.KMLHeatmap.getColorForAltitude(g.altitude_ft??0,this.replayColorMinAlt,this.replayColorMaxAlt),j.polyline(g.coords||[],{color:v,weight:3,opacity:.8}).addTo(this.replayLayer),this.replayLastDrawnIndex=h}}else break}}if(this.replayAirplaneMarker&&this.app.map&&!this.app.map.hasLayer(this.replayAirplaneMarker)&&this.replayAirplaneMarker.addTo(this.app.map),this.replayAirplaneMarker&&this.app.map){if(s){let d,h=0;if(o&&(s.time||0)<this.replayCurrentTime){let A=(this.replayCurrentTime-(s.time||0))/((o.time||0)-(s.time||0)),b=s.coords?.[1]?.[0]||0,m=s.coords?.[1]?.[1]||0,y=o.coords?.[0]?.[0]||0,E=o.coords?.[0]?.[1]||0;d=[b+(y-b)*A,m+(E-m)*A],h=window.KMLHeatmap.calculateBearing(b,m,y,E)}else{d=s.coords?.[1]||[0,0];let A=s.coords?.[0]?.[0]||0,b=s.coords?.[0]?.[1]||0,m=s.coords?.[1]?.[0]||0,y=s.coords?.[1]?.[1]||0;h=window.KMLHeatmap.calculateBearing(A,b,m,y)}let g=window.KMLHeatmap.calculateSmoothedBearing(this.replaySegments,p,5);if(g!==null?(h=g,this.replayLastBearing=h):this.replayLastBearing!==null&&(h=this.replayLastBearing),this.replayAirplaneMarker.setLatLng(d),this.replayPlaying||e){let A=this.app.map.getSize(),b=this.app.map.latLngToContainerPoint(d),m=.1,y=A.x*m,E=A.y*m,T=!1;if((b.x<y||b.x>A.x-y||b.y<E||b.y>A.y-E)&&(T=!0),e&&(T=!0),T){this.app.map.panTo(d,{animate:!0,duration:.5,easeLinearity:.25,noMoveStart:!0});let S=Date.now();this.replayRecenterTimestamps.push(S);let w=S-3e4;this.replayRecenterTimestamps=this.replayRecenterTimestamps.filter(x=>x>w)}if(this.replayAutoZoom){let w=Date.now()-3e4;if(this.replayRecenterTimestamps=this.replayRecenterTimestamps.filter(P=>P>w),this.replayRecenterTimestamps.length>2){let U=Date.now()-5e3;if(this.replayRecenterTimestamps.filter(Ae=>Ae>=U).length>2&&this.replayLastZoom!==null&&this.replayLastZoom>9){let ve=Math.max(9,this.replayLastZoom-1);this.app.map.setZoom(ve,{animate:!0,duration:.5}),this.replayLastZoom=ve,this.replayRecenterTimestamps=[]}}}}let v=this.replayAirplaneMarker.getElement();if(v){let A=v.querySelector(".replay-airplane-icon");if(A){let b=h-45;A.style.transform="translate3d(0,0,0) rotate("+b+"deg)"}}}else if(this.replaySegments.length>0){let h=this.replaySegments[0]?.coords?.[0];h&&this.replayAirplaneMarker.setLatLng([h[0],h[1]])}}this.replayAirplaneMarker&&this.replayAirplaneMarker.getPopup()&&this.replayAirplaneMarker.isPopupOpen()&&this.updateReplayAirplanePopup()}};var Ue=class{constructor(e){this.app=e,this.originalMapParent=null,this.originalMapIndex=null,n.cacheElements(["wrapped-title","wrapped-year","wrapped-stats","wrapped-fun-facts","wrapped-aircraft-fleet","wrapped-top-airports","wrapped-airports-grid","map","wrapped-map-container","wrapped-modal","stats-btn","export-btn","wrapped-btn","heatmap-btn","airports-btn","altitude-btn","airspeed-btn","aviation-btn","year-filter","aircraft-filter","stats-panel","altitude-legend","airspeed-legend","loading"])}showWrapped(){if(!this.app.map)return;let e=this.app.selectedYear,t=window.KMLHeatmap.calculateYearStats(this.app.fullPathInfo||[],this.app.fullPathSegments||[],e,this.app.fullStats),a=n.get("wrapped-title"),r=n.get("wrapped-year");e==="all"?(a&&(a.textContent="\u2728 Your Flight History"),r&&(r.textContent="All Years")):(a&&(a.textContent="\u2728 Your Year in Flight"),r&&(r.textContent=e));let s=`
            <div class="stat-card">
                <div class="stat-value">${t.total_flights}</div>
                <div class="stat-label">Flights</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">${t.num_airports}</div>
                <div class="stat-label">Airports</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">${t.total_distance_nm.toFixed(0)}</div>
                <div class="stat-label">Nautical Miles</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">${t.flight_time}</div>
                <div class="stat-label">Flight Time</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">${(this.app.fullStats?.max_groundspeed_knots||0).toFixed(0)} kt</div>
                <div class="stat-label">Max Groundspeed</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">${Math.round((this.app.fullStats?.max_altitude_m||0)/.3048).toLocaleString()} ft</div>
                <div class="stat-label">Max Altitude (MSL)</div>
            </div>
        `,o=n.get("wrapped-stats");o&&(o.innerHTML=Q.sanitize(s));let p=window.KMLHeatmap.generateFunFacts(t,this.app.fullStats),d='<div class="fun-facts-title">\u2728 Facts</div>';p.forEach(m=>{d+=`<div class="fun-fact" data-category="${m.category}"><span class="fun-fact-icon">${m.icon}</span><span class="fun-fact-text">${m.text}</span></div>`});let h=n.get("wrapped-fun-facts");if(h&&(h.innerHTML=Q.sanitize(d)),t.aircraft_list&&t.aircraft_list.length>0){let m='<div class="aircraft-fleet-title">\u2708\uFE0F Fleet</div>',y=t.aircraft_list[0]?.flights??0,E=t.aircraft_list[t.aircraft_list.length-1]?.flights??0,T=y-E;t.aircraft_list.forEach(w=>{let x=w.model||w.type||"",P=T>0?(w.flights-E)/T:1,U;P>=.75?U="fleet-aircraft-high":P>=.5?U="fleet-aircraft-medium-high":P>=.25?U="fleet-aircraft-medium-low":U="fleet-aircraft-low";let ae=w.flight_time_str||"---";m+=`
                    <div class="fleet-aircraft ${U}">
                        <div class="fleet-aircraft-info">
                            <div class="fleet-aircraft-model">${x}</div>
                            <div class="fleet-aircraft-registration">${w.registration}</div>
                        </div>
                        <div class="fleet-aircraft-stats">
                            <div class="fleet-aircraft-flights">${w.flights} flights</div>
                            <div class="fleet-aircraft-time">${ae}</div>
                        </div>
                    </div>
                `});let S=n.get("wrapped-aircraft-fleet");S&&(S.innerHTML=Q.sanitize(m))}if(t.airport_names&&t.airport_names.length>0){let m;if(e==="all")m=this.app.fullPathInfo||[];else{let S=e.toString();m=(this.app.fullPathInfo||[]).filter(w=>w.year&&w.year.toString()===S)}let y={};m.forEach(S=>{S.start_airport&&(y[S.start_airport]=(y[S.start_airport]||0)+1),S.end_airport&&(y[S.end_airport]=(y[S.end_airport]||0)+1)});let E=t.airport_names.map(S=>({name:S,flight_count:y[S]||0}));E.sort((S,w)=>w.flight_count-S.flight_count);let T=E[0];if(T){let S='<div class="top-airports-title">\u{1F3E0} Home Base</div>';S+=`
                <div class="top-airport">
                    <div class="top-airport-name">${T.name}</div>
                    <div class="top-airport-count">${T.flight_count} flights</div>
                </div>
            `;let w=n.get("wrapped-top-airports");w&&(w.innerHTML=Q.sanitize(S));let x=t.airport_names.filter(P=>P!==T.name);if(x.length>0){let P='<div class="airports-grid-title">\u{1F5FA}\uFE0F Destinations</div><div class="airport-badges">';x.forEach(ae=>{P+=`<div class="airport-badge">${ae}</div>`}),P+="</div>";let U=n.get("wrapped-airports-grid");U&&(U.innerHTML=Q.sanitize(P))}else{let P=n.get("wrapped-airports-grid");P&&(P.innerHTML="")}}}let g=n.get("map"),v=n.get("wrapped-map-container");if(!g||!v)return;this.originalMapParent||(this.originalMapParent=g.parentNode,this.originalMapIndex=Array.from(this.originalMapParent.children).indexOf(g)),this.app.map.fitBounds(this.app.config.bounds,{padding:[80,80]}),[document.querySelector(".leaflet-control-zoom"),n.get("stats-btn"),n.get("export-btn"),n.get("wrapped-btn"),n.get("heatmap-btn"),n.get("airports-btn"),n.get("altitude-btn"),n.get("airspeed-btn"),n.get("aviation-btn"),n.get("year-filter"),n.get("aircraft-filter"),n.get("stats-panel"),n.get("altitude-legend"),n.get("airspeed-legend"),n.get("loading")].forEach(m=>{m&&(m.style.display="none")});let b=n.get("wrapped-modal");b&&(b.style.display="flex"),setTimeout(()=>{v.appendChild(g),g.style.width="100%",g.style.height="100%",g.style.borderRadius="12px",g.style.overflow="hidden",v.offsetHeight,setTimeout(()=>{this.app.map.invalidateSize(),this.app.map.fitBounds(this.app.config.bounds,{padding:[80,80]}),this.app.stateManager&&this.app.stateManager.saveMapState()},100)},50)}closeWrapped(e){if(!e||e.target.id==="wrapped-modal"){let t=n.get("map");if(!t)return;if(this.originalMapParent&&this.originalMapIndex!==null){let r=Array.from(this.originalMapParent.children);if(this.originalMapIndex>=r.length)this.originalMapParent.appendChild(t);else{let o=r[this.originalMapIndex];o&&this.originalMapParent.insertBefore(t,o)}if(t.style.width="",t.style.height="",t.style.borderRadius="",t.style.overflow="",[document.querySelector(".leaflet-control-zoom"),n.get("stats-btn"),n.get("export-btn"),n.get("wrapped-btn"),n.get("heatmap-btn"),n.get("airports-btn"),n.get("altitude-btn"),n.get("airspeed-btn"),n.get("year-filter"),n.get("aircraft-filter"),n.get("stats-panel"),n.get("altitude-legend"),n.get("airspeed-legend"),n.get("loading")].forEach(o=>{o&&(o.style.display="")}),this.app.config.openaipApiKey){let o=n.get("aviation-btn");o&&(o.style.display="")}setTimeout(()=>{this.app.map&&this.app.map.invalidateSize(),this.app.stateManager&&this.app.stateManager.saveMapState()},100)}let a=n.get("wrapped-modal");a&&(a.style.display="none")}}};var gt=Re(ue(),1);var Ye=class{constructor(e){this.app=e,n.cacheElements(["heatmap-btn","altitude-btn","airspeed-btn","airports-btn","aviation-btn","altitude-legend","airspeed-legend","export-btn","hide-buttons-btn","map","stats-btn","wrapped-btn","replay-btn","year-filter","aircraft-filter","stats-panel","loading"])}toggleHeatmap(){if(this.app.map){if(this.app.heatmapVisible){this.app.heatmapLayer&&this.app.map.removeLayer(this.app.heatmapLayer),this.app.heatmapVisible=!1;let e=n.get("heatmap-btn");e&&(e.style.opacity="0.5")}else{this.app.heatmapLayer&&(this.app.map.addLayer(this.app.heatmapLayer),this.app.heatmapLayer.e&&(this.app.heatmapLayer.e.style.pointerEvents="none")),this.app.heatmapVisible=!0;let e=n.get("heatmap-btn");e&&(e.style.opacity="1.0")}this.app.stateManager.saveMapState()}}toggleAltitude(){if(this.app.map){if(this.app.altitudeVisible){if(this.app.replayManager.replayActive&&!this.app.airspeedVisible)return;this.app.map.removeLayer(this.app.altitudeLayer),this.app.altitudeVisible=!1;let e=n.get("altitude-btn");e&&(e.style.opacity="0.5");let t=n.get("altitude-legend");t&&(t.style.display="none")}else{if(this.app.airspeedVisible){this.app.replayManager.replayActive||this.app.map.removeLayer(this.app.airspeedLayer),this.app.airspeedVisible=!1;let a=n.get("airspeed-btn");a&&(a.style.opacity="0.5");let r=n.get("airspeed-legend");r&&(r.style.display="none")}if(!this.app.replayManager.replayActive)this.app.map.addLayer(this.app.altitudeLayer),this.app.layerManager.redrawAltitudePaths();else{let a=this.app.replayManager.replayCurrentTime,r=this.app.replayManager.replayLastDrawnIndex;this.app.replayManager.replayLayer&&this.app.replayManager.replayLayer.clearLayers(),this.app.replayManager.replayLastDrawnIndex=-1;for(let s=0;s<=r&&s<this.app.replayManager.replaySegments.length;s++){let o=this.app.replayManager.replaySegments[s];if(o&&(o.time||0)<=a){let p=window.KMLHeatmap.getColorForAltitude(o.altitude_ft||0,this.app.replayManager.replayColorMinAlt,this.app.replayManager.replayColorMaxAlt);gt.polyline(o.coords||[],{color:p,weight:3,opacity:.8}).addTo(this.app.replayManager.replayLayer),this.app.replayManager.replayLastDrawnIndex=s}}}this.app.altitudeVisible=!0;let e=n.get("altitude-btn");e&&(e.style.opacity="1.0");let t=n.get("altitude-legend");t&&(t.style.display="block")}this.app.replayManager.replayActive&&this.app.replayManager.replayAirplaneMarker&&this.app.replayManager.replayAirplaneMarker.isPopupOpen()&&this.app.replayManager.updateReplayAirplanePopup(),this.app.stateManager.saveMapState()}}toggleAirspeed(){if(this.app.map){if(this.app.airspeedVisible){if(this.app.replayManager.replayActive&&!this.app.altitudeVisible)return;this.app.map.removeLayer(this.app.airspeedLayer),this.app.airspeedVisible=!1;let e=n.get("airspeed-btn");e&&(e.style.opacity="0.5");let t=n.get("airspeed-legend");t&&(t.style.display="none")}else{if(this.app.altitudeVisible){this.app.replayManager.replayActive||this.app.map.removeLayer(this.app.altitudeLayer),this.app.altitudeVisible=!1;let a=n.get("altitude-btn");a&&(a.style.opacity="0.5");let r=n.get("altitude-legend");r&&(r.style.display="none")}if(!this.app.replayManager.replayActive)this.app.map.addLayer(this.app.airspeedLayer),this.app.layerManager.redrawAirspeedPaths();else{let a=this.app.replayManager.replayCurrentTime,r=this.app.replayManager.replayLastDrawnIndex;this.app.replayManager.replayLayer&&this.app.replayManager.replayLayer.clearLayers(),this.app.replayManager.replayLastDrawnIndex=-1;for(let s=0;s<=r&&s<this.app.replayManager.replaySegments.length;s++){let o=this.app.replayManager.replaySegments[s];if(o&&(o.time||0)<=a&&(o.groundspeed_knots||0)>0){let p=window.KMLHeatmap.getColorForAltitude(o.groundspeed_knots||0,this.app.replayManager.replayColorMinSpeed,this.app.replayManager.replayColorMaxSpeed);gt.polyline(o.coords||[],{color:p,weight:3,opacity:.8}).addTo(this.app.replayManager.replayLayer),this.app.replayManager.replayLastDrawnIndex=s}}}this.app.airspeedVisible=!0;let e=n.get("airspeed-btn");e&&(e.style.opacity="1.0");let t=n.get("airspeed-legend");t&&(t.style.display="block")}this.app.replayManager.replayActive&&this.app.replayManager.replayAirplaneMarker&&this.app.replayManager.replayAirplaneMarker.isPopupOpen()&&this.app.replayManager.updateReplayAirplanePopup(),this.app.stateManager.saveMapState()}}toggleAirports(){if(this.app.map){if(this.app.airportsVisible){this.app.map.removeLayer(this.app.airportLayer),this.app.airportsVisible=!1;let e=n.get("airports-btn");e&&(e.style.opacity="0.5")}else{this.app.map.addLayer(this.app.airportLayer),this.app.airportsVisible=!0;let e=n.get("airports-btn");e&&(e.style.opacity="1.0")}this.app.stateManager.saveMapState()}}toggleAviation(){if(this.app.map&&this.app.config.openaipApiKey&&this.app.openaipLayers["Aviation Data"]){if(this.app.aviationVisible){this.app.map.removeLayer(this.app.openaipLayers["Aviation Data"]),this.app.aviationVisible=!1;let e=n.get("aviation-btn");e&&(e.style.opacity="0.5")}else{this.app.map.addLayer(this.app.openaipLayers["Aviation Data"]),this.app.aviationVisible=!0;let e=n.get("aviation-btn");e&&(e.style.opacity="1.0")}this.app.stateManager.saveMapState()}}toggleButtonsVisibility(){let e=document.querySelectorAll(".toggleable-btn"),t=n.get("hide-buttons-btn");this.app.buttonsHidden?(e.forEach(a=>{a.classList.remove("buttons-hidden")}),t&&(t.textContent="\u{1F53C}"),this.app.buttonsHidden=!1):(e.forEach(a=>{a.classList.add("buttons-hidden")}),t&&(t.textContent="\u{1F53D}"),this.app.buttonsHidden=!0),this.app.altitudeVisible&&this.app.layerManager.redrawAltitudePaths(),this.app.airspeedVisible&&this.app.layerManager.redrawAirspeedPaths(),this.app.stateManager.saveMapState()}exportMap(){let e=n.get("export-btn");if(!e)return;e.disabled=!0,e.textContent="\u23F3 Exporting...";let t=n.get("map");if(!t)return;let a=[document.querySelector(".leaflet-control-zoom"),n.get("stats-btn"),n.get("export-btn"),n.get("wrapped-btn"),n.get("replay-btn"),n.get("year-filter"),n.get("aircraft-filter"),n.get("heatmap-btn"),n.get("altitude-btn"),n.get("airspeed-btn"),n.get("airports-btn"),n.get("aviation-btn"),n.get("stats-panel"),n.get("altitude-legend"),n.get("airspeed-legend"),n.get("loading")],r=a.map(s=>s?s.style.display:null);a.forEach(s=>{s&&(s.style.display="none")}),setTimeout(()=>{window.domtoimage?.toJpeg(t,{width:t.offsetWidth*2,height:t.offsetHeight*2,bgcolor:"#1a1a1a",quality:.95}).then(s=>{a.forEach((p,d)=>{p&&(p.style.display=r[d]||"")}),e.disabled=!1,e.textContent="\u{1F4F7} Export";let o=document.createElement("a");o.download="heatmap_"+new Date().toISOString().slice(0,19).replace(/[:.]/g,"-")+".jpg",o.href=s,o.click()}).catch(s=>{a.forEach((o,p)=>{o&&(o.style.display=r[p]||"")}),alert("Export failed: "+s.message),e.disabled=!1,e.textContent="\u{1F4F7} Export"})},200)}};var Ge=class{constructor(e){this.config=e,this.selectedYear="all",this.selectedAircraft="all",this.allAirportsData=[],this.isInitializing=!0,this.map=null,this.heatmapLayer=null,this.altitudeLayer=F.layerGroup(),this.airspeedLayer=F.layerGroup(),this.airportLayer=F.layerGroup(),this.altitudeRenderer=F.svg(),this.airspeedRenderer=F.svg(),this.currentResolution=null,this.currentData=null,this.fullStats=null,this.fullPathInfo=null,this.fullPathSegments=null,this.altitudeRange={min:0,max:1e4},this.airspeedRange={min:0,max:200},this.heatmapVisible=!0,this.altitudeVisible=!1,this.airspeedVisible=!1,this.airportsVisible=!0,this.aviationVisible=!1,this.buttonsHidden=!1,this.selectedPathIds=new Set,this.pathSegments={},this.pathToAirports={},this.airportToPaths={},this.airportMarkers={},this.openaipLayers={},this.savedState=null,this.restoredYearFromState=!1,this.stateManager=null,this.dataManager=null,this.layerManager=null,this.filterManager=null,this.statsManager=null,this.pathSelection=null,this.airportManager=null,this.replayManager=null,this.wrappedManager=null,this.uiToggles=null}async initialize(){if(this.stateManager=new ke(this),this.savedState=this.stateManager.loadState(),this.savedState&&(this.savedState.selectedYear!==void 0&&(this.selectedYear=this.savedState.selectedYear,this.restoredYearFromState=!0),this.savedState.selectedAircraft&&(this.selectedAircraft=this.savedState.selectedAircraft),this.savedState.selectedPathIds&&this.savedState.selectedPathIds.length>0&&this.savedState.selectedPathIds.forEach(e=>{let t=typeof e=="string"?parseInt(e,10):e;this.selectedPathIds.add(t)}),this.savedState.heatmapVisible!==void 0&&(this.heatmapVisible=this.savedState.heatmapVisible),this.savedState.altitudeVisible!==void 0&&(this.altitudeVisible=this.savedState.altitudeVisible),this.savedState.airspeedVisible!==void 0&&(this.airspeedVisible=this.savedState.airspeedVisible),this.savedState.airportsVisible!==void 0&&(this.airportsVisible=this.savedState.airportsVisible),this.savedState.aviationVisible!==void 0&&(this.aviationVisible=this.savedState.aviationVisible),this.savedState.buttonsHidden!==void 0&&(this.buttonsHidden=this.savedState.buttonsHidden)),this.map=F.map("map",{center:this.config.center,zoom:10,zoomSnap:.25,zoomDelta:.25,wheelPxPerZoomLevel:120,preferCanvas:!0}),this.config.stadiaApiKey?F.tileLayer("https://tiles.stadiamaps.com/tiles/alidade_smooth_dark/{z}/{x}/{y}{r}.png?api_key="+this.config.stadiaApiKey,{attribution:'&copy; <a href="https://stadiamaps.com/">Stadia Maps</a>'}).addTo(this.map):F.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png",{attribution:"&copy; OpenStreetMap contributors, &copy; CARTO"}).addTo(this.map),this.savedState&&this.savedState.center&&this.savedState.zoom?this.map.setView([this.savedState.center.lat,this.savedState.center.lng],this.savedState.zoom):this.map.fitBounds(this.config.bounds,{padding:[30,30]}),this.config.openaipApiKey&&(this.openaipLayers["Aviation Data"]=F.tileLayer("https://{s}.api.tiles.openaip.net/api/data/openaip/{z}/{x}/{y}.png?apiKey="+this.config.openaipApiKey,{attribution:'&copy; <a href="https://www.openaip.net">OpenAIP</a>',maxZoom:18,minZoom:7,subdomains:["a","b","c"]})),this.airportsVisible&&this.airportLayer.addTo(this.map),document.getElementById("heatmap-btn").style.opacity=this.heatmapVisible?"1.0":"0.5",document.getElementById("altitude-btn").style.opacity=this.altitudeVisible?"1.0":"0.5",document.getElementById("airspeed-btn").style.opacity=this.airspeedVisible?"1.0":"0.5",document.getElementById("airports-btn").style.opacity=this.airportsVisible?"1.0":"0.5",document.getElementById("aviation-btn").style.opacity=this.aviationVisible?"1.0":"0.5",this.config.openaipApiKey&&(document.getElementById("aviation-btn").style.display="block"),this.dataManager=new Ce(this),this.layerManager=new De(this),this.filterManager=new Ie(this),this.statsManager=new Ne(this),this.pathSelection=new ze(this),this.airportManager=new Be(this),this.replayManager=new Ve(this),this.wrappedManager=new Ue(this),this.uiToggles=new Ye(this),await this.loadInitialData(),this.setupEventHandlers(),this.isInitializing=!1,this.savedState&&this.savedState.buttonsHidden){let e=document.querySelectorAll(".toggleable-btn"),t=document.getElementById("hide-buttons-btn");e.forEach(a=>{a.classList.add("buttons-hidden")}),t&&(t.textContent="\u{1F53D}")}this.savedState&&this.savedState.wrappedVisible&&setTimeout(()=>{this.wrappedManager&&this.wrappedManager.showWrapped()},500),this.stateManager.saveMapState()}async loadInitialData(){let e=await this.dataManager.loadAirports();this.allAirportsData=e;let t=await this.dataManager.loadMetadata();if(t&&t.available_years){let a=document.getElementById("year-select");if(t.available_years.forEach(r=>{let s=document.createElement("option");s.value=r.toString(),s.textContent="\u{1F4C5} "+r,a.appendChild(s)}),this.selectedYear==="all"&&!this.restoredYearFromState){let r=t.available_years[t.available_years.length-1];r!==void 0&&(this.selectedYear=r.toString())}this.selectedYear&&this.selectedYear!=="all"&&(a.value=this.selectedYear)}this.createAirportMarkers(e),t&&t.stats&&(this.fullStats=t.stats);try{let a=await this.dataManager.loadData("z14_plus",this.selectedYear);a&&a.path_info&&(this.fullPathInfo=a.path_info),a&&a.path_segments&&(this.fullPathSegments=a.path_segments)}catch{}if(this.filterManager.updateAircraftDropdown(),this.airportManager.updateAirportPopups(),this.fullStats){let a=window.KMLHeatmap.calculateFilteredStatistics({pathInfo:this.fullPathInfo??[],segments:this.fullPathSegments??[],year:this.selectedYear,aircraft:this.selectedAircraft});this.statsManager.updateStatsPanel(a,!1)}if(this.airportManager.updateAirportOpacity(),t&&t.min_groundspeed_knots!==void 0&&t.max_groundspeed_knots!==void 0&&(this.airspeedRange.min=t.min_groundspeed_knots,this.airspeedRange.max=t.max_groundspeed_knots,this.layerManager.updateAirspeedLegend(this.airspeedRange.min,this.airspeedRange.max)),await this.dataManager.updateLayers(),this.airportManager.updateAirportMarkerSizes(),this.altitudeVisible&&(this.map.addLayer(this.altitudeLayer),document.getElementById("altitude-legend").style.display="block"),this.airspeedVisible&&(this.map.addLayer(this.airspeedLayer),document.getElementById("airspeed-legend").style.display="block"),this.aviationVisible&&this.config.openaipApiKey&&this.openaipLayers["Aviation Data"]&&this.map.addLayer(this.openaipLayers["Aviation Data"]),this.selectedPathIds.size>0&&this.replayManager.updateReplayButtonState(),this.savedState&&this.savedState.statsPanelVisible){let a=document.getElementById("stats-panel");a.style.display="block",a.offsetHeight,a.classList.add("visible")}}createAirportMarkers(e){let t=null;e.length>0&&(t=e.reduce((a,r)=>{let s=r,o=a,p=s.flight_count??0,d=o?.flight_count??0;return p>d?r:a})),e.forEach(a=>{let r=a.name?a.name.match(/\b([A-Z]{4})\b/):null,s=r?r[1]:"APT",o=t&&a.name===t.name,p=o?" airport-marker-home":"",d=o?" airport-label-home":"",h='<div class="airport-marker-container"><div class="airport-marker'+p+'"></div><div class="airport-label'+d+'">'+s+"</div></div>",g=window.KMLHeatmap.ddToDms(a.lat,!0),v=window.KMLHeatmap.ddToDms(a.lon,!1),A=`https://www.google.com/maps?q=${a.lat},${a.lon}`,b=`
            <div style="
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
                min-width: 220px;
                padding: 8px 4px;
                background-color: #2b2b2b;
                color: #ffffff;
            ">
                <div style="
                    font-size: 15px;
                    font-weight: bold;
                    color: #28a745;
                    margin-bottom: 10px;
                    padding-bottom: 8px;
                    border-bottom: 2px solid #28a745;
                    display: flex;
                    align-items: center;
                    gap: 6px;
                ">
                    <span style="font-size: 18px;">\u{1F6EB}</span>
                    <span>${a.name||"Unknown"}</span>
                    ${o?'<span style="font-size: 12px; background: #007bff; color: white; padding: 2px 6px; border-radius: 3px; margin-left: 4px;">HOME</span>':""}
                </div>
                <div style="margin-bottom: 8px;">
                    <div style="font-size: 11px; color: #999; margin-bottom: 2px; text-transform: uppercase; letter-spacing: 0.5px;">Coordinates</div>
                    <a href="${A}"
                       target="_blank"
                       style="
                           color: #4facfe;
                           text-decoration: none;
                           font-size: 12px;
                           font-family: monospace;
                           display: flex;
                           align-items: center;
                           gap: 4px;
                       "
                       onmouseover="this.style.textDecoration='underline'"
                       onmouseout="this.style.textDecoration='none'">
                        <span>\u{1F4CD}</span>
                        <span>${g}<br>${v}</span>
                    </a>
                </div>
                <div style="
                    background: linear-gradient(135deg, rgba(79, 172, 254, 0.15) 0%, rgba(0, 242, 254, 0.15) 100%);
                    padding: 8px 10px;
                    border-radius: 6px;
                    border-left: 3px solid #4facfe;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                ">
                    <span style="font-size: 12px; color: #ccc; font-weight: 500;">Total Flights</span>
                    <span style="font-size: 16px; font-weight: bold; color: #4facfe;">${a.flight_count||0}</span>
                </div>
            </div>`,m=F.marker([a.lat,a.lon],{icon:F.divIcon({html:h,iconSize:[12,12],iconAnchor:[6,6],popupAnchor:[0,-6],className:""})}).bindPopup(b,{autoPanPadding:[50,50]});m.on("click",y=>{this.replayManager.replayActive||this.pathSelection.selectPathsByAirport(a.name)}),m.addTo(this.airportLayer),this.airportMarkers[a.name]=m})}setupEventHandlers(){this.map.on("moveend",()=>this.stateManager.saveMapState()),this.map.on("zoomend",()=>{this.stateManager.saveMapState(),this.dataManager.updateLayers(),this.airportManager.updateAirportMarkerSizes()}),this.map.on("click",e=>{this.replayManager.replayActive&&this.replayManager.replayAirplaneMarker&&this.replayManager.replayAirplaneMarker.isPopupOpen()&&this.replayManager.replayAirplaneMarker.closePopup(),!this.replayManager.replayActive&&this.selectedPathIds.size>0&&this.pathSelection.clearSelection()})}toggleHeatmap(){this.uiToggles.toggleHeatmap()}toggleStats(){this.statsManager.toggleStats()}toggleAltitude(){this.uiToggles.toggleAltitude()}toggleAirspeed(){this.uiToggles.toggleAirspeed()}toggleAirports(){this.uiToggles.toggleAirports()}toggleAviation(){this.uiToggles.toggleAviation()}toggleReplay(){this.replayManager.toggleReplay()}filterByYear(){this.filterManager.filterByYear()}filterByAircraft(){this.filterManager.filterByAircraft()}togglePathSelection(e){this.pathSelection.togglePathSelection(Number(e))}exportMap(){this.uiToggles.exportMap()}showWrapped(){this.wrappedManager.showWrapped()}closeWrapped(e){this.wrappedManager.closeWrapped(e)}toggleButtonsVisibility(){this.uiToggles.toggleButtonsVisibility()}playReplay(){this.replayManager.playReplay()}pauseReplay(){this.replayManager.pauseReplay()}stopReplay(){this.replayManager.stopReplay()}seekReplay(e){this.replayManager.seekReplay(e)}changeReplaySpeed(){this.replayManager.changeReplaySpeed()}toggleAutoZoom(){this.replayManager.toggleAutoZoom()}};typeof window<"u"&&(window.initMapApp=async c=>{let e=new Ge(c);window.mapApp=e,await e.initialize(),window.toggleHeatmap=()=>e.toggleHeatmap(),window.toggleStats=()=>e.toggleStats(),window.toggleAltitude=()=>e.toggleAltitude(),window.toggleAirspeed=()=>e.toggleAirspeed(),window.toggleAirports=()=>e.toggleAirports(),window.toggleAviation=()=>e.toggleAviation(),window.toggleReplay=()=>e.toggleReplay(),window.filterByYear=()=>e.filterByYear(),window.filterByAircraft=()=>e.filterByAircraft(),window.togglePathSelection=t=>e.togglePathSelection(t),window.exportMap=()=>e.exportMap(),window.showWrapped=()=>e.showWrapped(),window.closeWrapped=t=>e.closeWrapped(t),window.toggleButtonsVisibility=()=>e.toggleButtonsVisibility(),window.playReplay=()=>e.playReplay(),window.pauseReplay=()=>e.pauseReplay(),window.stopReplay=()=>e.stopReplay(),window.seekReplay=t=>e.seekReplay(String(t)),window.changeReplaySpeed=()=>e.changeReplaySpeed(),window.toggleAutoZoom=()=>e.toggleAutoZoom()});typeof window<"u"&&window.MAP_CONFIG&&window.initMapApp&&window.initMapApp(window.MAP_CONFIG);return va(Ya);})();
/*! Bundled license information:

dompurify/dist/purify.es.mjs:
  (*! @license DOMPurify 3.3.1 | (c) Cure53 and other contributors | Released under the Apache license 2.0 and Mozilla Public License 2.0 | github.com/cure53/DOMPurify/blob/3.3.1/LICENSE *)
*/
