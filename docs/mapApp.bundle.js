"use strict";var MapAppModule=(()=>{var wa=Object.create;var Pe=Object.defineProperty;var Ea=Object.getOwnPropertyDescriptor;var Pa=Object.getOwnPropertyNames;var Ca=Object.getPrototypeOf,Ra=Object.prototype.hasOwnProperty;var ka=(n,e)=>()=>(e||n((e={exports:{}}).exports,e),e.exports),Da=(n,e)=>{for(var t in e)Pe(n,t,{get:e[t],enumerable:!0})},Kt=(n,e,t,a)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of Pa(e))!Ra.call(n,s)&&s!==t&&Pe(n,s,{get:()=>e[s],enumerable:!(a=Ea(e,s))||a.enumerable});return n};var me=(n,e,t)=>(t=n!=null?wa(Ca(n)):{},Kt(e||!n||!n.__esModule?Pe(t,"default",{value:n,enumerable:!0}):t,n)),Ia=n=>Kt(Pe({},"__esModule",{value:!0}),n);var ie=ka((si,Gt)=>{Gt.exports=window.L});var ii={};Da(ii,{MapApp:()=>Ge});var z=me(ie(),1);var lt=class{constructor(){this.cache=new Map}get(e){if(this.cache.has(e)){let a=this.cache.get(e);if(document.contains(a))return a;this.cache.delete(e)}let t=document.getElementById(e);return t&&this.cache.set(e,t),t}cacheElements(e){e.forEach(t=>{let a=document.getElementById(t);a&&this.cache.set(t,a)})}clear(){this.cache.clear()}remove(e){this.cache.delete(e)}has(e){return this.cache.has(e)}get size(){return this.cache.size}},l=new lt;var Ce=class{constructor(e){this.app=e,l.cacheElements(["loading"]),this.dataLoader=new window.KMLHeatmap.DataLoader({dataDir:e.config.dataDir,showLoading:()=>this.showLoading(),hideLoading:()=>this.hideLoading()}),this.loadedData={},this.currentData=null}showLoading(){let e=l.get("loading");e&&(e.style.display="block")}hideLoading(){let e=l.get("loading");e&&(e.style.display="none")}async loadData(e,t){return await this.dataLoader.loadData(e,t)}async loadAirports(){return await this.dataLoader.loadAirports()}async loadMetadata(){return await this.dataLoader.loadMetadata()}async updateLayers(){if(!this.app.map)return;let e=await this.loadData("data",this.app.selectedYear);if(!e)return;this.currentData=e,this.app.currentData=e;let t=e.coordinates;if((this.app.selectedYear!=="all"||this.app.selectedAircraft!=="all")&&e.path_segments){let a=new Set;e.path_info&&e.path_info.forEach(r=>{let o=this.app.selectedYear==="all"||r.year&&r.year.toString()===this.app.selectedYear,p=this.app.selectedAircraft==="all"||r.aircraft_registration===this.app.selectedAircraft;o&&p&&a.add(r.id)});let s=new Set;e.path_segments.forEach(r=>{if(a.has(r.path_id)){let o=r.coords;o&&o.length===2&&(s.add(JSON.stringify(o[0])),s.add(JSON.stringify(o[1])))}}),t=Array.from(s).map(r=>JSON.parse(r))}if(this.app.heatmapLayer&&this.app.heatmapLayer.remove(),this.app.heatmapLayer=L.heatLayer(t,{radius:10,blur:15,minOpacity:.25,maxOpacity:.6,max:1,gradient:{0:"blue",.3:"cyan",.5:"lime",.7:"yellow",1:"red"}}),this.app.heatmapLayer.e&&(this.app.heatmapLayer.e.style.pointerEvents="none"),this.app.heatmapVisible&&!this.app.replayManager.replayActive&&this.app.heatmapLayer.addTo(this.app.map),this.app.pathToAirports={},this.app.airportToPaths={},e.path_info&&e.path_info.forEach(a=>{let s=a.id;this.app.pathToAirports[s]={start:a.start_airport,end:a.end_airport},a.start_airport&&(this.app.airportToPaths[a.start_airport]||(this.app.airportToPaths[a.start_airport]=new Set),this.app.airportToPaths[a.start_airport].add(s)),a.end_airport&&(this.app.airportToPaths[a.end_airport]||(this.app.airportToPaths[a.end_airport]=new Set),this.app.airportToPaths[a.end_airport].add(s))}),e.path_segments&&e.path_segments.length>0){let a=e.path_segments.map(o=>o.altitude_ft||0),s=a[0]??0,r=a[0]??0;for(let o=1;o<a.length;o++){let p=a[o]??0;p<s&&(s=p),p>r&&(r=p)}this.app.altitudeRange.min=s,this.app.altitudeRange.max=r}this.app.layerManager.redrawAltitudePaths(),this.app.airspeedVisible&&this.app.layerManager.redrawAirspeedPaths()}};var Re=class{constructor(e){this.app=e,l.cacheElements(["stats-panel","wrapped-modal"])}saveMapState(){if(!this.app.map)return;let e=l.get("stats-panel"),t=l.get("wrapped-modal"),a={center:this.app.map.getCenter(),zoom:this.app.map.getZoom(),heatmapVisible:this.app.heatmapVisible,altitudeVisible:this.app.altitudeVisible,airspeedVisible:this.app.airspeedVisible,airportsVisible:this.app.airportsVisible,aviationVisible:this.app.aviationVisible,selectedYear:this.app.selectedYear,selectedAircraft:this.app.selectedAircraft,selectedPathIds:Array.from(this.app.selectedPathIds),statsPanelVisible:e?e.classList.contains("visible"):!1,wrappedVisible:t?t.style.display==="flex":!1,buttonsHidden:this.app.buttonsHidden};try{localStorage.setItem("kml-heatmap-state",JSON.stringify(a))}catch{}this.updateUrl(a)}loadMapState(){try{let e=localStorage.getItem("kml-heatmap-state");if(e)return JSON.parse(e)}catch{}return null}updateUrl(e){let t=window.KMLHeatmap.encodeStateToUrl(e),a=t?"?"+t:window.location.pathname;try{history.replaceState(null,"",a)}catch{}}loadState(){let e=window.KMLHeatmap.parseUrlParams(new URLSearchParams(window.location.search));return e&&Object.keys(e).length>0?e:this.loadMapState()}};var he=me(ie(),1);function Wt(...n){console.warn(...n)}function $t(...n){console.error(...n)}var ke=class{constructor(e){this.app=e,l.cacheElements(["legend-min","legend-max","airspeed-legend-min","airspeed-legend-max"])}redrawAltitudePaths(){if(!this.app.currentData)return;this.app.altitudeLayer.clearLayers(),this.app.pathSegments={};let e,t;if(this.app.selectedPathIds.size>0){let s=this.app.currentData.path_segments.filter(r=>this.app.selectedPathIds.has(r.path_id));if(s.length>0){let r=s.map(c=>c.altitude_ft||0),o=r[0]??0,p=r[0]??0;for(let c=1;c<r.length;c++){let h=r[c]??0;h<o&&(o=h),h>p&&(p=h)}e=o,t=p}else e=this.app.altitudeRange.min,t=this.app.altitudeRange.max}else e=this.app.altitudeRange.min,t=this.app.altitudeRange.max;let a=new Map(this.app.currentData.path_info.map(s=>[s.id,s]));this.app.currentData.path_segments.forEach(s=>{let r=s.path_id,o=a.get(r);if(this.app.selectedYear!=="all"&&o&&o.year&&o.year.toString()!==this.app.selectedYear||this.app.selectedAircraft!=="all"&&o&&o.aircraft_registration!==this.app.selectedAircraft)return;let p=this.app.selectedPathIds.has(r);if(this.app.selectedPathIds.size>0&&!p&&this.app.buttonsHidden)return;let c=window.KMLHeatmap.getColorForAltitude(s.altitude_ft??0,e,t);he.polyline(s.coords||[],{color:c,weight:p?6:4,opacity:p?1:this.app.selectedPathIds.size>0?.1:.85,renderer:this.app.altitudeRenderer,interactive:!0}).bindPopup("Altitude: "+s.altitude_ft+" ft ("+s.altitude_m+" m)").addTo(this.app.altitudeLayer).on("click",f=>{he.DomEvent.stopPropagation(f),this.app.pathSelection.togglePathSelection(r)}),this.app.pathSegments[r]||(this.app.pathSegments[r]=[]),this.app.pathSegments[r].push(s)}),this.updateAltitudeLegend(e,t),this.app.airportManager.updateAirportOpacity(),this.app.statsManager.updateStatsForSelection()}redrawAirspeedPaths(){if(!this.app.currentData){Wt("redrawAirspeedPaths: No current data available");return}this.app.airspeedLayer.clearLayers();let e,t;if(this.app.selectedPathIds.size>0){let s=this.app.currentData.path_segments.filter(r=>this.app.selectedPathIds.has(r.path_id)&&(r.groundspeed_knots||0)>0);if(s.length>0){let r=s.map(c=>c.groundspeed_knots||0),o=r[0]??0,p=r[0]??0;for(let c=1;c<r.length;c++){let h=r[c]??0;h<o&&(o=h),h>p&&(p=h)}e=o,t=p}else e=this.app.airspeedRange.min,t=this.app.airspeedRange.max}else e=this.app.airspeedRange.min,t=this.app.airspeedRange.max;let a=new Map(this.app.currentData.path_info.map(s=>[s.id,s]));this.app.currentData.path_segments.forEach(s=>{let r=s.path_id,o=a.get(r);if(!(this.app.selectedYear!=="all"&&o&&o.year&&o.year.toString()!==this.app.selectedYear)&&!(this.app.selectedAircraft!=="all"&&o&&o.aircraft_registration!==this.app.selectedAircraft)&&(s.groundspeed_knots||0)>0){let p=this.app.selectedPathIds.has(r);if(this.app.selectedPathIds.size>0&&!p&&this.app.buttonsHidden)return;let c=window.KMLHeatmap.getColorForAirspeed(s.groundspeed_knots??0,e,t),h=Math.round((s.groundspeed_knots||0)*1.852);he.polyline(s.coords||[],{color:c,weight:p?6:4,opacity:p?1:this.app.selectedPathIds.size>0?.1:.85,renderer:this.app.airspeedRenderer,interactive:!0}).bindPopup("Groundspeed: "+s.groundspeed_knots+" kt ("+h+" km/h)").addTo(this.app.airspeedLayer).on("click",b=>{he.DomEvent.stopPropagation(b),this.app.pathSelection.togglePathSelection(r)})}}),this.updateAirspeedLegend(e,t),this.app.airportManager.updateAirportOpacity(),this.app.statsManager.updateStatsForSelection()}updateAltitudeLegend(e,t){let a=Math.round(e),s=Math.round(t),r=Math.round(e*.3048),o=Math.round(t*.3048),p=l.get("legend-min"),c=l.get("legend-max");p&&(p.textContent=a+" ft ("+r+" m)"),c&&(c.textContent=s+" ft ("+o+" m)")}updateAirspeedLegend(e,t){let a=Math.round(e),s=Math.round(t),r=Math.round(e*1.852),o=Math.round(t*1.852),p=l.get("airspeed-legend-min"),c=l.get("airspeed-legend-max");p&&(p.textContent=a+" kt ("+r+" km/h)"),c&&(c.textContent=s+" kt ("+o+" km/h)")}};var De=class{constructor(e){this.app=e,l.cacheElements(["aircraft-select","year-select"])}updateAircraftDropdown(){if(!this.app.fullPathInfo)return;let e=l.get("aircraft-select");if(!e)return;let t=this.app.selectedAircraft;for(;e.options.length>1;)e.remove(1);let a;this.app.selectedYear==="all"?a=this.app.fullPathInfo:a=this.app.fullPathInfo.filter(p=>p.year&&p.year.toString()===this.app.selectedYear);let s={};a.forEach(p=>{if(p.aircraft_registration){let c=p.aircraft_registration;s[c]||(s[c]={registration:c,type:p.aircraft_type,flights:0}),s[c].flights+=1}});let r=Object.values(s).sort((p,c)=>c.flights-p.flights),o=!1;r.forEach(p=>{let c=document.createElement("option");c.value=p.registration;let h=p.type?" ("+p.type+")":"";c.textContent="\u2708\uFE0F "+p.registration+h,e.appendChild(c),p.registration===t&&(o=!0)}),!o&&t!=="all"?(this.app.selectedAircraft="all",e.value="all"):e.value=t}async filterByYear(){let e=l.get("year-select");if(!e)return;this.app.selectedYear=e.value,this.app.dataManager.loadedData={},this.app.altitudeLayer.clearLayers(),this.app.pathSegments={},this.app.isInitializing||this.app.selectedPathIds.clear(),await this.app.dataManager.updateLayers();let t=await this.app.dataManager.loadData("data",this.app.selectedYear);t&&(this.app.fullPathInfo=t.path_info||[],this.app.fullPathSegments=t.path_segments||[]),this.updateAircraftDropdown();let a=window.KMLHeatmap.calculateFilteredStatistics({pathInfo:this.app.fullPathInfo??[],segments:this.app.fullPathSegments??[],year:this.app.selectedYear,aircraft:this.app.selectedAircraft,coordinateCount:this.app.currentData?.original_points});this.app.statsManager.updateStatsPanel(a,!1),this.app.airportManager.updateAirportOpacity(),this.app.airportManager.updateAirportPopups(),this.app.isInitializing||this.app.stateManager.saveMapState()}async filterByAircraft(){let e=l.get("aircraft-select");if(!e)return;this.app.selectedAircraft=e.value,this.app.altitudeLayer.clearLayers(),this.app.pathSegments={},this.app.isInitializing||this.app.selectedPathIds.clear(),await this.app.dataManager.updateLayers();let t=window.KMLHeatmap.calculateFilteredStatistics({pathInfo:this.app.fullPathInfo??[],segments:this.app.fullPathSegments??[],year:this.app.selectedYear,aircraft:this.app.selectedAircraft,coordinateCount:this.app.currentData?.original_points});this.app.statsManager.updateStatsPanel(t,!1),this.app.airportManager.updateAirportOpacity(),this.app.airportManager.updateAirportPopups(),this.app.isInitializing||this.app.stateManager.saveMapState()}};var{entries:aa,setPrototypeOf:Zt,isFrozen:Oa,getPrototypeOf:Ha,getOwnPropertyDescriptor:Fa}=Object,{freeze:H,seal:B,create:ft}=Object,{apply:gt,construct:yt}=typeof Reflect<"u"&&Reflect;H||(H=function(e){return e});B||(B=function(e){return e});gt||(gt=function(e,t){for(var a=arguments.length,s=new Array(a>2?a-2:0),r=2;r<a;r++)s[r-2]=arguments[r];return e.apply(t,s)});yt||(yt=function(e){for(var t=arguments.length,a=new Array(t>1?t-1:0),s=1;s<t;s++)a[s-1]=arguments[s];return new e(...a)});var Ie=F(Array.prototype.forEach),Na=F(Array.prototype.lastIndexOf),jt=F(Array.prototype.pop),ye=F(Array.prototype.push),za=F(Array.prototype.splice),He=F(String.prototype.toLowerCase),pt=F(String.prototype.toString),dt=F(String.prototype.match),be=F(String.prototype.replace),Ba=F(String.prototype.indexOf),Va=F(String.prototype.trim),V=F(Object.prototype.hasOwnProperty),O=F(RegExp.prototype.test),Ae=Ua(TypeError);function F(n){return function(e){e instanceof RegExp&&(e.lastIndex=0);for(var t=arguments.length,a=new Array(t>1?t-1:0),s=1;s<t;s++)a[s-1]=arguments[s];return gt(n,e,a)}}function Ua(n){return function(){for(var e=arguments.length,t=new Array(e),a=0;a<e;a++)t[a]=arguments[a];return yt(n,t)}}function y(n,e){let t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:He;Zt&&Zt(n,null);let a=e.length;for(;a--;){let s=e[a];if(typeof s=="string"){let r=t(s);r!==s&&(Oa(e)||(e[a]=r),s=r)}n[s]=!0}return n}function Ya(n){for(let e=0;e<n.length;e++)V(n,e)||(n[e]=null);return n}function W(n){let e=ft(null);for(let[t,a]of aa(n))V(n,t)&&(Array.isArray(a)?e[t]=Ya(a):a&&typeof a=="object"&&a.constructor===Object?e[t]=W(a):e[t]=a);return e}function Me(n,e){for(;n!==null;){let a=Fa(n,e);if(a){if(a.get)return F(a.get);if(typeof a.value=="function")return F(a.value)}n=Ha(n)}function t(){return null}return t}var qt=H(["a","abbr","acronym","address","area","article","aside","audio","b","bdi","bdo","big","blink","blockquote","body","br","button","canvas","caption","center","cite","code","col","colgroup","content","data","datalist","dd","decorator","del","details","dfn","dialog","dir","div","dl","dt","element","em","fieldset","figcaption","figure","font","footer","form","h1","h2","h3","h4","h5","h6","head","header","hgroup","hr","html","i","img","input","ins","kbd","label","legend","li","main","map","mark","marquee","menu","menuitem","meter","nav","nobr","ol","optgroup","option","output","p","picture","pre","progress","q","rp","rt","ruby","s","samp","search","section","select","shadow","slot","small","source","spacer","span","strike","strong","style","sub","summary","sup","table","tbody","td","template","textarea","tfoot","th","thead","time","tr","track","tt","u","ul","var","video","wbr"]),ct=H(["svg","a","altglyph","altglyphdef","altglyphitem","animatecolor","animatemotion","animatetransform","circle","clippath","defs","desc","ellipse","enterkeyhint","exportparts","filter","font","g","glyph","glyphref","hkern","image","inputmode","line","lineargradient","marker","mask","metadata","mpath","part","path","pattern","polygon","polyline","radialgradient","rect","stop","style","switch","symbol","text","textpath","title","tref","tspan","view","vkern"]),mt=H(["feBlend","feColorMatrix","feComponentTransfer","feComposite","feConvolveMatrix","feDiffuseLighting","feDisplacementMap","feDistantLight","feDropShadow","feFlood","feFuncA","feFuncB","feFuncG","feFuncR","feGaussianBlur","feImage","feMerge","feMergeNode","feMorphology","feOffset","fePointLight","feSpecularLighting","feSpotLight","feTile","feTurbulence"]),Ka=H(["animate","color-profile","cursor","discard","font-face","font-face-format","font-face-name","font-face-src","font-face-uri","foreignobject","hatch","hatchpath","mesh","meshgradient","meshpatch","meshrow","missing-glyph","script","set","solidcolor","unknown","use"]),ht=H(["math","menclose","merror","mfenced","mfrac","mglyph","mi","mlabeledtr","mmultiscripts","mn","mo","mover","mpadded","mphantom","mroot","mrow","ms","mspace","msqrt","mstyle","msub","msup","msubsup","mtable","mtd","mtext","mtr","munder","munderover","mprescripts"]),Ga=H(["maction","maligngroup","malignmark","mlongdiv","mscarries","mscarry","msgroup","mstack","msline","msrow","semantics","annotation","annotation-xml","mprescripts","none"]),Xt=H(["#text"]),Jt=H(["accept","action","align","alt","autocapitalize","autocomplete","autopictureinpicture","autoplay","background","bgcolor","border","capture","cellpadding","cellspacing","checked","cite","class","clear","color","cols","colspan","controls","controlslist","coords","crossorigin","datetime","decoding","default","dir","disabled","disablepictureinpicture","disableremoteplayback","download","draggable","enctype","enterkeyhint","exportparts","face","for","headers","height","hidden","high","href","hreflang","id","inert","inputmode","integrity","ismap","kind","label","lang","list","loading","loop","low","max","maxlength","media","method","min","minlength","multiple","muted","name","nonce","noshade","novalidate","nowrap","open","optimum","part","pattern","placeholder","playsinline","popover","popovertarget","popovertargetaction","poster","preload","pubdate","radiogroup","readonly","rel","required","rev","reversed","role","rows","rowspan","spellcheck","scope","selected","shape","size","sizes","slot","span","srclang","start","src","srcset","step","style","summary","tabindex","title","translate","type","usemap","valign","value","width","wrap","xmlns","slot"]),ut=H(["accent-height","accumulate","additive","alignment-baseline","amplitude","ascent","attributename","attributetype","azimuth","basefrequency","baseline-shift","begin","bias","by","class","clip","clippathunits","clip-path","clip-rule","color","color-interpolation","color-interpolation-filters","color-profile","color-rendering","cx","cy","d","dx","dy","diffuseconstant","direction","display","divisor","dur","edgemode","elevation","end","exponent","fill","fill-opacity","fill-rule","filter","filterunits","flood-color","flood-opacity","font-family","font-size","font-size-adjust","font-stretch","font-style","font-variant","font-weight","fx","fy","g1","g2","glyph-name","glyphref","gradientunits","gradienttransform","height","href","id","image-rendering","in","in2","intercept","k","k1","k2","k3","k4","kerning","keypoints","keysplines","keytimes","lang","lengthadjust","letter-spacing","kernelmatrix","kernelunitlength","lighting-color","local","marker-end","marker-mid","marker-start","markerheight","markerunits","markerwidth","maskcontentunits","maskunits","max","mask","mask-type","media","method","mode","min","name","numoctaves","offset","operator","opacity","order","orient","orientation","origin","overflow","paint-order","path","pathlength","patterncontentunits","patterntransform","patternunits","points","preservealpha","preserveaspectratio","primitiveunits","r","rx","ry","radius","refx","refy","repeatcount","repeatdur","restart","result","rotate","scale","seed","shape-rendering","slope","specularconstant","specularexponent","spreadmethod","startoffset","stddeviation","stitchtiles","stop-color","stop-opacity","stroke-dasharray","stroke-dashoffset","stroke-linecap","stroke-linejoin","stroke-miterlimit","stroke-opacity","stroke","stroke-width","style","surfacescale","systemlanguage","tabindex","tablevalues","targetx","targety","transform","transform-origin","text-anchor","text-decoration","text-rendering","textlength","type","u1","u2","unicode","values","viewbox","visibility","version","vert-adv-y","vert-origin-x","vert-origin-y","width","word-spacing","wrap","writing-mode","xchannelselector","ychannelselector","x","x1","x2","xmlns","y","y1","y2","z","zoomandpan"]),Qt=H(["accent","accentunder","align","bevelled","close","columnsalign","columnlines","columnspan","denomalign","depth","dir","display","displaystyle","encoding","fence","frame","height","href","id","largeop","length","linethickness","lspace","lquote","mathbackground","mathcolor","mathsize","mathvariant","maxsize","minsize","movablelimits","notation","numalign","open","rowalign","rowlines","rowspacing","rowspan","rspace","rquote","scriptlevel","scriptminsize","scriptsizemultiplier","selection","separator","separators","stretchy","subscriptshift","supscriptshift","symmetric","voffset","width","xmlns"]),Oe=H(["xlink:href","xml:id","xlink:title","xml:space","xmlns:xlink"]),Wa=B(/\{\{[\w\W]*|[\w\W]*\}\}/gm),$a=B(/<%[\w\W]*|[\w\W]*%>/gm),Za=B(/\$\{[\w\W]*/gm),ja=B(/^data-[\-\w.\u00B7-\uFFFF]+$/),qa=B(/^aria-[\-\w]+$/),ia=B(/^(?:(?:(?:f|ht)tps?|mailto|tel|callto|sms|cid|xmpp|matrix):|[^a-z]|[a-z+.\-]+(?:[^a-z+.\-:]|$))/i),Xa=B(/^(?:\w+script|data):/i),Ja=B(/[\u0000-\u0020\u00A0\u1680\u180E\u2000-\u2029\u205F\u3000]/g),ra=B(/^html$/i),Qa=B(/^[a-z][.\w]*(-[.\w]+)+$/i),ea=Object.freeze({__proto__:null,ARIA_ATTR:qa,ATTR_WHITESPACE:Ja,CUSTOM_ELEMENT:Qa,DATA_ATTR:ja,DOCTYPE_NAME:ra,ERB_EXPR:$a,IS_ALLOWED_URI:ia,IS_SCRIPT_OR_DATA:Xa,MUSTACHE_EXPR:Wa,TMPLIT_EXPR:Za}),ve={element:1,attribute:2,text:3,cdataSection:4,entityReference:5,entityNode:6,progressingInstruction:7,comment:8,document:9,documentType:10,documentFragment:11,notation:12},ei=function(){return typeof window>"u"?null:window},ti=function(e,t){if(typeof e!="object"||typeof e.createPolicy!="function")return null;let a=null,s="data-tt-policy-suffix";t&&t.hasAttribute(s)&&(a=t.getAttribute(s));let r="dompurify"+(a?"#"+a:"");try{return e.createPolicy(r,{createHTML(o){return o},createScriptURL(o){return o}})}catch{return console.warn("TrustedTypes policy "+r+" could not be created."),null}},ta=function(){return{afterSanitizeAttributes:[],afterSanitizeElements:[],afterSanitizeShadowDOM:[],beforeSanitizeAttributes:[],beforeSanitizeElements:[],beforeSanitizeShadowDOM:[],uponSanitizeAttribute:[],uponSanitizeElement:[],uponSanitizeShadowNode:[]}};function sa(){let n=arguments.length>0&&arguments[0]!==void 0?arguments[0]:ei(),e=u=>sa(u);if(e.version="3.3.1",e.removed=[],!n||!n.document||n.document.nodeType!==ve.document||!n.Element)return e.isSupported=!1,e;let{document:t}=n,a=t,s=a.currentScript,{DocumentFragment:r,HTMLTemplateElement:o,Node:p,Element:c,NodeFilter:h,NamedNodeMap:f=n.NamedNodeMap||n.MozNamedAttrMap,HTMLFormElement:b,DOMParser:T,trustedTypes:g}=n,A=c.prototype,v=Me(A,"cloneNode"),x=Me(A,"remove"),U=Me(A,"nextSibling"),$=Me(A,"childNodes"),S=Me(A,"parentNode");if(typeof o=="function"){let u=t.createElement("template");u.content&&u.content.ownerDocument&&(t=u.content.ownerDocument)}let M,Y="",{implementation:X,createNodeIterator:ee,createDocumentFragment:We,getElementsByTagName:ha}=t,{importNode:ua}=a,I=ta();e.isSupported=typeof aa=="function"&&typeof S=="function"&&X&&X.createHTMLDocument!==void 0;let{MUSTACHE_EXPR:$e,ERB_EXPR:Ze,TMPLIT_EXPR:je,DATA_ATTR:fa,ARIA_ATTR:ga,IS_SCRIPT_OR_DATA:ya,ATTR_WHITESPACE:Mt,CUSTOM_ELEMENT:ba}=ea,{IS_ALLOWED_URI:vt}=ea,C=null,St=y({},[...qt,...ct,...mt,...ht,...Xt]),R=null,Lt=y({},[...Jt,...ut,...Qt,...Oe]),w=Object.seal(ft(null,{tagNameCheck:{writable:!0,configurable:!1,enumerable:!0,value:null},attributeNameCheck:{writable:!0,configurable:!1,enumerable:!0,value:null},allowCustomizedBuiltInElements:{writable:!0,configurable:!1,enumerable:!0,value:!1}})),ue=null,qe=null,se=Object.seal(ft(null,{tagCheck:{writable:!0,configurable:!1,enumerable:!0,value:null},attributeCheck:{writable:!0,configurable:!1,enumerable:!0,value:null}})),_t=!0,Xe=!0,Tt=!1,xt=!0,ne=!1,Se=!0,te=!1,Je=!1,Qe=!1,oe=!1,Le=!1,_e=!1,wt=!0,Et=!1,Aa="user-content-",et=!0,fe=!1,le={},K=null,tt=y({},["annotation-xml","audio","colgroup","desc","foreignobject","head","iframe","math","mi","mn","mo","ms","mtext","noembed","noframes","noscript","plaintext","script","style","svg","template","thead","title","video","xmp"]),Pt=null,Ct=y({},["audio","video","img","source","image","track"]),at=null,Rt=y({},["alt","class","for","id","label","name","pattern","placeholder","role","summary","title","value","style","xmlns"]),Te="http://www.w3.org/1998/Math/MathML",xe="http://www.w3.org/2000/svg",Z="http://www.w3.org/1999/xhtml",pe=Z,it=!1,rt=null,Ma=y({},[Te,xe,Z],pt),we=y({},["mi","mo","mn","ms","mtext"]),Ee=y({},["annotation-xml"]),va=y({},["title","style","font","a","script"]),ge=null,Sa=["application/xhtml+xml","text/html"],La="text/html",P=null,de=null,_a=t.createElement("form"),kt=function(i){return i instanceof RegExp||i instanceof Function},st=function(){let i=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};if(!(de&&de===i)){if((!i||typeof i!="object")&&(i={}),i=W(i),ge=Sa.indexOf(i.PARSER_MEDIA_TYPE)===-1?La:i.PARSER_MEDIA_TYPE,P=ge==="application/xhtml+xml"?pt:He,C=V(i,"ALLOWED_TAGS")?y({},i.ALLOWED_TAGS,P):St,R=V(i,"ALLOWED_ATTR")?y({},i.ALLOWED_ATTR,P):Lt,rt=V(i,"ALLOWED_NAMESPACES")?y({},i.ALLOWED_NAMESPACES,pt):Ma,at=V(i,"ADD_URI_SAFE_ATTR")?y(W(Rt),i.ADD_URI_SAFE_ATTR,P):Rt,Pt=V(i,"ADD_DATA_URI_TAGS")?y(W(Ct),i.ADD_DATA_URI_TAGS,P):Ct,K=V(i,"FORBID_CONTENTS")?y({},i.FORBID_CONTENTS,P):tt,ue=V(i,"FORBID_TAGS")?y({},i.FORBID_TAGS,P):W({}),qe=V(i,"FORBID_ATTR")?y({},i.FORBID_ATTR,P):W({}),le=V(i,"USE_PROFILES")?i.USE_PROFILES:!1,_t=i.ALLOW_ARIA_ATTR!==!1,Xe=i.ALLOW_DATA_ATTR!==!1,Tt=i.ALLOW_UNKNOWN_PROTOCOLS||!1,xt=i.ALLOW_SELF_CLOSE_IN_ATTR!==!1,ne=i.SAFE_FOR_TEMPLATES||!1,Se=i.SAFE_FOR_XML!==!1,te=i.WHOLE_DOCUMENT||!1,oe=i.RETURN_DOM||!1,Le=i.RETURN_DOM_FRAGMENT||!1,_e=i.RETURN_TRUSTED_TYPE||!1,Qe=i.FORCE_BODY||!1,wt=i.SANITIZE_DOM!==!1,Et=i.SANITIZE_NAMED_PROPS||!1,et=i.KEEP_CONTENT!==!1,fe=i.IN_PLACE||!1,vt=i.ALLOWED_URI_REGEXP||ia,pe=i.NAMESPACE||Z,we=i.MATHML_TEXT_INTEGRATION_POINTS||we,Ee=i.HTML_INTEGRATION_POINTS||Ee,w=i.CUSTOM_ELEMENT_HANDLING||{},i.CUSTOM_ELEMENT_HANDLING&&kt(i.CUSTOM_ELEMENT_HANDLING.tagNameCheck)&&(w.tagNameCheck=i.CUSTOM_ELEMENT_HANDLING.tagNameCheck),i.CUSTOM_ELEMENT_HANDLING&&kt(i.CUSTOM_ELEMENT_HANDLING.attributeNameCheck)&&(w.attributeNameCheck=i.CUSTOM_ELEMENT_HANDLING.attributeNameCheck),i.CUSTOM_ELEMENT_HANDLING&&typeof i.CUSTOM_ELEMENT_HANDLING.allowCustomizedBuiltInElements=="boolean"&&(w.allowCustomizedBuiltInElements=i.CUSTOM_ELEMENT_HANDLING.allowCustomizedBuiltInElements),ne&&(Xe=!1),Le&&(oe=!0),le&&(C=y({},Xt),R=[],le.html===!0&&(y(C,qt),y(R,Jt)),le.svg===!0&&(y(C,ct),y(R,ut),y(R,Oe)),le.svgFilters===!0&&(y(C,mt),y(R,ut),y(R,Oe)),le.mathMl===!0&&(y(C,ht),y(R,Qt),y(R,Oe))),i.ADD_TAGS&&(typeof i.ADD_TAGS=="function"?se.tagCheck=i.ADD_TAGS:(C===St&&(C=W(C)),y(C,i.ADD_TAGS,P))),i.ADD_ATTR&&(typeof i.ADD_ATTR=="function"?se.attributeCheck=i.ADD_ATTR:(R===Lt&&(R=W(R)),y(R,i.ADD_ATTR,P))),i.ADD_URI_SAFE_ATTR&&y(at,i.ADD_URI_SAFE_ATTR,P),i.FORBID_CONTENTS&&(K===tt&&(K=W(K)),y(K,i.FORBID_CONTENTS,P)),i.ADD_FORBID_CONTENTS&&(K===tt&&(K=W(K)),y(K,i.ADD_FORBID_CONTENTS,P)),et&&(C["#text"]=!0),te&&y(C,["html","head","body"]),C.table&&(y(C,["tbody"]),delete ue.tbody),i.TRUSTED_TYPES_POLICY){if(typeof i.TRUSTED_TYPES_POLICY.createHTML!="function")throw Ae('TRUSTED_TYPES_POLICY configuration option must provide a "createHTML" hook.');if(typeof i.TRUSTED_TYPES_POLICY.createScriptURL!="function")throw Ae('TRUSTED_TYPES_POLICY configuration option must provide a "createScriptURL" hook.');M=i.TRUSTED_TYPES_POLICY,Y=M.createHTML("")}else M===void 0&&(M=ti(g,s)),M!==null&&typeof Y=="string"&&(Y=M.createHTML(""));H&&H(i),de=i}},Dt=y({},[...ct,...mt,...Ka]),It=y({},[...ht,...Ga]),Ta=function(i){let d=S(i);(!d||!d.tagName)&&(d={namespaceURI:pe,tagName:"template"});let m=He(i.tagName),_=He(d.tagName);return rt[i.namespaceURI]?i.namespaceURI===xe?d.namespaceURI===Z?m==="svg":d.namespaceURI===Te?m==="svg"&&(_==="annotation-xml"||we[_]):!!Dt[m]:i.namespaceURI===Te?d.namespaceURI===Z?m==="math":d.namespaceURI===xe?m==="math"&&Ee[_]:!!It[m]:i.namespaceURI===Z?d.namespaceURI===xe&&!Ee[_]||d.namespaceURI===Te&&!we[_]?!1:!It[m]&&(va[m]||!Dt[m]):!!(ge==="application/xhtml+xml"&&rt[i.namespaceURI]):!1},G=function(i){ye(e.removed,{element:i});try{S(i).removeChild(i)}catch{x(i)}},ae=function(i,d){try{ye(e.removed,{attribute:d.getAttributeNode(i),from:d})}catch{ye(e.removed,{attribute:null,from:d})}if(d.removeAttribute(i),i==="is")if(oe||Le)try{G(d)}catch{}else try{d.setAttribute(i,"")}catch{}},Ot=function(i){let d=null,m=null;if(Qe)i="<remove></remove>"+i;else{let E=dt(i,/^[\r\n\t ]+/);m=E&&E[0]}ge==="application/xhtml+xml"&&pe===Z&&(i='<html xmlns="http://www.w3.org/1999/xhtml"><head></head><body>'+i+"</body></html>");let _=M?M.createHTML(i):i;if(pe===Z)try{d=new T().parseFromString(_,ge)}catch{}if(!d||!d.documentElement){d=X.createDocument(pe,"template",null);try{d.documentElement.innerHTML=it?Y:_}catch{}}let D=d.body||d.documentElement;return i&&m&&D.insertBefore(t.createTextNode(m),D.childNodes[0]||null),pe===Z?ha.call(d,te?"html":"body")[0]:te?d.documentElement:D},Ht=function(i){return ee.call(i.ownerDocument||i,i,h.SHOW_ELEMENT|h.SHOW_COMMENT|h.SHOW_TEXT|h.SHOW_PROCESSING_INSTRUCTION|h.SHOW_CDATA_SECTION,null)},nt=function(i){return i instanceof b&&(typeof i.nodeName!="string"||typeof i.textContent!="string"||typeof i.removeChild!="function"||!(i.attributes instanceof f)||typeof i.removeAttribute!="function"||typeof i.setAttribute!="function"||typeof i.namespaceURI!="string"||typeof i.insertBefore!="function"||typeof i.hasChildNodes!="function")},Ft=function(i){return typeof p=="function"&&i instanceof p};function j(u,i,d){Ie(u,m=>{m.call(e,i,d,de)})}let Nt=function(i){let d=null;if(j(I.beforeSanitizeElements,i,null),nt(i))return G(i),!0;let m=P(i.nodeName);if(j(I.uponSanitizeElement,i,{tagName:m,allowedTags:C}),Se&&i.hasChildNodes()&&!Ft(i.firstElementChild)&&O(/<[/\w!]/g,i.innerHTML)&&O(/<[/\w!]/g,i.textContent)||i.nodeType===ve.progressingInstruction||Se&&i.nodeType===ve.comment&&O(/<[/\w]/g,i.data))return G(i),!0;if(!(se.tagCheck instanceof Function&&se.tagCheck(m))&&(!C[m]||ue[m])){if(!ue[m]&&Bt(m)&&(w.tagNameCheck instanceof RegExp&&O(w.tagNameCheck,m)||w.tagNameCheck instanceof Function&&w.tagNameCheck(m)))return!1;if(et&&!K[m]){let _=S(i)||i.parentNode,D=$(i)||i.childNodes;if(D&&_){let E=D.length;for(let N=E-1;N>=0;--N){let q=v(D[N],!0);q.t=(i.t||0)+1,_.insertBefore(q,U(i))}}}return G(i),!0}return i instanceof c&&!Ta(i)||(m==="noscript"||m==="noembed"||m==="noframes")&&O(/<\/no(script|embed|frames)/i,i.innerHTML)?(G(i),!0):(ne&&i.nodeType===ve.text&&(d=i.textContent,Ie([$e,Ze,je],_=>{d=be(d,_," ")}),i.textContent!==d&&(ye(e.removed,{element:i.cloneNode()}),i.textContent=d)),j(I.afterSanitizeElements,i,null),!1)},zt=function(i,d,m){if(wt&&(d==="id"||d==="name")&&(m in t||m in _a))return!1;if(!(Xe&&!qe[d]&&O(fa,d))){if(!(_t&&O(ga,d))){if(!(se.attributeCheck instanceof Function&&se.attributeCheck(d,i))){if(!R[d]||qe[d]){if(!(Bt(i)&&(w.tagNameCheck instanceof RegExp&&O(w.tagNameCheck,i)||w.tagNameCheck instanceof Function&&w.tagNameCheck(i))&&(w.attributeNameCheck instanceof RegExp&&O(w.attributeNameCheck,d)||w.attributeNameCheck instanceof Function&&w.attributeNameCheck(d,i))||d==="is"&&w.allowCustomizedBuiltInElements&&(w.tagNameCheck instanceof RegExp&&O(w.tagNameCheck,m)||w.tagNameCheck instanceof Function&&w.tagNameCheck(m))))return!1}else if(!at[d]){if(!O(vt,be(m,Mt,""))){if(!((d==="src"||d==="xlink:href"||d==="href")&&i!=="script"&&Ba(m,"data:")===0&&Pt[i])){if(!(Tt&&!O(ya,be(m,Mt,"")))){if(m)return!1}}}}}}}return!0},Bt=function(i){return i!=="annotation-xml"&&dt(i,ba)},Vt=function(i){j(I.beforeSanitizeAttributes,i,null);let{attributes:d}=i;if(!d||nt(i))return;let m={attrName:"",attrValue:"",keepAttr:!0,allowedAttributes:R,forceKeepAttr:void 0},_=d.length;for(;_--;){let D=d[_],{name:E,namespaceURI:N,value:q}=D,ce=P(E),ot=q,k=E==="value"?ot:Va(ot);if(m.attrName=ce,m.attrValue=k,m.keepAttr=!0,m.forceKeepAttr=void 0,j(I.uponSanitizeAttribute,i,m),k=m.attrValue,Et&&(ce==="id"||ce==="name")&&(ae(E,i),k=Aa+k),Se&&O(/((--!?|])>)|<\/(style|title|textarea)/i,k)){ae(E,i);continue}if(ce==="attributename"&&dt(k,"href")){ae(E,i);continue}if(m.forceKeepAttr)continue;if(!m.keepAttr){ae(E,i);continue}if(!xt&&O(/\/>/i,k)){ae(E,i);continue}ne&&Ie([$e,Ze,je],Yt=>{k=be(k,Yt," ")});let Ut=P(i.nodeName);if(!zt(Ut,ce,k)){ae(E,i);continue}if(M&&typeof g=="object"&&typeof g.getAttributeType=="function"&&!N)switch(g.getAttributeType(Ut,ce)){case"TrustedHTML":{k=M.createHTML(k);break}case"TrustedScriptURL":{k=M.createScriptURL(k);break}}if(k!==ot)try{N?i.setAttributeNS(N,E,k):i.setAttribute(E,k),nt(i)?G(i):jt(e.removed)}catch{ae(E,i)}}j(I.afterSanitizeAttributes,i,null)},xa=function u(i){let d=null,m=Ht(i);for(j(I.beforeSanitizeShadowDOM,i,null);d=m.nextNode();)j(I.uponSanitizeShadowNode,d,null),Nt(d),Vt(d),d.content instanceof r&&u(d.content);j(I.afterSanitizeShadowDOM,i,null)};return e.sanitize=function(u){let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},d=null,m=null,_=null,D=null;if(it=!u,it&&(u="<!-->"),typeof u!="string"&&!Ft(u))if(typeof u.toString=="function"){if(u=u.toString(),typeof u!="string")throw Ae("dirty is not a string, aborting")}else throw Ae("toString is not a function");if(!e.isSupported)return u;if(Je||st(i),e.removed=[],typeof u=="string"&&(fe=!1),fe){if(u.nodeName){let q=P(u.nodeName);if(!C[q]||ue[q])throw Ae("root node is forbidden and cannot be sanitized in-place")}}else if(u instanceof p)d=Ot("<!---->"),m=d.ownerDocument.importNode(u,!0),m.nodeType===ve.element&&m.nodeName==="BODY"||m.nodeName==="HTML"?d=m:d.appendChild(m);else{if(!oe&&!ne&&!te&&u.indexOf("<")===-1)return M&&_e?M.createHTML(u):u;if(d=Ot(u),!d)return oe?null:_e?Y:""}d&&Qe&&G(d.firstChild);let E=Ht(fe?u:d);for(;_=E.nextNode();)Nt(_),Vt(_),_.content instanceof r&&xa(_.content);if(fe)return u;if(oe){if(Le)for(D=We.call(d.ownerDocument);d.firstChild;)D.appendChild(d.firstChild);else D=d;return(R.shadowroot||R.shadowrootmode)&&(D=ua.call(a,D,!0)),D}let N=te?d.outerHTML:d.innerHTML;return te&&C["!doctype"]&&d.ownerDocument&&d.ownerDocument.doctype&&d.ownerDocument.doctype.name&&O(ra,d.ownerDocument.doctype.name)&&(N="<!DOCTYPE "+d.ownerDocument.doctype.name+`>
`+N),ne&&Ie([$e,Ze,je],q=>{N=be(N,q," ")}),M&&_e?M.createHTML(N):N},e.setConfig=function(){let u=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};st(u),Je=!0},e.clearConfig=function(){de=null,Je=!1},e.isValidAttribute=function(u,i,d){de||st({});let m=P(u),_=P(i);return zt(m,_,d)},e.addHook=function(u,i){typeof i=="function"&&ye(I[u],i)},e.removeHook=function(u,i){if(i!==void 0){let d=Na(I[u],i);return d===-1?void 0:za(I[u],d,1)[0]}return jt(I[u])},e.removeHooks=function(u){I[u]=[]},e.removeAllHooks=function(){I=ta()},e}var J=sa();var Fe=class{constructor(e){this.app=e,l.cacheElements(["stats-panel"])}updateStatsForSelection(){if(this.app.selectedPathIds.size===0){let o=window.KMLHeatmap.calculateFilteredStatistics({pathInfo:this.app.fullPathInfo||[],segments:this.app.fullPathSegments||[],year:this.app.selectedYear,aircraft:this.app.selectedAircraft,coordinateCount:this.app.currentData?.original_points});o&&this.updateStatsPanel(o,!1);return}let e=(this.app.fullPathInfo||[]).filter(o=>this.app.selectedPathIds.has(o.id)),t=(this.app.fullPathSegments||[]).filter(o=>this.app.selectedPathIds.has(o.path_id));if(t.length===0)return;let a=new Set;for(let o of t)o.coords&&o.coords.length===2&&(a.add(JSON.stringify(o.coords[0])),a.add(JSON.stringify(o.coords[1])));let s=a.size,r=window.KMLHeatmap.calculateFilteredStatistics({pathInfo:e,segments:t,year:"all",aircraft:"all",coordinateCount:s});this.updateStatsPanel(r,!0)}updateStatsPanel(e,t){let a="";t?(a+='<p style="margin:0 0 10px 0; font-weight:bold; font-size:15px;">\u{1F4CA} Selected Paths Statistics</p>',a+='<div style="background-color: #3a5a7a; padding: 4px 8px; margin-bottom: 8px; border-radius: 3px; font-size: 11px; color: #a0c0e0;">Showing stats for '+e.num_paths+" selected path(s)</div>"):a+='<p style="margin:0 0 10px 0; font-weight:bold; font-size:15px;">\u{1F4CA} Flight Statistics</p>',a+='<div style="margin-bottom: 8px;"><strong>Data Points:</strong> '+e.total_points+"</div>",a+='<div style="margin-bottom: 8px;"><strong>Flights:</strong> '+e.num_paths+"</div>",e.airport_names&&e.airport_names.length>0&&(a+='<div style="margin-bottom: 8px; max-height: 150px; overflow-y: auto;"><strong>Airports ('+e.num_airports+"):</strong><br>",e.airport_names.forEach(o=>{a+='<span style="margin-left: 10px;">\u2022 '+o+"</span><br>"}),a+="</div>"),e.num_aircraft&&e.num_aircraft>0&&e.aircraft_list&&e.aircraft_list.length>0&&(a+='<div style="margin-bottom: 8px; max-height: 150px; overflow-y: auto;"><strong>Aircrafts ('+e.num_aircraft+"):</strong><br>",e.aircraft_list.forEach(o=>{let p=o.type?" ("+o.type+")":"";a+='<span style="margin-left: 10px;">\u2022 '+o.registration+p+" - "+o.flights+" flight(s)</span><br>"}),a+="</div>"),e.total_flight_time_str&&(a+='<div style="margin-bottom: 8px;"><strong>Total Flight Time:</strong> '+e.total_flight_time_str+"</div>");let s=(e.total_distance_nm*1.852).toFixed(1);if(a+='<div style="margin-bottom: 8px;"><strong>Distance:</strong> '+e.total_distance_nm.toFixed(1)+" nm ("+s+" km)</div>",e.num_paths>0){let o=(e.total_distance_nm/e.num_paths).toFixed(1),p=(parseFloat(o)*1.852).toFixed(1);a+='<div style="margin-bottom: 8px;"><strong>Average Distance per Trip:</strong> '+o+" nm ("+p+" km)</div>"}if(e.longest_flight_nm&&e.longest_flight_nm>0){let o=(e.longest_flight_km||0).toFixed(1);a+='<div style="margin-bottom: 8px;"><strong>Longest Flight:</strong> '+e.longest_flight_nm.toFixed(1)+" nm ("+o+" km)</div>"}if(e.avg_groundspeed_knots&&e.avg_groundspeed_knots>0){let o=Math.round(e.avg_groundspeed_knots*1.852);a+='<div style="margin-bottom: 8px;"><strong>Average Groundspeed:</strong> '+Math.round(e.avg_groundspeed_knots)+" kt ("+o+" km/h)</div>"}if(e.cruise_speed_knots&&e.cruise_speed_knots>0){let o=Math.round(e.cruise_speed_knots*1.852);a+='<div style="margin-bottom: 8px;"><strong>Cruise Speed (>1000ft AGL):</strong> '+Math.round(e.cruise_speed_knots)+" kt ("+o+" km/h)</div>"}if(e.max_groundspeed_knots&&e.max_groundspeed_knots>0){let o=Math.round(e.max_groundspeed_knots*1.852);a+='<div style="margin-bottom: 8px;"><strong>Max Groundspeed:</strong> '+Math.round(e.max_groundspeed_knots)+" kt ("+o+" km/h)</div>"}if(e.max_altitude_ft){let o=Math.round(e.max_altitude_ft*.3048);if(a+='<div style="margin-bottom: 8px;"><strong>Max Altitude (MSL):</strong> '+Math.round(e.max_altitude_ft)+" ft ("+o+" m)</div>",e.total_altitude_gain_ft){let p=Math.round(e.total_altitude_gain_ft*.3048);a+='<div style="margin-bottom: 8px;"><strong>Elevation Gain:</strong> '+Math.round(e.total_altitude_gain_ft)+" ft ("+p+" m)</div>"}}if(e.most_common_cruise_altitude_ft&&e.most_common_cruise_altitude_ft>0){let o=Math.round(e.most_common_cruise_altitude_m||0);a+='<div style="margin-bottom: 8px;"><strong>Most Common Cruise Altitude (AGL):</strong> '+e.most_common_cruise_altitude_ft+" ft ("+o+" m)</div>"}let r=l.get("stats-panel");r&&(r.innerHTML=J.sanitize(a))}toggleStats(){let e=l.get("stats-panel");e&&(e.classList.contains("visible")?(e.classList.remove("visible"),setTimeout(()=>{e.style.display="none",this.app.stateManager.saveMapState()},300)):(e.style.display="block",e.offsetHeight,e.classList.add("visible"),this.app.stateManager.saveMapState()))}};function re(n,e=50){n&&setTimeout(()=>{n.invalidateSize()},e)}var Ne=class{constructor(e){this.app=e}togglePathSelection(e){this.app.selectedPathIds.has(e)?this.app.selectedPathIds.delete(e):this.app.selectedPathIds.add(e),this.app.altitudeVisible&&(this.app.layerManager.redrawAltitudePaths(),re(this.app.map)),this.app.airspeedVisible&&(this.app.layerManager.redrawAirspeedPaths(),re(this.app.map)),this.app.replayManager.updateReplayButtonState(),this.app.stateManager.saveMapState()}selectPathsByAirport(e){let t=this.app.airportToPaths[e];t&&t.forEach(a=>{this.app.selectedPathIds.add(a)}),this.app.altitudeVisible&&(this.app.layerManager.redrawAltitudePaths(),re(this.app.map)),this.app.airspeedVisible&&(this.app.layerManager.redrawAirspeedPaths(),re(this.app.map)),this.app.replayManager.updateReplayButtonState(),this.app.stateManager.saveMapState()}clearSelection(){this.app.selectedPathIds.clear(),this.app.altitudeVisible&&(this.app.layerManager.redrawAltitudePaths(),re(this.app.map)),this.app.airspeedVisible&&(this.app.layerManager.redrawAirspeedPaths(),re(this.app.map)),this.app.replayManager.updateReplayButtonState(),this.app.stateManager.saveMapState()}};var ze=class{constructor(e){this.app=e}calculateAirportFlightCounts(){return window.KMLHeatmap.calculateAirportFlightCounts(this.app.fullPathInfo??[],this.app.selectedYear,this.app.selectedAircraft)}updateAirportPopups(){if(!this.app.allAirportsData||!this.app.airportMarkers)return;let e=this.calculateAirportFlightCounts(),t=null,a=0;Object.keys(e).forEach(s=>{let r=e[s];r!==void 0&&r>a&&(a=r,t=s)}),this.app.allAirportsData.forEach(s=>{let r=this.app.airportMarkers[s.name];if(!r)return;let o=e[s.name]||0,p=s.name===t,c=window.KMLHeatmap.ddToDms(s.lat,!0),h=window.KMLHeatmap.ddToDms(s.lon,!1),f=`https://www.google.com/maps?q=${s.lat},${s.lon}`,b=`
            <div style="
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
                min-width: 220px;
                padding: 8px 4px;
                background-color: #2b2b2b;
                color: #ffffff;
            ">
                <div style="
                    font-size: 15px;
                    font-weight: bold;
                    color: #28a745;
                    margin-bottom: 10px;
                    padding-bottom: 8px;
                    border-bottom: 2px solid #28a745;
                    display: flex;
                    align-items: center;
                    gap: 6px;
                ">
                    <span style="font-size: 18px;">\u{1F6EB}</span>
                    <span>${s.name||"Unknown"}</span>
                    ${p?'<span style="font-size: 12px; background: #007bff; color: white; padding: 2px 6px; border-radius: 3px; margin-left: 4px;">HOME</span>':""}
                </div>
                <div style="margin-bottom: 8px;">
                    <div style="font-size: 11px; color: #999; margin-bottom: 2px; text-transform: uppercase; letter-spacing: 0.5px;">Coordinates</div>
                    <a href="${f}"
                       target="_blank"
                       style="
                           color: #4facfe;
                           text-decoration: none;
                           font-size: 12px;
                           font-family: monospace;
                           display: flex;
                           align-items: center;
                           gap: 4px;
                       "
                       onmouseover="this.style.textDecoration='underline'"
                       onmouseout="this.style.textDecoration='none'">
                        <span>\u{1F4CD}</span>
                        <span>${c}<br>${h}</span>
                    </a>
                </div>
                <div style="
                    background: linear-gradient(135deg, rgba(79, 172, 254, 0.15) 0%, rgba(0, 242, 254, 0.15) 100%);
                    padding: 8px 10px;
                    border-radius: 6px;
                    border-left: 3px solid #4facfe;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                ">
                    <span style="font-size: 12px; color: #ccc; font-weight: 500;">Total Flights</span>
                    <span style="font-size: 16px; font-weight: bold; color: #4facfe;">${o}</span>
                </div>
            </div>`;r.setPopupContent(b)})}updateAirportOpacity(){let e=this.app.selectedYear!=="all"||this.app.selectedAircraft!=="all",t=this.app.selectedPathIds.size>0;if(!e&&!t){Object.keys(this.app.airportMarkers).forEach(s=>{let r=this.app.airportMarkers[s];r&&(r.setOpacity(1),this.app.airportLayer.hasLayer(r)||r.addTo(this.app.airportLayer))});return}let a=new Set;e&&this.app.fullPathInfo&&this.app.fullPathInfo.forEach(s=>{let r=this.app.selectedYear==="all"||s.year&&s.year.toString()===this.app.selectedYear,o=this.app.selectedAircraft==="all"||s.aircraft_registration===this.app.selectedAircraft;r&&o&&(s.start_airport&&a.add(s.start_airport),s.end_airport&&a.add(s.end_airport))}),t&&this.app.selectedPathIds.forEach(s=>{if(this.app.fullPathInfo){let r=this.app.fullPathInfo.find(o=>o.id===s);r&&(r.start_airport&&a.add(r.start_airport),r.end_airport&&a.add(r.end_airport))}else{let r=this.app.pathToAirports[s];r&&(r.start&&a.add(r.start),r.end&&a.add(r.end))}}),Object.keys(this.app.airportMarkers).forEach(s=>{let r=this.app.airportMarkers[s];r&&(a.has(s)?(r.setOpacity(1),this.app.airportLayer.hasLayer(r)||r.addTo(this.app.airportLayer)):this.app.airportLayer.hasLayer(r)&&this.app.airportLayer.removeLayer(r))})}updateAirportMarkerSizes(){if(!this.app.map)return;let e=this.app.map.getZoom(),t="";e>=14?t="xlarge":e>=12?t="large":e>=10?t="medium":e>=8?t="medium-small":e>=6&&(t="small"),document.querySelectorAll(".airport-marker-container").forEach(a=>{let s=a.querySelector(".airport-marker"),r=a.querySelector(".airport-label");!s||!r||(e<5?r.style.display="none":r.style.display="",a.classList.remove("airport-marker-container-small","airport-marker-container-medium-small","airport-marker-container-medium","airport-marker-container-large","airport-marker-container-xlarge"),s.classList.remove("airport-marker-small","airport-marker-medium-small","airport-marker-medium","airport-marker-large","airport-marker-xlarge"),r.classList.remove("airport-label-small","airport-label-medium-small","airport-label-medium","airport-label-large","airport-label-xlarge"),t&&(a.classList.add("airport-marker-container-"+t),s.classList.add("airport-marker-"+t),r.classList.add("airport-label-"+t)))})}};var Q=me(ie(),1);var na=me(ie(),1);var Be=class{constructor(e){this.app=e}updateAirplanePopup(e){if(!e.replayAirplaneMarker||!e.replayActive)return;let t=null;for(let v=0;v<e.replaySegments.length;v++){let x=e.replaySegments[v];if(x&&(x.time||0)<=e.replayCurrentTime)t=x;else break}if(!t&&e.replaySegments.length>0&&(t=e.replaySegments[0]),!t)return;let a=`<div style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif; min-width: 180px; padding: 8px 4px; background-color: #2b2b2b; color: #ffffff;">`;a+='<div style="font-size: 14px; font-weight: bold; color: #4facfe; margin-bottom: 8px; padding-bottom: 6px; border-bottom: 2px solid #4facfe; display: flex; align-items: center; gap: 6px;">',a+='<span style="font-size: 16px;">\u2708\uFE0F</span>',a+="<span>Current Position</span>",a+="</div>";let s=t.altitude_ft||0,r=Math.round(s/50)*50,o=Math.round(r*.3048),p=window.KMLHeatmap.getColorForAltitude(s,e.replayColorMinAlt,e.replayColorMaxAlt),c=p.replace("rgb(","rgba(").replace(")",", 0.15)");a+='<div style="margin-bottom: 8px;">',a+='<div style="font-size: 11px; color: #999; margin-bottom: 2px; text-transform: uppercase; letter-spacing: 0.5px;">Altitude (MSL)</div>',a+='<div style="background: '+c+"; padding: 6px 8px; border-radius: 6px; border-left: 3px solid "+p+';">',a+='<span style="font-size: 16px; font-weight: bold; color: '+p+';">'+r+" ft</span>",a+='<span style="font-size: 12px; color: #ccc; margin-left: 6px;">('+o+" m)</span>",a+="</div>",a+="</div>";let h=t.groundspeed_knots||0,f=h*1.852,b=Math.round(h),T=Math.round(f),g=window.KMLHeatmap.getColorForAirspeed(h,e.replayColorMinSpeed,e.replayColorMaxSpeed),A=g.replace("rgb(","rgba(").replace(")",", 0.15)");a+='<div style="margin-bottom: 8px;">',a+='<div style="font-size: 11px; color: #999; margin-bottom: 2px; text-transform: uppercase; letter-spacing: 0.5px;">Groundspeed</div>',a+='<div style="background: '+A+"; padding: 6px 8px; border-radius: 6px; border-left: 3px solid "+g+';">',a+='<span style="font-size: 16px; font-weight: bold; color: '+g+';">'+b+" kt</span>",a+='<span style="font-size: 12px; color: #ccc; margin-left: 6px;">('+T+" km/h)</span>",a+="</div>",a+="</div>",a+="</div>",e.replayAirplaneMarker.getPopup()?e.replayAirplaneMarker.getPopup().setContent(a):e.replayAirplaneMarker.bindPopup(a,{autoPanPadding:[50,50]}),e.replayAirplaneMarker.openPopup()}updateDisplay(e,t=!1){let a=l.get("replay-time-display");a&&(a.textContent=window.KMLHeatmap.formatTime(e.replayCurrentTime)+" / "+window.KMLHeatmap.formatTime(e.replayMaxTime));let s=l.get("replay-slider");s&&(s.value=e.replayCurrentTime.toString());let r=l.get("replay-slider-start");r&&(r.textContent=window.KMLHeatmap.formatTime(e.replayCurrentTime));let o=null,p=null,c=-1;for(let h=0;h<e.replaySegments.length;h++){let f=e.replaySegments[h];if(f&&(f.time||0)<=e.replayCurrentTime)o=f,c=h;else if(f){p=f;break}}if(e.replayLayer){let h=this.app.airspeedVisible&&!this.app.altitudeVisible;for(let f=0;f<e.replaySegments.length;f++){let b=e.replaySegments[f];if(b)if((b.time||0)<=e.replayCurrentTime&&e.replayCurrentTime>0){if(f>e.replayLastDrawnIndex){let T;h&&(b.groundspeed_knots||0)>0?T=window.KMLHeatmap.getColorForAltitude(b.groundspeed_knots??0,e.replayColorMinSpeed,e.replayColorMaxSpeed):T=window.KMLHeatmap.getColorForAltitude(b.altitude_ft??0,e.replayColorMinAlt,e.replayColorMaxAlt),na.polyline(b.coords||[],{color:T,weight:3,opacity:.8}).addTo(e.replayLayer),e.replayLastDrawnIndex=f}}else break}}if(e.replayAirplaneMarker&&this.app.map&&!this.app.map.hasLayer(e.replayAirplaneMarker)&&e.replayAirplaneMarker.addTo(this.app.map),e.replayAirplaneMarker&&this.app.map){if(o){let h,f;if(p&&(o.time||0)<e.replayCurrentTime){let g=(e.replayCurrentTime-(o.time||0))/((p.time||0)-(o.time||0)),A=o.coords?.[1]?.[0]||0,v=o.coords?.[1]?.[1]||0,x=p.coords?.[0]?.[0]||0,U=p.coords?.[0]?.[1]||0;h=[A+(x-A)*g,v+(U-v)*g],f=window.KMLHeatmap.calculateBearing(A,v,x,U)}else{h=o.coords?.[1]||[0,0];let g=o.coords?.[0]?.[0]||0,A=o.coords?.[0]?.[1]||0,v=o.coords?.[1]?.[0]||0,x=o.coords?.[1]?.[1]||0;f=window.KMLHeatmap.calculateBearing(g,A,v,x)}let b=window.KMLHeatmap.calculateSmoothedBearing(e.replaySegments,c,5);if(b!==null?(f=b,e.replayLastBearing=f):e.replayLastBearing!==null&&(f=e.replayLastBearing),e.replayAirplaneMarker.setLatLng(h),e.replayPlaying||t){let g=this.app.map.getSize(),A=this.app.map.latLngToContainerPoint(h),v=.1,x=g.x*v,U=g.y*v,$=!1;if((A.x<x||A.x>g.x-x||A.y<U||A.y>g.y-U)&&($=!0),t&&($=!0),$){this.app.map.panTo(h,{animate:!0,duration:.5,easeLinearity:.25,noMoveStart:!0});let S=Date.now();e.replayRecenterTimestamps.push(S);let M=S-3e4;e.replayRecenterTimestamps=e.replayRecenterTimestamps.filter(Y=>Y>M)}if(e.replayAutoZoom&&e.replayRecenterTimestamps.length>2){let M=Date.now()-5e3;if(e.replayRecenterTimestamps.filter(X=>X>=M).length>2&&e.replayLastZoom!==null&&e.replayLastZoom>9){let ee=Math.max(9,e.replayLastZoom-1);this.app.map.setZoom(ee,{animate:!0,duration:.5}),e.replayLastZoom=ee,e.replayRecenterTimestamps=[]}}}let T=e.replayAirplaneMarker.getElement();if(T){let g=T.querySelector(".replay-airplane-icon");if(g){let A=f-45;g.style.transform="translate3d(0,0,0) rotate("+A+"deg)"}}}else if(e.replaySegments.length>0){let f=e.replaySegments[0]?.coords?.[0];f&&e.replayAirplaneMarker.setLatLng([f[0],f[1]])}}e.replayAirplaneMarker&&e.replayAirplaneMarker.getPopup()&&e.replayAirplaneMarker.isPopupOpen()&&this.updateAirplanePopup(e)}};var Ve=class{constructor(e){this.app=e,this.renderer=new Be(e),l.cacheElements(["replay-controls","replay-btn","replay-play-btn","replay-pause-btn","replay-slider","replay-slider-start","replay-slider-end","replay-time-display","replay-speed","replay-autozoom-btn","altitude-btn","altitude-legend"]),this.replayActive=!1,this.replayPlaying=!1,this.replayCurrentTime=0,this.replayMaxTime=0,this.replaySpeed=50,this.replayInterval=null,this.replayLayer=null,this.replaySegments=[],this.replayAirplaneMarker=null,this.replayLastDrawnIndex=-1,this.replayLastBearing=null,this.replayAnimationFrameId=null,this.replayLastFrameTime=null,this.replayColorMinAlt=0,this.replayColorMaxAlt=1e4,this.replayColorMinSpeed=0,this.replayColorMaxSpeed=200,this.replayAutoZoom=!1,this.replayLastZoom=null,this.replayRecenterTimestamps=[]}toggleReplay(){let e=l.get("replay-controls");if(e)if(this.replayActive){this.stopReplay(),e.style.display="none",this.replayActive=!1;let t=l.get("replay-btn");if(t&&(t.textContent="\u25B6\uFE0F Replay"),document.body.classList.remove("replay-active"),this.replayAirplaneMarker&&this.app.map&&(this.app.map.removeLayer(this.replayAirplaneMarker),this.replayAirplaneMarker=null),this.replayLayer&&this.app.map&&this.app.map.removeLayer(this.replayLayer),this.restoreLayerVisibility(),!this.app.altitudeVisible&&!this.app.airspeedVisible&&this.app.map){this.app.altitudeVisible=!0;let a=l.get("altitude-btn");a&&(a.style.opacity="1.0");let s=l.get("altitude-legend");s&&(s.style.display="block"),this.app.map.addLayer(this.app.altitudeLayer)}setTimeout(()=>{this.app.altitudeVisible?this.app.layerManager.redrawAltitudePaths():this.app.airspeedVisible&&this.app.layerManager.redrawAirspeedPaths(),this.app.map&&this.app.map.invalidateSize()},100),this.updateReplayButtonState(),this.app.stateManager.saveMapState()}else{if(this.app.selectedPathIds.size!==1)return;if(this.initializeReplay()){e.style.display="block",this.replayActive=!0;let t=l.get("replay-btn");t&&(t.textContent="\u23F9\uFE0F Replay",t.style.opacity="1.0");let a=l.get("replay-autozoom-btn");a&&(a.style.opacity=this.replayAutoZoom?"1.0":"0.5",a.title=this.replayAutoZoom?"Auto-zoom enabled":"Auto-zoom disabled"),document.body.classList.add("replay-active"),this.hideOtherLayersDuringReplay(),this.app.stateManager.saveMapState()}}}updateReplayButtonState(){let e=l.get("replay-btn");if(!e)return;let t=this.app.fullStats&&this.app.fullStats.max_groundspeed_knots!==void 0&&this.app.fullStats.max_groundspeed_knots>0;this.app.selectedPathIds.size===1&&t?(e.style.opacity="1.0",e.disabled=!1,e.setAttribute("aria-disabled","false")):(e.style.opacity="0.5",e.disabled=!0,e.setAttribute("aria-disabled","true"))}updateReplayAirplanePopup(){this.renderer.updateAirplanePopup(this)}initializeReplay(){if(!this.app.fullPathSegments)return alert("No flight data available for replay. Please wait for data to load or refresh the page."),!1;let e=Array.from(this.app.selectedPathIds)[0];if(this.replaySegments=this.app.fullPathSegments.filter(h=>h.path_id===e&&h.time!==void 0&&h.time!==null),this.replaySegments.length===0)return!1;if(this.replaySegments.sort((h,f)=>(h.time||0)-(f.time||0)),this.app.currentData&&this.app.currentData.path_segments){let h=this.app.currentData.path_segments.filter(f=>f.path_id===e);if(h.length>0){let f=h.map(g=>g.altitude_ft||0),b=window.KMLHeatmap.findMinMax(f);this.replayColorMinAlt=b.min,this.replayColorMaxAlt=b.max;let T=h.map(g=>g.groundspeed_knots||0).filter(g=>g>0);if(T.length>0){let g=window.KMLHeatmap.findMinMax(T);this.replayColorMinSpeed=g.min,this.replayColorMaxSpeed=g.max}else this.replayColorMinSpeed=this.app.airspeedRange.min,this.replayColorMaxSpeed=this.app.airspeedRange.max}else{let f=this.replaySegments.map(g=>g.altitude_ft||0),b=window.KMLHeatmap.findMinMax(f);this.replayColorMinAlt=b.min,this.replayColorMaxAlt=b.max;let T=this.replaySegments.map(g=>g.groundspeed_knots||0).filter(g=>g>0);if(T.length>0){let g=window.KMLHeatmap.findMinMax(T);this.replayColorMinSpeed=g.min,this.replayColorMaxSpeed=g.max}else this.replayColorMinSpeed=this.app.airspeedRange.min,this.replayColorMaxSpeed=this.app.airspeedRange.max}}let t=this.replaySegments[this.replaySegments.length-1];this.replayMaxTime=t?.time||0;let a=l.get("replay-slider");a&&(a.max=this.replayMaxTime.toString());let s=l.get("replay-slider-end");s&&(s.textContent=window.KMLHeatmap.formatTime(this.replayMaxTime)),this.app.layerManager.updateAltitudeLegend(this.replayColorMinAlt,this.replayColorMaxAlt),this.app.layerManager.updateAirspeedLegend(this.replayColorMinSpeed,this.replayColorMaxSpeed),this.replayLayer||(this.replayLayer=Q.layerGroup()),this.replayLayer.clearLayers(),this.app.map&&this.replayLayer.addTo(this.app.map),this.replayAirplaneMarker&&this.app.map&&(this.app.map.removeLayer(this.replayAirplaneMarker),this.replayAirplaneMarker=null);let r=Q.divIcon({html:'<div class="replay-airplane-icon">\u2708\uFE0F</div>',iconSize:[32,32],iconAnchor:[16,16],className:""}),p=this.replaySegments[0]?.coords?.[0];if(!p||!this.app.map)return!1;this.replayAirplaneMarker=Q.marker([p[0],p[1]],{icon:r,zIndexOffset:1e3}),this.replayAirplaneMarker.addTo(this.app.map);let c=this.replayAirplaneMarker.getElement();return c&&(c.style.transition="transform 0.08s linear",c.style.cursor="pointer",c.style.pointerEvents="auto",c.addEventListener("click",h=>{h.stopPropagation(),this.replayAirplaneMarker.isPopupOpen()?this.replayAirplaneMarker.closePopup():this.updateReplayAirplanePopup()})),this.replayCurrentTime=0,this.replayLastDrawnIndex=-1,this.replayLastBearing=null,this.replayAutoZoom&&this.app.map?(this.app.map.setView([p[0],p[1]],16,{animate:!0,duration:.8}),this.replayLastZoom=16):this.app.map&&this.app.map.panTo([p[0],p[1]],{animate:!0,duration:.8}),this.updateReplayDisplay(),!0}hideOtherLayersDuringReplay(){if(!this.app.map)return;this.app.heatmapLayer&&this.app.heatmapVisible&&this.app.map.removeLayer(this.app.heatmapLayer),this.app.altitudeVisible&&this.app.map.removeLayer(this.app.altitudeLayer),this.app.airspeedVisible&&this.app.map.removeLayer(this.app.airspeedLayer),["heatmap-btn","airports-btn","aviation-btn","year-select","aircraft-select"].forEach(t=>{let a=document.getElementById(t);a&&(a.disabled=!0)})}restoreLayerVisibility(){if(!this.app.map)return;this.app.heatmapLayer&&this.app.heatmapVisible&&(this.app.map.addLayer(this.app.heatmapLayer),this.app.heatmapLayer.e&&(this.app.heatmapLayer.e.style.pointerEvents="none")),this.app.altitudeVisible&&(this.app.map.addLayer(this.app.altitudeLayer),setTimeout(()=>{this.app.layerManager.redrawAltitudePaths(),this.app.map&&this.app.map.invalidateSize()},50)),this.app.airspeedVisible&&(this.app.map.addLayer(this.app.airspeedLayer),setTimeout(()=>{this.app.layerManager.redrawAirspeedPaths(),this.app.map&&this.app.map.invalidateSize()},50)),["heatmap-btn","airports-btn","aviation-btn","year-select","aircraft-select"].forEach(t=>{let a=document.getElementById(t);a&&(a.disabled=!1)})}playReplay(){if(!this.replayActive||!this.app.map)return;if(this.replayCurrentTime>=this.replayMaxTime){if(this.replayCurrentTime=0,this.replayLastDrawnIndex=-1,this.replayLayer&&this.replayLayer.clearLayers(),this.replayAirplaneMarker&&this.replaySegments.length>0&&this.app.map){let r=this.replaySegments[0]?.coords?.[0];r&&(this.replayAirplaneMarker.setLatLng([r[0],r[1]]),this.replayAutoZoom&&(this.app.map.setView([r[0],r[1]],16,{animate:!0,duration:.5}),this.replayLastZoom=16))}this.replayRecenterTimestamps=[],this.replayLastBearing=null}this.replayPlaying=!0;let e=l.get("replay-play-btn"),t=l.get("replay-pause-btn");e&&(e.style.display="none"),t&&(t.style.display="inline-block"),this.replayLastFrameTime=null;let a=s=>{if(!this.replayPlaying)return;this.replayLastFrameTime===null&&(this.replayLastFrameTime=s);let r=s-this.replayLastFrameTime;this.replayLastFrameTime=s;let o=r/1e3*this.replaySpeed;if(this.replayCurrentTime+=o,this.replayCurrentTime>=this.replayMaxTime){if(this.replayCurrentTime=this.replayMaxTime,this.pauseReplay(),this.replaySegments.length>0&&this.app.map){let p=[];if(this.replaySegments.forEach(c=>{c.coords&&c.coords.length>0&&c.coords.forEach(h=>{p.push(h)})}),p.length>0){let c=Q.latLngBounds(p);this.app.map.fitBounds(c,{padding:[50,50],animate:!0,duration:1})}}}else this.replayAnimationFrameId=requestAnimationFrame(a);this.updateReplayDisplay()};this.replayAnimationFrameId=requestAnimationFrame(a),this.app.stateManager.saveMapState()}pauseReplay(){this.replayPlaying=!1;let e=l.get("replay-play-btn"),t=l.get("replay-pause-btn");e&&(e.style.display="inline-block"),t&&(t.style.display="none"),this.replayAnimationFrameId&&(cancelAnimationFrame(this.replayAnimationFrameId),this.replayAnimationFrameId=null),this.replayLastFrameTime=null,this.app.stateManager.saveMapState()}stopReplay(){if(this.pauseReplay(),this.replayCurrentTime=0,this.replayLastDrawnIndex=-1,this.replayLastBearing=null,this.replayRecenterTimestamps=[],this.replayLayer&&this.replayLayer.clearLayers(),this.replayAirplaneMarker&&this.replaySegments.length>0){let t=this.replaySegments[0]?.coords?.[0];t&&this.replayAirplaneMarker.setLatLng([t[0],t[1]])}this.updateReplayDisplay()}seekReplay(e){let t=parseFloat(e);t<this.replayCurrentTime&&(this.replayLayer&&this.replayLayer.clearLayers(),this.replayLastDrawnIndex=-1),this.replayCurrentTime=t,this.updateReplayDisplay(!0),this.app.stateManager.saveMapState()}changeReplaySpeed(){let e=l.get("replay-speed");e&&(this.replaySpeed=parseFloat(e.value),this.app.stateManager.saveMapState())}toggleAutoZoom(){this.replayAutoZoom=!this.replayAutoZoom;let e=l.get("replay-autozoom-btn");e&&(e.style.opacity=this.replayAutoZoom?"1.0":"0.5",e.title=this.replayAutoZoom?"Auto-zoom enabled":"Auto-zoom disabled"),this.app.stateManager.saveMapState()}updateReplayDisplay(e=!1){this.renderer.updateDisplay(this,e)}};function oa(n,e,t){return`
            <div class="stat-card">
                <div class="stat-value">${n.total_flights}</div>
                <div class="stat-label">Flights</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">${n.num_airports}</div>
                <div class="stat-label">Airports</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">${n.total_distance_nm.toFixed(0)}</div>
                <div class="stat-label">Nautical Miles</div>
            </div>
            ${t?`
            <div class="stat-card">
                <div class="stat-value">${n.flight_time}</div>
                <div class="stat-label">Flight Time</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">${(e?.max_groundspeed_knots||0).toFixed(0)} kt</div>
                <div class="stat-label">Max Groundspeed</div>
            </div>
            `:""}
            <div class="stat-card">
                <div class="stat-value">${Math.round((e?.max_altitude_m||0)/.3048)} ft</div>
                <div class="stat-label">Max Altitude (MSL)</div>
            </div>
        `}function la(n){let e='<div class="fun-facts-title">\u2728 Facts</div>';return n.forEach(t=>{e+=`<div class="fun-fact" data-category="${t.category}"><span class="fun-fact-icon">${t.icon}</span><span class="fun-fact-text">${t.text}</span></div>`}),e}function ai(n){return n>=.75?"fleet-aircraft-high":n>=.5?"fleet-aircraft-medium-high":n>=.25?"fleet-aircraft-medium-low":"fleet-aircraft-low"}function pa(n){if(!n.aircraft_list||n.aircraft_list.length===0)return"";let e='<div class="aircraft-fleet-title">\u2708\uFE0F Fleet</div>',t=n.aircraft_list[0]?.flights??0,a=n.aircraft_list[n.aircraft_list.length-1]?.flights??0,s=t-a;return n.aircraft_list.forEach(r=>{let o=r.model||r.type||"",p=s>0?(r.flights-a)/s:1,c=ai(p),h=r.flight_time_str||"---";e+=`
                    <div class="fleet-aircraft ${c}">
                        <div class="fleet-aircraft-info">
                            <div class="fleet-aircraft-model">${o}</div>
                            <div class="fleet-aircraft-registration">${r.registration}</div>
                        </div>
                        <div class="fleet-aircraft-stats">
                            <div class="fleet-aircraft-flights">${r.flights} flights</div>
                            <div class="fleet-aircraft-time">${h}</div>
                        </div>
                    </div>
                `}),e}function da(n){let e='<div class="top-airports-title">\u{1F3E0} Home Base</div>';return e+=`
                <div class="top-airport">
                    <div class="top-airport-name">${n.name}</div>
                    <div class="top-airport-count">${n.flight_count} flights</div>
                </div>
            `,e}function ca(n){if(n.length===0)return"";let e='<div class="airports-grid-title">\u{1F5FA}\uFE0F Destinations</div><div class="airport-badges">';return n.forEach(t=>{e+=`<div class="airport-badge">${t}</div>`}),e+="</div>",e}var Ue=class{constructor(e){this.app=e,this.originalMapParent=null,this.originalMapIndex=null,l.cacheElements(["wrapped-title","wrapped-year","wrapped-stats","wrapped-fun-facts","wrapped-aircraft-fleet","wrapped-top-airports","wrapped-airports-grid","map","wrapped-map-container","wrapped-modal","stats-btn","export-btn","wrapped-btn","heatmap-btn","airports-btn","altitude-btn","airspeed-btn","aviation-btn","year-filter","aircraft-filter","stats-panel","altitude-legend","airspeed-legend","loading"])}showWrapped(){if(!this.app.map)return;let e=this.app.selectedYear,t=window.KMLHeatmap.calculateYearStats(this.app.fullPathInfo||[],this.app.fullPathSegments||[],e,this.app.fullStats),a=l.get("wrapped-title"),s=l.get("wrapped-year");e==="all"?(a&&(a.textContent="\u2728 Your Flight History"),s&&(s.textContent="All Years")):(a&&(a.textContent="\u2728 Your Year in Flight"),s&&(s.textContent=e));let r=this.app.fullStats!==null&&this.app.fullStats.max_groundspeed_knots!==void 0&&this.app.fullStats.max_groundspeed_knots>0,o=oa(t,this.app.fullStats??null,r),p=l.get("wrapped-stats");p&&(p.innerHTML=J.sanitize(o));let c=window.KMLHeatmap.generateFunFacts(t,this.app.fullStats),h=la(c),f=l.get("wrapped-fun-facts");if(f&&(f.innerHTML=J.sanitize(h)),t.aircraft_list&&t.aircraft_list.length>0){let v=pa(t),x=l.get("wrapped-aircraft-fleet");x&&(x.innerHTML=J.sanitize(v))}if(t.airport_names&&t.airport_names.length>0){let v;if(e==="all")v=this.app.fullPathInfo||[];else{let S=e.toString();v=(this.app.fullPathInfo||[]).filter(M=>M.year&&M.year.toString()===S)}let x={};v.forEach(S=>{S.start_airport&&(x[S.start_airport]=(x[S.start_airport]||0)+1),S.end_airport&&(x[S.end_airport]=(x[S.end_airport]||0)+1)});let U=t.airport_names.map(S=>({name:S,flight_count:x[S]||0}));U.sort((S,M)=>M.flight_count-S.flight_count);let $=U[0];if($){let S=da($),M=l.get("wrapped-top-airports");M&&(M.innerHTML=J.sanitize(S));let Y=t.airport_names.filter(We=>We!==$.name),X=ca(Y),ee=l.get("wrapped-airports-grid");ee&&(ee.innerHTML=J.sanitize(X))}}let b=l.get("map"),T=l.get("wrapped-map-container");if(!b||!T)return;this.originalMapParent||(this.originalMapParent=b.parentNode,this.originalMapIndex=Array.from(this.originalMapParent.children).indexOf(b)),this.app.map.fitBounds(this.app.config.bounds,{padding:[80,80]}),[document.querySelector(".leaflet-control-zoom"),l.get("stats-btn"),l.get("export-btn"),l.get("wrapped-btn"),l.get("heatmap-btn"),l.get("airports-btn"),l.get("altitude-btn"),l.get("airspeed-btn"),l.get("aviation-btn"),l.get("year-filter"),l.get("aircraft-filter"),l.get("stats-panel"),l.get("altitude-legend"),l.get("airspeed-legend"),l.get("loading")].forEach(v=>{v&&(v.style.display="none")});let A=l.get("wrapped-modal");A&&(A.style.display="flex"),setTimeout(()=>{T.appendChild(b),b.style.width="100%",b.style.height="100%",b.style.borderRadius="12px",b.style.overflow="hidden",T.offsetHeight,setTimeout(()=>{this.app.map.invalidateSize(),this.app.map.fitBounds(this.app.config.bounds,{padding:[80,80]}),this.app.stateManager&&this.app.stateManager.saveMapState()},100)},50)}closeWrapped(e){if(!e||e.target.id==="wrapped-modal"){let t=l.get("map");if(!t)return;if(this.originalMapParent&&this.originalMapIndex!==null){let s=Array.from(this.originalMapParent.children);if(this.originalMapIndex>=s.length)this.originalMapParent.appendChild(t);else{let o=s[this.originalMapIndex];o&&this.originalMapParent.insertBefore(t,o)}if(t.style.width="",t.style.height="",t.style.borderRadius="",t.style.overflow="",[document.querySelector(".leaflet-control-zoom"),l.get("stats-btn"),l.get("export-btn"),l.get("wrapped-btn"),l.get("heatmap-btn"),l.get("airports-btn"),l.get("altitude-btn"),l.get("airspeed-btn"),l.get("year-filter"),l.get("aircraft-filter"),l.get("stats-panel"),l.get("altitude-legend"),l.get("airspeed-legend"),l.get("loading")].forEach(o=>{o&&(o.style.display="")}),this.app.config.openaipApiKey){let o=l.get("aviation-btn");o&&(o.style.display="")}setTimeout(()=>{this.app.map&&this.app.map.invalidateSize(),this.app.stateManager&&this.app.stateManager.saveMapState()},100)}let a=l.get("wrapped-modal");a&&(a.style.display="none")}}};var bt=me(ie(),1);var Ye=class{constructor(e){this.app=e,l.cacheElements(["heatmap-btn","altitude-btn","airspeed-btn","airports-btn","aviation-btn","altitude-legend","airspeed-legend","export-btn","hide-buttons-btn","map","stats-btn","wrapped-btn","replay-btn","year-filter","aircraft-filter","stats-panel","loading"])}toggleHeatmap(){if(this.app.map){if(this.app.heatmapVisible){this.app.heatmapLayer&&this.app.map.removeLayer(this.app.heatmapLayer),this.app.heatmapVisible=!1;let e=l.get("heatmap-btn");e&&(e.style.opacity="0.5")}else{this.app.heatmapLayer&&(this.app.map.addLayer(this.app.heatmapLayer),this.app.heatmapLayer.e&&(this.app.heatmapLayer.e.style.pointerEvents="none")),this.app.heatmapVisible=!0;let e=l.get("heatmap-btn");e&&(e.style.opacity="1.0")}this.app.stateManager.saveMapState()}}toggleAltitude(){if(this.app.map){if(this.app.altitudeVisible){if(this.app.replayManager.replayActive&&!this.app.airspeedVisible)return;this.app.map.removeLayer(this.app.altitudeLayer),this.app.altitudeVisible=!1;let e=l.get("altitude-btn");e&&(e.style.opacity="0.5");let t=l.get("altitude-legend");t&&(t.style.display="none")}else{if(this.app.airspeedVisible){this.app.replayManager.replayActive||this.app.map.removeLayer(this.app.airspeedLayer),this.app.airspeedVisible=!1;let a=l.get("airspeed-btn");a&&(a.style.opacity="0.5");let s=l.get("airspeed-legend");s&&(s.style.display="none")}if(!this.app.replayManager.replayActive)this.app.map.addLayer(this.app.altitudeLayer),this.app.layerManager.redrawAltitudePaths();else{let a=this.app.replayManager.replayCurrentTime,s=this.app.replayManager.replayLastDrawnIndex;this.app.replayManager.replayLayer&&this.app.replayManager.replayLayer.clearLayers(),this.app.replayManager.replayLastDrawnIndex=-1;for(let r=0;r<=s&&r<this.app.replayManager.replaySegments.length;r++){let o=this.app.replayManager.replaySegments[r];if(o&&(o.time||0)<=a){let p=window.KMLHeatmap.getColorForAltitude(o.altitude_ft||0,this.app.replayManager.replayColorMinAlt,this.app.replayManager.replayColorMaxAlt);bt.polyline(o.coords||[],{color:p,weight:3,opacity:.8}).addTo(this.app.replayManager.replayLayer),this.app.replayManager.replayLastDrawnIndex=r}}}this.app.altitudeVisible=!0;let e=l.get("altitude-btn");e&&(e.style.opacity="1.0");let t=l.get("altitude-legend");t&&(t.style.display="block")}this.app.replayManager.replayActive&&this.app.replayManager.replayAirplaneMarker&&this.app.replayManager.replayAirplaneMarker.isPopupOpen()&&this.app.replayManager.updateReplayAirplanePopup(),this.app.stateManager.saveMapState()}}toggleAirspeed(){if(this.app.map){if(this.app.airspeedVisible){if(this.app.replayManager.replayActive&&!this.app.altitudeVisible)return;this.app.map.removeLayer(this.app.airspeedLayer),this.app.airspeedVisible=!1;let e=l.get("airspeed-btn");e&&(e.style.opacity="0.5");let t=l.get("airspeed-legend");t&&(t.style.display="none")}else{if(this.app.altitudeVisible){this.app.replayManager.replayActive||this.app.map.removeLayer(this.app.altitudeLayer),this.app.altitudeVisible=!1;let a=l.get("altitude-btn");a&&(a.style.opacity="0.5");let s=l.get("altitude-legend");s&&(s.style.display="none")}if(!this.app.replayManager.replayActive)this.app.map.addLayer(this.app.airspeedLayer),this.app.layerManager.redrawAirspeedPaths();else{let a=this.app.replayManager.replayCurrentTime,s=this.app.replayManager.replayLastDrawnIndex;this.app.replayManager.replayLayer&&this.app.replayManager.replayLayer.clearLayers(),this.app.replayManager.replayLastDrawnIndex=-1;for(let r=0;r<=s&&r<this.app.replayManager.replaySegments.length;r++){let o=this.app.replayManager.replaySegments[r];if(o&&(o.time||0)<=a&&(o.groundspeed_knots||0)>0){let p=window.KMLHeatmap.getColorForAltitude(o.groundspeed_knots||0,this.app.replayManager.replayColorMinSpeed,this.app.replayManager.replayColorMaxSpeed);bt.polyline(o.coords||[],{color:p,weight:3,opacity:.8}).addTo(this.app.replayManager.replayLayer),this.app.replayManager.replayLastDrawnIndex=r}}}this.app.airspeedVisible=!0;let e=l.get("airspeed-btn");e&&(e.style.opacity="1.0");let t=l.get("airspeed-legend");t&&(t.style.display="block")}this.app.replayManager.replayActive&&this.app.replayManager.replayAirplaneMarker&&this.app.replayManager.replayAirplaneMarker.isPopupOpen()&&this.app.replayManager.updateReplayAirplanePopup(),this.app.stateManager.saveMapState()}}toggleAirports(){if(this.app.map){if(this.app.airportsVisible){this.app.map.removeLayer(this.app.airportLayer),this.app.airportsVisible=!1;let e=l.get("airports-btn");e&&(e.style.opacity="0.5")}else{this.app.map.addLayer(this.app.airportLayer),this.app.airportsVisible=!0;let e=l.get("airports-btn");e&&(e.style.opacity="1.0")}this.app.stateManager.saveMapState()}}toggleAviation(){if(this.app.map&&this.app.config.openaipApiKey&&this.app.openaipLayers["Aviation Data"]){if(this.app.aviationVisible){this.app.map.removeLayer(this.app.openaipLayers["Aviation Data"]),this.app.aviationVisible=!1;let e=l.get("aviation-btn");e&&(e.style.opacity="0.5")}else{this.app.map.addLayer(this.app.openaipLayers["Aviation Data"]),this.app.aviationVisible=!0;let e=l.get("aviation-btn");e&&(e.style.opacity="1.0")}this.app.stateManager.saveMapState()}}toggleButtonsVisibility(){let e=document.querySelectorAll(".toggleable-btn"),t=l.get("hide-buttons-btn");this.app.buttonsHidden?(e.forEach(a=>{a.classList.remove("buttons-hidden")}),t&&(t.textContent="\u{1F53C}"),this.app.buttonsHidden=!1):(e.forEach(a=>{a.classList.add("buttons-hidden")}),t&&(t.textContent="\u{1F53D}"),this.app.buttonsHidden=!0),this.app.altitudeVisible&&this.app.layerManager.redrawAltitudePaths(),this.app.airspeedVisible&&this.app.layerManager.redrawAirspeedPaths(),this.app.stateManager.saveMapState()}exportMap(){let e=l.get("export-btn");if(!e)return;e.disabled=!0,e.textContent="\u23F3 Exporting...";let t=l.get("map");if(!t)return;let a=[document.querySelector(".leaflet-control-zoom"),l.get("stats-btn"),l.get("export-btn"),l.get("wrapped-btn"),l.get("replay-btn"),l.get("year-filter"),l.get("aircraft-filter"),l.get("heatmap-btn"),l.get("altitude-btn"),l.get("airspeed-btn"),l.get("airports-btn"),l.get("aviation-btn"),l.get("stats-panel"),l.get("altitude-legend"),l.get("airspeed-legend"),l.get("loading")],s=a.map(r=>r?r.style.display:null);a.forEach(r=>{r&&(r.style.display="none")}),setTimeout(()=>{window.domtoimage?.toJpeg(t,{width:t.offsetWidth*2,height:t.offsetHeight*2,bgcolor:"#1a1a1a",quality:.95}).then(r=>{a.forEach((p,c)=>{p&&(p.style.display=s[c]||"")}),e.disabled=!1,e.textContent="\u{1F4F7} Export";let o=document.createElement("a");o.download="heatmap_"+new Date().toISOString().slice(0,19).replace(/[:.]/g,"-")+".jpg",o.href=r,o.click()}).catch(r=>{a.forEach((o,p)=>{o&&(o.style.display=s[p]||"")}),alert("Export failed: "+r.message),e.disabled=!1,e.textContent="\u{1F4F7} Export"})},200)}};var Ke=me(ie(),1);async function ma(n){let e=await n.dataManager.loadAirports();n.allAirportsData=e;let t=await n.dataManager.loadMetadata();if(t&&t.available_years){let r=document.getElementById("year-select");if(t.available_years.forEach(o=>{let p=document.createElement("option");p.value=o.toString(),p.textContent="\u{1F4C5} "+o,r.appendChild(p)}),n.selectedYear==="all"&&!n.restoredYearFromState){let o=t.available_years[t.available_years.length-1];o!==void 0&&(n.selectedYear=o.toString())}n.selectedYear&&n.selectedYear!=="all"&&(r.value=n.selectedYear)}At(n,e),t&&t.stats&&(n.fullStats=t.stats);try{let r=await n.dataManager.loadData("data",n.selectedYear);r&&r.path_info&&(n.fullPathInfo=r.path_info),r&&r.path_segments&&(n.fullPathSegments=r.path_segments)}catch(r){$t("Failed to load full path data:",r)}if(n.filterManager.updateAircraftDropdown(),n.airportManager.updateAirportPopups(),n.fullStats){let r=window.KMLHeatmap.calculateFilteredStatistics({pathInfo:n.fullPathInfo??[],segments:n.fullPathSegments??[],year:n.selectedYear,aircraft:n.selectedAircraft,coordinateCount:n.currentData?.original_points});n.statsManager.updateStatsPanel(r,!1)}n.airportManager.updateAirportOpacity();let a=t&&t.max_groundspeed_knots!==void 0&&t.max_groundspeed_knots>0;a&&(n.airspeedRange.min=t.min_groundspeed_knots,n.airspeedRange.max=t.max_groundspeed_knots,n.layerManager.updateAirspeedLegend(n.airspeedRange.min,n.airspeedRange.max));let s=l.get("airspeed-btn");if(s&&(a?(s.disabled=!1,s.style.opacity=n.airspeedVisible?"1.0":"0.5"):(s.disabled=!0,s.style.opacity="0.3")),await n.dataManager.updateLayers(),n.airportManager.updateAirportMarkerSizes(),n.altitudeVisible&&(n.map.addLayer(n.altitudeLayer),document.getElementById("altitude-legend").style.display="block"),n.airspeedVisible&&(n.map.addLayer(n.airspeedLayer),document.getElementById("airspeed-legend").style.display="block"),n.aviationVisible&&n.config.openaipApiKey&&n.openaipLayers["Aviation Data"]&&n.map.addLayer(n.openaipLayers["Aviation Data"]),n.selectedPathIds.size>0&&n.replayManager.updateReplayButtonState(),n.savedState&&n.savedState.statsPanelVisible){let r=document.getElementById("stats-panel");r.style.display="block",r.offsetHeight,r.classList.add("visible")}}function At(n,e){let t=null;e.length>0&&(t=e.reduce((a,s)=>{let r=s,o=a,p=r.flight_count??0,c=o?.flight_count??0;return p>c?s:a})),e.forEach(a=>{let s=a.name?a.name.match(/\b([A-Z]{4})\b/):null,r=s?s[1]:"APT",o=t&&a.name===t.name,p=o?" airport-marker-home":"",c=o?" airport-label-home":"",h='<div class="airport-marker-container"><div class="airport-marker'+p+'"></div><div class="airport-label'+c+'">'+r+"</div></div>",f=window.KMLHeatmap.ddToDms(a.lat,!0),b=window.KMLHeatmap.ddToDms(a.lon,!1),T=`https://www.google.com/maps?q=${a.lat},${a.lon}`,g=`
          <div style="
              font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
              min-width: 220px;
              padding: 8px 4px;
              background-color: #2b2b2b;
              color: #ffffff;
          ">
              <div style="
                  font-size: 15px;
                  font-weight: bold;
                  color: #28a745;
                  margin-bottom: 10px;
                  padding-bottom: 8px;
                  border-bottom: 2px solid #28a745;
                  display: flex;
                  align-items: center;
                  gap: 6px;
              ">
                  <span style="font-size: 18px;">\u{1F6EB}</span>
                  <span>${a.name||"Unknown"}</span>
                  ${o?'<span style="font-size: 12px; background: #007bff; color: white; padding: 2px 6px; border-radius: 3px; margin-left: 4px;">HOME</span>':""}
              </div>
              <div style="margin-bottom: 8px;">
                  <div style="font-size: 11px; color: #999; margin-bottom: 2px; text-transform: uppercase; letter-spacing: 0.5px;">Coordinates</div>
                  <a href="${T}"
                     target="_blank"
                     style="
                         color: #4facfe;
                         text-decoration: none;
                         font-size: 12px;
                         font-family: monospace;
                         display: flex;
                         align-items: center;
                         gap: 4px;
                     "
                     onmouseover="this.style.textDecoration='underline'"
                     onmouseout="this.style.textDecoration='none'">
                      <span>\u{1F4CD}</span>
                      <span>${f}<br>${b}</span>
                  </a>
              </div>
              <div style="
                  background: linear-gradient(135deg, rgba(79, 172, 254, 0.15) 0%, rgba(0, 242, 254, 0.15) 100%);
                  padding: 8px 10px;
                  border-radius: 6px;
                  border-left: 3px solid #4facfe;
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
              ">
                  <span style="font-size: 12px; color: #ccc; font-weight: 500;">Total Flights</span>
                  <span style="font-size: 16px; font-weight: bold; color: #4facfe;">${a.flight_count||0}</span>
              </div>
          </div>`,A=Ke.marker([a.lat,a.lon],{icon:Ke.divIcon({html:h,iconSize:[12,12],iconAnchor:[6,6],popupAnchor:[0,-6],className:""})}).bindPopup(g,{autoPanPadding:[50,50]});A.on("click",v=>{n.replayManager.replayActive||n.pathSelection.selectPathsByAirport(a.name)}),A.addTo(n.airportLayer),n.airportMarkers[a.name]=A})}var Ge=class{constructor(e){this.config=e,this.selectedYear="all",this.selectedAircraft="all",this.allAirportsData=[],this.isInitializing=!0,this.map=null,this.heatmapLayer=null,this.altitudeLayer=z.layerGroup(),this.airspeedLayer=z.layerGroup(),this.airportLayer=z.layerGroup(),this.altitudeRenderer=z.svg(),this.airspeedRenderer=z.svg(),this.currentData=null,this.fullStats=null,this.fullPathInfo=null,this.fullPathSegments=null,this.altitudeRange={min:0,max:1e4},this.airspeedRange={min:0,max:200},this.heatmapVisible=!0,this.altitudeVisible=!1,this.airspeedVisible=!1,this.airportsVisible=!0,this.aviationVisible=!1,this.buttonsHidden=!1,this.selectedPathIds=new Set,this.pathSegments={},this.pathToAirports={},this.airportToPaths={},this.airportMarkers={},this.openaipLayers={},this.savedState=null,this.restoredYearFromState=!1,this.stateManager=null,this.dataManager=null,this.layerManager=null,this.filterManager=null,this.statsManager=null,this.pathSelection=null,this.airportManager=null,this.replayManager=null,this.wrappedManager=null,this.uiToggles=null}async initialize(){if(this.stateManager=new Re(this),this.savedState=this.stateManager.loadState(),this.savedState&&(this.savedState.selectedYear!==void 0&&(this.selectedYear=this.savedState.selectedYear,this.restoredYearFromState=!0),this.savedState.selectedAircraft&&(this.selectedAircraft=this.savedState.selectedAircraft),this.savedState.selectedPathIds&&this.savedState.selectedPathIds.length>0&&this.savedState.selectedPathIds.forEach(e=>{let t=typeof e=="string"?parseInt(e,10):e;this.selectedPathIds.add(t)}),this.savedState.heatmapVisible!==void 0&&(this.heatmapVisible=this.savedState.heatmapVisible),this.savedState.altitudeVisible!==void 0&&(this.altitudeVisible=this.savedState.altitudeVisible),this.savedState.airspeedVisible!==void 0&&(this.airspeedVisible=this.savedState.airspeedVisible),this.savedState.airportsVisible!==void 0&&(this.airportsVisible=this.savedState.airportsVisible),this.savedState.aviationVisible!==void 0&&(this.aviationVisible=this.savedState.aviationVisible),this.savedState.buttonsHidden!==void 0&&(this.buttonsHidden=this.savedState.buttonsHidden)),this.map=z.map("map",{center:this.config.center,zoom:10,zoomSnap:.25,zoomDelta:.25,wheelPxPerZoomLevel:120,preferCanvas:!0}),this.config.stadiaApiKey?z.tileLayer("https://tiles.stadiamaps.com/tiles/alidade_smooth_dark/{z}/{x}/{y}{r}.png?api_key="+this.config.stadiaApiKey,{attribution:'&copy; <a href="https://stadiamaps.com/">Stadia Maps</a>'}).addTo(this.map):z.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png",{attribution:"&copy; OpenStreetMap contributors, &copy; CARTO"}).addTo(this.map),this.savedState&&this.savedState.center&&this.savedState.zoom?this.map.setView([this.savedState.center.lat,this.savedState.center.lng],this.savedState.zoom):this.map.fitBounds(this.config.bounds,{padding:[30,30]}),this.config.openaipApiKey&&(this.openaipLayers["Aviation Data"]=z.tileLayer("https://{s}.api.tiles.openaip.net/api/data/openaip/{z}/{x}/{y}.png?apiKey="+this.config.openaipApiKey,{attribution:'&copy; <a href="https://www.openaip.net">OpenAIP</a>',maxZoom:18,minZoom:7,subdomains:["a","b","c"]})),this.airportsVisible&&this.airportLayer.addTo(this.map),document.getElementById("heatmap-btn").style.opacity=this.heatmapVisible?"1.0":"0.5",document.getElementById("altitude-btn").style.opacity=this.altitudeVisible?"1.0":"0.5",document.getElementById("airspeed-btn").style.opacity=this.airspeedVisible?"1.0":"0.5",document.getElementById("airports-btn").style.opacity=this.airportsVisible?"1.0":"0.5",document.getElementById("aviation-btn").style.opacity=this.aviationVisible?"1.0":"0.5",this.config.openaipApiKey&&(document.getElementById("aviation-btn").style.display="block"),this.dataManager=new Ce(this),this.layerManager=new ke(this),this.filterManager=new De(this),this.statsManager=new Fe(this),this.pathSelection=new Ne(this),this.airportManager=new ze(this),this.replayManager=new Ve(this),this.wrappedManager=new Ue(this),this.uiToggles=new Ye(this),await this.loadInitialData(),this.setupEventHandlers(),this.isInitializing=!1,this.savedState&&this.savedState.buttonsHidden){let e=document.querySelectorAll(".toggleable-btn"),t=document.getElementById("hide-buttons-btn");e.forEach(a=>{a.classList.add("buttons-hidden")}),t&&(t.textContent="\u{1F53D}")}this.savedState&&this.savedState.wrappedVisible&&setTimeout(()=>{this.wrappedManager&&this.wrappedManager.showWrapped()},500),this.stateManager.saveMapState()}async loadInitialData(){await ma(this)}createAirportMarkers(e){At(this,e)}setupEventHandlers(){this.map.on("moveend",()=>this.stateManager.saveMapState()),this.map.on("zoomend",()=>{this.stateManager.saveMapState(),this.airportManager.updateAirportMarkerSizes()}),this.map.on("click",e=>{this.replayManager.replayActive&&this.replayManager.replayAirplaneMarker&&this.replayManager.replayAirplaneMarker.isPopupOpen()&&this.replayManager.replayAirplaneMarker.closePopup(),!this.replayManager.replayActive&&this.selectedPathIds.size>0&&this.pathSelection.clearSelection()})}toggleHeatmap(){this.uiToggles.toggleHeatmap()}toggleStats(){this.statsManager.toggleStats()}toggleAltitude(){this.uiToggles.toggleAltitude()}toggleAirspeed(){this.uiToggles.toggleAirspeed()}toggleAirports(){this.uiToggles.toggleAirports()}toggleAviation(){this.uiToggles.toggleAviation()}toggleReplay(){this.replayManager.toggleReplay()}filterByYear(){this.filterManager.filterByYear()}filterByAircraft(){this.filterManager.filterByAircraft()}togglePathSelection(e){this.pathSelection.togglePathSelection(Number(e))}exportMap(){this.uiToggles.exportMap()}showWrapped(){this.wrappedManager.showWrapped()}closeWrapped(e){this.wrappedManager.closeWrapped(e)}toggleButtonsVisibility(){this.uiToggles.toggleButtonsVisibility()}playReplay(){this.replayManager.playReplay()}pauseReplay(){this.replayManager.pauseReplay()}stopReplay(){this.replayManager.stopReplay()}seekReplay(e){this.replayManager.seekReplay(e)}changeReplaySpeed(){this.replayManager.changeReplaySpeed()}toggleAutoZoom(){this.replayManager.toggleAutoZoom()}};typeof window<"u"&&(window.initMapApp=async n=>{let e=new Ge(n);return window.mapApp=e,await e.initialize(),window.toggleHeatmap=()=>e.toggleHeatmap(),window.toggleStats=()=>e.toggleStats(),window.toggleAltitude=()=>e.toggleAltitude(),window.toggleAirspeed=()=>e.toggleAirspeed(),window.toggleAirports=()=>e.toggleAirports(),window.toggleAviation=()=>e.toggleAviation(),window.toggleReplay=()=>e.toggleReplay(),window.filterByYear=()=>e.filterByYear(),window.filterByAircraft=()=>e.filterByAircraft(),window.togglePathSelection=t=>e.togglePathSelection(t),window.exportMap=()=>e.exportMap(),window.showWrapped=()=>e.showWrapped(),window.closeWrapped=t=>e.closeWrapped(t),window.toggleButtonsVisibility=()=>e.toggleButtonsVisibility(),window.playReplay=()=>e.playReplay(),window.pauseReplay=()=>e.pauseReplay(),window.stopReplay=()=>e.stopReplay(),window.seekReplay=t=>e.seekReplay(t),window.changeReplaySpeed=()=>e.changeReplaySpeed(),window.toggleAutoZoom=()=>e.toggleAutoZoom(),e});typeof window<"u"&&window.MAP_CONFIG&&window.initMapApp&&window.initMapApp(window.MAP_CONFIG);return Ia(ii);})();
/*! Bundled license information:

dompurify/dist/purify.es.mjs:
  (*! @license DOMPurify 3.3.1 | (c) Cure53 and other contributors | Released under the Apache license 2.0 and Mozilla Public License 2.0 | github.com/cure53/DOMPurify/blob/3.3.1/LICENSE *)
*/
